
<script>
// scriptsPlanificacion.html - VERSI√ìN LIMPIA
// Variables globales
var mesActual = new Date();
var diaSeleccionado = null;
// Variables del modal
var pasoActual = 1;
var temasSeleccionados = [];
var tiempoTotalDisponible = 240; // minutos
var tiempoUsado = 0;
var bloquesActivos = [];
var configuracionActual = null;

// Inicializar secci√≥n de planificaci√≥n
function inicializarSeccionPlanificacion() {
  console.log('üîß Inicializando planificaci√≥n limpia...');
  renderizarCalendario();
  // Auto-seleccionar d√≠a actual
  const hoy = new Date();
  if (mesActual.getMonth() === hoy.getMonth() && mesActual.getFullYear() === hoy.getFullYear()) {
    seleccionarDia(hoy.getDate());
  }
}

// Renderizar calendario
function renderizarCalendario() {
  const a√±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();
  
  // Actualizar t√≠tulo
  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  document.getElementById('tituloMes').textContent = meses[mes] + ' ' + a√±o;
  
  // Calcular primer d√≠a (lunes = 0)
  let primerDia = new Date(a√±o, mes, 1).getDay();
  primerDia = primerDia === 0 ? 6 : primerDia - 1; // Ajustar para lunes = 0
  
  const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
  const hoy = new Date();
  
  // Generar HTML del calendario
  let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
  
  // Encabezados de d√≠as
  const diasSemana = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
  diasSemana.forEach(dia => {
    html += '<div style="text-align: center; font-weight: bold; padding: 8px; color: #666; font-size: 12px;">' + dia + '</div>';
  });
  
  // D√≠as vac√≠os al inicio
  for (let i = 0; i < primerDia; i++) {
    html += '<div></div>';
  }
  
  //D√≠as del mes
  for (let dia = 1; dia <= diasEnMes; dia++) {
    const fecha = new Date(a√±o, mes, dia);
    const esHoy = fecha.toDateString() === hoy.toDateString();
    const esSeleccionado = diaSeleccionado === dia;
    
    // Estilos del d√≠a
    let estilos = 'min-height: 80px; border: 1px solid #ddd; border-radius: 5px; padding: 5px; cursor: pointer; ';
    estilos += 'display: flex; flex-direction: column; justify-content: space-between; ';
    
    if (esHoy) {
      estilos += 'border: 2px solid #2196f3; background: #e3f2fd; ';
    } else if (esSeleccionado) {
      estilos += 'background: #f0f0f0; ';
    } else {
      estilos += 'background: white; ';
    }
    
    html += '<div onclick="seleccionarDia(' + dia + ')" style="' + estilos + '">';
    
    // N√∫mero del d√≠a
    html += '<div style="font-weight: bold; color: ' + (esHoy ? '#2196f3' : '#333') + ';">' + dia + '</div>';
    
    // Contenido del d√≠a (placeholder por ahora)
    html += '<div id="contenido-' + a√±o + '-' + mes + '-' + dia + '" style="font-size: 10px; flex: 1;"></div>';
    
    html += '</div>';
  }
  
  html += '</div>';
  
  document.getElementById('calendario').innerHTML = html;
}

// Cambiar mes
function cambiarMes(direccion) {
  mesActual.setMonth(mesActual.getMonth() + direccion);
  diaSeleccionado = null; // Reset selecci√≥n
  renderizarCalendario();
  limpiarDetalleDia();
}

// Ir a hoy
function irAHoy() {
  mesActual = new Date();
  renderizarCalendario();
  seleccionarDia(new Date().getDate());
}

// Seleccionar d√≠a
function seleccionarDia(dia) {
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  const esDiaPasado = fechaSeleccionada < hoy;
  
  diaSeleccionado = dia;
  renderizarCalendario(); // Re-renderizar para mostrar selecci√≥n
  
  // Actualizar detalle del d√≠a
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const tituloFecha = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
  
  if (esDiaPasado) {
    document.getElementById('tituloDetalleDia').textContent = tituloFecha + ' (Solo lectura)';
    document.getElementById('contenidoDetalleDia').innerHTML = 
      '<div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">' +
      '<strong>‚ÑπÔ∏è D√≠a pasado:</strong> Solo puedes consultar la informaci√≥n, no modificar.' +
      '</div>' +
      '<p style="color: #999;">Detalle del d√≠a en desarrollo...</p>';
  } else {
    document.getElementById('tituloDetalleDia').textContent = tituloFecha;
    document.getElementById('contenidoDetalleDia').innerHTML = 
      '<p style="color: #999;">D√≠a seleccionado: ' + dia + '. Detalle en desarrollo...</p>';
  }
}

// Limpiar detalle del d√≠a
function limpiarDetalleDia() {
  document.getElementById('tituloDetalleDia').textContent = 'Selecciona un d√≠a';
  document.getElementById('contenidoDetalleDia').innerHTML = '<p style="text-align: center; color: #666; padding: 40px 0;"><i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br>Selecciona un d√≠a del calendario</p>';
}

// Abrir modal de nueva planificaci√≥n
function nuevaPlanificacion() {
  // Validar que hay un d√≠a seleccionado
  if (!diaSeleccionado) {
    alert('‚ö†Ô∏è Primero selecciona un d√≠a del calendario');
    return;
  }
  
  // Validar que no es d√≠a pasado
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada < hoy) {
    alert('‚ö†Ô∏è No puedes crear planificaciones para d√≠as pasados');
    return;
  }
  
  // Reset variables
  pasoActual = 1;
  temasSeleccionados = [];
  tiempoUsado = 0;
  bloquesActivos = [];
  
  // Establecer fecha seleccionada
  const fechaStr = fechaSeleccionada.getFullYear() + '-' + 
    String(fechaSeleccionada.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fechaSeleccionada.getDate()).padStart(2, '0');
  document.getElementById('fechaPlanificacion').value = fechaStr;
  
  // Mostrar modal
  document.getElementById('modalNuevaPlanificacion').style.display = 'flex';
  
  // Cargar oposiciones
  cargarOposiciones();
  
  // Mostrar paso 1
  mostrarPaso(1);
  
  // Verificar repasos del d√≠a seleccionado
  verificarRepasosDelDia();
}

// Cerrar modal
function cerrarModal() {
  document.getElementById('modalNuevaPlanificacion').style.display = 'none';
}

// Mostrar paso espec√≠fico
function mostrarPaso(numeroPaso) {
  pasoActual = numeroPaso;
  
  // Ocultar todos los pasos
  document.getElementById('paso1').style.display = 'none';
  document.getElementById('paso2').style.display = 'none';
  document.getElementById('paso3').style.display = 'none';
  
  // Mostrar paso actual
  document.getElementById('paso' + numeroPaso).style.display = 'block';
  
  // Actualizar indicadores visuales
  actualizarIndicadoresPasos();
  
  // Actualizar botones
  document.getElementById('btnAnterior').style.display = numeroPaso > 1 ? 'inline-block' : 'none';
  document.getElementById('btnSiguiente').textContent = numeroPaso === 3 ? 'Crear Planificaci√≥n' : 'Siguiente ‚ñ∂';
  
  // Acciones espec√≠ficas por paso
  if (numeroPaso === 2) {
    cargarConfiguracionActual();
    mostrarRepasosEnPasoDos();
    actualizarTiempoDisponible();
  } else if (numeroPaso === 3) {
    // Actualizar tiempo disponible real para planificaci√≥n (sin repasos)
    const horasUsuario = parseFloat(document.getElementById('horasEstudio').value) || 4;
    tiempoTotalDisponible = horasUsuario * 60; // Solo tiempo de estudio
    
    cargarArbolTemas();
    actualizarResumenTiempo();
  }

}

// Actualizar indicadores de pasos
function actualizarIndicadoresPasos() {
  for (let i = 1; i <= 3; i++) {
    const indicador = document.getElementById('indicadorPaso' + i);
    const circulo = indicador.querySelector('div');
    const texto = indicador.querySelector('span');
    
    if (i < pasoActual) {
      // Paso completado
      circulo.style.background = '#28a745';
      circulo.style.color = 'white';
      texto.style.color = '#28a745';
    } else if (i === pasoActual) {
      // Paso actual
      circulo.style.background = '#007bff';
      circulo.style.color = 'white';
      texto.style.color = '#007bff';
    } else {
      // Paso pendiente
      circulo.style.background = '#ddd';
      circulo.style.color = '#999';
      texto.style.color = '#999';
    }
  }
}

// Paso siguiente
function pasoSiguiente() {
  if (pasoActual === 1) {
    // Validar paso 1
    if (!document.getElementById('fechaPlanificacion').value) {
      alert('‚ö†Ô∏è Selecciona una fecha');
      return;
    }
    if (!document.getElementById('oposicionPlanificacion').value) {
      alert('‚ö†Ô∏è Selecciona una oposici√≥n');
      return;
    }
    mostrarPaso(2);
    
  } else if (pasoActual === 2) {
    // Validar paso 2
    const horas = parseFloat(document.getElementById('horasEstudio').value);
    if (!horas || horas < 0.5) {
      alert('‚ö†Ô∏è Introduce un tiempo de estudio v√°lido (m√≠nimo 0.5 horas)');
      return;
    }
    mostrarPaso(3);
    
  } else if (pasoActual === 3) {
    // Crear planificaci√≥n
    crearPlanificacion();
  }
}

// Paso anterior
function pasoAnterior() {
  if (pasoActual > 1) {
    mostrarPaso(pasoActual - 1);
  }
}

// Cargar oposiciones (conectado al backend)
function cargarOposiciones() {
  const select = document.getElementById('oposicionPlanificacion');
  select.innerHTML = '<option value="">-- Cargando oposiciones... --</option>';
  
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      select.innerHTML = '<option value="">-- Selecciona una oposici√≥n --</option>';
      
      oposiciones.forEach(function(oposicion) {
        const option = document.createElement('option');
        option.value = oposicion.id;
        option.textContent = oposicion.nombre;
        select.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      select.innerHTML = '<option value="">-- Error al cargar --</option>';
    })
    .getOposicionesParaPlanificacion();
}

// Verificar repasos del d√≠a con indicador de carga
function verificarRepasosDelDia() {
  const fecha = document.getElementById('fechaPlanificacion').value;
  if (!fecha) {
    document.getElementById('alertaRepasos').style.display = 'none';
    return;
  }
  
  // Mostrar indicador de carga
  const alertaDiv = document.getElementById('alertaRepasos');
  const listaDiv = document.getElementById('listaRepasos');
  
  alertaDiv.style.display = 'block';
  listaDiv.innerHTML = '<p style="margin: 0;"><i class="fas fa-spinner fa-spin"></i> Comprobando repasos programados...</p>';
  
  const fechaMs = new Date(fecha + 'T00:00:00').getTime();
  
  google.script.run
    .withSuccessHandler(function(repasos) {
      if (repasos && repasos.length > 0) {
        let html = '<ul style="margin: 0; padding-left: 20px;">';
        repasos.forEach(function(repaso) {
          html += '<li><strong>R' + repaso.numeroRepaso + ':</strong> ' + repaso.nombreTema + ' <span style="color: #856404;">(30 min)</span></li>';
        });
        html += '</ul>';
        html += '<p style="margin: 10px 0 0 0; font-weight: bold; color: #856404;">Total tiempo repasos: ' + (repasos.length * 30) + ' minutos</p>';
        
        listaDiv.innerHTML = html;
        alertaDiv.style.display = 'block';
        
        // Guardar info de repasos para el paso 2
        window.repasosDelDia = repasos;
      } else {
        alertaDiv.style.display = 'none';
        window.repasosDelDia = [];
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar repasos:', error);
      alertaDiv.style.display = 'none';
      window.repasosDelDia = [];
    })
    .getRepasosDelDia(fechaMs);
}

// Cargar configuraci√≥n actual (conectado al backend)
function cargarConfiguracionActual() {
  const idOposicion = document.getElementById('oposicionPlanificacion').value;
  if (!idOposicion) return;
  
  google.script.run
    .withSuccessHandler(function(config) {
      configuracionActual = config;
      
      document.getElementById('vueltaActual').textContent = config.vueltaActual;
      
      const minutosPorPagina = getMinutosPorPaginaLocal(config);
      document.getElementById('minutosPorPagina').textContent = minutosPorPagina;
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar configuraci√≥n:', error);
      // Valores por defecto
      document.getElementById('vueltaActual').textContent = '1';
      document.getElementById('minutosPorPagina').textContent = '30';
    })
    .getConfiguracionOposicion(idOposicion);
}

// Funci√≥n auxiliar para calcular minutos por p√°gina localmente
function getMinutosPorPaginaLocal(config) {
  switch (config.vueltaActual) {
    case 1: return config.minPorPagV1;
    case 2: return config.minPorPagV2;
    case 3: return config.minPorPagV3;
    default: return config.minPorPagV4;
  }
}

// Modificar actualizarTiempoDisponible para incluir repasos
function actualizarTiempoDisponible() {
  const horas = parseFloat(document.getElementById('horasEstudio').value) || 0;
  const tiempoEstudio = horas * 60;
  const tiempoRepasos = window.repasosDelDia ? window.repasosDelDia.length * 30 : 0;
  const tiempoTotal = tiempoEstudio + tiempoRepasos;
  
  tiempoTotalDisponible = tiempoEstudio; // Solo el tiempo de estudio para la planificaci√≥n
  
  document.getElementById('tiempoEstudio').textContent = tiempoEstudio + ' min';
  document.getElementById('tiempoTotalConRepasos').textContent = tiempoTotal + ' min';
  
  if (pasoActual === 3) {
    actualizarResumenTiempo();
  }
}

// Mostrar repasos en el paso 2
function mostrarRepasosEnPasoDos() {
  const infoDiv = document.getElementById('infoRepasosStepDos');
  const detalleDiv = document.getElementById('detalleRepasosStepDos');
  
  if (window.repasosDelDia && window.repasosDelDia.length > 0) {
    const tiempoRepasos = window.repasosDelDia.length * 30;
    
    let html = '<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">';
    html += '<div>';
    html += '<ul style="margin: 0; padding-left: 20px;">';
    window.repasosDelDia.forEach(function(repaso) {
      html += '<li>' + repaso.nombreTema + ' <span style="color: #856404;">(30 min)</span></li>';
    });
    html += '</ul>';
    html += '</div>';
    html += '<div style="text-align: center; background: #ffc107; color: white; padding: 10px; border-radius: 5px; min-width: 80px;">';
    html += '<div style="font-size: 20px; font-weight: bold;">' + tiempoRepasos + ' min</div>';
    html += '<div style="font-size: 12px;">Total</div>';
    html += '</div>';
    html += '</div>';
    
    detalleDiv.innerHTML = html;
    infoDiv.style.display = 'block';
    
    // Actualizar el c√°lculo de tiempo
    document.getElementById('tiempoRepasos').textContent = tiempoRepasos + ' min';
    actualizarTiempoDisponible();
  } else {
    infoDiv.style.display = 'none';
    document.getElementById('tiempoRepasos').textContent = '0 min';
    actualizarTiempoDisponible();
  }
}

// Cargar √°rbol de temas (CORREGIDO - tiempo estudio MENOS repasos)
function cargarArbolTemas() {
  const idOposicion = document.getElementById('oposicionPlanificacion').value;
  const contenedor = document.getElementById('arbolTemas');
  
  if (!idOposicion) {
    contenedor.innerHTML = '<p style="text-align: center; color: #666;">Selecciona una oposici√≥n para cargar los temas</p>';
    return;
  }
  
  // Calcular tiempo disponible REAL (estudio - repasos)
  const horasUsuario = parseFloat(document.getElementById('horasEstudio').value) || 4;
  const tiempoEstudio = horasUsuario * 60; // Minutos de estudio
  const tiempoRepasos = window.repasosDelDia ? window.repasosDelDia.length * 30 : 0; // Minutos de repasos
  const tiempoEstudioDisponible = tiempoEstudio; // Solo tiempo para temas nuevos (sin repasos)
  
  console.log('‚è±Ô∏è Tiempo estudio:', tiempoEstudio, 'min');
  console.log('‚è±Ô∏è Tiempo repasos:', tiempoRepasos, 'min');
  console.log('‚è±Ô∏è Tiempo disponible para temas:', tiempoEstudioDisponible, 'min');
  
  // Mostrar loading
  contenedor.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando √°rbol de temas...</p>';
  
  google.script.run
    .withSuccessHandler(function(data) {
      console.log('‚úÖ √Årbol de temas recibido:', data);
      
      // Guardar √°rbol global para validaciones
      window.arbolCompletoGlobal = data.arbol;
      
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay temas principales vinculados a esta oposici√≥n</p>';
        return;
      }
      
      // Renderizar √°rbol real
      renderizarArbolPorBloques(data.arbol, data.minutosPorPagina, data.bloques);
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar √°rbol:', error);
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas: ' + error.message + '</p>';
    })
    .getArbolTemasConEstados(idOposicion, tiempoEstudioDisponible); // ‚Üê TIEMPO SIN REPASOS
}

// Renderizar √°rbol agrupado por bloques (CORREGIDO)
function renderizarArbolPorBloques(arbolTemas, minutosPorPagina, bloquesInfo) {
  const contenedor = document.getElementById('arbolTemas');
  
  if (!arbolTemas || arbolTemas.length === 0) {
    contenedor.innerHTML = '<p style="text-align: center; color: #666;">No hay temas vinculados a esta oposici√≥n</p>';
    return;
  }
  
  // Agrupar temas por bloque (USANDO DATOS REALES)
  const temasPorBloque = agruparTemasPorBloque(arbolTemas, bloquesInfo);
  
  let html = '';
  
  // Renderizar cada bloque
  Object.keys(temasPorBloque).forEach(nombreBloque => {
    const temasDelBloque = temasPorBloque[nombreBloque];
    const esEspecial = esBloqueBloqueEspecial(nombreBloque);
    
    html += '<div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">';
    
    // Header del bloque (colapsable)
    html += '<div onclick="toggleBloque(\'' + nombreBloque + '\')" style="padding: 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">';
    html += '<div>';
    html += '<h6 style="margin: 0; font-weight: bold;">' + nombreBloque;
    if (esEspecial) {
      html += ' <span style="background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ESPECIAL</span>';
    }
    html += '</h6>';
    html += '<small style="color: #666;">' + temasDelBloque.length + ' temas principales</small>';
    html += '</div>';
    html += '<i id="icono-' + nombreBloque + '" style="transition: transform 0.3s;">‚ñº</i>';
    html += '</div>';
    
    // Contenido del bloque (inicialmente visible)
    html += '<div id="bloque-' + nombreBloque + '" style="padding: 15px;">';
    
    // Renderizar cada tema del bloque
    temasDelBloque.forEach(tema => {
      html += renderizarNodoTema(tema, 0, nombreBloque);
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  contenedor.innerHTML = html;
}

// Agrupar temas por bloque (USANDO DATOS REALES)
function agruparTemasPorBloque(arbolTemas, bloquesInfo) {
  const temasPorBloque = {};
  
  arbolTemas.forEach(tema => {
    const idBloque = tema.idBloque;
    const nombreBloque = bloquesInfo[idBloque] || 'Sin Bloque';
    
    if (!temasPorBloque[nombreBloque]) {
      temasPorBloque[nombreBloque] = [];
    }
    
    temasPorBloque[nombreBloque].push(tema);
  });
  
  console.log('üìä Temas agrupados por bloque:', temasPorBloque);
  return temasPorBloque;
}

// Renderizar nodo de tema con checkbox padre/hijo
function renderizarNodoTema(nodo, nivel, nombreBloque) {
  const margenIzquierdo = nivel * 20;
  const iconoEstado = getIconoEstado(nodo.estado);
  const colorFondo = getColorFondo(nodo.estado);
  
  let html = '';
  
  // Contenedor del nodo
  html += '<div style="margin-left: ' + margenIzquierdo + 'px; margin-bottom: 8px;">';
  
  // Fila del tema
  html += '<div style="display: flex; align-items: center; padding: 10px; background: ' + colorFondo + '; border: 1px solid #e0e0e0; border-radius: 6px;">';
  
  // Checkbox (para hojas seleccionables O padres seleccionables)
  if (nodo.seleccionable || nodo.seleccionablePadre) {
    const yaSeleccionado = temasSeleccionados.some(t => t.id === nodo.id);
    const tipoSeleccion = nodo.seleccionablePadre ? 'padre' : 'hijo';
    
    html += '<input type="checkbox" ';
    html += 'onchange="toggleSeleccionTemaConValidacion(this, ' + nodo.id + ', ' + nodo.tiempoMinutos + ', \'' + nombreBloque + '\', \'' + tipoSeleccion + '\')" ';
    html += (yaSeleccionado ? 'checked ' : '');
    html += 'style="margin-right: 10px; transform: scale(1.2);" ';
    html += 'title="' + (nodo.seleccionablePadre ? 'Seleccionar tema completo (' + nodo.tiempoTexto + ')' : 'Seleccionar subtema') + '">';
  } else {
    html += '<span style="width: 24px; margin-right: 10px; text-align: center; font-size: 16px;">' + iconoEstado + '</span>';
  }
  
  // Contenido del tema
  html += '<div style="flex: 1;">';
  html += '<div style="font-weight: ' + (nivel === 0 ? 'bold' : 'normal') + '; color: ' + getColorTexto(nodo.estado) + ';">';
  html += nodo.nombreCompleto;
  html += '</div>';
  
  if (nodo.paginas > 0) {
    html += '<small style="color: #666; font-size: 11px;">';
    html += nodo.paginas + ' p√°gs ‚Ä¢ ' + nodo.tiempoTexto;
    html += '</small>';
  }
  html += '</div>';
  
  // Badge de estado
  html += '<div style="margin-left: 10px;">';
  html += '<span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ' + getColorBadge(nodo.estado) + '; color: white; font-weight: bold;">';
  html += getTextoEstado(nodo.estado);
  html += '</span>';
  html += '</div>';
  
  html += '</div>';
  
  // Renderizar hijos si existen
  if (nodo.hijos && nodo.hijos.length > 0) {
    nodo.hijos.forEach(hijo => {
      html += renderizarNodoTema(hijo, nivel + 1, nombreBloque);
    });
  }
  
  html += '</div>';
  
  return html;
}

// Toggle selecci√≥n con validaci√≥n de orden (FUNCI√ìN COMPLETA)
function toggleSeleccionTemaConValidacion(checkbox, idTema, tiempoMinutos, nombreBloque, tipoSeleccion) {
  if (checkbox.checked) {
    // Validar orden consecutivo
    const nodoSeleccionado = { id: idTema };
    const validacionOrden = validarOrdenConsecutivo(nodoSeleccionado, window.arbolCompletoGlobal);
    
    if (!validacionOrden.esConsecutivo) {
      const confirmar = confirm('‚ö†Ô∏è ' + validacionOrden.mensaje + '\n\n¬øQuieres continuar seleccionando este tema?');
      if (!confirmar) {
        checkbox.checked = false;
        return;
      }
    }
    
    // Validar l√≠mites normales
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque,
      tipo: tipoSeleccion
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
    // Mostrar mensaje informativo para temas padre
    if (tipoSeleccion === 'padre') {
      setTimeout(() => {
        alert('‚úÖ Tema padre seleccionado completo.\nSe estudiar√° todo el tema en ' + formatearTiempo(tiempoMinutos) + '.');
      }, 100);
    }
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Formatear tiempo localmente
function formatearTiempo(minutos) {
  if (!minutos || minutos <= 0) return '0m';
  
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;
  
  if (horas > 0) {
    return horas + 'h ' + mins + 'm';
  } else {
    return mins + 'm';
  }
}

// Funciones auxiliares para estilos
function getIconoEstado(estado) {
  switch (estado) {
    case 'completado': return '‚úÖ';
    case 'en_progreso': return 'üîÑ';
    default: return '‚≠ï';
  }
}

function getColorFondo(estado) {
  switch (estado) {
    case 'completado': return '#e8f5e9';
    case 'en_progreso': return '#fff3e0';
    default: return '#ffffff';
  }
}

function getColorTexto(estado) {
  switch (estado) {
    case 'completado': return '#2e7d32';
    case 'en_progreso': return '#ef6c00';
    default: return '#333333';
  }
}

function getColorBadge(estado) {
  switch (estado) {
    case 'completado': return '#4caf50';
    case 'en_progreso': return '#ff9800';
    default: return '#9e9e9e';
  }
}

function getTextoEstado(estado) {
  switch (estado) {
    case 'completado': return 'OK';
    case 'en_progreso': return 'PROG';
    default: return 'PEND';
  }
}

// Verificar si es bloque especial
function esBloqueBloqueEspecial(nombreBloque) {
  const nombre = nombreBloque.toLowerCase();
  return nombre.includes('geograf√≠a') || nombre.includes('geografia') || nombre.includes('callejero');
}

// Toggle colapsar bloque
function toggleBloque(nombreBloque) {
  const contenido = document.getElementById('bloque-' + nombreBloque);
  const icono = document.getElementById('icono-' + nombreBloque);
  
  if (contenido.style.display === 'none') {
    contenido.style.display = 'block';
    icono.textContent = '‚ñº';
  } else {
    contenido.style.display = 'none';
    icono.textContent = '‚ñ∂';
  }
}

// Toggle selecci√≥n de tema
function toggleSeleccionTema(checkbox, idTema, tiempoMinutos, nombreBloque) {
  if (checkbox.checked) {
    // Validar selecci√≥n
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Validar selecci√≥n de tema
function validarSeleccionTema(tiempoMinutos, nombreBloque) {
  // Verificar tiempo disponible
  if (tiempoUsado + tiempoMinutos > tiempoTotalDisponible) {
    return {
      valido: false,
      mensaje: 'Excede el tiempo disponible (' + Math.round((tiempoUsado + tiempoMinutos - tiempoTotalDisponible)) + ' min de m√°s)'
    };
  }
  
  // Verificar l√≠mite de bloques
  if (!bloquesActivos.includes(nombreBloque)) {
    const esEspecial = esBloqueBloqueEspecial(nombreBloque);
    
    if (!esEspecial && bloquesActivos.filter(b => !esBloqueBloqueEspecial(b)).length >= 3) {
      return {
        valido: false,
        mensaje: 'M√°ximo 3 bloques normales permitidos'
      };
    }
    
    if (bloquesActivos.length >= 4) {
      return {
        valido: false,
        mensaje: 'M√°ximo 4 bloques total (3 normales + 1 especial)'
      };
    }
  }
  
  return { valido: true };
}

// Actualizar resumen de tiempo
function actualizarResumenTiempo() {
  const tiempoRestante = tiempoTotalDisponible - tiempoUsado;
  
  document.getElementById('tiempoTotal').textContent = tiempoTotalDisponible;
  document.getElementById('tiempoSeleccionado').textContent = tiempoUsado;
  document.getElementById('tiempoRestante').textContent = tiempoRestante;
  document.getElementById('bloquesUsados').textContent = bloquesActivos.length + '/3';
  
  // Cambiar colores seg√∫n estado
  const elementoRestante = document.getElementById('tiempoRestante');
  if (tiempoRestante < 0) {
    elementoRestante.style.color = '#dc3545';
  } else if (tiempoRestante < 30) {
    elementoRestante.style.color = '#ffc107';
  } else {
    elementoRestante.style.color = '#28a745';
  }
}

// Crear planificaci√≥n
function crearPlanificacion() {
  alert('üöß Crear planificaci√≥n - En desarrollo...');
}

// Event listener para cambio de horas
document.addEventListener('DOMContentLoaded', function() {
  // Solo a√±adir el listener si el elemento existe
  setTimeout(function() {
    const horasInput = document.getElementById('horasEstudio');
    if (horasInput) {
      horasInput.addEventListener('input', actualizarTiempoDisponible);
    }
  }, 100);
});

// Event listeners para el modal
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    // Listener para cambio de fecha
    const fechaInput = document.getElementById('fechaPlanificacion');
    if (fechaInput) {
      fechaInput.addEventListener('change', verificarRepasosDelDia);
    }
    
    // Listener para cambio de oposici√≥n
    const oposicionSelect = document.getElementById('oposicionPlanificacion');
    if (oposicionSelect) {
      oposicionSelect.addEventListener('change', function() {
        if (pasoActual >= 2) {
          cargarConfiguracionActual();
        }
      });
    }
    
    // Listener para cambio de horas
    const horasInput = document.getElementById('horasEstudio');
    if (horasInput) {
      horasInput.addEventListener('input', actualizarTiempoDisponible);
    }
  }, 100);
});

// Validar orden consecutivo de temas
function validarOrdenConsecutivo(nodoSeleccionado, arbolCompleto) {
  // Buscar el nodo en el √°rbol completo para obtener contexto
  function encontrarNodoEnArbol(arbol, idBuscado) {
    for (let tema of arbol) {
      if (tema.id === idBuscado) return { nodo: tema, padre: null };
      
      if (tema.hijos && tema.hijos.length > 0) {
        const resultado = encontrarNodoEnArbol(tema.hijos, idBuscado);
        if (resultado.nodo) return { nodo: resultado.nodo, padre: tema };
      }
    }
    return { nodo: null, padre: null };
  }
  
  const { nodo, padre } = encontrarNodoEnArbol(arbolCompleto, nodoSeleccionado.id);
  
  if (!padre) return { esConsecutivo: true }; // Tema padre, no hay orden que validar
  
  // Obtener hermanos del mismo padre
  const hermanos = padre.hijos.sort((a, b) => {
    const numA = parseFloat((a.prenombre || '0').replace(/[^\d.]/g, ''));
    const numB = parseFloat((b.prenombre || '0').replace(/[^\d.]/g, ''));
    return numA - numB;
  });
  
  // Encontrar posici√≥n del nodo actual
  const posicionActual = hermanos.findIndex(h => h.id === nodoSeleccionado.id);
  
  // Verificar si hay hermanos anteriores sin completar/seleccionar
  const hermanosPreviosSinCompletar = [];
  for (let i = 0; i < posicionActual; i++) {
    const hermano = hermanos[i];
    const yaSeleccionado = temasSeleccionados.some(t => t.id === hermano.id);
    const completado = hermano.estado === 'completado';
    
    if (!yaSeleccionado && !completado) {
      hermanosPreviosSinCompletar.push(hermano);
    }
  }
  
  if (hermanosPreviosSinCompletar.length > 0) {
    return {
      esConsecutivo: false,
      mensaje: 'Te est√°s saltando el orden. Temas anteriores pendientes: ' + 
               hermanosPreviosSinCompletar.map(h => h.prenombre || h.nombre).join(', '),
      temasSaltados: hermanosPreviosSinCompletar
    };
  }
  
  return { esConsecutivo: true };
}

</script>
