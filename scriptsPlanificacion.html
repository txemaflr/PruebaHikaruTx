
<script>
// scriptsPlanificacion.html - VERSI√ìN LIMPIA
// Variables globales
var mesActual = new Date();
var diaSeleccionado = null;
// Variables del modal
var pasoActual = 1;
var temasSeleccionados = [];
var tiempoTotalDisponible = 240; // minutos
var tiempoUsado = 0;
var bloquesActivos = [];
var configuracionActual = null;
var oposicionActiva = null;

/*
// Inicializar secci√≥n de planificaci√≥n
function inicializarSeccionPlanificacion() {
  console.log('üîß Inicializando planificaci√≥n limpia...');
  renderizarCalendario();
  // Auto-seleccionar d√≠a actual
  const hoy = new Date();
  if (mesActual.getMonth() === hoy.getMonth() && mesActual.getFullYear() === hoy.getFullYear()) {
    seleccionarDia(hoy.getDate());
  }
}
*/

// 1. Inicializar secci√≥n de planificaci√≥n
function inicializarSeccionPlanificacion() {
  console.log('Inicializando secci√≥n Planificaci√≥n...');
  cargarOposicionActiva();
  // Al final de inicializarSeccionPlanificacion(), a√±adir:
  setTimeout(() => {
    if (typeof renderizarCalendario === 'function') {
      renderizarCalendario();
    }
  }, 500);
}

// 2. Cargar oposici√≥n activa
function cargarOposicionActiva() {
  google.script.run
    .withSuccessHandler(function(oposicion) {
      oposicionActiva = oposicion;
      console.log('Oposici√≥n activa cargada:', oposicion);
      mostrarPaginaPrincipal();
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposici√≥n activa:', error);
      mostrarPaginaPrincipal();
    })
    .getOposicionActiva();
}

// 3. Mostrar p√°gina principal (VERSI√ìN CON COMPARACI√ìN)
function mostrarPaginaPrincipal() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  if (!oposicionActiva) {
    // No hay oposici√≥n activa - mostrar selector
    let html = '<div style="text-align: center; padding: 40px;">';
    html += '<h3>Selecciona una oposici√≥n para planificar</h3>';
    html += '<p style="color: #666; margin-bottom: 30px;">Solo puedes tener una oposici√≥n activa a la vez</p>';
    
    html += '<div style="max-width: 400px; margin: 0 auto;">';
    html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Oposici√≥n:</label>';
    html += '<select id="selectorOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
    html += '<option value="">-- Selecciona una oposici√≥n --</option>';
    html += '</select>';
    
    html += '<button onclick="establecerOposicionActiva()" ';
    html += 'style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">';
    html += 'Establecer como activa</button>';
    html += '</div>';
    html += '</div>';
    
    contenedor.innerHTML = html;
    // A√ëADIR ESTAS L√çNEAS:
    setTimeout(() => {
      inicializarCalendarioPlanificacion();
    }, 200);
    cargarOposicionesDisponibles();
    
  } else {
    // Ya hay oposici√≥n activa
    let html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
    html += '<div>';
    html += '<h3 style="margin: 0; color: #007bff;">üìö ' + oposicionActiva.nombre + '</h3>';
    html += '<p style="margin: 5px 0 0 0; color: #666;">Oposici√≥n activa</p>';
    html += '</div>';
    html += '<div>';
    html += '<button onclick="cambiarOposicion()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 3px; margin-right: 10px;">Cambiar</button>';
    html += '<button id="btnCompararOposiciones" onclick="mostrarComparadorOposiciones()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 3px; margin-right: 10px;" disabled>';
    html += 'üîç Comparar</button>';
    html += '</div>';
    html += '</div>';
    
    contenedor.innerHTML = html;
    
    // Verificar si hay m√°s de una oposici√≥n para habilitar comparaci√≥n
    verificarOposicionesDisponibles();
  }
}

// 4. Cargar oposiciones disponibles
function cargarOposicionesDisponibles() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const select = document.getElementById('selectorOposicion');
      
      oposiciones.forEach(function(op) {
        const option = document.createElement('option');
        option.value = op.id;
        option.textContent = op.nombre;
        select.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      alert('Error al cargar oposiciones');
    })
    .getOposicionesOrdenadas();
}

// 5. Establecer oposici√≥n activa
function establecerOposicionActiva() {
  const idOposicion = document.getElementById('selectorOposicion').value;
  
  if (!idOposicion) {
    alert('Selecciona una oposici√≥n');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function() {
      alert('Oposici√≥n establecida correctamente');
      cargarOposicionActiva();
    })
    .withFailureHandler(function(error) {
      console.error('Error al establecer oposici√≥n activa:', error);
      alert('Error al establecer oposici√≥n activa');
    })
    .setOposicionActiva(idOposicion);
}

// 6. Cambiar oposici√≥n activa (VERSI√ìN CON CANCELAR)
function cambiarOposicion() {
  cambiarOposicionConConfirmacion(); // Usar la funci√≥n con confirmaciones
}

// 7. Verificar si hay m√°s oposiciones para habilitar comparaci√≥n
function verificarOposicionesDisponibles() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const btnComparar = document.getElementById('btnCompararOposiciones');
      if (btnComparar && oposiciones.length > 1) {
        btnComparar.disabled = false;
        btnComparar.title = 'Comparar con otras oposiciones';
      }
    })
    .getOposicionesOrdenadas();
}

// 8. Mostrar comparador de oposiciones (VERSI√ìN COMPLETA)
function mostrarComparadorOposiciones() {
  // Crear modal
  let html = '<div id="modalComparacion" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">';
  html += '<div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">';
  
  // Cabecera
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
  html += '<h4 style="margin: 0;">üîç Comparar Oposiciones</h4>';
  html += '<button onclick="cerrarModalComparacion()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>';
  html += '</div>';
  
  // Informaci√≥n actual
  html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">';
  html += '<strong>Oposici√≥n activa:</strong> ' + oposicionActiva.nombre;
  html += '</div>';
  
  // Selector de oposici√≥n para comparar
  html += '<div style="margin-bottom: 20px;">';
  html += '<label style="display: block; margin-bottom: 10px;">Comparar con:</label>';
  html += '<select id="selectorOposicionComparar" onchange="cargarComparacion()" style="width: 100%; padding: 10px;">';
  html += '<option value="">-- Selecciona una oposici√≥n --</option>';
  html += '</select>';
  html += '</div>';
  
  // Contenedor de resultados
  html += '<div id="resultadosComparacion"></div>';
  
  html += '</div>';
  html += '</div>';
  
  document.body.insertAdjacentHTML('beforeend', html);
  
  // Cargar oposiciones disponibles para comparar
  cargarOposicionesParaComparar();
}

// 9. Cargar oposiciones para cambio (excluyendo la actual)
function cargarOposicionesParaCambio() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const select = document.getElementById('selectorNuevaOposicion');
      
      oposiciones.forEach(function(op) {
        // Excluir la oposici√≥n actualmente activa
        if (op.id != oposicionActiva.id) {
          const option = document.createElement('option');
          option.value = op.id;
          option.textContent = op.nombre;
          select.appendChild(option);
        }
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      alert('Error al cargar oposiciones');
    })
    .getOposicionesOrdenadas();
}

// 10. Cancelar cambio de oposici√≥n
function cancelarCambioOposicion() {
  // Volver a mostrar la p√°gina principal con la oposici√≥n actual
  mostrarPaginaPrincipal();
}

// 11. Confirmar cambio de oposici√≥n
function confirmarCambioOposicion() {
  const idNuevaOposicion = document.getElementById('selectorNuevaOposicion').value;
  
  if (!idNuevaOposicion) {
    alert('Selecciona una oposici√≥n');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function() {
      alert('Oposici√≥n cambiada correctamente');
      // Recargar la p√°gina principal con la nueva oposici√≥n
      cargarOposicionActiva();
    })
    .withFailureHandler(function(error) {
      console.error('Error al cambiar oposici√≥n:', error);
      alert('Error al cambiar oposici√≥n');
    })
    .setOposicionActiva(idNuevaOposicion);
}

// 12. Cargar oposiciones para comparar (excluyendo la activa)
function cargarOposicionesParaComparar() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const select = document.getElementById('selectorOposicionComparar');
      
      oposiciones.forEach(function(op) {
        if (op.id != oposicionActiva.id) {
          const option = document.createElement('option');
          option.value = op.id;
          option.textContent = op.nombre;
          select.appendChild(option);
        }
      });
    })
    .getOposicionesOrdenadas();
}

// 13. Cargar comparaci√≥n de temas
function cargarComparacion() {
  const idOposicionComparar = document.getElementById('selectorOposicionComparar').value;
  const contenedor = document.getElementById('resultadosComparacion');
  
  if (!idOposicionComparar) {
    contenedor.innerHTML = '';
    return;
  }
  
  contenedor.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Cargando comparaci√≥n...</p>';
  
  google.script.run
    .withSuccessHandler(function(temas) {
      mostrarResultadosComparacion(temas, idOposicionComparar);
    })
    .withFailureHandler(function(error) {
      console.error('Error al comparar:', error);
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar comparaci√≥n</p>';
    })
    .getTemasComunes(oposicionActiva.id, idOposicionComparar);
}

// 14. Mostrar resultados de la comparaci√≥n (VERSI√ìN √ÅRBOL COLAPSABLE)
function mostrarResultadosComparacion(temas, idOposicionComparar) {
  // Cargar los datos organizados en √°rbol por bloque
  google.script.run
    .withSuccessHandler(function(temasPorBloque) {
      mostrarArbolTemasConCheckboxes(temasPorBloque, idOposicionComparar);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar temas en √°rbol:', error);
      const contenedor = document.getElementById('resultadosComparacion');
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas en √°rbol</p>';
    })
    .getTemassComunesEnArbolPorBloque(oposicionActiva.id, idOposicionComparar);
}

// 16. Mostrar √°rbol de temas con checkboxes (VERSI√ìN NOMBRES CORREGIDOS)
function mostrarArbolTemasConCheckboxes(datosBloquess, idOposicionComparar) {
  const contenedor = document.getElementById('resultadosComparacion');
  
  if (datosBloquess.length === 0) {
    contenedor.innerHTML = '<div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 5px;">' +
                          '<h5 style="color: #856404;">No hay temas comunes</h5>' +
                          '<p style="color: #856404; margin: 0;">Estas oposiciones no comparten ning√∫n tema.</p>' +
                          '</div>';
    return;
  }
  
  // Calcular estad√≠sticas totales recursivamente
  let stats = calcularEstadisticasRecursivas(datosBloquess);
  
  let html = '<div>';
  
  // Estad√≠sticas generales
  html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">';
  html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">';
  
  html += '<div><strong>' + stats.totalTemas + '</strong><br><span style="color: #666; font-size: 12px;">Temas comunes</span></div>';
  html += '<div><strong style="color: #28a745;">' + stats.totalCompletados + '</strong><br><span style="color: #666; font-size: 12px;">Completados</span></div>';
  html += '<div><strong style="color: #dc3545;">' + stats.totalPendientes + '</strong><br><span style="color: #666; font-size: 12px;">Pendientes</span></div>';
  html += '<div><strong style="color: #007bff;">' + stats.totalHoras.toFixed(1) + 'h</strong><br><span style="color: #666; font-size: 12px;">Tiempo total</span></div>';
  
  html += '</div>';
  html += '</div>';
  
  // Contador de seleccionados
  html += '<div id="contadorSeleccionados" style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center;">';
  html += '<strong>Seleccionados: <span id="temasSeleccionadosCount">0</span> temas | ';
  html += 'Tiempo: <span id="tiempoSeleccionadoCount">0.0</span>h</strong>';
  html += '<button id="btnPlanificarSeleccionados" onclick="planificarTemasSeleccionados()" ';
  html += 'style="background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 5px; margin-left: 20px;" disabled>';
  html += 'üìÖ Planificar seleccionados</button>';
  html += '</div>';
  
  // Checkbox para seleccionar todos
  html += '<div style="margin-bottom: 15px;">';
  html += '<label style="cursor: pointer; font-weight: bold;">';
  html += '<input type="checkbox" id="seleccionarTodos" onchange="toggleSeleccionarTodos()" style="margin-right: 8px;"> ';
  html += 'Seleccionar todos los temas pendientes';
  html += '</label>';
  html += '</div>';
  
  // Temas por bloque con √°rbol
  datosBloquess.forEach(bloque => {
    html += '<div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">';
    
    // Cabecera del bloque
    html += '<div style="background: #007bff; color: white; padding: 12px; font-weight: bold;">';
    html += 'üìö ' + bloque.nombreBloque + ' (' + (stats.temasPorBloque[bloque.idBloque] || 0) + ' temas comunes)';
    html += '</div>';
    
    // Temas del bloque en formato √°rbol
    html += '<div style="padding: 10px;">';
    html += renderizarArbolTemas(bloque.temas, 0);
    html += '</div>';
    
    html += '</div>';
  });
  
  html += '</div>';
  
  contenedor.innerHTML = html;
}

// 15. Cerrar modal de comparaci√≥n
function cerrarModalComparacion() {
  const modal = document.getElementById('modalComparacion');
  if (modal) {
    modal.remove();
  }
}

// 17. Actualizar contador de temas seleccionados
function actualizarContador() {
  const checkboxes = document.querySelectorAll('.tema-checkbox:checked');
  let totalTemas = checkboxes.length;
  let totalHoras = 0;
  
  checkboxes.forEach(checkbox => {
    totalHoras += parseFloat(checkbox.getAttribute('data-horas'));
  });
  
  document.getElementById('temasSeleccionadosCount').textContent = totalTemas;
  document.getElementById('tiempoSeleccionadoCount').textContent = totalHoras.toFixed(1);
  
  // Habilitar/deshabilitar bot√≥n de planificar
  const btnPlanificar = document.getElementById('btnPlanificarSeleccionados');
  btnPlanificar.disabled = totalTemas === 0;
}

// 18. Toggle seleccionar todos
function toggleSeleccionarTodos() {
  const seleccionarTodos = document.getElementById('seleccionarTodos').checked;
  const checkboxes = document.querySelectorAll('.tema-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = seleccionarTodos;
  });
  
  actualizarContador();
}

// 19. Planificar temas seleccionados (VERSI√ìN CORREGIDA)
function planificarTemasSeleccionados() {
  const checkboxes = document.querySelectorAll('.tema-checkbox:checked');
  
  if (checkboxes.length === 0) {
    alert('Selecciona al menos un tema');
    return;
  }
  
  // Recopilar informaci√≥n completa de temas seleccionados
  const temasSeleccionados = [];
  let tiempoTotal = 0;
  
  checkboxes.forEach(checkbox => {
    const horas = parseFloat(checkbox.getAttribute('data-horas'));
    temasSeleccionados.push({
      id: parseInt(checkbox.getAttribute('data-tema-id')),
      horas: horas
    });
    tiempoTotal += horas;
  });
  
  // Confirmar antes de proceder
  const mensaje = `¬øCrear planificaci√≥n con ${temasSeleccionados.length} temas seleccionados?\n\nTiempo total estimado: ${tiempoTotal.toFixed(1)} horas`;
  
  if (!confirm(mensaje)) {
    return;
  }
  
  // Guardar datos en variable global para usar en nueva planificaci√≥n
  window.temasParaPlanificar = {
    temas: temasSeleccionados,
    tiempoTotal: tiempoTotal,
    origen: 'comparacion'
  };
  
  // Cerrar modal de comparaci√≥n
  cerrarModalComparacion();
  
  // Mostrar modal de nueva planificaci√≥n
  setTimeout(function() {
    mostrarNuevaPlanificacionConTemas();
  }, 100);
}

// 20. Mostrar nueva planificaci√≥n con temas pre-seleccionados (VERSI√ìN COMPLETA)
function mostrarNuevaPlanificacionConTemas() {
  if (!window.temasParaPlanificar) {
    alert('Error: No hay temas seleccionados');
    return;
  }
  
  // Mostrar modal de nueva planificaci√≥n
  document.getElementById('modalNuevaPlanificacion').style.display = 'flex';
  pasoActualPlanificacion = 1;
  fechaSeleccionada = null;
  repasosDiaSeleccionado = [];
  
  // Marcar que viene de comparaci√≥n
  window.modoCreacionPlanificacion = 'desde_comparacion';
  
  // Mostrar paso 1 espec√≠fico para temas de comparaci√≥n
  mostrarPaso1ConTemasPreseleccionados();
}

// 24. Paso 1 espec√≠fico para temas de comparaci√≥n
function mostrarPaso1ConTemasPreseleccionados() {
  const contenedor = document.getElementById('paso1Planificacion') || document.getElementById('paso1');
  
  let html = '<h4>Paso 1: Planificar temas seleccionados</h4>';
  
  // Resumen de temas seleccionados
  html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">';
  html += '<h5 style="color: #0d47a1; margin: 0 0 10px 0;">üìö Temas de comparaci√≥n seleccionados</h5>';
  html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">';
  html += '<div><strong>' + window.temasParaPlanificar.temas.length + '</strong><br><span style="font-size: 12px;">Temas</span></div>';
  html += '<div><strong>' + window.temasParaPlanificar.tiempoTotal.toFixed(1) + 'h</strong><br><span style="font-size: 12px;">Tiempo estimado</span></div>';
  html += '<div><strong>' + oposicionActiva.nombre + '</strong><br><span style="font-size: 12px;">Oposici√≥n</span></div>';
  html += '</div>';
  html += '</div>';
  
  // Selector de fecha
  html += '<div style="margin-bottom: 20px;">';
  html += '<label style="display: block; margin-bottom: 10px;"><strong>Fecha para planificar:</strong></label>';
  html += '<input type="date" id="fechaPlanificacion" ';
  html += 'min="' + new Date().toISOString().split('T')[0] + '" ';
  html += 'onchange="cargarRepasosDiaConTemas(this.value)" ';
  html += 'style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">';
  html += '</div>';
  
  // Contenedor para repasos del d√≠a
  html += '<div id="repasosDiaContainer" style="margin-bottom: 20px;"></div>';
  
  // Validaciones y advertencias
  html += '<div id="validacionesDia"></div>';
  
  contenedor.innerHTML = html;
  
  // Establecer fecha por defecto (hoy)
  document.getElementById('fechaPlanificacion').value = new Date().toISOString().split('T')[0];
  cargarRepasosDiaConTemas(new Date().toISOString().split('T')[0]);
  
  // Actualizar botones del modal
  const btnAnterior = document.getElementById('btnAnteriorPaso');
  const btnSiguiente = document.getElementById('btnSiguientePaso');

  if (btnAnterior) btnAnterior.style.display = 'none';
  if (btnSiguiente) {
    btnSiguiente.textContent = 'Siguiente: Configurar tiempo';
    btnSiguiente.disabled = false;
  }
}

// 25. Cargar repasos del d√≠a con c√°lculo de tiempo disponible
function cargarRepasosDiaConTemas(fecha) {
  if (!fecha) return;
  
  fechaSeleccionada = new Date(fecha);
  
  const contenedorRepasos = document.getElementById('repasosDiaContainer');
  const contenedorValidaciones = document.getElementById('validacionesDia');
  
  contenedorRepasos.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Verificando d√≠a y repasos...</p>';
  
  // Verificar si el d√≠a es modificable
  google.script.run
    .withSuccessHandler(function(esModificable) {
      if (!esModificable) {
        mostrarDiaNoModificableConTemas(fecha);
        return;
      }
      
      // Cargar repasos del d√≠a
      google.script.run
        .withSuccessHandler(function(repasos) {
          repasosDiaSeleccionado = repasos;
          mostrarRepasosDiaConTemas(repasos);
          validarDisponibilidadDiaConTemas(repasos);
        })
        .withFailureHandler(function(error) {
          console.error('Error al cargar repasos:', error);
          contenedorRepasos.innerHTML = '<p style="color: red;">Error al cargar repasos</p>';
        })
        .getRepasosDelDia(fechaMs); // Usar el nombre correcto
    })
    .withFailureHandler(function(error) {
      console.error('Error al verificar d√≠a:', error);
    })
    .esDiaModificable(fecha);
}




// 21. Calcular estad√≠sticas recursivamente (VERSI√ìN CORREGIDA)
function calcularEstadisticasRecursivas(bloquesDatos) {
  let totalTemas = 0;
  let totalCompletados = 0;
  let totalHoras = 0;
  let contadorPorBloque = {};
  
  function contarTemaRecursivo(tema) {
    if (tema.esComun) {
      totalTemas++;
      if (tema.completado) totalCompletados++;
      totalHoras += tema.horasEstimadas || 0;
      
      const idBloque = tema.id_bloque || 'sin_bloque';
      contadorPorBloque[idBloque] = (contadorPorBloque[idBloque] || 0) + 1;
    }
    
    if (tema.hijos) {
      tema.hijos.forEach(hijo => contarTemaRecursivo(hijo));
    }
  }
  
  bloquesDatos.forEach(bloque => {
    bloque.temas.forEach(tema => contarTemaRecursivo(tema));
  });
  
  return {
    totalTemas: totalTemas,
    totalCompletados: totalCompletados,
    totalPendientes: totalTemas - totalCompletados,
    totalHoras: totalHoras,
    temasPorBloque: contadorPorBloque
  };
}

// 22. Renderizar √°rbol de temas de forma recursiva
function renderizarArbolTemas(temas, nivel) {
  let html = '';
  const margenIzquierdo = nivel * 20;
  
  temas.forEach(tema => {
    // Solo mostrar si es com√∫n (tiene checkbox) o tiene hijos comunes
    const tieneHijosComunes = tema.hijos && tema.hijos.some(hijo => hijo.esComun || (hijo.hijos && hijo.hijos.length > 0));
    
    if (tema.esComun || tieneHijosComunes) {
      const estado = tema.completado ? '‚úÖ' : '‚≠ï';
      const colorFondo = tema.completado ? '#d4edda' : '#f8f9fa';
      
      html += '<div style="margin-left: ' + margenIzquierdo + 'px; margin-bottom: 5px;">';
      html += '<div style="display: flex; align-items: center; padding: 8px; background: ' + colorFondo + '; border-radius: 5px;">';
      
      // Icono de colapsar/expandir si tiene hijos
      if (tema.hijos && tema.hijos.length > 0) {
        html += '<span onclick="toggleArbol(this)" style="cursor: pointer; margin-right: 8px; user-select: none; width: 16px; text-align: center;">‚ñº</span>';
      } else {
        html += '<span style="margin-right: 8px; width: 16px;"></span>';
      }
      
      // Checkbox solo para temas comunes y pendientes
      if (tema.esComun && !tema.completado) {
        html += '<input type="checkbox" class="tema-checkbox" ';
        html += 'data-tema-id="' + tema.id + '" ';
        html += 'data-horas="' + (tema.horasEstimadas || 0) + '" ';
        html += 'onchange="actualizarContador()" ';
        html += 'style="margin-right: 10px;">';
      } else if (tema.esComun && tema.completado) {
        html += '<span style="margin-right: 10px; width: 16px; text-align: center;">‚úÖ</span>';
      } else {
        html += '<span style="margin-right: 10px; width: 16px;"></span>';
      }
      
      // Informaci√≥n del tema
      html += '<div style="flex: 1;">';
      html += '<strong>' + tema.nombreCompleto + '</strong>';
      
      if (tema.esComun) {
        html += '<br><small style="color: #666;">';
        html += (tema.paginas || 0) + ' p√°ginas | ' + (tema.horasEstimadas || 0).toFixed(1) + 'h estimadas';
        if (tema.completado) {
          html += ' | <span style="color: #28a745;">Completado</span>';
        }
        html += '</small>';
      }
      html += '</div>';
      
      html += '</div>';
      
      // Renderizar hijos (inicialmente visibles)
      if (tema.hijos && tema.hijos.length > 0) {
        html += '<div class="hijos-tema">';
        html += renderizarArbolTemas(tema.hijos, nivel + 1);
        html += '</div>';
      }
      
      html += '</div>';
    }
  });
  
  return html;
}

// 23. Toggle √°rbol (colapsar/expandir)
function toggleArbol(elemento) {
  const contenedorHijos = elemento.parentElement.parentElement.querySelector('.hijos-tema');
  if (contenedorHijos) {
    if (contenedorHijos.style.display === 'none') {
      contenedorHijos.style.display = 'block';
      elemento.textContent = '‚ñº';
    } else {
      contenedorHijos.style.display = 'none';
      elemento.textContent = '‚ñ∂';
    }
  }
}

// 26. Mostrar d√≠a no modificable para temas de comparaci√≥n
function mostrarDiaNoModificableConTemas(fecha) {
  const contenedorRepasos = document.getElementById('repasosDiaContainer');
  const contenedorValidaciones = document.getElementById('validacionesDia');
  
  contenedorRepasos.innerHTML = '';
  
  let html = '<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 15px;">';
  html += '<h5 style="color: #856404; margin: 0 0 10px 0;"><i class="fas fa-exclamation-triangle"></i> D√≠a no modificable</h5>';
  html += '<p style="margin: 0; color: #856404;">Los d√≠as anteriores no se pueden modificar. Selecciona hoy o una fecha futura.</p>';
  html += '</div>';
  
  contenedorValidaciones.innerHTML = html;
  document.getElementById('btnSiguientePaso').disabled = true;
}

// 27. Mostrar repasos del d√≠a para temas de comparaci√≥n
function mostrarRepasosDiaConTemas(repasos) {
  const contenedor = document.getElementById('repasosDiaContainer');
  
  if (repasos.length === 0) {
    contenedor.innerHTML = '<div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px;">' +
                          '<h5 style="color: #155724; margin: 0 0 5px 0;"><i class="fas fa-check-circle"></i> Sin repasos programados</h5>' +
                          '<p style="margin: 0; color: #155724;">Perfecto, todo el tiempo estar√° disponible para los temas seleccionados.</p>' +
                          '</div>';
    return;
  }
  
  let tiempoTotalRepasos = repasos.reduce((total, repaso) => total + repaso.tiempoEstimado, 0);
  
  let html = '<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px;">';
  html += '<h5 style="color: #856404; margin: 0 0 10px 0;"><i class="fas fa-redo"></i> Repasos programados (' + repasos.length + ')</h5>';
  html += '<p style="color: #856404; margin: 0 0 10px 0;">Estos repasos reducir√°n el tiempo disponible para estudiar.</p>';
  
  repasos.forEach(function(repaso) {
    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #ffeaa7;">';
    html += '<div><strong>R' + repaso.numeroRepaso + ':</strong> ' + repaso.nombreTema + '</div>';
    html += '<div style="color: #856404; font-size: 12px;">' + repaso.tiempoEstimado + ' min</div>';
    html += '</div>';
  });
  
  html += '<div style="text-align: right; margin-top: 10px; font-weight: bold; color: #856404;">';
  html += 'Tiempo total repasos: ' + Math.round(tiempoTotalRepasos / 60 * 10) / 10 + ' horas';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
}

// 28. Validar disponibilidad con c√°lculo de tiempo
function validarDisponibilidadDiaConTemas(repasos) {
  const contenedor = document.getElementById('validacionesDia');
  
  const tiempoRepasos = repasos.reduce((total, repaso) => total + repaso.tiempoEstimado, 0) / 60; // en horas
  const tiempoTemas = window.temasParaPlanificar.tiempoTotal;
  const tiempoMinimoNecesario = tiempoRepasos + tiempoTemas;
  
  let html = '<div style="background: #e3f2fd; border: 1px solid #bbdefb; padding: 15px; border-radius: 5px;">';
  html += '<h5 style="color: #0d47a1; margin: 0 0 10px 0;">‚è±Ô∏è C√°lculo de tiempo</h5>';
  html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-bottom: 10px;">';
  
  html += '<div style="padding: 8px; background: #fff3e0; border-radius: 3px;">';
  html += '<div style="font-weight: bold;">' + tiempoRepasos.toFixed(1) + 'h</div>';
  html += '<div style="font-size: 12px;">Repasos</div>';
  html += '</div>';
  
  html += '<div style="padding: 8px; background: #e8f5e8; border-radius: 3px;">';
  html += '<div style="font-weight: bold;">' + tiempoTemas.toFixed(1) + 'h</div>';
  html += '<div style="font-size: 12px;">Temas nuevos</div>';
  html += '</div>';
  
  html += '<div style="padding: 8px; background: #f3e5f5; border-radius: 3px;">';
  html += '<div style="font-weight: bold;">' + tiempoMinimoNecesario.toFixed(1) + 'h</div>';
  html += '<div style="font-size: 12px;">Total necesario</div>';
  html += '</div>';
  
  html += '</div>';
  html += '<p style="margin: 0; color: #0d47a1; text-align: center;"><strong>En el siguiente paso podr√°s ajustar las horas de estudio disponibles.</strong></p>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  document.getElementById('btnSiguientePaso').disabled = false;
}

// 29. Funci√≥n para mostrar paso 1 normal (no desde comparaci√≥n)
function mostrarPaso1Normal() {
  const contenedor = document.getElementById('paso1');
  
  if (!oposicionActiva) {
    contenedor.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">' +
                          '<h5>‚ö†Ô∏è Error: No hay oposici√≥n activa</h5>' +
                          '<p>Debes tener una oposici√≥n activa para crear planificaciones.</p>' +
                          '</div>';
    document.getElementById('btnSiguiente').disabled = true;
    return;
  }
  
  let html = '<h4>Paso 1: Configurar d√≠a de planificaci√≥n</h4>';
  
  // Informaci√≥n de oposici√≥n activa (no editable)
  html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">';
  html += '<h5 style="color: #0d47a1; margin: 0 0 5px 0;">üìö Oposici√≥n activa</h5>';
  html += '<p style="margin: 0; font-weight: bold; color: #0d47a1;">' + oposicionActiva.nombre + '</p>';
  html += '</div>';
  
  // Selector de fecha
  html += '<div style="margin-bottom: 20px;">';
  html += '<label style="display: block; margin-bottom: 10px; font-weight: bold;">Fecha para planificar:</label>';
  html += '<input type="date" id="fechaPlanificacion" ';
  html += 'min="' + new Date().toISOString().split('T')[0] + '" ';
  html += 'onchange="verificarRepasosDelDia()" ';
  html += 'style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">';
  html += '</div>';
  
  // Contenedor para repasos del d√≠a
  html += '<div id="alertaRepasos" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin-bottom: 20px;">';
  html += '<h6 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Repasos programados para este d√≠a:</h6>';
  html += '<div id="listaRepasos"></div>';
  html += '<p style="margin: 10px 0 0 0; font-size: 14px; color: #856404;">';
  html += '<strong>Nota:</strong> Estos repasos reducir√°n el tiempo disponible para temas nuevos.';
  html += '</p>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  
  // Establecer fecha por defecto (d√≠a seleccionado del calendario o hoy)
  const fechaDefecto = diaSeleccionado ? 
    new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado) : 
    new Date();
  
  document.getElementById('fechaPlanificacion').value = fechaDefecto.toISOString().split('T')[0];
  verificarRepasosDelDia();
}

// 30. Funci√≥n principal que decide qu√© mostrar en paso 1
function mostrarPaso1() {
  if (window.modoCreacionPlanificacion === 'desde_comparacion' && window.temasParaPlanificar) {
    mostrarPaso1ConTemasPreseleccionados();
  } else {
    mostrarPaso1Normal();
  }
}

// 31. Funci√≥n actualizada para calcular tiempo correctamente
function actualizarCalculoTiempo() {
  const horasPrevistas = parseFloat(document.getElementById('horasEstudio').value) || 0;
  const minutosPrevistas = horasPrevistas * 60;
  
  // Calcular tiempo de repasos
  const tiempoRepasos = window.repasosDelDia ? window.repasosDelDia.length * 30 : 0;
  
  // C√ÅLCULO CORRECTO: Tiempo real = Previstas - Repasos
  const tiempoRealEstudio = Math.max(0, minutosPrevistas - tiempoRepasos);
  
  // Actualizar variables globales
  tiempoTotalDisponible = tiempoRealEstudio; // Solo el tiempo real para temas nuevos
  window.tiempoTotalParaPlanificacion = minutosPrevistas; // Tiempo total previsto
  window.tiempoRepasosDelDia = tiempoRepasos; // Tiempo de repasos
  window.tiempoRealParaTemas = tiempoRealEstudio; // Tiempo real para temas
  
  // Actualizar interfaz
  document.getElementById('tiempoEstudio').textContent = tiempoRealEstudio + ' min';
  document.getElementById('tiempoRepasos').textContent = tiempoRepasos + ' min';
  document.getElementById('tiempoTotalConRepasos').textContent = minutosPrevistas + ' min';
  
  // Mostrar advertencia si no hay tiempo suficiente
  mostrarAdvertenciaTiempo(tiempoRealEstudio, tiempoRepasos, minutosPrevistas);
  
  console.log('‚è±Ô∏è C√°lculo actualizado:');
  console.log('   Horas previstas:', horasPrevistas, 'h =', minutosPrevistas, 'min');
  console.log('   Tiempo repasos:', tiempoRepasos, 'min');
  console.log('   Tiempo real para temas:', tiempoRealEstudio, 'min');
}

// 32. Mostrar advertencia si el tiempo es insuficiente
function mostrarAdvertenciaTiempo(tiempoReal, tiempoRepasos, tiempoTotal) {
  let advertenciaDiv = document.getElementById('advertenciaTiempo');
  
  // Crear div de advertencia si no existe
  if (!advertenciaDiv) {
    advertenciaDiv = document.createElement('div');
    advertenciaDiv.id = 'advertenciaTiempo';
    advertenciaDiv.style.marginTop = '15px';
    document.getElementById('infoConfiguracion').parentElement.appendChild(advertenciaDiv);
  }
  
  if (tiempoReal <= 30) { // Menos de 30 minutos para estudiar
    let html = '<div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px;">';
    html += '<h6 style="color: #721c24; margin: 0 0 10px 0;">‚ö†Ô∏è Advertencia de tiempo</h6>';
    
    if (tiempoReal <= 0) {
      html += '<p style="margin: 0; color: #721c24;">Los repasos ocupan todo el tiempo disponible o m√°s. ';
      html += 'Considera aumentar las horas previstas o posponer algunos repasos.</p>';
    } else {
      html += '<p style="margin: 0; color: #721c24;">Solo quedan ' + tiempoReal + ' minutos para temas nuevos despu√©s de los repasos. ';
      html += 'Podr√°s seleccionar muy pocos temas.</p>';
    }
    html += '</div>';
    
    advertenciaDiv.innerHTML = html;
  } else {
    advertenciaDiv.innerHTML = ''; // Limpiar advertencia
  }
}

// 33. Validaci√≥n del paso 2 (actualizada)
function validarPaso2() {
  const horas = parseFloat(document.getElementById('horasEstudio').value);
  
  if (!horas || horas < 0.5) {
    alert('‚ö†Ô∏è Introduce un tiempo de estudio v√°lido (m√≠nimo 0.5 horas)');
    return false;
  }
  
  const tiempoReal = window.tiempoRealParaTemas || 0;
  
  if (tiempoReal <= 0) {
    const confirmar = confirm('‚ö†Ô∏è Los repasos ocupan todo el tiempo disponible.\n\n' +
                            '¬øQuieres continuar? Solo podr√°s gestionar los repasos, no a√±adir temas nuevos.');
    return confirmar;
  }
  
  if (tiempoReal < 60) { // Menos de 1 hora
    const confirmar = confirm('‚ö†Ô∏è Solo tienes ' + tiempoReal + ' minutos para temas nuevos.\n\n' +
                            '¬øQuieres continuar con tan poco tiempo?');
    return confirmar;
  }
  
  return true;
}

// 34. Pre-cargar temas seleccionados de la comparaci√≥n
function precargarTemasDeComparacion() {
  // Limpiar selecci√≥n anterior
  temasSeleccionados = [];
  bloquesActivos = [];
  tiempoUsado = 0;
  
  console.log('üîÑ Pre-cargando temas de comparaci√≥n:', window.temasParaPlanificar.temas);
  
  // Convertir temas de comparaci√≥n al formato esperado
  window.temasParaPlanificar.temas.forEach(tema => {
    const tiempoMinutos = Math.round(tema.horas * 60); // Convertir horas a minutos
    
    temasSeleccionados.push({
      id: tema.id,
      tiempo: tiempoMinutos,
      bloque: 'pre-seleccionado', // Se actualizar√° al cargar el √°rbol
      tipo: 'comparacion'
    });
    
    tiempoUsado += tiempoMinutos;
  });
  
  console.log('‚úÖ Temas pre-cargados:', temasSeleccionados.length);
  console.log('‚è±Ô∏è Tiempo pre-usado:', tiempoUsado, 'min');
}

// 35. Cargar √°rbol de temas corregido (SIN ERROR)
function cargarArbolTemasCorregido() {
  const idOposicion = oposicionActiva ? oposicionActiva.id : null;
  const contenedor = document.getElementById('arbolTemas');
  
  if (!idOposicion) {
    contenedor.innerHTML = '<p style="color: red; text-align: center;">Error: No hay oposici√≥n activa</p>';
    return;
  }
  
  // VARIABLE CORREGIDA: usar tiempoTotalDisponible en lugar de tiempoEstudioDisponible
  const tiempoDisponibleReal = tiempoTotalDisponible;
  
  console.log('üå≥ Cargando √°rbol para oposici√≥n:', idOposicion);
  console.log('‚è±Ô∏è Tiempo disponible real:', tiempoDisponibleReal, 'min');
  
  // Mostrar loading
  contenedor.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando √°rbol de temas...</p>';
  
  google.script.run
    .withSuccessHandler(function(data) {
      console.log('‚úÖ √Årbol de temas recibido:', data);
      
      // Guardar √°rbol global para validaciones
      window.arbolCompletoGlobal = data.arbol;
      
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay temas principales vinculados a esta oposici√≥n</p>';
        return;
      }
      
      // Renderizar √°rbol con temas pre-seleccionados
      renderizarArbolConTemasPreseleccionados(data.arbol, data.minutosPorPagina, data.bloques);
      
      // Actualizar informaci√≥n de bloques para temas pre-seleccionados
      actualizarBloquesTemasPreseleccionados(data.arbol);
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar √°rbol:', error);
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas: ' + error.message + '</p>';
    })
    .getArbolTemasConEstados(idOposicion, tiempoDisponibleReal); // VARIABLE CORREGIDA
}

// 36. Renderizar nodo con verificaci√≥n de pre-selecci√≥n
function renderizarNodoTemaConPreseleccion(nodo, nivel, nombreBloque) {
  const margenIzquierdo = nivel * 20;
  const iconoEstado = getIconoEstado(nodo.estado);
  const colorFondo = getColorFondo(nodo.estado);
  
  // Verificar si est√° pre-seleccionado
  const estaPreseleccionado = temasSeleccionados.some(t => t.id === nodo.id);
  
  let html = '';
  
  // Contenedor del nodo
  html += '<div style="margin-left: ' + margenIzquierdo + 'px; margin-bottom: 8px;">';
  
  // Fila del tema
  html += '<div style="display: flex; align-items: center; padding: 10px; background: ' + colorFondo + '; border: 1px solid #e0e0e0; border-radius: 6px;">';
  
  // Checkbox (para hojas seleccionables O padres seleccionables)
  if (nodo.seleccionable || nodo.seleccionablePadre) {
    const tipoSeleccion = nodo.seleccionablePadre ? 'padre' : 'hijo';
    
    html += '<input type="checkbox" ';
    html += 'onchange="toggleSeleccionTemaConValidacion(this, ' + nodo.id + ', ' + nodo.tiempoMinutos + ', \'' + nombreBloque + '\', \'' + tipoSeleccion + '\')" ';
    html += (estaPreseleccionado ? 'checked ' : ''); // MARCAR SI EST√Å PRE-SELECCIONADO
    html += 'style="margin-right: 10px; transform: scale(1.2);" ';
    html += 'title="' + (nodo.seleccionablePadre ? 'Seleccionar tema completo (' + nodo.tiempoTexto + ')' : 'Seleccionar subtema') + '">';
    
    // A√±adir badge si est√° pre-seleccionado
    if (estaPreseleccionado) {
      html += '<span style="margin-left: 5px; background: #007bff; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">PRE-SEL</span>';
    }
  } else {
    html += '<span style="width: 24px; margin-right: 10px; text-align: center; font-size: 16px;">' + iconoEstado + '</span>';
  }
  
  // Contenido del tema
  html += '<div style="flex: 1;">';
  html += '<div style="font-weight: ' + (nivel === 0 ? 'bold' : 'normal') + '; color: ' + getColorTexto(nodo.estado) + ';">';
  html += nodo.nombreCompleto;
  html += '</div>';
  
  if (nodo.paginas > 0) {
    html += '<small style="color: #666; font-size: 11px;">';
    html += nodo.paginas + ' p√°gs ‚Ä¢ ' + nodo.tiempoTexto;
    html += '</small>';
  }
  html += '</div>';
  
  // Badge de estado
  html += '<div style="margin-left: 10px;">';
  html += '<span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ' + getColorBadge(nodo.estado) + '; color: white; font-weight: bold;">';
  html += getTextoEstado(nodo.estado);
  html += '</span>';
  html += '</div>';
  
  html += '</div>';
  
  // Renderizar hijos si existen
  if (nodo.hijos && nodo.hijos.length > 0) {
    nodo.hijos.forEach(hijo => {
      html += renderizarNodoTemaConPreseleccion(hijo, nivel + 1, nombreBloque);
    });
  }
  
  html += '</div>';
  
  return html;
}

// 37. Actualizar informaci√≥n de bloques para temas pre-seleccionados
function actualizarBloquesTemasPreseleccionados(arbolTemas) {
  // Funci√≥n recursiva para buscar tema en √°rbol
  function buscarTemaEnArbol(arbol, idBuscado) {
    for (let tema of arbol) {
      if (tema.id === idBuscado) {
        return tema;
      }
      if (tema.hijos && tema.hijos.length > 0) {
        const encontrado = buscarTemaEnArbol(tema.hijos, idBuscado);
        if (encontrado) return encontrado;
      }
    }
    return null;
  }
  
  // Actualizar informaci√≥n de bloque para cada tema pre-seleccionado
  temasSeleccionados.forEach((tema, index) => {
    if (tema.tipo === 'comparacion') {
      const nodoCompleto = buscarTemaEnArbol(arbolTemas, tema.id);
      if (nodoCompleto) {
        // Obtener nombre del bloque del nodo
        const nombreBloque = obtenerNombreBloqueDeNodo(nodoCompleto, arbolTemas);
        temasSeleccionados[index].bloque = nombreBloque;
        
        // A√±adir bloque a activos si no est√°
        if (!bloquesActivos.includes(nombreBloque)) {
          bloquesActivos.push(nombreBloque);
        }
      }
    }
  });
  
  console.log('üîÑ Bloques activos actualizados:', bloquesActivos);
  console.log('üîÑ Temas con bloques actualizados:', temasSeleccionados);
}

// 38. Funci√≥n mejorada para cambiar oposici√≥n con confirmaciones
function cambiarOposicionConConfirmacion() {
  // Verificar si la oposici√≥n actual tiene progreso
  google.script.run
    .withSuccessHandler(function(progreso) {
      if (progreso.tieneProgreso) {
        mostrarDialogoConfirmacionCambio(progreso);
      } else {
        // No tiene progreso, cambiar directamente
        mostrarSelectorNuevaOposicion();
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al verificar progreso:', error);
      // En caso de error, continuar con el cambio
      mostrarSelectorNuevaOposicion();
    })
    .verificarProgresoOposicion(oposicionActiva.id);
}

// 39. Mostrar di√°logo de confirmaci√≥n cuando hay progreso
function mostrarDialogoConfirmacionCambio(progreso) {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  let html = '<div style="text-align: center; padding: 40px;">';
  html += '<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 30px; border-radius: 10px; max-width: 600px; margin: 0 auto;">';
  
  html += '<h3 style="color: #856404; margin: 0 0 20px 0;">‚ö†Ô∏è Cambiar oposici√≥n con progreso</h3>';
  
  html += '<p style="color: #856404; margin-bottom: 20px;">La oposici√≥n actual <strong>' + oposicionActiva.nombre + '</strong> tiene progreso:</p>';
  
  // Mostrar estad√≠sticas de progreso
  html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">';
  html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">';
  
  html += '<div>';
  html += '<div style="font-size: 24px; font-weight: bold; color: #28a745;">' + progreso.temasCompletados + '</div>';
  html += '<div style="font-size: 12px; color: #666;">Temas completados</div>';
  html += '</div>';
  
  html += '<div>';
  html += '<div style="font-size: 24px; font-weight: bold; color: #007bff;">' + progreso.horasEstudiadas + 'h</div>';
  html += '<div style="font-size: 12px; color: #666;">Horas estudiadas</div>';
  html += '</div>';
  
  html += '<div>';
  html += '<div style="font-size: 24px; font-weight: bold; color: #ffc107;">' + progreso.repasosPendientes + '</div>';
  html += '<div style="font-size: 12px; color: #666;">Repasos pendientes</div>';
  html += '</div>';
  
  html += '</div>';
  html += '</div>';
  
  html += '<p style="color: #856404; margin-bottom: 30px;">¬øQu√© quieres hacer con esta oposici√≥n?</p>';
  
  // Opciones
  html += '<div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto;">';
  
  html += '<button onclick="marcarOposicionComoInterrumpida()" ';
  html += 'style="background: #ffc107; color: #212529; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">';
  html += '‚è∏Ô∏è Marcar como INTERRUMPIDA y cambiar';
  html += '<br><small style="font-weight: normal;">Podr√°s retomarla m√°s tarde</small>';
  html += '</button>';
  
  html += '<button onclick="marcarOposicionComoFinalizada()" ';
  html += 'style="background: #28a745; color: white; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">';
  html += '‚úÖ Marcar como FINALIZADA y cambiar';
  html += '<br><small style="font-weight: normal;">La has terminado o abandonado definitivamente</small>';
  html += '</button>';
  
  html += '<button onclick="cancelarCambioOposicion()" ';
  html += 'style="background: #6c757d; color: white; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">';
  html += '‚ùå Cancelar cambio';
  html += '<br><small style="font-weight: normal;">Seguir con la oposici√≥n actual</small>';
  html += '</button>';
  
  html += '</div>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
}

// 40. Marcar oposici√≥n como interrumpida
function marcarOposicionComoInterrumpida() {
  const confirmar = confirm('¬øEst√°s seguro de marcar "' + oposicionActiva.nombre + '" como INTERRUMPIDA?\n\n' +
                           'Esto significa que la pausas temporalmente pero podr√°s retomarla m√°s tarde.');
  
  if (!confirmar) return;
  
  google.script.run
    .withSuccessHandler(function() {
      alert('Oposici√≥n marcada como interrumpida correctamente');
      mostrarSelectorNuevaOposicion();
    })
    .withFailureHandler(function(error) {
      console.error('Error al marcar como interrumpida:', error);
      alert('Error al marcar oposici√≥n como interrumpida');
    })
    .cambiarEstadoOposicion(oposicionActiva.id, 'interrumpida');
}

// 41. Marcar oposici√≥n como finalizada
function marcarOposicionComoFinalizada() {
  const confirmar = confirm('¬øEst√°s seguro de marcar "' + oposicionActiva.nombre + '" como FINALIZADA?\n\n' +
                           'Esto significa que la has terminado o abandonado definitivamente.');
  
  if (!confirmar) return;
  
  google.script.run
    .withSuccessHandler(function() {
      alert('Oposici√≥n marcada como finalizada correctamente');
      mostrarSelectorNuevaOposicion();
    })
    .withFailureHandler(function(error) {
      console.error('Error al marcar como finalizada:', error);
      alert('Error al marcar oposici√≥n como finalizada');
    })
    .cambiarEstadoOposicion(oposicionActiva.id, 'finalizada');
}

// 42. Mostrar selector de nueva oposici√≥n (despu√©s de confirmar cambio)
function mostrarSelectorNuevaOposicion() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  let html = '<div style="text-align: center; padding: 40px;">';
  html += '<h3>Seleccionar nueva oposici√≥n activa</h3>';
  
  if (oposicionActiva) {
    html += '<p style="color: #666; margin-bottom: 30px;">Anterior: <strong>' + oposicionActiva.nombre + '</strong></p>';
  }
  
  html += '<div style="max-width: 400px; margin: 0 auto;">';
  html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Nueva oposici√≥n:</label>';
  html += '<select id="selectorNuevaOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
  html += '<option value="">-- Selecciona una oposici√≥n --</option>';
  html += '</select>';
  
  html += '<div style="display: flex; gap: 10px; justify-content: center;">';
  html += '<button onclick="cancelarCambioOposicion()" ';
  html += 'style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Cancelar</button>';
  
  html += '<button onclick="confirmarCambioOposicion()" ';
  html += 'style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Establecer como activa</button>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  
  // Cargar oposiciones disponibles
  cargarOposicionesParaCambio();
}

// 43. Cargar oposiciones disponibles (excluyendo finalizadas y la actual)
function cargarOposicionesParaCambio() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const select = document.getElementById('selectorNuevaOposicion');
      
      oposiciones.forEach(function(op) {
        // Excluir la actual y las finalizadas
        if (op.estado !== 'finalizada' && (!oposicionActiva || op.id != oposicionActiva.id)) {
          const option = document.createElement('option');
          option.value = op.id;
          option.textContent = op.nombre + (op.estado === 'interrumpida' ? ' (Interrumpida)' : '');
          select.appendChild(option);
        }
      });
      
      if (select.options.length === 1) { // Solo la opci√≥n por defecto
        select.innerHTML = '<option value="">-- No hay otras oposiciones disponibles --</option>';
        document.querySelector('button[onclick="confirmarCambioOposicion()"]').disabled = true;
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      alert('Error al cargar oposiciones');
    })
    .getOposicionesOrdenadas();
}

// 44. Confirmar cambio de oposici√≥n (actualizado)
function confirmarCambioOposicion() {
  const idNuevaOposicion = document.getElementById('selectorNuevaOposicion').value;
  
  if (!idNuevaOposicion) {
    alert('Selecciona una oposici√≥n');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function() {
      alert('Oposici√≥n cambiada correctamente');
      // Recargar la p√°gina principal con la nueva oposici√≥n
      cargarOposicionActiva();
    })
    .withFailureHandler(function(error) {
      console.error('Error al cambiar oposici√≥n:', error);
      alert('Error al cambiar oposici√≥n');
    })
    .setOposicionActiva(idNuevaOposicion);
}

// 45. Configurar event listeners para horas
function setupEventListenerHoras() {
  const horasInput = document.getElementById('horasEstudio');
  if (horasInput) {
    horasInput.removeEventListener('input', actualizarCalculoTiempo);
    horasInput.addEventListener('input', actualizarCalculoTiempo);
  }
}

// 46. Funci√≥n para mostrar paso 2
function mostrarPaso2() {
  cargarConfiguracionActual();
  mostrarRepasosEnPasoDos();
  actualizarCalculoTiempo();
}

// 47. Renderizar √°rbol con temas pre-seleccionados marcados
function renderizarArbolConTemasPreseleccionados(arbolTemas, minutosPorPagina, bloquesInfo) {
  const contenedor = document.getElementById('arbolTemas');
  
  // Agrupar temas por bloque
  const temasPorBloque = agruparTemasPorBloque(arbolTemas, bloquesInfo);
  
  let html = '';
  
  // Renderizar cada bloque
  Object.keys(temasPorBloque).forEach(nombreBloque => {
    const temasDelBloque = temasPorBloque[nombreBloque];
    const esEspecial = esBloqueBloqueEspecial(nombreBloque);
    
    html += '<div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">';
    
    // Header del bloque
    html += '<div onclick="toggleBloque(\'' + nombreBloque + '\')" style="padding: 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">';
    html += '<div>';
    html += '<h6 style="margin: 0; font-weight: bold;">' + nombreBloque;
    if (esEspecial) {
      html += ' <span style="background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ESPECIAL</span>';
    }
    html += '</h6>';
    html += '<small style="color: #666;">' + temasDelBloque.length + ' temas principales</small>';
    html += '</div>';
    html += '<i id="icono-' + nombreBloque + '" style="transition: transform 0.3s;">‚ñº</i>';
    html += '</div>';
    
    // Contenido del bloque
    html += '<div id="bloque-' + nombreBloque + '" style="padding: 15px;">';
    
    // Renderizar cada tema del bloque
    temasDelBloque.forEach(tema => {
      html += renderizarNodoTemaConPreseleccion(tema, 0, nombreBloque);
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  contenedor.innerHTML = html;
  
  // Actualizar resumen despu√©s del renderizado
  setTimeout(() => {
    actualizarResumenTiempo();
  }, 100);
}

// 48. Forzar renderizado inicial del calendario
function inicializarCalendarioPlanificacion() {
  if (document.getElementById('calendario')) {
    renderizarCalendario();
    // Auto-seleccionar d√≠a actual si estamos en el mes actual
    const hoy = new Date();
    if (mesActual.getMonth() === hoy.getMonth() && mesActual.getFullYear() === hoy.getFullYear()) {
      setTimeout(() => {
        seleccionarDia(hoy.getDate());
      }, 100);
    }
  }
}



// Renderizar calendario
function renderizarCalendario() {
  const a√±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();
  
  // Actualizar t√≠tulo
  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  document.getElementById('tituloMes').textContent = meses[mes] + ' ' + a√±o;
  
  // Calcular primer d√≠a (lunes = 0)
  let primerDia = new Date(a√±o, mes, 1).getDay();
  primerDia = primerDia === 0 ? 6 : primerDia - 1; // Ajustar para lunes = 0
  
  const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
  const hoy = new Date();
  
  // Generar HTML del calendario
  let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
  
  // Encabezados de d√≠as
  const diasSemana = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
  diasSemana.forEach(dia => {
    html += '<div style="text-align: center; font-weight: bold; padding: 8px; color: #666; font-size: 12px;">' + dia + '</div>';
  });
  
  // D√≠as vac√≠os al inicio
  for (let i = 0; i < primerDia; i++) {
    html += '<div></div>';
  }
  
  //D√≠as del mes
  for (let dia = 1; dia <= diasEnMes; dia++) {
    const fecha = new Date(a√±o, mes, dia);
    const esHoy = fecha.toDateString() === hoy.toDateString();
    const esSeleccionado = diaSeleccionado === dia;
    
    // Estilos del d√≠a
    let estilos = 'min-height: 80px; border: 1px solid #ddd; border-radius: 5px; padding: 5px; cursor: pointer; ';
    estilos += 'display: flex; flex-direction: column; justify-content: space-between; ';
    
    if (esHoy) {
      estilos += 'border: 2px solid #2196f3; background: #e3f2fd; ';
    } else if (esSeleccionado) {
      estilos += 'background: #f0f0f0; ';
    } else {
      estilos += 'background: white; ';
    }
    
    html += '<div onclick="seleccionarDia(' + dia + ')" style="' + estilos + '">';
    
    // N√∫mero del d√≠a
    html += '<div style="font-weight: bold; color: ' + (esHoy ? '#2196f3' : '#333') + ';">' + dia + '</div>';
    
    // Contenido del d√≠a (placeholder por ahora)
    html += '<div id="contenido-' + a√±o + '-' + mes + '-' + dia + '" style="font-size: 10px; flex: 1;"></div>';
    
    html += '</div>';
  }
  
  html += '</div>';
  
  document.getElementById('calendario').innerHTML = html;
}


// Cambiar mes
function cambiarMes(direccion) {
  mesActual.setMonth(mesActual.getMonth() + direccion);
  diaSeleccionado = null; // Reset selecci√≥n
  renderizarCalendario();
  limpiarDetalleDia();
}

// Ir a hoy
function irAHoy() {
  mesActual = new Date();
  renderizarCalendario();
  seleccionarDia(new Date().getDate());
}

// Seleccionar d√≠a
function seleccionarDia(dia) {
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  const esDiaPasado = fechaSeleccionada < hoy;
  
  diaSeleccionado = dia;
  renderizarCalendario(); // Re-renderizar para mostrar selecci√≥n
  
  // Actualizar detalle del d√≠a
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const tituloFecha = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
  
  if (esDiaPasado) {
    document.getElementById('tituloDetalleDia').textContent = tituloFecha + ' (Solo lectura)';
    document.getElementById('contenidoDetalleDia').innerHTML = 
      '<div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">' +
      '<strong>‚ÑπÔ∏è D√≠a pasado:</strong> Solo puedes consultar la informaci√≥n, no modificar.' +
      '</div>' +
      '<p style="color: #999;">Detalle del d√≠a en desarrollo...</p>';
  } else {
    document.getElementById('tituloDetalleDia').textContent = tituloFecha;
    document.getElementById('contenidoDetalleDia').innerHTML = 
      '<p style="color: #999;">D√≠a seleccionado: ' + dia + '. Detalle en desarrollo...</p>';
  }
}

// Limpiar detalle del d√≠a
function limpiarDetalleDia() {
  document.getElementById('tituloDetalleDia').textContent = 'Selecciona un d√≠a';
  document.getElementById('contenidoDetalleDia').innerHTML = '<p style="text-align: center; color: #666; padding: 40px 0;"><i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br>Selecciona un d√≠a del calendario</p>';
}

// Abrir modal de nueva planificaci√≥n
function nuevaPlanificacion() {
  // Validar que hay un d√≠a seleccionado
  if (!diaSeleccionado) {
    alert('‚ö†Ô∏è Primero selecciona un d√≠a del calendario');
    return;
  }
  
  // Validar que no es d√≠a pasado
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada < hoy) {
    alert('‚ö†Ô∏è No puedes crear planificaciones para d√≠as pasados');
    return;
  }
  
  // Reset variables
  pasoActual = 1;
  temasSeleccionados = [];
  tiempoUsado = 0;
  bloquesActivos = [];
  
  // Establecer fecha seleccionada
  const fechaStr = fechaSeleccionada.getFullYear() + '-' + 
    String(fechaSeleccionada.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fechaSeleccionada.getDate()).padStart(2, '0');
  document.getElementById('fechaPlanificacion').value = fechaStr;
  
  // Mostrar modal
  document.getElementById('modalNuevaPlanificacion').style.display = 'flex';
  
  // Cargar oposiciones
  //cargarOposiciones();
  
  // Mostrar paso 1
  mostrarPaso(1);
  
  // Verificar repasos del d√≠a seleccionado
  verificarRepasosDelDia();
}

// Cerrar modal
function cerrarModal() {
  document.getElementById('modalNuevaPlanificacion').style.display = 'none';
}

// Mostrar paso espec√≠fico
function mostrarPaso(numeroPaso) {
  pasoActual = numeroPaso;
  
  // Ocultar todos los pasos
  document.getElementById('paso1').style.display = 'none';
  document.getElementById('paso2').style.display = 'none';
  document.getElementById('paso3').style.display = 'none';
  
  // Mostrar paso actual
  document.getElementById('paso' + numeroPaso).style.display = 'block';
  
  // Actualizar indicadores visuales
  actualizarIndicadoresPasos();
  
  // Actualizar botones
  document.getElementById('btnAnterior').style.display = numeroPaso > 1 ? 'inline-block' : 'none';
  document.getElementById('btnSiguiente').textContent = numeroPaso === 3 ? 'Crear Planificaci√≥n' : 'Siguiente ‚ñ∂';
  
  // Acciones espec√≠ficas por paso
  if (numeroPaso === 1) {
    mostrarPaso1(); // ‚Üê A√ëADIR ESTA L√çNEA
  } else if (numeroPaso === 2) {
    mostrarPaso2(); // Usar funci√≥n espec√≠fica
    setupEventListenerHoras(); // Configurar listeners
  } else if (numeroPaso === 3) {
  // Obtener tiempo real disponible del paso 2 (ya calculado correctamente)
  const tiempoRealParaTemas = window.tiempoRealParaTemas || 0;
  
  // Actualizar variables globales para el √°rbol
  tiempoTotalDisponible = tiempoRealParaTemas; // ‚Üê CORRECTO
    // Pre-cargar temas de comparaci√≥n si existen
    if (window.temasParaPlanificar && window.temasParaPlanificar.temas) {
      precargarTemasDeComparacion();
    }
    
    cargarArbolTemasCorregido();  // ‚Üê NUEVA FUNCI√ìN
    actualizarResumenTiempo();
    }

}

// Actualizar indicadores de pasos
function actualizarIndicadoresPasos() {
  for (let i = 1; i <= 3; i++) {
    const indicador = document.getElementById('indicadorPaso' + i);
    const circulo = indicador.querySelector('div');
    const texto = indicador.querySelector('span');
    
    if (i < pasoActual) {
      // Paso completado
      circulo.style.background = '#28a745';
      circulo.style.color = 'white';
      texto.style.color = '#28a745';
    } else if (i === pasoActual) {
      // Paso actual
      circulo.style.background = '#007bff';
      circulo.style.color = 'white';
      texto.style.color = '#007bff';
    } else {
      // Paso pendiente
      circulo.style.background = '#ddd';
      circulo.style.color = '#999';
      texto.style.color = '#999';
    }
  }
}

// Paso siguiente
function pasoSiguiente() {
  if (pasoActual === 1) {
    // Validar paso 1
    if (!document.getElementById('fechaPlanificacion').value) {
      alert('‚ö†Ô∏è Selecciona una fecha');
      return;
    }
    /*
    if (!document.getElementById('oposicionPlanificacion').value) {
      alert('‚ö†Ô∏è Selecciona una oposici√≥n');
      return;
    }
    */
    mostrarPaso(2);
    
    } else if (pasoActual === 2) {
      // Validar paso 2 con nueva funci√≥n
      if (!validarPaso2()) {
        return;
      }
      mostrarPaso(3);
    } else if (pasoActual === 3) {
    // Crear planificaci√≥n
    crearPlanificacion();
  }
}

// Paso anterior
function pasoAnterior() {
  if (pasoActual > 1) {
    mostrarPaso(pasoActual - 1);
  }
}

// Cargar oposiciones (conectado al backend)
function cargarOposiciones() {
  const select = document.getElementById('oposicionPlanificacion');
  select.innerHTML = '<option value="">-- Cargando oposiciones... --</option>';
  
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      select.innerHTML = '<option value="">-- Selecciona una oposici√≥n --</option>';
      
      oposiciones.forEach(function(oposicion) {
        const option = document.createElement('option');
        option.value = oposicion.id;
        option.textContent = oposicion.nombre;
        select.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      select.innerHTML = '<option value="">-- Error al cargar --</option>';
    })
    .getOposicionesParaPlanificacion();
}

// Verificar repasos del d√≠a con indicador de carga
function verificarRepasosDelDia() {
  const fechaInput = document.getElementById('fechaPlanificacion');
  if (!fechaInput || !fechaInput.value) {
    const alertaDiv = document.getElementById('alertaRepasos');
    if (alertaDiv) alertaDiv.style.display = 'none';
    return;
  }
  
  const fecha = fechaInput.value;
  const fechaMs = new Date(fecha + 'T00:00:00').getTime();
  
  google.script.run
    .withSuccessHandler(function(repasos) {
      const alertaDiv = document.getElementById('alertaRepasos');
      const listaDiv = document.getElementById('listaRepasos');
      
      if (!alertaDiv || !listaDiv) return; // Elementos no existen
      
      if (repasos && repasos.length > 0) {
        // Mostrar repasos...
        window.repasosDelDia = repasos;
        alertaDiv.style.display = 'block';
      } else {
        alertaDiv.style.display = 'none';
        window.repasosDelDia = [];
      }
      
      const btnSiguiente = document.getElementById('btnSiguientePaso');
      if (btnSiguiente) btnSiguiente.disabled = false;
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar repasos:', error);
      window.repasosDelDia = [];
      const btnSiguiente = document.getElementById('btnSiguientePaso');
      if (btnSiguiente) btnSiguiente.disabled = false;
    })
    .getRepasosDelDia(fechaMs);
}

// Cargar configuraci√≥n actual (conectado al backend)
function cargarConfiguracionActual() {
  const idOposicion = document.getElementById('oposicionPlanificacion').value;
  if (!idOposicion) return;
  
  google.script.run
    .withSuccessHandler(function(config) {
      configuracionActual = config;
      
      document.getElementById('vueltaActual').textContent = config.vueltaActual;
      
      const minutosPorPagina = getMinutosPorPaginaLocal(config);
      document.getElementById('minutosPorPagina').textContent = minutosPorPagina;
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar configuraci√≥n:', error);
      // Valores por defecto
      document.getElementById('vueltaActual').textContent = '1';
      document.getElementById('minutosPorPagina').textContent = '30';
    })
    .getConfiguracionOposicion(idOposicion);
}

// Funci√≥n auxiliar para calcular minutos por p√°gina localmente
function getMinutosPorPaginaLocal(config) {
  switch (config.vueltaActual) {
    case 1: return config.minPorPagV1;
    case 2: return config.minPorPagV2;
    case 3: return config.minPorPagV3;
    default: return config.minPorPagV4;
  }
}

function actualizarTiempoDisponible() {
  actualizarCalculoTiempo(); // Usar la nueva funci√≥n
}

// Mostrar repasos en el paso 2
function mostrarRepasosEnPasoDos() {
  const infoDiv = document.getElementById('infoRepasosStepDos');
  const detalleDiv = document.getElementById('detalleRepasosStepDos');
  
  if (window.repasosDelDia && window.repasosDelDia.length > 0) {
    const tiempoRepasos = window.repasosDelDia.length * 30;
    
    let html = '<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">';
    html += '<div>';
    html += '<ul style="margin: 0; padding-left: 20px;">';
    window.repasosDelDia.forEach(function(repaso) {
      html += '<li>' + repaso.nombreTema + ' <span style="color: #856404;">(30 min)</span></li>';
    });
    html += '</ul>';
    html += '</div>';
    html += '<div style="text-align: center; background: #ffc107; color: white; padding: 10px; border-radius: 5px; min-width: 80px;">';
    html += '<div style="font-size: 20px; font-weight: bold;">' + tiempoRepasos + ' min</div>';
    html += '<div style="font-size: 12px;">Total</div>';
    html += '</div>';
    html += '</div>';
    
    detalleDiv.innerHTML = html;
    infoDiv.style.display = 'block';
    
    // Actualizar el c√°lculo de tiempo
    document.getElementById('tiempoRepasos').textContent = tiempoRepasos + ' min';
    actualizarTiempoDisponible();
  } else {
    infoDiv.style.display = 'none';
    document.getElementById('tiempoRepasos').textContent = '0 min';
    actualizarTiempoDisponible();
  }
    // Actualizar el c√°lculo de tiempo despu√©s de mostrar repasos
  actualizarCalculoTiempo();
}

// Cargar √°rbol de temas (CORREGIDO - tiempo estudio MENOS repasos)
function cargarArbolTemas() {
  const idOposicion = document.getElementById('oposicionPlanificacion').value;
  const contenedor = document.getElementById('arbolTemas');
  
  if (!idOposicion) {
    contenedor.innerHTML = '<p style="text-align: center; color: #666;">Selecciona una oposici√≥n para cargar los temas</p>';
    return;
  }
  
  // Calcular tiempo disponible REAL (estudio - repasos)
  const horasUsuario = parseFloat(document.getElementById('horasEstudio').value) || 4;
  const tiempoEstudio = horasUsuario * 60; // Minutos de estudio
  const tiempoRepasos = window.repasosDelDia ? window.repasosDelDia.length * 30 : 0; // Minutos de repasos
  const tiempoEstudioDisponible = tiempoEstudio; // Solo tiempo para temas nuevos (sin repasos)
  
  console.log('‚è±Ô∏è Tiempo estudio:', tiempoEstudio, 'min');
  console.log('‚è±Ô∏è Tiempo repasos:', tiempoRepasos, 'min');
  console.log('‚è±Ô∏è Tiempo disponible para temas:', tiempoEstudioDisponible, 'min');
  
  // Mostrar loading
  contenedor.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando √°rbol de temas...</p>';
  
  google.script.run
    .withSuccessHandler(function(data) {
      console.log('‚úÖ √Årbol de temas recibido:', data);
      
      // Guardar √°rbol global para validaciones
      window.arbolCompletoGlobal = data.arbol;
      
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay temas principales vinculados a esta oposici√≥n</p>';
        return;
      }
      
      // Renderizar √°rbol real
      renderizarArbolPorBloques(data.arbol, data.minutosPorPagina, data.bloques);
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar √°rbol:', error);
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas: ' + error.message + '</p>';
    })
    .getArbolTemasConEstados(idOposicion, tiempoEstudioDisponible); // ‚Üê TIEMPO SIN REPASOS
}

// Renderizar √°rbol agrupado por bloques (CORREGIDO)
function renderizarArbolPorBloques(arbolTemas, minutosPorPagina, bloquesInfo) {
  const contenedor = document.getElementById('arbolTemas');
  
  if (!arbolTemas || arbolTemas.length === 0) {
    contenedor.innerHTML = '<p style="text-align: center; color: #666;">No hay temas vinculados a esta oposici√≥n</p>';
    return;
  }
  
  // Agrupar temas por bloque (USANDO DATOS REALES)
  const temasPorBloque = agruparTemasPorBloque(arbolTemas, bloquesInfo);
  
  let html = '';
  
  // Renderizar cada bloque
  Object.keys(temasPorBloque).forEach(nombreBloque => {
    const temasDelBloque = temasPorBloque[nombreBloque];
    const esEspecial = esBloqueBloqueEspecial(nombreBloque);
    
    html += '<div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">';
    
    // Header del bloque (colapsable)
    html += '<div onclick="toggleBloque(\'' + nombreBloque + '\')" style="padding: 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">';
    html += '<div>';
    html += '<h6 style="margin: 0; font-weight: bold;">' + nombreBloque;
    if (esEspecial) {
      html += ' <span style="background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ESPECIAL</span>';
    }
    html += '</h6>';
    html += '<small style="color: #666;">' + temasDelBloque.length + ' temas principales</small>';
    html += '</div>';
    html += '<i id="icono-' + nombreBloque + '" style="transition: transform 0.3s;">‚ñº</i>';
    html += '</div>';
    
    // Contenido del bloque (inicialmente visible)
    html += '<div id="bloque-' + nombreBloque + '" style="padding: 15px;">';
    
    // Renderizar cada tema del bloque
    temasDelBloque.forEach(tema => {
      html += renderizarNodoTemaConPreseleccion(tema, 0, nombreBloque);
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  contenedor.innerHTML = html;
}

// Agrupar temas por bloque (USANDO DATOS REALES)
function agruparTemasPorBloque(arbolTemas, bloquesInfo) {
  const temasPorBloque = {};
  
  arbolTemas.forEach(tema => {
    const idBloque = tema.idBloque;
    const nombreBloque = bloquesInfo[idBloque] || 'Sin Bloque';
    
    if (!temasPorBloque[nombreBloque]) {
      temasPorBloque[nombreBloque] = [];
    }
    
    temasPorBloque[nombreBloque].push(tema);
  });
  
  console.log('üìä Temas agrupados por bloque:', temasPorBloque);
  return temasPorBloque;
}

// Renderizar nodo de tema con checkbox padre/hijo
function renderizarNodoTema(nodo, nivel, nombreBloque) {
  const margenIzquierdo = nivel * 20;
  const iconoEstado = getIconoEstado(nodo.estado);
  const colorFondo = getColorFondo(nodo.estado);
  
  let html = '';
  
  // Contenedor del nodo
  html += '<div style="margin-left: ' + margenIzquierdo + 'px; margin-bottom: 8px;">';
  
  // Fila del tema
  html += '<div style="display: flex; align-items: center; padding: 10px; background: ' + colorFondo + '; border: 1px solid #e0e0e0; border-radius: 6px;">';
  
  // Checkbox (para hojas seleccionables O padres seleccionables)
  if (nodo.seleccionable || nodo.seleccionablePadre) {
    const yaSeleccionado = temasSeleccionados.some(t => t.id === nodo.id);
    const tipoSeleccion = nodo.seleccionablePadre ? 'padre' : 'hijo';
    
    html += '<input type="checkbox" ';
    html += 'onchange="toggleSeleccionTemaConValidacion(this, ' + nodo.id + ', ' + nodo.tiempoMinutos + ', \'' + nombreBloque + '\', \'' + tipoSeleccion + '\')" ';
    html += (yaSeleccionado ? 'checked ' : '');
    html += 'style="margin-right: 10px; transform: scale(1.2);" ';
    html += 'title="' + (nodo.seleccionablePadre ? 'Seleccionar tema completo (' + nodo.tiempoTexto + ')' : 'Seleccionar subtema') + '">';
  } else {
    html += '<span style="width: 24px; margin-right: 10px; text-align: center; font-size: 16px;">' + iconoEstado + '</span>';
  }
  
  // Contenido del tema
  html += '<div style="flex: 1;">';
  html += '<div style="font-weight: ' + (nivel === 0 ? 'bold' : 'normal') + '; color: ' + getColorTexto(nodo.estado) + ';">';
  html += nodo.nombreCompleto;
  html += '</div>';
  
  if (nodo.paginas > 0) {
    html += '<small style="color: #666; font-size: 11px;">';
    html += nodo.paginas + ' p√°gs ‚Ä¢ ' + nodo.tiempoTexto;
    html += '</small>';
  }
  html += '</div>';
  
  // Badge de estado
  html += '<div style="margin-left: 10px;">';
  html += '<span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ' + getColorBadge(nodo.estado) + '; color: white; font-weight: bold;">';
  html += getTextoEstado(nodo.estado);
  html += '</span>';
  html += '</div>';
  
  html += '</div>';
  
  // Renderizar hijos si existen
  if (nodo.hijos && nodo.hijos.length > 0) {
    nodo.hijos.forEach(hijo => {
      html += renderizarNodoTema(hijo, nivel + 1, nombreBloque);
    });
  }
  
  html += '</div>';
  
  return html;
}

// Toggle selecci√≥n con validaci√≥n de orden (FUNCI√ìN COMPLETA)
function toggleSeleccionTemaConValidacion(checkbox, idTema, tiempoMinutos, nombreBloque, tipoSeleccion) {
  if (checkbox.checked) {
    // Validar orden consecutivo
    const nodoSeleccionado = { id: idTema };
    const validacionOrden = validarOrdenConsecutivo(nodoSeleccionado, window.arbolCompletoGlobal);
    
    if (!validacionOrden.esConsecutivo) {
      const confirmar = confirm('‚ö†Ô∏è ' + validacionOrden.mensaje + '\n\n¬øQuieres continuar seleccionando este tema?');
      if (!confirmar) {
        checkbox.checked = false;
        return;
      }
    }
    
    // Validar l√≠mites normales
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque,
      tipo: tipoSeleccion
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
    // Mostrar mensaje informativo para temas padre
    if (tipoSeleccion === 'padre') {
      setTimeout(() => {
        alert('‚úÖ Tema padre seleccionado completo.\nSe estudiar√° todo el tema en ' + formatearTiempo(tiempoMinutos) + '.');
      }, 100);
    }
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Formatear tiempo localmente
function formatearTiempo(minutos) {
  if (!minutos || minutos <= 0) return '0m';
  
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;
  
  if (horas > 0) {
    return horas + 'h ' + mins + 'm';
  } else {
    return mins + 'm';
  }
}

// Funciones auxiliares para estilos
function getIconoEstado(estado) {
  switch (estado) {
    case 'completado': return '‚úÖ';
    case 'en_progreso': return 'üîÑ';
    default: return '‚≠ï';
  }
}

function getColorFondo(estado) {
  switch (estado) {
    case 'completado': return '#e8f5e9';
    case 'en_progreso': return '#fff3e0';
    default: return '#ffffff';
  }
}

function getColorTexto(estado) {
  switch (estado) {
    case 'completado': return '#2e7d32';
    case 'en_progreso': return '#ef6c00';
    default: return '#333333';
  }
}

function getColorBadge(estado) {
  switch (estado) {
    case 'completado': return '#4caf50';
    case 'en_progreso': return '#ff9800';
    default: return '#9e9e9e';
  }
}

function getTextoEstado(estado) {
  switch (estado) {
    case 'completado': return 'OK';
    case 'en_progreso': return 'PROG';
    default: return 'PEND';
  }
}

// Verificar si es bloque especial
function esBloqueBloqueEspecial(nombreBloque) {
  const nombre = nombreBloque.toLowerCase();
  return nombre.includes('geograf√≠a') || nombre.includes('geografia') || nombre.includes('callejero');
}

// Toggle colapsar bloque
function toggleBloque(nombreBloque) {
  const contenido = document.getElementById('bloque-' + nombreBloque);
  const icono = document.getElementById('icono-' + nombreBloque);
  
  if (contenido.style.display === 'none') {
    contenido.style.display = 'block';
    icono.textContent = '‚ñº';
  } else {
    contenido.style.display = 'none';
    icono.textContent = '‚ñ∂';
  }
}

// Toggle selecci√≥n de tema
function toggleSeleccionTema(checkbox, idTema, tiempoMinutos, nombreBloque) {
  if (checkbox.checked) {
    // Validar selecci√≥n
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Validar selecci√≥n de tema
function validarSeleccionTema(tiempoMinutos, nombreBloque) {
  // Verificar tiempo disponible
  if (tiempoUsado + tiempoMinutos > tiempoTotalDisponible) {
    return {
      valido: false,
      mensaje: 'Excede el tiempo disponible (' + Math.round((tiempoUsado + tiempoMinutos - tiempoTotalDisponible)) + ' min de m√°s)'
    };
  }
  
  // Verificar l√≠mite de bloques
  if (!bloquesActivos.includes(nombreBloque)) {
    const esEspecial = esBloqueBloqueEspecial(nombreBloque);
    
    if (!esEspecial && bloquesActivos.filter(b => !esBloqueBloqueEspecial(b)).length >= 3) {
      return {
        valido: false,
        mensaje: 'M√°ximo 3 bloques normales permitidos'
      };
    }
    
    if (bloquesActivos.length >= 4) {
      return {
        valido: false,
        mensaje: 'M√°ximo 4 bloques total (3 normales + 1 especial)'
      };
    }
  }
  
  return { valido: true };
}

// Actualizar resumen de tiempo
function actualizarResumenTiempo() {
  const tiempoRestante = tiempoTotalDisponible - tiempoUsado;
  
  document.getElementById('tiempoTotal').textContent = tiempoTotalDisponible;
  document.getElementById('tiempoSeleccionado').textContent = tiempoUsado;
  document.getElementById('tiempoRestante').textContent = tiempoRestante;
  document.getElementById('bloquesUsados').textContent = bloquesActivos.length + '/3';
  
  // Cambiar colores seg√∫n estado
  const elementoRestante = document.getElementById('tiempoRestante');
  if (tiempoRestante < 0) {
    elementoRestante.style.color = '#dc3545';
  } else if (tiempoRestante < 30) {
    elementoRestante.style.color = '#ffc107';
  } else {
    elementoRestante.style.color = '#28a745';
  }
}

// Crear planificaci√≥n
function crearPlanificacion() {
  alert('üöß Crear planificaci√≥n - En desarrollo...');
}

// Event listener para cambio de horas
document.addEventListener('DOMContentLoaded', function() {
  // Solo a√±adir el listener si el elemento existe
  setTimeout(function() {
    const horasInput = document.getElementById('horasEstudio');
    if (horasInput) {
      horasInput.addEventListener('input', actualizarTiempoDisponible);
    }
  }, 100);
});

// Event listeners para el modal
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    // Listener para cambio de fecha
    const fechaInput = document.getElementById('fechaPlanificacion');
    if (fechaInput) {
      fechaInput.addEventListener('change', verificarRepasosDelDia);
    }
    
    // Listener para cambio de oposici√≥n
    const oposicionSelect = document.getElementById('oposicionPlanificacion');
    if (oposicionSelect) {
      oposicionSelect.addEventListener('change', function() {
        if (pasoActual >= 2) {
          cargarConfiguracionActual();
        }
      });
    }
    
    // Listener para cambio de horas
    const horasInput = document.getElementById('horasEstudio');
    if (horasInput) {
      horasInput.addEventListener('input', actualizarTiempoDisponible);
    }
  }, 100);
});

// Validar orden consecutivo de temas
function validarOrdenConsecutivo(nodoSeleccionado, arbolCompleto) {
  // Buscar el nodo en el √°rbol completo para obtener contexto
  function encontrarNodoEnArbol(arbol, idBuscado) {
    for (let tema of arbol) {
      if (tema.id === idBuscado) return { nodo: tema, padre: null };
      
      if (tema.hijos && tema.hijos.length > 0) {
        const resultado = encontrarNodoEnArbol(tema.hijos, idBuscado);
        if (resultado.nodo) return { nodo: resultado.nodo, padre: tema };
      }
    }
    return { nodo: null, padre: null };
  }
  
  const { nodo, padre } = encontrarNodoEnArbol(arbolCompleto, nodoSeleccionado.id);
  
  if (!padre) return { esConsecutivo: true }; // Tema padre, no hay orden que validar
  
  // Obtener hermanos del mismo padre
  const hermanos = padre.hijos.sort((a, b) => {
    const numA = parseFloat((a.prenombre || '0').replace(/[^\d.]/g, ''));
    const numB = parseFloat((b.prenombre || '0').replace(/[^\d.]/g, ''));
    return numA - numB;
  });
  
  // Encontrar posici√≥n del nodo actual
  const posicionActual = hermanos.findIndex(h => h.id === nodoSeleccionado.id);
  
  // Verificar si hay hermanos anteriores sin completar/seleccionar
  const hermanosPreviosSinCompletar = [];
  for (let i = 0; i < posicionActual; i++) {
    const hermano = hermanos[i];
    const yaSeleccionado = temasSeleccionados.some(t => t.id === hermano.id);
    const completado = hermano.estado === 'completado';
    
    if (!yaSeleccionado && !completado) {
      hermanosPreviosSinCompletar.push(hermano);
    }
  }
  
  if (hermanosPreviosSinCompletar.length > 0) {
    return {
      esConsecutivo: false,
      mensaje: 'Te est√°s saltando el orden. Temas anteriores pendientes: ' + 
               hermanosPreviosSinCompletar.map(h => h.prenombre || h.nombre).join(', '),
      temasSaltados: hermanosPreviosSinCompletar
    };
  }
  
  return { esConsecutivo: true };
}

</script>
