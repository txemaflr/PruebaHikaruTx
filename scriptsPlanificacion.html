
<script>
// scriptsPlanificacion.html - VERSI√ìN LIMPIA
// Variables globales
var mesActual = new Date();
var diaSeleccionado = null;
// Variables del modal
var pasoActual = 1;
var temasSeleccionados = [];
var tiempoTotalDisponible = 240; // minutos
var tiempoUsado = 0;
var bloquesActivos = [];
var configuracionActual = null;
var oposicionActiva = null;
var detalleActual = {
  dia: null,
  mes: null,
  a√±o: null,
  fijo: false // Si true, no cambiar autom√°ticamente
};
var estadoDetalle = {
  diaActual: null,
  mesActual: null,
  a√±oActual: null
};
var cargandoCalendario = false;
// CACH√â PARA OPTIMIZACI√ìN
var cacheCalendario = {};
var mesAnterior = null;

// 1. Inicializar secci√≥n de planificaci√≥n
function inicializarSeccionPlanificacion() {
  console.log('üöÄ Inicializando secci√≥n Planificaci√≥n COMPLETA...');
  
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  if (contenedor) {
    contenedor.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner loading-spinner-large"></div><p>Cargando configuraci√≥n...</p></div>';
  }
  
  // 1. Procesar repasos pendientes primero
  google.script.run
    .withSuccessHandler(function() {
      console.log('‚úÖ Repasos pendientes procesados');
      cargarOposicionYCalendario();
    })
    .withFailureHandler(function(error) {
      console.warn('‚ö†Ô∏è Error al procesar repasos:', error);
      cargarOposicionYCalendario(); // Continuar aunque falle
    })
    .procesarRepasosPendientes();
}

// FUNCI√ìN COMPLETA PARA CARGAR TODO
function cargarOposicionYCalendario() {
  google.script.run
    .withSuccessHandler(function(oposicion) {
      oposicionActiva = oposicion;
      
      if (oposicion) {
        mostrarPantallaPrincipalMejorada();
        inicializarCalendarioCompleto();
      } else {
        mostrarSelectorOposicion();
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar oposici√≥n:', error);
      mostrarSelectorOposicion();
    })
    .getOposicionActiva();
}

// CALENDARIO COMPLETO QUE CARGA TODO AL INICIO
function inicializarCalendarioCompleto() {
  renderizarCalendario();
  
  // ‚úÖ MOSTRAR LOADING EN CALENDARIO
  mostrarLoadingEnCalendario();
  
  // Seleccionar d√≠a de hoy por defecto
  const hoy = new Date();
  if (hoy.getFullYear() === mesActual.getFullYear() && hoy.getMonth() === mesActual.getMonth()) {
    seleccionarDia(hoy.getDate());
  }
  
  cargarTodoElMes();
}

// FUNCI√ìN PARA MOSTRAR LOADING EN CALENDARIO
function mostrarLoadingEnCalendario() {
  console.log('‚è≥ Mostrando loading calendario');
  
  const calendario = document.getElementById('calendario');
  if (!calendario) return;
  
  // Buscar o crear loading
  let loadingDiv = document.getElementById('calendario-loading');
  if (!loadingDiv) {
    loadingDiv = document.createElement('div');
    loadingDiv.id = 'calendario-loading';
    loadingDiv.style.cssText = `
      text-align: center; 
      padding: 15px; 
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
      border-radius: 8px; 
      margin-bottom: 15px; 
      color: #1976d2; 
      font-size: 14px; 
      font-weight: 500;
      border: 1px solid #90caf9;
    `;
    calendario.parentNode.insertBefore(loadingDiv, calendario);
  }
  
  loadingDiv.innerHTML = `
    <div class="loading-spinner" style="display: inline-block; margin-right: 10px;"></div>
    üìÖ Cargando planificaciones y repasos del mes...
  `;
  loadingDiv.style.display = 'block';
  
  cargandoCalendario = true;
}

function ocultarLoadingCalendario() {
  console.log('‚úÖ Ocultando loading calendario');
  
  const loadingDiv = document.getElementById('calendario-loading');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
  
  cargandoCalendario = false;
}

// FUNCI√ìN QUE CARGA PLANIFICACIONES Y REPASOS DE TODO EL MES
function cargarTodoElMes() {
  const a√±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();
  const claveCache = a√±o + '-' + mes;
  
  console.log('üíæ Verificando cach√© para:', claveCache);
  
  // Verificar si ya tenemos los datos en cach√©
  if (cacheCalendario[claveCache]) {
    console.log('üéØ CACH√â HIT - Usando datos guardados');
    const datos = cacheCalendario[claveCache];
    mostrarTodoEnCalendario(datos.planificaciones, datos.repasosPorDia);
    return; // ‚Üê SALIR SIN LLAMAR AL BACKEND
  }
  
  console.log('üöÄ CACH√â MISS - Cargando del servidor:', a√±o, mes);
  
  // UNA SOLA LLAMADA para obtener todo
  google.script.run
    .withSuccessHandler(function(datos) {
      console.log('‚úÖ Datos completos recibidos:', datos);
      
      const planificaciones = datos.planificaciones || [];
      const repasosPorDia = datos.repasosPorDia || {};
      
      // GUARDAR EN CACH√â
      cacheCalendario[claveCache] = {
        planificaciones: planificaciones,
        repasosPorDia: repasosPorDia,
        timestamp: new Date().getTime()
      };
      
      console.log('üíæ Datos guardados en cach√© para:', claveCache);
      console.log('üìä Total:', planificaciones.length, 'planificaciones,', Object.keys(repasosPorDia).length, 'd√≠as con repasos');
      
      mostrarTodoEnCalendario(planificaciones, repasosPorDia);
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar datos completos:', error);
      
      // Fallback: mostrar calendario vac√≠o
      renderizarCalendario();
      ocultarLoadingCalendario();
    })
    .getDatosCompletosDelMes(a√±o, mes);
}

// MOSTRAR TODO EN CALENDARIO
function mostrarTodoEnCalendario(planificaciones, repasosPorDia) {
  console.log('üé® Mostrando todo en calendario');
  
  // ‚úÖ OCULTAR LOADING
  ocultarLoadingCalendario();
  
  // Limpiar contenido anterior
  document.querySelectorAll('[id^="contenido-"]').forEach(el => el.innerHTML = '');
  
  // Mostrar planificaciones
  planificaciones.forEach(plan => {
    const contenedor = document.getElementById('contenido-' + mesActual.getFullYear() + '-' + mesActual.getMonth() + '-' + plan.dia);
    if (contenedor) {
      const tiempoHoras = Math.round(plan.tiempoTotal / 60 * 10) / 10;
      contenedor.innerHTML += `<div style="background: #4caf50; color: white; padding: 2px 4px; margin: 1px 0; border-radius: 3px; font-size: 9px;">üìö ${plan.temas.length} temas ‚Ä¢ ${tiempoHoras}h</div>`;
    }
  });
  
  // Mostrar repasos
  Object.keys(repasosPorDia).forEach(dia => {
    const contenedor = document.getElementById('contenido-' + mesActual.getFullYear() + '-' + mesActual.getMonth() + '-' + dia);
    if (contenedor) {
      const repasos = repasosPorDia[dia];
      contenedor.innerHTML += `<div style="background: #ff9800; color: white; padding: 2px 4px; margin: 1px 0; border-radius: 3px; font-size: 9px;">üîÑ ${repasos.length} repasos</div>`;
    }
  });
  
  // ‚úÖ SOLO en carga inicial (no en navegaci√≥n)
  if (!estadoDetalle.diaActual) {
    const hoy = new Date();
    if (hoy.getFullYear() === mesActual.getFullYear() && hoy.getMonth() === mesActual.getMonth()) {
      setTimeout(function() {
        seleccionarDia(hoy.getDate());
      }, 200);
    }
  }
  
  console.log('‚úÖ Calendario completamente cargado');
}


// 2. Cargar oposici√≥n activa
function cargarOposicionActiva() {
  var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  if (contenedor) {
    contenedor.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner loading-spinner-large"></div><p>Cargando oposici√≥n activa...</p></div>';
  }
  
  google.script.run
    .withSuccessHandler(function(oposicion) {
      oposicionActiva = oposicion;
      console.log('Oposici√≥n activa cargada:', oposicion);
      
      // Mostrar interfaz b√°sica
      if (contenedor) {
        if (oposicion) {
          contenedor.innerHTML = 
            '<div style="background: #d4edda; padding: 20px; border-radius: 8px; text-align: center;">' +
            '<h3 style="margin: 0; color: #155724;">üìö ' + oposicion.nombre + '</h3>' +
            '<p style="margin: 10px 0 0 0; color: #155724;">Oposici√≥n activa cargada correctamente</p>' +
            '</div>';
          
          // Inicializar calendario b√°sico
          setTimeout(function() {
            if (typeof renderizarCalendario === 'function') {
              renderizarCalendario();
            }
            cargarPlanificacionesDelMes();
          }, 500);
          
        } else {
          contenedor.innerHTML = 
            '<div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">' +
            '<h3 style="margin: 0; color: #856404;">‚ö†Ô∏è Sin oposici√≥n activa</h3>' +
            '<p style="margin: 10px 0; color: #856404;">No hay ninguna oposici√≥n configurada como activa</p>' +
            '<button onclick="mostrarSelectorOposicion()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px;">Configurar Oposici√≥n</button>' +
            '</div>';
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposici√≥n activa:', error);
      
      if (contenedor) {
        contenedor.innerHTML = 
          '<div style="background: #f8d7da; padding: 20px; border-radius: 8px; text-align: center;">' +
          '<h3 style="margin: 0; color: #721c24;">‚ùå Error de conexi√≥n</h3>' +
          '<p style="margin: 10px 0; color: #721c24;">No se pudo cargar la oposici√≥n activa</p>' +
          '<button onclick="cargarOposicionActiva()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px;">Reintentar</button>' +
          '</div>';
      }
      
      mostrarError('No se pudo cargar la oposici√≥n activa');
    })
    .getOposicionActiva();
}

function mostrarSelectorOposicion() {
  var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  if (!contenedor) return;
  
  var html = '<div style="text-align: center; padding: 40px;">';
  html += '<h3>Selecciona una oposici√≥n para planificar</h3>';
  html += '<p style="color: #666; margin-bottom: 30px;">Solo puedes tener una oposici√≥n activa a la vez</p>';
  
  html += '<div style="max-width: 400px; margin: 0 auto;">';
  html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Oposici√≥n:</label>';
  html += '<select id="selectorOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
  html += '<option value="">-- Cargando oposiciones --</option>';
  html += '</select>';
  
  html += '<button onclick="establecerOposicionActiva()" ';
  html += 'style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">';
  html += 'Establecer como activa</button>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  cargarOposicionesDisponibles();
}


// Cerrar modal de cambio de oposici√≥n
function cerrarCambiadorOposicion() {
  const overlay = document.getElementById('overlayOposiciones');
  if (overlay) {
    overlay.remove();
  }
}

// Mostrar modal para completar oposici√≥n
function mostrarCompletarOposicion() {
  const confirmar = confirm(`üèÅ ¬øCompletar la oposici√≥n "${oposicionActiva.nombre}"?\n\n‚úÖ Se marcar√° como completada\nüîÑ Pasar√° a la siguiente vuelta\nüìã Se resetear√°n los progresos de temas\n\n¬øContinuar?`);
  
  if (!confirmar) return;
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      if (resultado.success) {
        alert('üéâ ' + resultado.mensaje);
        inicializarSeccionPlanificacion();
      } else {
        alert('‚ùå Error al completar oposici√≥n');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al completar oposici√≥n:', error);
      alert('‚ùå Error al completar oposici√≥n: ' + error.message);
    })
    .completarOposicion(oposicionActiva.id);
}

// Placeholder para configuraci√≥n
function mostrarConfiguracion() {
  alert('‚öôÔ∏è Configuraci√≥n en desarrollo');
}

// 3. Mostrar p√°gina principal (VERSI√ìN CON COMPARACI√ìN)
function mostrarPaginaPrincipal() {
  mostrarPantallaPrincipalMejorada();
}

// Mostrar pantalla principal mejorada con opciones de oposici√≥n
function mostrarPantallaPrincipalMejorada() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  if (!oposicionActiva) {
    mostrarSelectorOposicion();
    return;
  }
  
  let html = '';
  
  // Header con oposici√≥n activa
  html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center;">';
  html += '<h3 style="margin: 0 0 10px 0;">üéØ ' + oposicionActiva.nombre + '</h3>';
  html += '<p style="margin: 0; opacity: 0.9;">Oposici√≥n activa - Planificaci√≥n de estudio</p>';
  html += '</div>';
  
  // Panel de acciones
  html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">';
  
  // Cambiar oposici√≥n
  html += '<button onclick="mostrarCambiadorOposicion()" style="background: #ff9800; color: white; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; text-align: center;">';
  html += '<div style="font-size: 24px; margin-bottom: 5px;">üîÑ</div>';
  html += '<div style="font-weight: bold;">Cambiar Oposici√≥n</div>';
  html += '<div style="font-size: 12px; opacity: 0.9;">Pausar actual y activar otra</div>';
  html += '</button>';
  
  // Completar oposici√≥n
  html += '<button onclick="mostrarCompletarOposicion()" style="background: #4caf50; color: white; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; text-align: center;">';
  html += '<div style="font-size: 24px; margin-bottom: 5px;">üèÅ</div>';
  html += '<div style="font-weight: bold;">Completar Oposici√≥n</div>';
  html += '<div style="font-size: 12px; opacity: 0.9;">Pasar a siguiente vuelta</div>';
  html += '</button>';
  
  // Configuraci√≥n
  html += '<button onclick="mostrarConfiguracion()" style="background: #607d8b; color: white; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; text-align: center;">';
  html += '<div style="font-size: 24px; margin-bottom: 5px;">‚öôÔ∏è</div>';
  html += '<div style="font-weight: bold;">Configuraci√≥n</div>';
  html += '<div style="font-size: 12px; opacity: 0.9;">Tiempos y par√°metros</div>';
  html += '</button>';
  
  html += '</div>';
  
  contenedor.innerHTML = html;
}

// 4. Cargar oposiciones disponibles
function cargarOposicionesDisponibles() {
  var select = document.getElementById('selectorOposicion');
  if (!select) return;
  
  select.innerHTML = '<option value="">-- Cargando oposiciones --</option>';
  select.disabled = true;
  
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      select.disabled = false;
      select.innerHTML = '<option value="">-- Selecciona una oposici√≥n --</option>';
      
      oposiciones.forEach(function(op) {
        var option = document.createElement('option');
        option.value = op.id;
        option.textContent = op.nombre;
        select.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      select.disabled = false;
      select.innerHTML = '<option value="">Error al cargar</option>';
      mostrarError('Error al cargar oposiciones');
    })
    .getOposicionesParaPlanificacion();
}

// 5. Establecer oposici√≥n activa
function establecerOposicionActiva() {
  var idOposicion = document.getElementById('selectorOposicion').value;
  
  if (!idOposicion) {
    mostrarAdvertencia('Selecciona una oposici√≥n antes de continuar');
    return;
  }
  
  var btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Configurando...';
  
  google.script.run
    .withSuccessHandler(function() {
      btn.disabled = false;
      btn.textContent = 'Establecer como activa';
      mostrarExito('Oposici√≥n establecida correctamente');
      
      // Recargar la secci√≥n
      setTimeout(function() {
        cargarOposicionActiva();
      }, 1000);
    })
    .withFailureHandler(function(error) {
      console.error('Error al establecer oposici√≥n activa:', error);
      btn.disabled = false;
      btn.textContent = 'Establecer como activa';
      mostrarError('No se pudo establecer la oposici√≥n activa');
    })
    .setOposicionActiva(idOposicion);
}

// 6. Cambiar oposici√≥n activa (VERSI√ìN CON CANCELAR)
function cambiarOposicion() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  let html = '<div style="text-align: center; padding: 40px;">';
  html += '<h3>Cambiar oposici√≥n activa</h3>';
  html += '<p style="color: #666; margin-bottom: 30px;">Actualmente: <strong>' + oposicionActiva.nombre + '</strong></p>';
  
  html += '<div style="max-width: 400px; margin: 0 auto;">';
  html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Nueva oposici√≥n:</label>';
  html += '<select id="selectorNuevaOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
  html += '<option value="">-- Selecciona una oposici√≥n --</option>';
  html += '</select>';
  
  html += '<div style="display: flex; gap: 10px; justify-content: center;">';
  html += '<button onclick="cancelarCambioOposicion()" ';
  html += 'style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Cancelar</button>';
  
  html += '<button onclick="confirmarCambioOposicion()" ';
  html += 'style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Cambiar</button>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  
  // Cargar oposiciones (excluyendo la actual)
  cargarOposicionesParaCambio();
}

// 7. Verificar si hay m√°s oposiciones para habilitar comparaci√≥n
function verificarOposicionesDisponibles() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const btnComparar = document.getElementById('btnCompararOposiciones');
      if (btnComparar && oposiciones.length > 1) {
        btnComparar.disabled = false;
        btnComparar.title = 'Comparar con otras oposiciones';
      }
    })
    .getOposicionesOrdenadas();
}

// Mostrar modal para cambiar oposici√≥n
function mostrarCambiadorOposicion() {
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.id = 'overlayOposiciones';
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
  
  // Crear modal
  const modal = document.createElement('div');
  modal.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;';
  
  modal.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">üîÑ Cambiar Oposici√≥n Activa</h3>
      <button onclick="cerrarCambiadorOposicion()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
    </div>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
      <strong>‚ö†Ô∏è Importante:</strong> La oposici√≥n actual "${oposicionActiva.nombre}" pasar√° a estado "en pausa" y podr√°s reactivarla m√°s tarde.
    </div>
    
    <div id="listaOposiciones" style="text-align: center; padding: 20px;">
      <div class="loading-spinner"></div>
      <p>Cargando oposiciones...</p>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Cargar oposiciones
  cargarOposicionesParaCambio();
}

// 8. Mostrar comparador de oposiciones
function mostrarComparadorOposiciones() {
  mostrarAdvertencia('Pr√≥ximo paso: Implementar modal de comparaci√≥n');
}

// Cargar lista de oposiciones para cambio
function cargarOposicionesParaCambio() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const container = document.getElementById('listaOposiciones');
      if (!container) return;
      
      let html = '';
      
      const oposicionesDisponibles = oposiciones.filter(op => op.id != oposicionActiva.id);
      
      if (oposicionesDisponibles.length === 0) {
        html = '<div style="text-align: center; color: #666; padding: 40px;"><h6>No hay otras oposiciones</h6><p>Solo tienes una oposici√≥n disponible</p></div>';
      } else {
        oposicionesDisponibles.forEach(function(op) {
          const estadoColor = op.estado === 'completada' ? '#4caf50' : op.estado === 'en_pausa' ? '#ff9800' : '#607d8b';
          const estadoTexto = op.estado === 'completada' ? 'Completada' : op.estado === 'en_pausa' ? 'En pausa' : 'Inactiva';
          
          html += '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">';
          html += '<div>';
          html += '<div style="font-weight: bold; font-size: 16px;">' + op.nombre + '</div>';
          html += '<div style="font-size: 12px; color: ' + estadoColor + '; font-weight: bold;">‚óè ' + estadoTexto + '</div>';
          html += '</div>';
          html += '<button onclick="confirmarCambioOposicion(' + op.id + ', \'' + op.nombre + '\')" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Activar</button>';
          html += '</div>';
        });
      }
      
      container.innerHTML = html;
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      const container = document.getElementById('listaOposiciones');
      if (container) {
        container.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;"><h6>‚ùå Error</h6><p>No se pudieron cargar las oposiciones</p></div>';
      }
    })
    .getTodasLasOposiciones();
}

// 10. Cancelar cambio de oposici√≥n
function cancelarCambioOposicion() {
  // Volver a mostrar la p√°gina principal con la oposici√≥n actual
  mostrarPaginaPrincipal();
}

// 11. Confirmar cambio de oposici√≥n
function confirmarCambioOposicion(idOposicion, nombreOposicion) {
  const confirmar = confirm(`¬øCambiar a la oposici√≥n "${nombreOposicion}"?\n\nLa oposici√≥n actual "${oposicionActiva.nombre}" pasar√° a estado "en pausa".`);
  
  if (!confirmar) return;
  
  // Mostrar loading
  const container = document.getElementById('listaOposiciones');
  if (container) {
    container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>Cambiando oposici√≥n...</p></div>';
  }
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      if (resultado.success) {
        // Actualizar oposici√≥n activa global
        oposicionActiva = resultado.oposicion;
        
        // Cerrar modal
        cerrarCambiadorOposicion();
        
        // Mostrar mensaje de √©xito
        alert(`‚úÖ Oposici√≥n cambiada correctamente a "${resultado.oposicion.nombre}"`);
        
        // Recargar secci√≥n
        inicializarSeccionPlanificacion();
        
      } else {
        alert('‚ùå Error al cambiar oposici√≥n');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cambiar oposici√≥n:', error);
      alert('‚ùå Error al cambiar oposici√≥n: ' + error.message);
    })
    .cambiarOposicionActiva(idOposicion);
}


// Renderizar calendario
if (typeof renderizarCalendario === 'undefined') {
  function renderizarCalendario() {
    var calendarioDiv = document.getElementById('calendario');
    if (!calendarioDiv) {
      console.warn('Elemento calendario no encontrado');
      return;
    }
    
    var a√±o = mesActual.getFullYear();
    var mes = mesActual.getMonth();
    
    // Actualizar t√≠tulo si existe
    var tituloMes = document.getElementById('tituloMes');
    if (tituloMes) {
      var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      tituloMes.textContent = meses[mes] + ' ' + a√±o;
    }
    
    // Calendario b√°sico (simplificado)
    var primerDia = new Date(a√±o, mes, 1).getDay();
    primerDia = primerDia === 0 ? 6 : primerDia - 1;
    
    var diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
    var hoy = new Date();
    
    var html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 12px;">';
    
    // Encabezados
    var diasSemana = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
    diasSemana.forEach(function(dia) {
      html += '<div style="text-align: center; font-weight: bold; padding: 8px; color: #666;">' + dia + '</div>';
    });
    
    // D√≠as vac√≠os
    for (var i = 0; i < primerDia; i++) {
      html += '<div></div>';
    }
    
    // D√≠as del mes
    for (var dia = 1; dia <= diasEnMes; dia++) {
      var fecha = new Date(a√±o, mes, dia);
      var esHoy = fecha.toDateString() === hoy.toDateString();
      var esSeleccionado = diaSeleccionado === dia;
      
      var estilos = 'min-height: 50px; border: 1px solid #ddd; border-radius: 3px; padding: 5px; cursor: pointer; ';
      estilos += 'display: flex; flex-direction: column; justify-content: space-between; ';
      
      if (esHoy) {
        estilos += 'border: 2px solid #007bff; background: #e3f2fd; ';
      } else if (esSeleccionado) {
        estilos += 'background: #f0f0f0; ';
      } else {
        estilos += 'background: white; ';
      }
      
      html += '<div onclick="seleccionarDia(' + dia + ')" style="' + estilos + '">';
      html += '<div style="font-weight: bold; color: ' + (esHoy ? '#007bff' : '#333') + ';">' + dia + '</div>';
      html += '<div id="contenido-' + a√±o + '-' + mes + '-' + dia + '" style="font-size: 8px; flex: 1;"></div>';
      html += '</div>';
    }
    
    html += '</div>';
    calendarioDiv.innerHTML = html;
  }
}


// Cambiar mes
function cambiarMes(direccion) {
  console.log('üìÖ Navegando mes, direcci√≥n:', direccion);
  
  // ‚úÖ MOSTRAR LOADING INMEDIATAMENTE
  cargandoCalendario = true;
  mostrarLoadingEnCalendario();
  
  // Cambiar mes
  mesActual.setMonth(mesActual.getMonth() + direccion);
  
  // ‚úÖ MANTENER d√≠a seleccionado visualmente (NO cambiar diaSeleccionado)
  console.log('üìç Manteniendo d√≠a seleccionado:', diaSeleccionado);
  
  // Renderizar calendario SIN cambiar selecci√≥n
  renderizarCalendario();
  
  // Cargar datos del nuevo mes
  cargarTodoElMes();
  
  // Al terminar de cargar, restaurar selecci√≥n visual si existe
  if (diaSeleccionado) {
    setTimeout(function() {
      marcarDiaSeleccionado(diaSeleccionado);
    }, 300);
  }
}

// Funci√≥n auxiliar para verificar si es mes actual
function esMesActual() {
  const hoy = new Date();
  return mesActual.getFullYear() === hoy.getFullYear() && 
         mesActual.getMonth() === hoy.getMonth();
}

// Funci√≥n para marcar d√≠a visualmente SIN cambiar detalle
function marcarDiaSeleccionado(dia) {
  // Quitar selecci√≥n anterior
  document.querySelectorAll('[onclick*="seleccionarDia"]').forEach(el => {
    const esHoy = el.style.border && el.style.border.includes('2196f3');
    if (!esHoy) {
      el.style.background = 'white';
    }
  });
  
  // Marcar d√≠a espec√≠fico
  const diaElement = document.querySelector(`[onclick="seleccionarDia(${dia})"]`);
  if (diaElement) {
    const esHoy = diaElement.style.border && diaElement.style.border.includes('2196f3');
    if (esHoy) {
      diaElement.style.background = '#e3f2fd';
    } else {
      diaElement.style.background = '#f0f0f0';
    }
  }
  
  diaSeleccionado = dia;
}

// SELECCIONAR D√çA SIN RECARGAR CALENDARIO
function seleccionarDia(dia) {
  console.log('üìÖ Intentando seleccionar d√≠a:', dia);
  
  const mesSeleccion = mesActual.getMonth();
  const a√±oSeleccion = mesActual.getFullYear();
  
  // ‚úÖ VERIFICAR SI YA EST√Å SELECCIONADO
  if (estadoDetalle.diaActual === dia && 
      estadoDetalle.mesActual === mesSeleccion && 
      estadoDetalle.a√±oActual === a√±oSeleccion) {
    console.log('üìç D√≠a ya seleccionado, no recargar detalle');
    return; // ‚úÖ NO HACER NADA
  }
  
  console.log('üîÑ Seleccionando nuevo d√≠a:', dia);
  
  // Actualizar estado
  diaSeleccionado = dia;
  estadoDetalle = {
    diaActual: dia,
    mesActual: mesSeleccion,
    a√±oActual: a√±oSeleccion
  };
  
  // Marcar visualmente
  marcarDiaSeleccionado(dia);
  
  // Cargar detalle solo si es diferente
  cargarDetalleDiaCompleto(dia);
}

// FUNCI√ìN DE TEST DESDE EL FRONTEND
function testPlanificacionesDesdeWeb() {
  console.log('üß™ FRONTEND: Ejecutando test de planificaciones...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('‚úÖ FRONTEND: Resultado del test:', resultado);
      
      let mensaje = 'üß™ RESULTADO DEL TEST:\n\n';
      mensaje += 'üìÖ B√∫squeda: ' + resultado.a√±o + '-' + (resultado.mes + 1) + ' (Julio 2025)\n';
      mensaje += 'üìä Planificaciones encontradas: ' + resultado.planificaciones + '\n';
      
      if (resultado.planificaciones > 0) {
        mensaje += '\n‚úÖ ¬°√âXITO! Se encontraron planificaciones\n';
        mensaje += 'Detalles: ' + JSON.stringify(resultado.datos, null, 2);
      } else {
        mensaje += '\n‚ùå No se encontraron planificaciones\n';
        mensaje += 'Verifica que existan datos en la hoja Planificacion_Temas para julio 2025';
      }
      
      alert(mensaje);
      
      // Recargar autom√°ticamente si encontr√≥ datos
      if (resultado.planificaciones > 0) {
        cargarPlanificacionesDelMes();
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error en test:', error);
      alert('‚ùå Error en test: ' + error.message);
    })
    .testPlanificacionesJulio2025();
}

// Funci√≥n temporal para inicializar con la nueva funci√≥n
function inicializarCalendarioConNuevaFuncion() {
  console.log('üöÄ FRONTEND: Inicializando calendario con nueva funci√≥n...');
  
  // Renderizar calendario
  renderizarCalendario();
  
  // Cargar planificaciones con la nueva funci√≥n
  cargarPlanificacionesDelMes(); // Ya usa la nueva funci√≥n
  
  console.log('‚úÖ FRONTEND: Calendario inicializado');
}

// Limpiar detalle del d√≠a
function limpiarDetalleDia() {
  document.getElementById('tituloDetalleDia').textContent = 'Selecciona un d√≠a';
  document.getElementById('contenidoDetalleDia').innerHTML = '<p style="text-align: center; color: #666; padding: 40px 0;"><i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br>Selecciona un d√≠a del calendario</p>';
}

function mostrarPlanificacionesEnCalendario(planificaciones) {
  console.log('üìÖ FRONTEND: Mostrando', planificaciones.length, 'planificaciones en calendario');
  
  if (!planificaciones || !Array.isArray(planificaciones) || planificaciones.length === 0) {
    console.log('‚ÑπÔ∏è FRONTEND: Sin planificaciones v√°lidas para mostrar');
    return;
  }
  
  let planificacionesMostradas = 0;
  
  planificaciones.forEach(function(planificacion, index) {
    try {
      console.log('üîç FRONTEND: Procesando planificaci√≥n', index, ':', planificacion);
      
      // Validaciones estrictas
      if (!planificacion) {
        console.warn('‚ö†Ô∏è FRONTEND: Planificaci√≥n', index, 'es null/undefined');
        return;
      }
      
      if (!planificacion.fecha) {
        console.warn('‚ö†Ô∏è FRONTEND: Planificaci√≥n', index, 'sin fecha');
        return;
      }
      
      if (!planificacion.temas || !Array.isArray(planificacion.temas)) {
        console.warn('‚ö†Ô∏è FRONTEND: Planificaci√≥n', index, 'sin temas v√°lidos');
        return;
      }
      
      const fechaPlan = new Date(planificacion.fecha);
      
      if (isNaN(fechaPlan.getTime())) {
        console.warn('‚ö†Ô∏è FRONTEND: Fecha inv√°lida en planificaci√≥n', index, ':', planificacion.fecha);
        return;
      }
      
      const a√±o = fechaPlan.getFullYear();
      const mes = fechaPlan.getMonth();
      const dia = fechaPlan.getDate();
      
      console.log('üìç FRONTEND: Buscando contenedor para fecha:', a√±o, mes, dia);
      
      // Buscar contenedor del d√≠a
      const idContenedor = 'contenido-' + a√±o + '-' + mes + '-' + dia;
      const contenedorDia = document.getElementById(idContenedor);
      
      if (contenedorDia) {
        // Crear HTML para la planificaci√≥n
        let html = '';
        
        // Indicador de planificaci√≥n (verde)
        html += '<div style="background: #4caf50; color: white; padding: 2px 4px; margin: 1px 0; border-radius: 3px; font-size: 9px; font-weight: bold; text-align: center;">';
        html += 'üìö ' + planificacion.temas.length + ' tema' + (planificacion.temas.length > 1 ? 's' : '');
        html += '</div>';
        
        // Indicador de tiempo (azul)
        const tiempoTotal = planificacion.tiempoTotal || 0;
        if (tiempoTotal > 0) {
          const horas = Math.floor(tiempoTotal / 60);
          const minutos = tiempoTotal % 60;
          const tiempoTexto = horas > 0 ? horas + 'h' + (minutos > 0 ? ' ' + minutos + 'm' : '') : minutos + 'm';
          
          html += '<div style="background: #2196f3; color: white; padding: 2px 4px; margin: 1px 0; border-radius: 3px; font-size: 8px; text-align: center;">';
          html += '‚è±Ô∏è ' + tiempoTexto;
          html += '</div>';
        }
        
        contenedorDia.innerHTML = html;
        planificacionesMostradas++;
        
        console.log('‚úÖ FRONTEND: Planificaci√≥n mostrada en d√≠a', dia, '- Contenedor:', idContenedor);
      } else {
        console.warn('‚ö†Ô∏è FRONTEND: Contenedor no encontrado:', idContenedor);
      }
      
    } catch (error) {
      console.error('‚ùå FRONTEND: Error al mostrar planificaci√≥n', index, ':', error);
    }
  });
  
  console.log('üìä FRONTEND: Total planificaciones mostradas en calendario:', planificacionesMostradas);
}

// FUNCI√ìN PARA COMPLETAR REPASOS
function marcarRepasoComoCompletado(idRepaso, nombreTema) {
  console.log('üìù FRONTEND: Completando repaso:', idRepaso, nombreTema);
  
  const tiempoReal = prompt('‚è±Ô∏è ¬øCu√°ntos minutos dedicaste al repaso de "' + nombreTema + '"?', '30');
  
  if (!tiempoReal || isNaN(tiempoReal) || parseInt(tiempoReal) < 1) {
    alert('‚ö†Ô∏è Por favor, introduce un tiempo v√°lido en minutos');
    return;
  }
  
  const notaTest = prompt('üìù ¬øC√≥mo fue el repaso? (Bien/Regular/Mal o nota espec√≠fica):', 'Bien');
  
  // Mostrar loading en el bot√≥n
  const botones = document.querySelectorAll('button');
  botones.forEach(function(btn) {
    if (btn.onclick && btn.onclick.toString().includes(idRepaso)) {
      btn.disabled = true;
      btn.textContent = '‚è≥ Guardando...';
    }
  });
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('‚úÖ FRONTEND: Repaso completado exitosamente:', resultado);
      
      if (resultado.success) {
        alert('üéâ ¬°Repaso completado!\n\n‚úÖ ' + resultado.mensaje);
        
        // Recargar detalle del d√≠a
        setTimeout(function() {
          cargarDetalleDiaCompletoMejorado(diaSeleccionado);
        }, 500);
      } else {
        alert('‚ùå Error al completar repaso: ' + resultado.error);
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error al completar repaso:', error);
      alert('‚ùå Error de conexi√≥n al completar repaso: ' + error.message);
    })
    .marcarRepasoComoCompletado(idRepaso, parseInt(tiempoReal), notaTest || null);
}

// FUNCI√ìN PARA MOSTRAR DETALLE CON ACCIONES
function mostrarDetalleCompletoConAcciones(planificacion, repasos, esDiaPasado) {
  console.log('üé® FRONTEND: Mostrando detalle con √°rbol colapsable');
  
  const contenido = document.getElementById('contenidoDetalleDia');
  if (!contenido) return;
  
  let html = '';
  
  // SECCI√ìN PLANIFICACIONES
  if (planificacion && planificacion.temas && planificacion.temas.length > 0) {
    html += crearSeccionPlanificaciones(planificacion, esDiaPasado);
  }
  
  // SECCI√ìN REPASOS
  if (repasos && repasos.length > 0) {
    html += crearSeccionRepasos(repasos, esDiaPasado);
  }
  
  // SIN CONTENIDO
  if (!planificacion?.temas?.length && !repasos?.length) {
    html += crearSeccionVacia(esDiaPasado);
  }
  
  contenido.innerHTML = html;
  console.log('‚úÖ FRONTEND: Detalle con √°rbol mostrado');
}

// CREAR SECCI√ìN DE PLANIFICACIONES AGRUPADAS
function crearSeccionPlanificaciones(planificacion, esDiaPasado) {
  console.log('üìö Agrupando planificaciones por tema padre');
  
  // Agrupar temas por padre original
  const gruposPorPadre = {};
  
  planificacion.temas.forEach(tema => {
    // Extraer tema padre del nombre jer√°rquico
    const nombreCompleto = tema.nombre || '';
    const partes = nombreCompleto.split(' ‚Üí ');
    const temaPadre = partes[0] || 'Sin clasificar';
    
    if (!gruposPorPadre[temaPadre]) {
      gruposPorPadre[temaPadre] = {
        nombre: temaPadre,
        temas: [],
        tiempoTotal: 0
      };
    }
    
    gruposPorPadre[temaPadre].temas.push(tema);
    gruposPorPadre[temaPadre].tiempoTotal += (tema.tiempo || 0);
  });
  
  let html = '<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">';
  html += '<h6 style="margin: 0 0 15px 0; color: #2e7d32;">üìö Planificaci√≥n del d√≠a</h6>';
  
  // Crear √°rbol colapsable por cada grupo
  Object.values(gruposPorPadre).forEach(grupo => {
    const idGrupo = 'grupo-' + grupo.nombre.replace(/[^a-zA-Z0-9]/g, '-');
    const tiempoHoras = Math.round(grupo.tiempoTotal / 60 * 100) / 100;
    
    html += `
      <div style="background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0; overflow: hidden;">
        <div onclick="toggleGrupo('${idGrupo}')" style="
          background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); 
          color: white; 
          padding: 12px 15px; 
          cursor: pointer; 
          display: flex; 
          justify-content: space-between; 
          align-items: center;
          font-weight: bold;
        ">
          <span>üìÇ ${grupo.nombre}</span>
          <div style="display: flex; align-items: center; gap: 15px;">
            <span style="font-size: 12px; opacity: 0.9;">${grupo.temas.length} temas ‚Ä¢ ${tiempoHoras}h</span>
            <span id="icono-${idGrupo}" style="font-size: 12px;">‚ñº</span>
          </div>
        </div>
        
        <div id="${idGrupo}" style="padding: 15px; display: block;">
    `;
    
    // Temas dentro del grupo
    grupo.temas.forEach(tema => {
      const nombreTema = tema.nombre.includes(' ‚Üí ') ? tema.nombre.split(' ‚Üí ').slice(1).join(' ‚Üí ') : tema.nombre;
      const estaCompletado = tema.estado === 'completado';
      
      // Determinar colores seg√∫n estado
      const colorFondo = estaCompletado ? '#d4edda' : '#f8f9fa';
      const colorBorde = estaCompletado ? '#28a745' : '#4caf50';
      const colorTexto = estaCompletado ? '#155724' : '#2e7d32';
      const iconoEstado = estaCompletado ? '‚úÖ' : 'üìù';
      const textoEstado = estaCompletado ? ' ‚úÖ COMPLETADO' : '';
      
      html += `
        <div style="
          background: ${colorFondo}; 
          padding: 12px; 
          border-radius: 5px; 
          margin-bottom: 8px; 
          border-left: 3px solid ${colorBorde};
          display: flex; 
          justify-content: space-between; 
          align-items: center;
        ">
          <div style="flex: 1;">
            <div style="font-weight: 500; color: ${colorTexto}; margin-bottom: 4px;">${iconoEstado} ${nombreTema}${textoEstado}</div>
            <div style="font-size: 12px; color: #666;">‚è±Ô∏è ${tema.tiempo || 0} minutos</div>
          </div>
          ${!esDiaPasado && !estaCompletado ? `
            <button onclick="marcarTemaComoCompletado('${tema.idProgreso}', '${nombreTema.replace(/'/g, "\\'")}', '${idGrupo}')" 
              style="
                background: #4caf50; 
                color: white; 
                border: none; 
                padding: 8px 16px; 
                border-radius: 5px; 
                cursor: pointer; 
                font-size: 12px;
                font-weight: 500;
              ">
              ‚úÖ Completar
            </button>
          ` : estaCompletado ? `
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: #28a745; font-size: 12px; font-weight: bold;">COMPLETADO</span>
              <button onclick="deshacerTemaCompletado('${tema.idProgreso}', '${nombreTema.replace(/'/g, "\\'")}', '${idGrupo}')" 
                style="
                  background: #6c757d; 
                  color: white; 
                  border: none; 
                  padding: 4px 8px; 
                  border-radius: 3px; 
                  cursor: pointer; 
                  font-size: 10px;
                  font-weight: 500;
                " 
                title="Deshacer completado">
                ‚Ü∂ Deshacer
              </button>
            </div>
          ` : ''}
        </div>
      `;
    });
    
    html += '</div></div>';
  });
  
  html += '</div>';
  return html;
}

// FUNCI√ìN PARA DESHACER TEMA COMPLETADO
function deshacerTemaCompletado(idProgreso, nombreTema, idGrupo) {
  console.log('‚Ü∂ FRONTEND: Deshaciendo tema completado:', idProgreso, nombreTema);
  
  const confirmar = confirm('¬øDeshacer la finalizaci√≥n del tema "' + nombreTema + '"?\n\n‚ö†Ô∏è Esto eliminar√° todos los repasos pendientes programados para este tema.');
  
  if (!confirmar) return;
  
  // Mostrar loading en el bot√≥n
  const botones = document.querySelectorAll('button');
  botones.forEach(function(btn) {
    if (btn.onclick && btn.onclick.toString().includes(idProgreso)) {
      btn.disabled = true;
      btn.textContent = '‚è≥ Deshaciendo...';
    }
  });
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('‚úÖ FRONTEND: Tema deshecho exitosamente:', resultado);
      
      if (resultado.success) {
        alert('‚Ü∂ ¬°Tema deshecho!\n\n‚úÖ ' + resultado.mensaje + '\nüóëÔ∏è Eliminados ' + resultado.repasosEliminados + ' repasos pendientes');
        
        // Recargar detalle del d√≠a
        setTimeout(function() {
          cargarDetalleDiaCompletoMejorado(diaSeleccionado);
        }, 500);
      } else {
        alert('‚ùå Error al deshacer tema: ' + resultado.error);
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error al deshacer tema:', error);
      alert('‚ùå Error de conexi√≥n al deshacer tema: ' + error.message);
    })
    .deshacerTemaCompletado(idProgreso);
}

// CREAR SECCI√ìN DE REPASOS
function crearSeccionRepasos(repasos, esDiaPasado) {
  let html = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">';
  html += '<div onclick="toggleGrupo(\'repasos-grupo\')" style="';
  html += 'background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%); color: #212529; padding: 12px 15px; cursor: pointer; ';
  html += 'display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-radius: 5px; margin-bottom: 15px;">';
  html += '<span>üìÇ REPASOS</span>';
  html += '<div style="display: flex; align-items: center; gap: 15px;">';
  html += `<span style="font-size: 12px; opacity: 0.8;">${repasos.length} repasos ‚Ä¢ ${repasos.length * 30} min</span>`;
  html += '<span id="icono-repasos-grupo" style="font-size: 12px;">‚ñº</span>';
  html += '</div></div>';
  
  html += '<div id="repasos-grupo" style="display: block;">';
  
repasos.forEach(repaso => {
  const nombreCompleto = repaso.nombreTema || 'Repaso sin nombre';
  let estadoTexto = '';
  let colorFondo = 'white';
  let colorBorde = '#ffc107';
  let colorTexto = '#856404';
  let iconoEstado = 'üîÑ';
  let botonHtml = '';
  
  // Determinar colores y textos seg√∫n estado
  if (repaso.estado === 'completado') {
    estadoTexto = ' ‚úÖ COMPLETADO';
    colorFondo = '#d4edda';
    colorBorde = '#28a745';
    colorTexto = '#155724';
    iconoEstado = '‚úÖ';
    botonHtml = '<span style="color: #28a745; font-size: 12px; font-weight: bold;">COMPLETADO</span>';
  } else if (repaso.estado === 'retraso') {
    estadoTexto = ' ‚ö†Ô∏è RETRASO';
    colorBorde = '#dc3545';
    colorTexto = '#721c24';
    iconoEstado = '‚ö†Ô∏è';
    if (!esDiaPasado) {
      botonHtml = `<button onclick="marcarRepasoComoCompletado('${repaso.id}', '${nombreCompleto.replace(/'/g, "\\'")}', 'repasos-grupo')" 
        style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 500;">
        ‚úÖ Completar
      </button>`;
    }
  } else {
    // Estado pendiente
    if (!esDiaPasado) {
      botonHtml = `<button onclick="marcarRepasoComoCompletado('${repaso.id}', '${nombreCompleto.replace(/'/g, "\\'")}', 'repasos-grupo')" 
        style="background: #ffc107; color: #212529; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 500;">
        ‚úÖ Completar
      </button>`;
    }
  }
  
  html += `
    <div style="
      background: ${colorFondo}; 
      padding: 12px; 
      border-radius: 5px; 
      margin-bottom: 8px; 
      border-left: 3px solid ${colorBorde};
      display: flex; 
      justify-content: space-between; 
      align-items: center;
    ">
      <div style="flex: 1;">
        <div style="font-weight: 500; color: ${colorTexto}; margin-bottom: 4px;">${iconoEstado} ${nombreCompleto}${estadoTexto}</div>
        <div style="font-size: 12px; color: #666;">Repaso #${repaso.numeroRepaso} ‚Ä¢ ‚è±Ô∏è 30 minutos</div>
      </div>
      ${botonHtml}
    </div>
  `;
});
  
  html += '</div>';
  
  // Advertencia sobre repasos
  html += '<div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #f5c6cb;">';
  html += '<div style="color: #721c24; font-size: 12px; text-align: center;">';
  html += '<strong>‚ö†Ô∏è Importante:</strong> Los repasos no completados se mover√°n autom√°ticamente al d√≠a siguiente';
  html += '</div></div>';
  
  html += '</div>';
  return html;
}

// CREAR SECCI√ìN VAC√çA
function crearSeccionVacia(esDiaPasado) {
  let html = '<div style="text-align: center; color: #666; padding: 40px;">';
  html += '<i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>';
  html += '<h6>üìÖ D√≠a libre</h6>';
  html += '<p>No hay planificaciones ni repasos programados</p>';
  if (!esDiaPasado) {
    html += '<button onclick="nuevaPlanificacion()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">‚ûï Crear Planificaci√≥n</button>';
  }
  html += '</div>';
  return html;
}

// FUNCI√ìN PARA TOGGLE DE GRUPOS
function toggleGrupo(idGrupo) {
  const contenido = document.getElementById(idGrupo);
  const icono = document.getElementById('icono-' + idGrupo);
  
  if (contenido && icono) {
    if (contenido.style.display === 'none') {
      contenido.style.display = 'block';
      icono.textContent = '‚ñº';
    } else {
      contenido.style.display = 'none';
      icono.textContent = '‚ñ∂';
    }
  }
}

// FUNCI√ìN MEJORADA PARA CARGAR DETALLE DEL D√çA
function cargarDetalleDiaCompletoMejorado(dia) {
  console.log('üîç FRONTEND: Cargando detalle mejorado para d√≠a:', dia);
  
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  const esDiaPasado = fechaSeleccionada < hoy;
  
  // Actualizar t√≠tulo
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const tituloFecha = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
  const sufijo = esDiaPasado ? ' (Solo lectura)' : '';
  
  const tituloElement = document.getElementById('tituloDetalleDia');
  if (tituloElement) {
    tituloElement.textContent = tituloFecha + sufijo;
  }
  
  // Mostrar loading
  const contenido = document.getElementById('contenidoDetalleDia');
  if (!contenido) {
    console.error('‚ùå FRONTEND: Elemento contenidoDetalleDia no encontrado');
    return;
  }
  
  contenido.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>Cargando informaci√≥n del d√≠a...</p></div>';
  
  // Cargar planificaciones y repasos en paralelo
  const a√±o = fechaSeleccionada.getFullYear();
  const mes = fechaSeleccionada.getMonth();
  
  let planificacionDelDia = null;
  let repasosDelDia = [];
  let cargasCompletas = 0;
  
  function verificarCargaCompleta() {
    cargasCompletas++;
    if (cargasCompletas === 2) {
      mostrarDetalleCompletoConAcciones(planificacionDelDia, repasosDelDia, esDiaPasado);
    }
  }
  
  // Cargar planificaciones
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      console.log('‚úÖ FRONTEND: Planificaciones del d√≠a recibidas:', planificaciones);
      
      if (planificaciones && Array.isArray(planificaciones)) {
        planificacionDelDia = planificaciones.find(function(p) {
          if (!p || !p.fecha) return false;
          const fechaPlan = new Date(p.fecha);
          fechaPlan.setHours(0, 0, 0, 0);
          return fechaPlan.getTime() === fechaSeleccionada.getTime();
        });
      }
      
      console.log('üéØ FRONTEND: Planificaci√≥n encontrada para el d√≠a:', planificacionDelDia);
      verificarCargaCompleta();
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error al cargar planificaciones del d√≠a:', error);
      verificarCargaCompleta();
    })
    .getPlanificacionesDelMes(a√±o, mes);
  
  // Cargar repasos
  google.script.run
    .withSuccessHandler(function(repasos) {
      console.log('‚úÖ FRONTEND: Repasos del d√≠a recibidos:', repasos);
      repasosDelDia = repasos && Array.isArray(repasos) ? repasos : [];
      verificarCargaCompleta();
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error al cargar repasos del d√≠a:', error);
      verificarCargaCompleta();
    })
    .getRepasosDelDia(fechaSeleccionada.getTime());
}

// Funci√≥n para cargar detalle del d√≠a con planificaciones
function cargarDetalleDiaCompleto(dia) {
  console.log('üîç Cargando detalle para d√≠a:', dia);
  
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  const esDiaPasado = fechaSeleccionada < hoy;
  
  // Actualizar t√≠tulo
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const tituloFecha = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
  const sufijo = esDiaPasado ? ' (Solo lectura)' : '';
  
  const tituloElement = document.getElementById('tituloDetalleDia');
  if (tituloElement) {
    tituloElement.textContent = tituloFecha + sufijo;
  }
  
  // Mostrar loading
  const contenido = document.getElementById('contenidoDetalleDia');
  if (!contenido) {
    console.error('‚ùå Elemento contenidoDetalleDia no encontrado');
    return;
  }
  
  contenido.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>Cargando informaci√≥n del d√≠a...</p></div>';
  
  // Buscar planificaci√≥n para este d√≠a
  const a√±o = fechaSeleccionada.getFullYear();
  const mes = fechaSeleccionada.getMonth();
  
  console.log('üìÖ Buscando planificaciones para:', a√±o, mes);
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      console.log('‚úÖ Planificaciones recibidas:', planificaciones);
      
      // VALIDACI√ìN ROBUSTA
      if (!planificaciones || !Array.isArray(planificaciones)) {
        console.warn('‚ö†Ô∏è Planificaciones no es un array v√°lido:', planificaciones);
        planificaciones = [];
      }
      
      // Buscar planificaci√≥n para este d√≠a espec√≠fico
      let planDelDia = null;
      
      try {
        planDelDia = planificaciones.find(function(p) {
          if (!p || !p.fecha) return false;
          
          const fechaPlan = new Date(p.fecha);
          fechaPlan.setHours(0, 0, 0, 0);
          return fechaPlan.getTime() === fechaSeleccionada.getTime();
        });
      } catch (error) {
        console.error('‚ùå Error al buscar planificaci√≥n del d√≠a:', error);
        planDelDia = null;
      }
      
      console.log('üéØ Planificaci√≥n del d√≠a encontrada:', planDelDia);
      
      // Buscar repasos para este d√≠a
      console.log('üîÑ Buscando repasos para:', fechaSeleccionada.getTime());
      
      google.script.run
        .withSuccessHandler(function(repasos) {
          console.log('‚úÖ Repasos recibidos:', repasos);
          
          // VALIDACI√ìN ROBUSTA
          if (!repasos || !Array.isArray(repasos)) {
            console.warn('‚ö†Ô∏è Repasos no es un array v√°lido:', repasos);
            repasos = [];
          }
          
          mostrarDetalleCompletoConAcciones(planDelDia, repasos, esDiaPasado);
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Error al cargar repasos:', error);
          mostrarDetalleCompletoRobust(planDelDia, [], esDiaPasado);
        })
        .getRepasosDelDia(fechaSeleccionada.getTime());
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar planificaciones:', error);
      
      // Mostrar error en el contenido
      if (contenido) {
        contenido.innerHTML = 
          '<div style="text-align: center; color: #dc3545; padding: 40px;">' +
          '<h6>‚ùå Error de conexi√≥n</h6>' +
          '<p>No se pudo cargar la informaci√≥n del d√≠a</p>' +
          '<button onclick="cargarDetalleDiaCompleto(' + dia + ')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">üîÑ Reintentar</button>' +
          '</div>';
      }
    })
    .getPlanificacionesDelMes(a√±o, mes);
}

function mostrarDetalleCompletoRobust(planificacion, repasos, esDiaPasado) {
  console.log('üé® Mostrando detalle completo:', { planificacion, repasos, esDiaPasado });
  
  const contenido = document.getElementById('contenidoDetalleDia');
  if (!contenido) {
    console.error('‚ùå Elemento contenidoDetalleDia no encontrado');
    return;
  }
  
  let html = '';
  
  // Validar datos
  const tienePlanificacion = planificacion && planificacion.temas && Array.isArray(planificacion.temas);
  const tieneRepasos = repasos && Array.isArray(repasos) && repasos.length > 0;
  
  console.log('üìä Estado:', { tienePlanificacion, tieneRepasos });
  
  // Si hay planificaci√≥n
  if (tienePlanificacion) {
    html += '<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">';
    html += '<h6 style="margin: 0 0 10px 0; color: #2e7d32;">üìö Planificaci√≥n del d√≠a</h6>';
    html += '<div style="margin-bottom: 10px;"><strong>Temas programados:</strong> ' + planificacion.temas.length + '</div>';
    
    const tiempoTotal = planificacion.tiempoTotal || 0;
    const horas = Math.floor(tiempoTotal / 60);
    const minutos = tiempoTotal % 60;
    const tiempoTexto = horas > 0 ? horas + 'h ' + minutos + 'm' : minutos + 'm';
    html += '<div style="margin-bottom: 15px;"><strong>Tiempo total:</strong> ' + tiempoTexto + '</div>';
    
    html += '<div><strong>Temas:</strong></div>';
    html += '<ul style="margin: 5px 0 0 0; padding-left: 20px;">';
    planificacion.temas.forEach(function(tema) {
      const tiempoTema = tema.tiempo || 0;
      html += '<li>' + (tema.nombre || 'Tema sin nombre') + ' <span style="color: #666;">(' + tiempoTema + ' min)</span></li>';
    });
    html += '</ul>';
    html += '</div>';
  }
  
  // Si hay repasos
  if (tieneRepasos) {
    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">';
    html += '<h6 style="margin: 0 0 10px 0; color: #856404;">üîÑ Repasos programados</h6>';
    html += '<div style="margin-bottom: 10px;"><strong>Total:</strong> ' + repasos.length + ' repasos (' + (repasos.length * 30) + ' min)</div>';
    html += '<ul style="margin: 5px 0 0 0; padding-left: 20px;">';
    repasos.forEach(function(repaso) {
      const nombreTema = repaso.nombreTema || 'Tema sin nombre';
      const numeroRepaso = repaso.numeroRepaso || '?';
      html += '<li>' + nombreTema + ' <span style="color: #856404;">(Repaso #' + numeroRepaso + ')</span></li>';
    });
    html += '</ul>';
    html += '</div>';
  }
  
  // Si no hay nada
  if (!tienePlanificacion && !tieneRepasos) {
    html += '<div style="text-align: center; color: #666; padding: 40px;">';
    html += '<i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>';
    html += '<h6>üìÖ D√≠a libre</h6>';
    html += '<p>No hay planificaciones ni repasos programados</p>';
    if (!esDiaPasado) {
      html += '<button onclick="nuevaPlanificacion()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">‚ûï Crear Planificaci√≥n</button>';
    }
    html += '</div>';
  }
  
  contenido.innerHTML = html;
  console.log('‚úÖ Detalle del d√≠a mostrado correctamente');
}

// Mostrar detalle completo (planificaci√≥n + repasos)
function mostrarDetalleCompleto(planificacion, repasos, esDiaPasado) {
  const contenido = document.getElementById('contenidoDetalleDia');
  let html = '';
  
  // Si hay planificaci√≥n
  if (planificacion) {
    html += '<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">';
    html += '<h6 style="margin: 0 0 10px 0; color: #2e7d32;">üìö Planificaci√≥n del d√≠a</h6>';
    html += '<div style="margin-bottom: 10px;"><strong>Temas programados:</strong> ' + planificacion.temas.length + '</div>';
    
    const horas = Math.floor(planificacion.tiempoTotal / 60);
    const minutos = planificacion.tiempoTotal % 60;
    const tiempoTexto = horas > 0 ? horas + 'h ' + minutos + 'm' : minutos + 'm';
    html += '<div style="margin-bottom: 15px;"><strong>Tiempo total:</strong> ' + tiempoTexto + '</div>';
    
    html += '<div><strong>Temas:</strong></div>';
    html += '<ul style="margin: 5px 0 0 0; padding-left: 20px;">';
    planificacion.temas.forEach(function(tema) {
      html += '<li>' + tema.nombre + ' <span style="color: #666;">(' + tema.tiempo + ' min)</span></li>';
    });
    html += '</ul>';
    html += '</div>';
  }
  
  // Si hay repasos
  if (repasos && repasos.length > 0) {
    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">';
    html += '<h6 style="margin: 0 0 10px 0; color: #856404;">üîÑ Repasos programados</h6>';
    html += '<div style="margin-bottom: 10px;"><strong>Total:</strong> ' + repasos.length + ' repasos (' + (repasos.length * 30) + ' min)</div>';
    html += '<ul style="margin: 5px 0 0 0; padding-left: 20px;">';
    repasos.forEach(function(repaso) {
      html += '<li>' + repaso.nombreTema + ' <span style="color: #856404;">(Repaso #' + repaso.numeroRepaso + ')</span></li>';
    });
    html += '</ul>';
    html += '</div>';
  }
  
  // Si no hay nada
  if (!planificacion && (!repasos || repasos.length === 0)) {
    html += '<div style="text-align: center; color: #666; padding: 40px;">';
    html += '<i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>';
    html += '<h6>üìÖ D√≠a libre</h6>';
    html += '<p>No hay planificaciones ni repasos programados</p>';
    if (!esDiaPasado) {
      html += '<button onclick="nuevaPlanificacion()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">‚ûï Crear Planificaci√≥n</button>';
    }
    html += '</div>';
  }
  
  contenido.innerHTML = html;
  console.log('‚úÖ Detalle del d√≠a mostrado');
}


// Abrir modal de nueva planificaci√≥n
function nuevaPlanificacion() {
  if (!diaSeleccionado) {
    mostrarAdvertencia('Primero selecciona un d√≠a del calendario', 'D√≠a no seleccionado');
    return;
  }
  
  if (!oposicionActiva) {
    mostrarError('Debes tener una oposici√≥n activa', 'Configuraci√≥n incompleta');
    return;
  }
  
  // Validar que no es d√≠a pasado
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada < hoy) {
    mostrarAdvertencia('No puedes crear planificaciones para d√≠as pasados', 'Fecha no v√°lida');
    return;
  }
  
  // Resetear estado usando TUS variables
  resetearEstadoPlanificacion();
  
  // Establecer fecha autom√°ticamente usando TUS variables  
  const fechaStr = fechaSeleccionada.getFullYear() + '-' + 
    String(fechaSeleccionada.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fechaSeleccionada.getDate()).padStart(2, '0');

  // Cargar oposiciones
  // No cargar oposiciones aqu√≠ - se configura autom√°ticamente en mostrarPaso1()
  
  // Guardar fecha en variable global (crear si no existe)
  window.fechaPlanificacion = fechaStr;
  
  document.getElementById('modalNuevaPlanificacion').style.display = 'flex';
  mostrarPaso(1);

    // Verificar repasos del d√≠a seleccionado
  verificarRepasosDelDia();
}
  

async function validarPaso2() {
  const horasInput = document.getElementById('horasEstudio');
  const horas = parseFloat(horasInput.value);
  
  if (!horas || horas < 0.5) {
    mostrarAdvertencia('Introduce un tiempo de estudio v√°lido (m√≠nimo 0.5 horas)', 'Tiempo inv√°lido');
    horasInput.focus();
    return false;
  }
  
  if (horas > 12) {
    const confirmar = await mostrarConfirmacion({
      titulo: 'Tiempo de estudio muy alto',
      mensaje: `Has introducido ${horas} horas de estudio. ¬øEst√°s seguro de que es correcto?`,
      icono: '‚ö†Ô∏è',
      textoConfirmar: 'S√≠, continuar',
      textoCancelar: 'Corregir',
      tipo: 'normal'
    });
    
    if (!confirmar) {
      horasInput.focus();
      return false;
    }
  }
  
  // Guardar tiempos usando TUS variables
  tiempoTotalDisponible = horas * 60;
  
  // Crear variables para repasos si no existen
  if (typeof repasosDelDia === 'undefined') {
    window.repasosDelDia = [];
  }
  
  const tiempoRepasos = repasosDelDia.length * 30;
  const tiempoEstudioReal = Math.max(0, tiempoTotalDisponible - tiempoRepasos);
  
  // Actualizar variable global
  tiempoTotalDisponible = tiempoEstudioReal;
  
  return true;
}  

  
function resetearEstadoPlanificacion() {
  // Resetear todas las variables del modal
  pasoActual = 1;
  temasSeleccionados = [];
  tiempoTotalDisponible = 240; // 4 horas por defecto
  tiempoUsado = 0;
  bloquesActivos = [];
  
  // Variables que pueden no existir a√∫n (cr√©alas si las necesitas)
  if (typeof repasosDelDia === 'undefined') {
    window.repasosDelDia = [];
  } else {
    repasosDelDia = [];
  }
  
  if (typeof contadorAdvertencias === 'undefined') {
    window.contadorAdvertencias = {
      orden: {},
      bloques: {}
    };
  } else {
    contadorAdvertencias = {
      orden: {},
      bloques: {}
    };
  }
  
  console.log('Estado de planificaci√≥n reseteado');
}


// Cerrar modal
function cerrarModal() {
  document.getElementById('modalNuevaPlanificacion').style.display = 'none';
}

// Mostrar paso espec√≠fico
function mostrarPaso(numeroPaso) {
  pasoActual = numeroPaso; // Usar TU variable
  
  // Ocultar todos los pasos
  document.getElementById('paso1').style.display = 'none';
  document.getElementById('paso2').style.display = 'none';
  document.getElementById('paso3').style.display = 'none';
  
  // Mostrar paso actual
  document.getElementById('paso' + numeroPaso).style.display = 'block';
  
  // Actualizar indicadores (si los tienes)
  actualizarIndicadoresPasos();
  
  // Actualizar botones
  document.getElementById('btnAnterior').style.display = numeroPaso > 1 ? 'inline-block' : 'none';
  document.getElementById('btnSiguiente').textContent = numeroPaso === 3 ? 'Crear Planificaci√≥n' : 'Siguiente ‚ñ∂';
  
  // Acciones espec√≠ficas por paso
  if (numeroPaso === 1) {
    mostrarPaso1();
  } else if (numeroPaso === 2) {
    mostrarPaso2();
  } else if (numeroPaso === 3) {
    mostrarPaso3();
  }
}

// REEMPLAZAR la funci√≥n mostrarPaso1() en scriptsPlanificacion.html

function mostrarPaso1() {
  console.log('üìÖ Configurando paso 1 con UI elegante');
  
  // Configurar fecha elegante
  if (window.fechaPlanificacion) {
    const fecha = new Date(window.fechaPlanificacion);
    
    // Ocultar input y rellenar displays elegantes
    const fechaInput = document.getElementById('fechaPlanificacion');
    if (fechaInput) {
      fechaInput.value = window.fechaPlanificacion;
    }
    
    // Configurar fecha elegante
    const fechaElegante = document.getElementById('fechaElegante');
    const diaSemanaElegante = document.getElementById('diaSemanaElegante');
    
    if (fechaElegante && diaSemanaElegante) {
      const opciones = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);
      
      // Separar d√≠a de la semana del resto
      const partes = fechaFormateada.split(', ');
      const diaSemana = partes[0]; // ej: "mi√©rcoles"
      const fechaSinDia = partes[1]; // ej: "16 de julio de 2025"
      
      fechaElegante.textContent = fechaSinDia;
      diaSemanaElegante.textContent = diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1);
    }
  }
  
  // Configurar oposici√≥n elegante
  if (oposicionActiva && oposicionActiva.nombre) {
    const oposicionElegante = document.getElementById('oposicionElegante');
    if (oposicionElegante) {
      oposicionElegante.textContent = oposicionActiva.nombre;
    }
    
    // Tambi√©n rellenar el select oculto para compatibilidad
    const select = document.getElementById('oposicionPlanificacion');
    if (select) {
      select.innerHTML = '';
      const option = document.createElement('option');
      option.value = oposicionActiva.id;
      option.textContent = oposicionActiva.nombre;
      option.selected = true;
      select.appendChild(option);
    }
    
    // Cargar configuraci√≥n autom√°ticamente
    setTimeout(cargarConfiguracionActual, 200);
  }
  
  // Verificar repasos del d√≠a autom√°ticamente
  verificarRepasosDelDia();
}

// A√ëADIR tambi√©n esta funci√≥n para configurar el listener del input
function configurarListenerTiempo() {
  const horasInput = document.getElementById('horasEstudio');
  if (horasInput) {
    // Quitar listeners anteriores
    horasInput.removeEventListener('input', actualizarTiempoDisponible);
    horasInput.removeEventListener('change', actualizarTiempoDisponible);
    
    // A√±adir listeners
    horasInput.addEventListener('input', actualizarTiempoDisponible);
    horasInput.addEventListener('change', actualizarTiempoDisponible);
    
    console.log('‚úÖ Listener de tiempo configurado');
  }
}

// Nueva funci√≥n espec√≠fica para configurar oposici√≥n en paso 1
function configurarOposicionEnPaso1() {
  const select = document.getElementById('oposicionPlanificacion');
  if (!select) {
    console.error('‚ùå Select oposicionPlanificacion no encontrado');
    return;
  }
  
  if (!oposicionActiva || !oposicionActiva.id) {
    console.error('‚ùå No hay oposici√≥n activa');
    select.innerHTML = '<option value="">-- Error: Sin oposici√≥n activa --</option>';
    return;
  }
  
  console.log('‚úÖ Configurando oposici√≥n activa:', oposicionActiva.nombre);
  
  // Limpiar y configurar select
  select.innerHTML = '';
  const option = document.createElement('option');
  option.value = oposicionActiva.id;
  option.textContent = oposicionActiva.nombre;
  option.selected = true;
  select.appendChild(option);
  select.disabled = true;
  
  // A√±adir texto explicativo si no existe
  const container = select.parentElement;
  let explicacion = container.querySelector('.explicacion-oposicion');
  if (!explicacion) {
    explicacion = document.createElement('small');
    explicacion.className = 'explicacion-oposicion';
    explicacion.style.color = '#666';
    explicacion.style.display = 'block';
    explicacion.style.marginTop = '5px';
    explicacion.textContent = 'Oposici√≥n activa actual';
    container.appendChild(explicacion);
  }
  
  // Cargar configuraci√≥n autom√°ticamente
  setTimeout(cargarConfiguracionActual, 200);
}

function mostrarPaso2() {
  console.log('‚è∞ Cargando paso 2 - Configuraci√≥n de tiempo');
  
  // Configurar listener para actualizaciones din√°micas
  setTimeout(configurarListenerTiempo, 100);
  
  // Mostrar repasos en paso 2 si existen
  mostrarRepasosEnPasoDos();
  
  // Actualizar tiempo inicial
  setTimeout(actualizarTiempoDisponible, 200);
}

// Funci√≥n para mostrar repasos en paso 2
function mostrarRepasosEnPasoDos() {
  const infoDiv = document.getElementById('infoRepasosStepDos');
  const detalleDiv = document.getElementById('detalleRepasosStepDos');
  
  if (!infoDiv || !detalleDiv) {
    console.warn('‚ö†Ô∏è Elementos de repasos paso 2 no encontrados');
    return;
  }
  
  if (window.repasosDelDia && window.repasosDelDia.length > 0) {
    const tiempoRepasos = window.repasosDelDia.length * 30;
    
    let html = '<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">';
    html += '<div>';
    html += '<ul style="margin: 0; padding-left: 20px;">';
    window.repasosDelDia.forEach(function(repaso) {
      html += '<li>' + repaso.nombreTema + ' <span style="color: #856404; font-weight: bold;">(30 min)</span></li>';
    });
    html += '</ul>';
    html += '</div>';
    html += '<div style="text-align: center; background: #ffc107; color: white; padding: 10px; border-radius: 5px; min-width: 80px;">';
    html += '<div style="font-size: 20px; font-weight: bold;">' + tiempoRepasos + ' min</div>';
    html += '<div style="font-size: 12px;">Total repasos</div>';
    html += '</div>';
    html += '</div>';
    
    detalleDiv.innerHTML = html;
    infoDiv.style.display = 'block';
    
    console.log('‚úÖ Repasos mostrados en paso 2:', window.repasosDelDia.length);
  } else {
    infoDiv.style.display = 'none';
    console.log('‚ÑπÔ∏è No hay repasos para mostrar en paso 2');
  }
}

function mostrarPaso3() {
  console.log('üìö Cargando temas para selecci√≥n');
  
  // Actualizar resumen inicial
  actualizarResumenTiempo();
  
  // Cargar √°rbol de temas de forma segura
  cargarArbolTemasSeguro();
}

function validarPaso1() {
  const fecha = document.getElementById('fechaPlanificacion')?.value;
  if (!fecha) {
    mostrarAdvertencia('Selecciona una fecha para continuar');
    return false;
  }
  window.fechaPlanificacion = fecha;
  return true;
}


// Actualizar indicadores de pasos
function actualizarIndicadoresPasos() {
  for (let i = 1; i <= 3; i++) {
    const indicador = document.getElementById('indicadorPaso' + i);
    const circulo = indicador.querySelector('div');
    const texto = indicador.querySelector('span');
    
    if (i < pasoActual) {
      // Paso completado
      circulo.style.background = '#28a745';
      circulo.style.color = 'white';
      texto.style.color = '#28a745';
    } else if (i === pasoActual) {
      // Paso actual
      circulo.style.background = '#007bff';
      circulo.style.color = 'white';
      texto.style.color = '#007bff';
    } else {
      // Paso pendiente
      circulo.style.background = '#ddd';
      circulo.style.color = '#999';
      texto.style.color = '#999';
    }
  }
}

// Paso siguiente
async function pasoSiguiente() {
  if (pasoActual === 1) {
    if (validarPaso1()) {
      mostrarPaso(2);
    }
  } else if (pasoActual === 2) {
    const valido = await validarPaso2();
    if (valido) {
      mostrarPaso(3);
    }
  } else if (pasoActual === 3) {
    await crearPlanificacion();
  }
}

// Paso anterior
function pasoAnterior() {
  if (pasoActual > 1) {
    mostrarPaso(pasoActual - 1);
  }
}

// REEMPLAZAR la funci√≥n cargarOposiciones() en scriptsPlanificacion.html

function cargarOposiciones() {
  console.log('üîÑ Cargando oposiciones para modal...');
  
  const select = document.getElementById('oposicionPlanificacion');
  if (!select) {
    console.error('‚ùå Select oposicionPlanificacion no encontrado');
    return;
  }
  
  // Si ya tenemos oposici√≥n activa, usarla directamente
  if (oposicionActiva && oposicionActiva.id) {
    console.log('‚úÖ Usando oposici√≥n activa:', oposicionActiva.nombre);
    
    select.innerHTML = '';
    const option = document.createElement('option');
    option.value = oposicionActiva.id;
    option.textContent = oposicionActiva.nombre;
    option.selected = true;
    select.appendChild(option);
    select.disabled = true;
    
    // A√±adir texto explicativo
    const container = select.parentElement;
    let explicacion = container.querySelector('.explicacion-oposicion');
    if (!explicacion) {
      explicacion = document.createElement('small');
      explicacion.className = 'explicacion-oposicion';
      explicacion.style.color = '#666';
      explicacion.style.display = 'block';
      explicacion.style.marginTop = '5px';
      explicacion.textContent = 'Oposici√≥n activa actual';
      container.appendChild(explicacion);
    }
    
    // Cargar configuraci√≥n autom√°ticamente
    setTimeout(cargarConfiguracionActual, 100);
    return;
  }
  
  // Si no hay oposici√≥n activa, cargar todas
  select.innerHTML = '<option value="">-- Cargando oposiciones... --</option>';
  select.disabled = true;
  
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      select.disabled = false;
      select.innerHTML = '<option value="">-- Selecciona una oposici√≥n --</option>';
      
      oposiciones.forEach(function(op) {
        const option = document.createElement('option');
        option.value = op.id;
        option.textContent = op.nombre;
        select.appendChild(option);
      });
      
      console.log('‚úÖ Oposiciones cargadas:', oposiciones.length);
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar oposiciones:', error);
      select.disabled = false;
      select.innerHTML = '<option value="">-- Error al cargar --</option>';
    })
    .getOposicionesParaPlanificacion();
}

// 8. FUNCI√ìN verificarRepasosDelDia() con loading
function verificarRepasosDelDia() {
  console.log('üîÑ Verificando repasos del d√≠a...');
  
  var fechaInput = document.getElementById('fechaPlanificacion');
  if (!fechaInput || !fechaInput.value) {
    console.warn('‚ö†Ô∏è No hay fecha seleccionada');
    return;
  }
  
  var fechaMs = new Date(fechaInput.value + 'T00:00:00').getTime();
  console.log('üîç Buscando repasos para:', new Date(fechaMs));
  
  google.script.run
    .withSuccessHandler(function(repasos) {
      console.log('‚úÖ Repasos recibidos:', repasos);
      
      if (typeof repasosDelDia === 'undefined') {
        window.repasosDelDia = [];
      }
      repasosDelDia = repasos || [];
      
      // MOSTRAR REPASOS DIRECTAMENTE - SIN BUSCAR ELEMENTOS COMPLICADOS
      if (repasos && repasos.length > 0) {
        // Buscar contenedor del paso 1
        var paso1 = document.getElementById('paso1');
        if (!paso1) {
          console.error('‚ùå Paso 1 no encontrado');
          return;
        }
        
        // Crear o encontrar div de repasos
        var alertaExistente = document.getElementById('alertaRepasos');
        if (alertaExistente) {
          alertaExistente.remove();
        }
        
        // Crear nuevo div de repasos
        var alertaDiv = document.createElement('div');
        alertaDiv.id = 'alertaRepasos';
        alertaDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin: 15px 0;';
        
        var html = '<h6 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Repasos programados para este d√≠a:</h6>';
        html += '<ul style="margin: 0; padding-left: 20px;">';
        repasos.forEach(function(repaso) {
          html += '<li><strong>' + repaso.nombreTema + '</strong> - Repaso #' + repaso.numeroRepaso + '</li>';
        });
        html += '</ul>';
        html += '<p style="margin: 10px 0 0 0; font-size: 14px; color: #856404;"><strong>Consejo:</strong> Ten en cuenta estos repasos al calcular el tiempo de estudio.</p>';
        
        alertaDiv.innerHTML = html;
        
        // Insertarlo al final del paso 1
        paso1.appendChild(alertaDiv);
        
        console.log('‚úÖ Repasos mostrados correctamente');
        
      } else {
        console.log('‚ÑπÔ∏è No hay repasos para este d√≠a');
        // Quitar alerta si existe
        var alertaExistente = document.getElementById('alertaRepasos');
        if (alertaExistente) {
          alertaExistente.remove();
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar repasos:', error);
      if (typeof repasosDelDia === 'undefined') {
        window.repasosDelDia = [];
      }
      repasosDelDia = [];
    })
    .getRepasosDelDia(fechaMs);
}

// A√ëADIR esta funci√≥n en scriptsPlanificacion.html (despu√©s de verificarRepasosDelDia)
function mostrarRepasosEnPaso1(repasos) {
  var alertaDiv = document.getElementById('alertaRepasos');
  var listaDiv = document.getElementById('listaRepasos');
  
  if (!alertaDiv || !listaDiv) {
    console.warn('Elementos de repasos no encontrados en paso 1');
    return;
  }
  
  if (repasos && repasos.length > 0) {
    // Mostrar alerta
    alertaDiv.style.display = 'block';
    
    // Construir lista de repasos
    var html = '<ul style="margin: 0; padding-left: 20px;">';
    repasos.forEach(function(repaso) {
      html += '<li><strong>' + repaso.nombreTema + '</strong> - Repaso #' + repaso.numeroRepaso + '</li>';
    });
    html += '</ul>';
    
    listaDiv.innerHTML = html;
    
    console.log('‚úÖ Repasos mostrados en paso 1:', repasos.length);
  } else {
    // Ocultar alerta si no hay repasos
    alertaDiv.style.display = 'none';
    console.log('‚ÑπÔ∏è No hay repasos para este d√≠a');
  }
}

// Cargar configuraci√≥n actual (conectado al backend)
function cargarConfiguracionActual() {
  const idOposicion = document.getElementById('oposicionPlanificacion').value;
  if (!idOposicion) return;
  
  google.script.run
    .withSuccessHandler(function(config) {
      configuracionActual = config;
      
      document.getElementById('vueltaActual').textContent = config.vueltaActual;
      
      const minutosPorPagina = getMinutosPorPaginaLocal(config);
      document.getElementById('minutosPorPagina').textContent = minutosPorPagina;
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar configuraci√≥n:', error);
      // Valores por defecto
      document.getElementById('vueltaActual').textContent = '1';
      document.getElementById('minutosPorPagina').textContent = '30';
    })
    .getConfiguracionOposicion(idOposicion);
}

// Funci√≥n auxiliar para calcular minutos por p√°gina localmente
function getMinutosPorPaginaLocal(config) {
  switch (config.vueltaActual) {
    case 1: return config.minPorPagV1;
    case 2: return config.minPorPagV2;
    case 3: return config.minPorPagV3;
    default: return config.minPorPagV4;
  }
}

// Modificar actualizarTiempoDisponible para incluir repasos
function actualizarTiempoDisponible() {
  const horas = parseFloat(document.getElementById('horasEstudio').value) || 0;
  const tiempoEstudio = horas * 60;
  const tiempoRepasos = window.repasosDelDia ? window.repasosDelDia.length * 30 : 0;
  const tiempoTotal = tiempoEstudio + tiempoRepasos;
  
  tiempoTotalDisponible = tiempoEstudio; // Solo el tiempo de estudio para la planificaci√≥n
  
  document.getElementById('tiempoEstudio').textContent = tiempoEstudio + ' min';
  document.getElementById('tiempoTotalConRepasos').textContent = tiempoTotal + ' min';
  
  if (pasoActual === 3) {
    actualizarResumenTiempo();
  }
}

// Mostrar repasos en el paso 2
function mostrarRepasosEnPasoDos() {
  const infoDiv = document.getElementById('infoRepasosStepDos');
  const detalleDiv = document.getElementById('detalleRepasosStepDos');
  
  if (window.repasosDelDia && window.repasosDelDia.length > 0) {
    const tiempoRepasos = window.repasosDelDia.length * 30;
    
    let html = '<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">';
    html += '<div>';
    html += '<ul style="margin: 0; padding-left: 20px;">';
    window.repasosDelDia.forEach(function(repaso) {
      html += '<li>' + repaso.nombreTema + ' <span style="color: #856404;">(30 min)</span></li>';
    });
    html += '</ul>';
    html += '</div>';
    html += '<div style="text-align: center; background: #ffc107; color: white; padding: 10px; border-radius: 5px; min-width: 80px;">';
    html += '<div style="font-size: 20px; font-weight: bold;">' + tiempoRepasos + ' min</div>';
    html += '<div style="font-size: 12px;">Total</div>';
    html += '</div>';
    html += '</div>';
    
    detalleDiv.innerHTML = html;
    infoDiv.style.display = 'block';
    
    // Actualizar el c√°lculo de tiempo
    document.getElementById('tiempoRepasos').textContent = tiempoRepasos + ' min';
    actualizarTiempoDisponible();
  } else {
    infoDiv.style.display = 'none';
    document.getElementById('tiempoRepasos').textContent = '0 min';
    actualizarTiempoDisponible();
  }
}

// 5. FUNCI√ìN cargarArbolTemas() con loading espec√≠fico
function cargarArbolTemas() {
  var contenedor = document.getElementById('arbolTemas');
  
  if (!oposicionActiva) {
    contenedor.innerHTML = '<p style="color: red; text-align: center;">Error: No hay oposici√≥n activa</p>';
    return;
  }
  
  var tiempoDisponible = tiempoTotalDisponible;
  
  // Mostrar loading espec√≠fico para el √°rbol
  mostrarLoadingArbol();
  
  google.script.run
    .withSuccessHandler(function(data) {
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay temas vinculados a esta oposici√≥n</p>';
        return;
      }
      
      renderizarArbolTemas(data.arbol, data.bloques);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar √°rbol:', error);
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas: ' + error.message + '</p>';
    })
    .getArbolTemasConEstados(oposicionActiva.id, tiempoDisponible);
}

// Renderizar √°rbol agrupado por bloques (CORREGIDO)
function renderizarArbolPorBloques(arbolTemas, minutosPorPagina, bloquesInfo) {
  const contenedor = document.getElementById('arbolTemas');
  
  if (!arbolTemas || arbolTemas.length === 0) {
    contenedor.innerHTML = '<p style="text-align: center; color: #666;">No hay temas vinculados a esta oposici√≥n</p>';
    return;
  }
  
  // Agrupar temas por bloque (USANDO DATOS REALES)
  const temasPorBloque = agruparTemasPorBloque(arbolTemas, bloquesInfo);
  
  let html = '';
  
  // Renderizar cada bloque
  Object.keys(temasPorBloque).forEach(nombreBloque => {
    const temasDelBloque = temasPorBloque[nombreBloque];
    const esEspecial = esBloqueBloqueEspecial(nombreBloque);
    
    html += '<div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">';
    
    // Header del bloque (colapsable)
    html += '<div onclick="toggleBloque(\'' + nombreBloque + '\')" style="padding: 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">';
    html += '<div>';
    html += '<h6 style="margin: 0; font-weight: bold;">' + nombreBloque;
    if (esEspecial) {
      html += ' <span style="background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ESPECIAL</span>';
    }
    html += '</h6>';
    html += '<small style="color: #666;">' + temasDelBloque.length + ' temas principales</small>';
    html += '</div>';
    html += '<i id="icono-' + nombreBloque + '" style="transition: transform 0.3s;">‚ñº</i>';
    html += '</div>';
    
    // Contenido del bloque (inicialmente visible)
    html += '<div id="bloque-' + nombreBloque + '" style="padding: 15px;">';
    
    // Renderizar cada tema del bloque
    temasDelBloque.forEach(tema => {
      html += renderizarNodoTema(tema, 0, nombreBloque);
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  contenedor.innerHTML = html;
}

// Agrupar temas por bloque (USANDO DATOS REALES)
function agruparTemasPorBloque(arbolTemas, bloquesInfo) {
  const temasPorBloque = {};
  
  arbolTemas.forEach(tema => {
    const idBloque = tema.idBloque;
    const nombreBloque = bloquesInfo[idBloque] || 'Sin Bloque';
    
    if (!temasPorBloque[nombreBloque]) {
      temasPorBloque[nombreBloque] = [];
    }
    
    temasPorBloque[nombreBloque].push(tema);
  });
  
  console.log('üìä Temas agrupados por bloque:', temasPorBloque);
  return temasPorBloque;
}

// Renderizar nodo de tema con checkbox padre/hijo
function renderizarNodoTema(nodo, nivel, nombreBloque) {
  const margenIzquierdo = nivel * 20;
  const iconoEstado = getIconoEstado(nodo.estado);
  const colorFondo = getColorFondo(nodo.estado);
  
  let html = '';
  
  // Contenedor del nodo
  html += '<div style="margin-left: ' + margenIzquierdo + 'px; margin-bottom: 8px;">';
  
  // Fila del tema
  html += '<div style="display: flex; align-items: center; padding: 10px; background: ' + colorFondo + '; border: 1px solid #e0e0e0; border-radius: 6px;">';
  
  // Checkbox (para hojas seleccionables O padres seleccionables)
  if (nodo.seleccionable || nodo.seleccionablePadre) {
    const yaSeleccionado = temasSeleccionados.some(t => t.id === nodo.id);
    const tipoSeleccion = nodo.seleccionablePadre ? 'padre' : 'hijo';
    
    html += '<input type="checkbox" ';
    html += 'onchange="toggleSeleccionTemaConValidacion(this, ' + nodo.id + ', ' + nodo.tiempoMinutos + ', \'' + nombreBloque + '\', \'' + tipoSeleccion + '\')" ';
    html += (yaSeleccionado ? 'checked ' : '');
    html += 'style="margin-right: 10px; transform: scale(1.2);" ';
    html += 'title="' + (nodo.seleccionablePadre ? 'Seleccionar tema completo (' + nodo.tiempoTexto + ')' : 'Seleccionar subtema') + '">';
  } else {
    html += '<span style="width: 24px; margin-right: 10px; text-align: center; font-size: 16px;">' + iconoEstado + '</span>';
  }
  
  // Contenido del tema
  html += '<div style="flex: 1;">';
  html += '<div style="font-weight: ' + (nivel === 0 ? 'bold' : 'normal') + '; color: ' + getColorTexto(nodo.estado) + ';">';
  html += nodo.nombreCompleto;
  html += '</div>';
  
  if (nodo.paginas > 0) {
    html += '<small style="color: #666; font-size: 11px;">';
    html += nodo.paginas + ' p√°gs ‚Ä¢ ' + nodo.tiempoTexto;
    html += '</small>';
  }
  html += '</div>';
  
  // Badge de estado
  html += '<div style="margin-left: 10px;">';
  html += '<span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ' + getColorBadge(nodo.estado) + '; color: white; font-weight: bold;">';
  html += getTextoEstado(nodo.estado);
  html += '</span>';
  html += '</div>';
  
  html += '</div>';
  
  // Renderizar hijos si existen
  if (nodo.hijos && nodo.hijos.length > 0) {
    nodo.hijos.forEach(hijo => {
      html += renderizarNodoTema(hijo, nivel + 1, nombreBloque);
    });
  }
  
  html += '</div>';
  
  return html;
}

// Toggle selecci√≥n con validaci√≥n de orden (FUNCI√ìN COMPLETA)
function toggleSeleccionTemaConValidacion(checkbox, idTema, tiempoMinutos, nombreBloque, tipoSeleccion) {
  if (checkbox.checked) {
    // Validar orden consecutivo
    const nodoSeleccionado = { id: idTema };
    const validacionOrden = validarOrdenConsecutivo(nodoSeleccionado, window.arbolCompletoGlobal);
    
    if (!validacionOrden.esConsecutivo) {
      const confirmar = confirm('‚ö†Ô∏è ' + validacionOrden.mensaje + '\n\n¬øQuieres continuar seleccionando este tema?');
      if (!confirmar) {
        checkbox.checked = false;
        return;
      }
    }
    
    // Validar l√≠mites normales
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque,
      tipo: tipoSeleccion
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
    // Mostrar mensaje informativo para temas padre
    if (tipoSeleccion === 'padre') {
      setTimeout(() => {
        alert('‚úÖ Tema padre seleccionado completo.\nSe estudiar√° todo el tema en ' + formatearTiempo(tiempoMinutos) + '.');
      }, 100);
    }
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Formatear tiempo localmente
function formatearTiempo(minutos) {
  if (!minutos || minutos <= 0) return '0m';
  
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;
  
  if (horas > 0) {
    return horas + 'h ' + mins + 'm';
  } else {
    return mins + 'm';
  }
}

// Funciones auxiliares para estilos
function getIconoEstado(estado) {
  switch (estado) {
    case 'completado': return '‚úÖ';
    case 'en_progreso': return 'üîÑ';
    default: return '‚≠ï';
  }
}

function getColorFondo(estado) {
  switch (estado) {
    case 'completado': return '#e8f5e9';
    case 'en_progreso': return '#fff3e0';
    default: return '#ffffff';
  }
}

function getColorTexto(estado) {
  switch (estado) {
    case 'completado': return '#2e7d32';
    case 'en_progreso': return '#ef6c00';
    default: return '#333333';
  }
}

function getColorBadge(estado) {
  switch (estado) {
    case 'completado': return '#4caf50';
    case 'en_progreso': return '#ff9800';
    default: return '#9e9e9e';
  }
}

function getTextoEstado(estado) {
  switch (estado) {
    case 'completado': return 'OK';
    case 'en_progreso': return 'PROG';
    default: return 'PEND';
  }
}

// Verificar si es bloque especial
function esBloqueBloqueEspecial(nombreBloque) {
  const nombre = nombreBloque.toLowerCase();
  return nombre.includes('geograf√≠a') || nombre.includes('geografia') || nombre.includes('callejero');
}

// Toggle colapsar bloque
function toggleBloque(nombreBloque) {
  const contenido = document.getElementById('bloque-' + nombreBloque);
  const icono = document.getElementById('icono-' + nombreBloque);
  
  if (contenido.style.display === 'none') {
    contenido.style.display = 'block';
    icono.textContent = '‚ñº';
  } else {
    contenido.style.display = 'none';
    icono.textContent = '‚ñ∂';
  }
}

// Toggle selecci√≥n de tema
function toggleSeleccionTema(checkbox, idTema, tiempoMinutos, nombreBloque) {
  if (checkbox.checked) {
    // Validar selecci√≥n
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Validar selecci√≥n de tema
function validarSeleccionTema(tiempoMinutos, nombreBloque) {
  // Calcular tiempo usando TUS variables
  const tiempoUsadoActual = temasSeleccionados.reduce((total, tema) => total + tema.tiempo, 0);
  
  // Validar tiempo
  if (tiempoUsadoActual + tiempoMinutos > tiempoTotalDisponible) {
    const exceso = tiempoUsadoActual + tiempoMinutos - tiempoTotalDisponible;
    mostrarAdvertencia(
      `Este tema excede el tiempo disponible por ${Math.round(exceso)} minutos`, 
      'Tiempo insuficiente'
    );
    return false;
  }
  
  // Validar l√≠mite de bloques usando TUS variables
  if (!bloquesActivos.includes(nombreBloque)) {
    if (bloquesActivos.length >= 3) {
      // Crear contador si no existe
      if (typeof contadorAdvertencias === 'undefined') {
        window.contadorAdvertencias = { orden: {}, bloques: {} };
      }
      
      const clave = 'limite_bloques_' + bloquesActivos.length;
      
      if (!contadorAdvertencias.bloques[clave]) {
        contadorAdvertencias.bloques[clave] = 0;
      }
      
      contadorAdvertencias.bloques[clave]++;
      
      if (contadorAdvertencias.bloques[clave] === 1) {
        mostrarAdvertencia(
          `Has alcanzado el l√≠mite recomendado de ${bloquesActivos.length} bloques activos. Se recomienda no mezclar m√°s bloques en una sesi√≥n.`,
          'L√≠mite de bloques'
        );
        return false;
      } else {
        mostrarAdvertencia(
          `Tienes ${bloquesActivos.length} bloques activos. Aunque no es recomendado, se permite continuar.`,
          'Advertencia de bloques'
        );
        return true;
      }
    }
  }
  
  return true;
}



// Actualizar resumen de tiempo
function actualizarResumenTiempo() {
  const tiempoRestante = tiempoTotalDisponible - tiempoUsado;
  
  document.getElementById('tiempoTotal').textContent = tiempoTotalDisponible;
  document.getElementById('tiempoSeleccionado').textContent = tiempoUsado;
  document.getElementById('tiempoRestante').textContent = tiempoRestante;
  document.getElementById('bloquesUsados').textContent = bloquesActivos.length + '/3';
  
  // Cambiar colores seg√∫n estado
  const elementoRestante = document.getElementById('tiempoRestante');
  if (tiempoRestante < 0) {
    elementoRestante.style.color = '#dc3545';
  } else if (tiempoRestante < 30) {
    elementoRestante.style.color = '#ffc107';
  } else {
    elementoRestante.style.color = '#28a745';
  }
}

// 6. FUNCI√ìN crearPlanificacion() con loading en modal
async function crearPlanificacion() {
  // Validaciones finales
  if (temasSeleccionados.length === 0) {
    mostrarAdvertencia('Debes seleccionar al menos un tema', 'Sin temas seleccionados');
    return;
  }
  
  // Recopilar datos
  var datos = {
    fecha: window.fechaPlanificacion || '',
    idOposicion: oposicionActiva.id,
    tiempoPrevisto: tiempoTotalDisponible + (repasosDelDia?.length * 30 || 0),
    tiempoRepasos: repasosDelDia?.length * 30 || 0,
    tiempoEstudio: tiempoTotalDisponible,
    temasSeleccionados: temasSeleccionados,
    numeroBloques: bloquesActivos.length
  };
  
  // Confirmar creaci√≥n
  var confirmar = await mostrarConfirmacion({
    titulo: 'Crear planificaci√≥n',
    mensaje: '¬øCrear planificaci√≥n para ' + datos.fecha + '?\n\n‚Ä¢ ' + datos.temasSeleccionados.length + ' temas\n‚Ä¢ ' + Math.round(datos.tiempoEstudio / 60 * 10) / 10 + 'h de estudio\n‚Ä¢ ' + datos.numeroBloques + ' bloques',
    icono: 'üìù',
    textoConfirmar: 'Crear Planificaci√≥n',
    textoCancelar: 'Revisar',
    tipo: 'normal'
  });
  
  if (!confirmar) return;
  
  // Loading en todo el modal
  var modal = document.querySelector('.contenedor-administracion-modal');
  if (!modal) {
    modal = document.getElementById('modalNuevaPlanificacion');
  }
  
  mostrarLoading(modal, {
    mensaje: 'Creando planificaci√≥n...',
    tipo: 'overlay'
  });
  
  // Llamar al backend
  google.script.run
    .withSuccessHandler(function(resultado) {
      ocultarLoading(modal);
      mostrarExito(
        'Planificaci√≥n creada con ' + resultado.temasCreados + ' temas',
        'üéâ ¬°Planificaci√≥n lista!'
      );
      cerrarModal();
      cargarPlanificacionesDelMes();
      seleccionarDia(diaSeleccionado);
    })
    .withFailureHandler(function(error) {
      console.error('Error al crear planificaci√≥n:', error);
      ocultarLoading(modal);
      mostrarError('No se pudo crear la planificaci√≥n: ' + error.message, 'Error de creaci√≥n');
    })
    .addPlanificacion(datos);
}

// 7. FUNCI√ìN cargarDetalleDia() con loading
function cargarDetalleDia(fecha, esDiaPasado) {
  var contenedor = document.getElementById('contenidoDetalleDia');
  
  // Mostrar loading espec√≠fico para el detalle
  mostrarLoading(contenedor, {
    mensaje: 'Cargando informaci√≥n del d√≠a...',
    tipo: 'overlay'
  });
  
  // Buscar planificaci√≥n para esta fecha
  var fechaStr = fecha.getFullYear() + '-' + 
    String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fecha.getDate()).padStart(2, '0');
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      ocultarLoading(contenedor);
      
      // Buscar planificaci√≥n para esta fecha espec√≠fica
      var planDelDia = planificaciones.find(function(p) {
        var fechaPlan = new Date(p.fecha);
        var fechaBuscar = new Date(fecha);
        fechaPlan.setHours(0, 0, 0, 0);
        fechaBuscar.setHours(0, 0, 0, 0);
        return fechaPlan.getTime() === fechaBuscar.getTime();
      });
      
      if (planDelDia) {
        cargarDetallePlanificacionCompleta(planDelDia.id, esDiaPasado);
      } else {
        mostrarInterfazSinPlanificacion(esDiaPasado);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al buscar planificaci√≥n:', error);
      ocultarLoading(contenedor);
      mostrarInterfazSinPlanificacion(esDiaPasado);
    })
    .getPlanificacionesDelMes(fecha.getFullYear(), fecha.getMonth());
}

// 4. FUNCI√ìN cargarPlanificacionesDelMes() con loading en calendario
function cargarPlanificacionesDelMes() {
  const a√±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();
  
  console.log('üîÑ FRONTEND: Cargando planificaciones para a√±o:', a√±o, 'mes:', mes, '(', getMonthName(mes), ')');
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      console.log('‚úÖ FRONTEND: Respuesta del backend:', typeof planificaciones, planificaciones);
      
      // VALIDACI√ìN MEJORADA
      if (planificaciones === null || planificaciones === undefined) {
        console.warn('‚ö†Ô∏è FRONTEND: Backend devolvi√≥ null/undefined');
        planificaciones = [];
      } else if (!Array.isArray(planificaciones)) {
        console.warn('‚ö†Ô∏è FRONTEND: Backend no devolvi√≥ array:', typeof planificaciones);
        planificaciones = [];
      }
      
      console.log('üìÖ FRONTEND: Planificaciones v√°lidas:', planificaciones.length);
      
      if (planificaciones.length > 0) {
        console.log('üéØ FRONTEND: Detalles de planificaciones:', planificaciones);
        mostrarPlanificacionesEnCalendario(planificaciones);
      } else {
        console.log('‚ÑπÔ∏è FRONTEND: Sin planificaciones para mostrar');
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error al cargar planificaciones:', error);
      alert('Error de conexi√≥n al cargar planificaciones: ' + error.message);
    })
    .getPlanificacionesDelMes(a√±o, mes);
}

// FUNCI√ìN AUXILIAR PARA NOMBRES DE MESES
function getMonthName(mes) {
  const nombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  return nombres[mes] || 'Mes inv√°lido';
}

// TAMBI√âN MODIFICAR cargarDetalleDiaCompleto() para usar la nueva funci√≥n
function cargarDetalleDiaCompletoNuevo(dia) {
  console.log('üîç FRONTEND: Cargando detalle para d√≠a:', dia);
  
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  const esDiaPasado = fechaSeleccionada < hoy;
  
  // Actualizar t√≠tulo
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const tituloFecha = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
  const sufijo = esDiaPasado ? ' (Solo lectura)' : '';
  
  const tituloElement = document.getElementById('tituloDetalleDia');
  if (tituloElement) {
    tituloElement.textContent = tituloFecha + sufijo;
  }
  
  // Mostrar loading
  const contenido = document.getElementById('contenidoDetalleDia');
  if (!contenido) {
    console.error('‚ùå FRONTEND: Elemento contenidoDetalleDia no encontrado');
    return;
  }
  
  contenido.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>Cargando informaci√≥n del d√≠a...</p></div>';
  
  // Buscar planificaci√≥n para este d√≠a
  const a√±o = fechaSeleccionada.getFullYear();
  const mes = fechaSeleccionada.getMonth();
  
  console.log('üìÖ FRONTEND: Buscando planificaciones para:', a√±o, mes);
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      console.log('‚úÖ FRONTEND: Planificaciones recibidas:', planificaciones);
      
      // VALIDACI√ìN ROBUSTA
      if (!planificaciones || !Array.isArray(planificaciones)) {
        console.warn('‚ö†Ô∏è FRONTEND: Planificaciones no es un array v√°lido:', planificaciones);
        planificaciones = [];
      }
      
      // Buscar planificaci√≥n para este d√≠a espec√≠fico
      let planDelDia = null;
      
      try {
        planDelDia = planificaciones.find(function(p) {
          if (!p || !p.fecha) return false;
          
          const fechaPlan = new Date(p.fecha);
          fechaPlan.setHours(0, 0, 0, 0);
          return fechaPlan.getTime() === fechaSeleccionada.getTime();
        });
      } catch (error) {
        console.error('‚ùå FRONTEND: Error al buscar planificaci√≥n del d√≠a:', error);
        planDelDia = null;
      }
      
      console.log('üéØ FRONTEND: Planificaci√≥n del d√≠a encontrada:', planDelDia);
      
      // Buscar repasos para este d√≠a
      console.log('üîÑ FRONTEND: Buscando repasos para:', fechaSeleccionada.getTime());
      
      google.script.run
        .withSuccessHandler(function(repasos) {
          console.log('‚úÖ FRONTEND: Repasos recibidos:', repasos);
          
          // VALIDACI√ìN ROBUSTA
          if (!repasos || !Array.isArray(repasos)) {
            console.warn('‚ö†Ô∏è FRONTEND: Repasos no es un array v√°lido:', repasos);
            repasos = [];
          }
          
          mostrarDetalleCompletoConAcciones(planDelDia, repasos, esDiaPasado);
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå FRONTEND: Error al cargar repasos:', error);
          mostrarDetalleCompletoRobust(planDelDia, [], esDiaPasado);
        })
        .getRepasosDelDia(fechaSeleccionada.getTime());
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error al cargar planificaciones:', error);
      
      // Mostrar error en el contenido
      if (contenido) {
        contenido.innerHTML = 
          '<div style="text-align: center; color: #dc3545; padding: 40px;">' +
          '<h6>‚ùå Error de conexi√≥n</h6>' +
          '<p>No se pudo cargar la informaci√≥n del d√≠a</p>' +
          '<button onclick="cargarDetalleDiaCompletoNuevo(' + dia + ')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">üîÑ Reintentar</button>' +
          '</div>';
      }
    })
    .getPlanificacionesDelMesNueva(a√±o, mes);  // ‚Üê USAR LA NUEVA FUNCI√ìN
}

function marcarTemaCompleto(idProgreso, nombreTema) {
  const tiempoReal = prompt('‚è±Ô∏è ¬øCu√°ntos minutos dedicaste al tema "' + nombreTema + '"?', '30');
  
  if (!tiempoReal || isNaN(tiempoReal) || tiempoReal < 1) {
    mostrarAdvertencia('Introduce un tiempo v√°lido en minutos', 'Tiempo no v√°lido');
    return;
  }
  
  const nota = prompt('üí≠ Nota personal (opcional):', '');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      if (resultado.success) {
        mostrarExito(
          `Se han programado ${resultado.repasosCreados} repasos autom√°ticamente`,
          '‚úÖ Tema completado'
        );
        setTimeout(() => {
          seleccionarDia(diaSeleccionado);
        }, 500);
      } else {
        mostrarError(`Error: ${resultado.error}`, 'No se pudo completar');
      }
    })
    .withFailureHandler(function(error) {
      mostrarError(`Error de conexi√≥n: ${error.message}`, 'Error de red');
    })
    .marcarTemaComoCompletado(idProgreso, parseInt(tiempoReal), nota || null);
}

// FUNCI√ìN PARA COMPLETAR TEMAS
function marcarTemaComoCompletado(idProgreso, nombreTema) {
  console.log('üìù FRONTEND: Completando tema:', idProgreso, nombreTema);
  
  const tiempoReal = prompt('‚è±Ô∏è ¬øCu√°ntos minutos dedicaste al tema "' + nombreTema + '"?', '60');
  
  if (!tiempoReal || isNaN(tiempoReal) || parseInt(tiempoReal) < 1) {
    alert('‚ö†Ô∏è Por favor, introduce un tiempo v√°lido en minutos');
    return;
  }
  
  const nota = prompt('üí≠ Nota personal sobre el estudio (opcional):', '');
  
  // Mostrar loading en el bot√≥n
  const botones = document.querySelectorAll('button');
  botones.forEach(function(btn) {
    if (btn.onclick && btn.onclick.toString().includes(idProgreso)) {
      btn.disabled = true;
      btn.textContent = '‚è≥ Guardando...';
    }
  });
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('‚úÖ FRONTEND: Tema completado exitosamente:', resultado);
      
      if (resultado.success) {
        alert('üéâ ¬°Tema completado!\n\n‚úÖ ' + resultado.mensaje + '\nüìÖ Se han programado ' + resultado.repasosCreados + ' repasos autom√°ticos');
        
        // Recargar detalle del d√≠a
        setTimeout(function() {
          cargarDetalleDiaCompletoMejorado(diaSeleccionado);
        }, 500);
      } else {
        alert('‚ùå Error al completar tema: ' + resultado.error);
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå FRONTEND: Error al completar tema:', error);
      alert('‚ùå Error de conexi√≥n al completar tema: ' + error.message);
    })
    .marcarTemaComoCompletado(idProgreso, parseInt(tiempoReal), nota || null);
}

// Validar orden consecutivo de temas
function validarOrdenConsecutivo(nodoSeleccionado, arbolCompleto) {
  // Buscar el nodo en el √°rbol completo para obtener contexto
  function encontrarNodoEnArbol(arbol, idBuscado) {
    for (let tema of arbol) {
      if (tema.id === idBuscado) return { nodo: tema, padre: null };
      
      if (tema.hijos && tema.hijos.length > 0) {
        const resultado = encontrarNodoEnArbol(tema.hijos, idBuscado);
        if (resultado.nodo) return { nodo: resultado.nodo, padre: tema };
      }
    }
    return { nodo: null, padre: null };
  }
  
  const { nodo, padre } = encontrarNodoEnArbol(arbolCompleto, nodoSeleccionado.id);
  
  if (!padre) return { esConsecutivo: true }; // Tema padre, no hay orden que validar
  
  // Obtener hermanos del mismo padre
  const hermanos = padre.hijos.sort((a, b) => {
    const numA = parseFloat((a.prenombre || '0').replace(/[^\d.]/g, ''));
    const numB = parseFloat((b.prenombre || '0').replace(/[^\d.]/g, ''));
    return numA - numB;
  });
  
  // Encontrar posici√≥n del nodo actual
  const posicionActual = hermanos.findIndex(h => h.id === nodoSeleccionado.id);
  
  // Verificar si hay hermanos anteriores sin completar/seleccionar
  const hermanosPreviosSinCompletar = [];
  for (let i = 0; i < posicionActual; i++) {
    const hermano = hermanos[i];
    const yaSeleccionado = temasSeleccionados.some(t => t.id === hermano.id);
    const completado = hermano.estado === 'completado';
    
    if (!yaSeleccionado && !completado) {
      hermanosPreviosSinCompletar.push(hermano);
    }
  }
  
  if (hermanosPreviosSinCompletar.length > 0) {
    return {
      esConsecutivo: false,
      mensaje: 'Te est√°s saltando el orden. Temas anteriores pendientes: ' + 
               hermanosPreviosSinCompletar.map(h => h.prenombre || h.nombre).join(', '),
      temasSaltados: hermanosPreviosSinCompletar
    };
  }
  
  return { esConsecutivo: true };
}

// ====================================
// FUNCIONES CON MANEJO DE ERRORES ROBUSTO
// A√±adir al final de scriptsPlanificacion.html
// ====================================

// Funci√≥n mejorada para cargar oposici√≥n activa
function cargarOposicionActivaSegura() {
  var contexto = 'cargarOposicionActiva';
  
  ejecutarSeguro(function() {
    var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
    if (contenedor) {
      mostrarLoading(contenedor, {
        mensaje: 'Cargando oposici√≥n activa...',
        tipo: 'overlay'
      });
    }
  }, 'mostrarLoadingOposicion');
  
  ejecutarConManejadorErrores(
    google.script.run.getOposicionActivaSegura,
    contexto,
    {
      successHandler: true,
      mensajeError: 'No se pudo cargar la oposici√≥n activa',
      reintentos: 2
    }
  ).then(function(oposicion) {
    ejecutarSeguro(function() {
      oposicionActiva = oposicion;
      
      var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
      if (contenedor) {
        ocultarLoading(contenedor);
      }
      
      console.log('Oposici√≥n activa cargada:', oposicion);
      
      if (oposicion) {
        mostrarExito('Oposici√≥n cargada: ' + oposicion.nombre, 'Configuraci√≥n lista');
        
        // Continuar con inicializaci√≥n
        inicializarCalendarioSeguro();
      } else {
        mostrarInfo('No hay oposici√≥n activa configurada');
        mostrarSelectorOposicion();
      }
    }, 'procesarResultadoOposicion');
    
  }).catch(function(errorInfo) {
    ejecutarSeguro(function() {
      var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
      if (contenedor) {
        ocultarLoading(contenedor);
      }
      
      // Mostrar interfaz de fallback
      mostrarSelectorOposicion();
    }, 'manejarErrorOposicion');
  });
}

// Funci√≥n mejorada para crear planificaci√≥n
function crearPlanificacionSegura() {
  var contexto = 'crearPlanificacion';
  
  return ejecutarSeguro(function() {
    // Validaciones del frontend
    var erroresValidacion = [];
    
    if (temasSeleccionados.length === 0) {
      erroresValidacion.push('Debes seleccionar al menos un tema');
    }
    
    if (!oposicionActiva || !oposicionActiva.id) {
      erroresValidacion.push('No hay oposici√≥n activa seleccionada');
    }
    
    if (!window.fechaPlanificacion) {
      erroresValidacion.push('Fecha de planificaci√≥n no v√°lida');
    }
    
    if (erroresValidacion.length > 0) {
      mostrarAdvertencia(erroresValidacion.join('\n'), 'Datos incompletos');
      return Promise.reject(new Error('Validaci√≥n fallida: ' + erroresValidacion.join(', ')));
    }
    
    // Preparar datos
    var datos = {
      fecha: window.fechaPlanificacion,
      idOposicion: oposicionActiva.id,
      tiempoPrevisto: tiempoTotalDisponible + (repasosDelDia?.length * 30 || 0),
      tiempoRepasos: repasosDelDia?.length * 30 || 0,
      tiempoEstudio: tiempoTotalDisponible,
      temasSeleccionados: temasSeleccionados,
      numeroBloques: bloquesActivos.length
    };
    
    // Validar datos en el frontend
    validarDatos(datos, {
      fecha: { requerido: true, tipo: 'string' },
      idOposicion: { requerido: true },
      temasSeleccionados: { requerido: true }
    }, 'planificaci√≥n');
    
    return mostrarConfirmacion({
      titulo: 'Crear planificaci√≥n',
      mensaje: '¬øCrear planificaci√≥n para ' + datos.fecha + '?\n\n‚Ä¢ ' + datos.temasSeleccionados.length + ' temas\n‚Ä¢ ' + Math.round(datos.tiempoEstudio / 60 * 10) / 10 + 'h de estudio\n‚Ä¢ ' + datos.numeroBloques + ' bloques',
      icono: 'üìù',
      textoConfirmar: 'Crear Planificaci√≥n',
      textoCancelar: 'Revisar',
      tipo: 'normal'
    }).then(function(confirmar) {
      if (!confirmar) {
        return Promise.reject(new Error('Cancelado por el usuario'));
      }
      
      // Mostrar loading en modal
      var modal = document.querySelector('.contenedor-administracion-modal') || 
                 document.getElementById('modalNuevaPlanificacion');
      
      if (modal) {
        mostrarLoading(modal, {
          mensaje: 'Creando planificaci√≥n...',
          tipo: 'overlay'
        });
      }
      
      // Ejecutar con manejo de errores robusto
      return ejecutarConManejadorErrores(
        google.script.run.addPlanificacionSegura,
        contexto,
        {
          parametros: [datos],
          successHandler: true,
          mensajeError: 'No se pudo crear la planificaci√≥n',
          reintentos: 1 // Solo 1 reintento para operaciones de escritura
        }
      ).then(function(resultado) {
        if (modal) {
          ocultarLoading(modal);
        }
        
        mostrarExito(
          'Planificaci√≥n creada con ' + resultado.temasCreados + ' temas',
          'üéâ ¬°Planificaci√≥n lista!'
        );
        
        // Limpiar y cerrar
        cerrarModal();
        cargarPlanificacionesDelMesSegura();
        seleccionarDia(diaSeleccionado);
        
        return resultado;
        
      }).catch(function(errorInfo) {
        if (modal) {
          ocultarLoading(modal);
        }
        throw errorInfo;
      });
    });
    
  }, contexto, Promise.reject(new Error('Error en validaci√≥n inicial')));
}

// Funci√≥n segura para cargar √°rbol de temas
function cargarArbolTemasSeguro() {
  const contenedor = document.getElementById('arbolTemas');
  
  if (!contenedor) {
    console.error('‚ùå Contenedor arbolTemas no encontrado');
    return;
  }
  
  if (!oposicionActiva) {
    contenedor.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 40px;"><h6>‚ùå No hay oposici√≥n activa</h6><p>Configura una oposici√≥n antes de continuar</p></div>';
    return;
  }
  
  // Mostrar loading
  contenedor.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner loading-spinner-large"></div><p>Cargando temas...</p></div>';
  
  // Llamar al backend de forma segura
  google.script.run
    .withSuccessHandler(function(data) {
      console.log('‚úÖ Temas cargados:', data);
      
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;"><h6>üì≠ Sin temas</h6><p>No hay temas vinculados a esta oposici√≥n</p></div>';
        return;
      }
      
      // Renderizar √°rbol
      renderizarArbolBasico(data.arbol, data.bloques || {});
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error al cargar temas:', error);
      
      contenedor.innerHTML = 
        '<div style="text-align: center; color: #dc3545; padding: 40px;">' +
        '<h6>‚ùå Error al cargar temas</h6>' +
        '<p>' + (error.message || 'Error de conexi√≥n') + '</p>' +
        '<button onclick="cargarArbolTemasSeguro()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîÑ Reintentar</button>' +
        '</div>';
    })
    .getArbolTemasConEstados(oposicionActiva.id, tiempoTotalDisponible);
}

// Funci√≥n b√°sica para renderizar √°rbol (sin complicaciones)
function renderizarArbolBasico(arbolTemas, bloquesInfo) {
  const contenedor = document.getElementById('arbolTemas');
  
  if (!arbolTemas || arbolTemas.length === 0) {
    contenedor.innerHTML = '<p style="text-align: center; color: #666;">No hay temas disponibles</p>';
    return;
  }
  
  let html = '<div style="padding: 10px;">';
  
  // Renderizar temas de forma simple
  arbolTemas.forEach(function(tema, index) {
    html += renderizarTemaB√°sico(tema, 0);
  });
  
  html += '</div>';
  contenedor.innerHTML = html;
  
  console.log('‚úÖ √Årbol de temas renderizado');
}

// Renderizar tema b√°sico
function renderizarTemaB√°sico(tema, nivel) {
  const margen = nivel * 20;
  let html = '';
  
  html += '<div style="margin-left: ' + margen + 'px; margin-bottom: 8px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px; background: white;">';
  
  // Checkbox solo si es seleccionable
  if (tema.seleccionable || tema.seleccionablePadre) {
    const yaSeleccionado = temasSeleccionados.some(t => t.id === tema.id);
    
    html += '<label style="display: flex; align-items: center; cursor: pointer;">';
    html += '<input type="checkbox" ';
    html += 'onchange="toggleSeleccionBasica(this, ' + tema.id + ', ' + tema.tiempoMinutos + ')" ';
    html += (yaSeleccionado ? 'checked ' : '');
    html += 'style="margin-right: 10px;"> ';
    html += '<div>';
    html += '<div style="font-weight: bold;">' + tema.nombreCompleto + '</div>';
    if (tema.tiempoTexto) {
      html += '<small style="color: #666;">' + tema.tiempoTexto + '</small>';
    }
    html += '</div>';
    html += '</label>';
  } else {
    html += '<div style="color: #999;">';
    html += '<div style="font-weight: bold;">' + tema.nombreCompleto + '</div>';
    html += '<small>Estado: ' + tema.estado + '</small>';
    html += '</div>';
  }
  
  html += '</div>';
  
  // Renderizar hijos si existen
  if (tema.hijos && tema.hijos.length > 0) {
    tema.hijos.forEach(function(hijo) {
      html += renderizarTemaB√°sico(hijo, nivel + 1);
    });
  }
  
  return html;
}

// Funci√≥n b√°sica para toggle de selecci√≥n
function toggleSeleccionBasica(checkbox, idTema, tiempoMinutos) {
  if (checkbox.checked) {
    // Validar tiempo disponible
    if (tiempoUsado + tiempoMinutos > tiempoTotalDisponible) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è No hay tiempo suficiente para este tema');
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos
    });
    
    tiempoUsado += tiempoMinutos;
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
    }
  }
  
  actualizarResumenTiempo();
}

// Funci√≥n mejorada para cargar planificaciones del mes
function cargarPlanificacionesDelMesSegura() {
  var contexto = 'cargarPlanificacionesDelMes';
  
  return ejecutarSeguro(function() {
    var a√±o = mesActual.getFullYear();
    var mes = mesActual.getMonth();
    
    // Mostrar loading en calendario
    mostrarLoadingCalendario();
    
    return ejecutarConManejadorErrores(
      google.script.run.getPlanificacionesDelMes,
      contexto,
      {
        parametros: [a√±o, mes],
        successHandler: true,
        mensajeError: 'No se pudieron cargar las planificaciones del mes',
        reintentos: 2
      }
    ).then(function(planificaciones) {
      // Restaurar calendario y mostrar planificaciones
      renderizarCalendario();
      
      if (planificaciones && planificaciones.length > 0) {
        mostrarPlanificacionesEnCalendario(planificaciones);
      }
      
    }).catch(function(errorInfo) {
      // Restaurar calendario aunque haya error
      renderizarCalendario();
      
      // Mostrar mensaje de error discreto en el calendario
      var calendario = document.getElementById('calendario');
      if (calendario) {
        var errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'text-align: center; color: #dc3545; font-size: 12px; margin-top: 10px;';
        errorDiv.innerHTML = 'Error al cargar planificaciones. <a href="#" onclick="cargarPlanificacionesDelMesSegura(); this.parentElement.remove();">Reintentar</a>';
        calendario.appendChild(errorDiv);
      }
    });
    
  }, contexto, Promise.reject(new Error('Error al inicializar carga de planificaciones')));
}

// Funci√≥n mejorada para inicializar calendario
function inicializarCalendarioSeguro() {
  return ejecutarSeguro(function() {
    renderizarCalendario();
    return cargarPlanificacionesDelMesSegura();
  }, 'inicializarCalendario');
}

// Funci√≥n wrapper para operaciones de UI cr√≠ticas
function ejecutarOperacionUI(operacion, contexto, valorPorDefecto) {
  return ejecutarSeguro(function() {
    return operacion();
  }, 'UI-' + contexto, valorPorDefecto);
}

// Funci√≥n de recuperaci√≥n para errores cr√≠ticos
function recuperarAplicacion() {
  ejecutarSeguro(function() {
    console.log('üîÑ Iniciando recuperaci√≥n de aplicaci√≥n...');
    
    // Limpiar estados
    oposicionActiva = null;
    temasSeleccionados = [];
    bloquesActivos = [];
    tiempoUsado = 0;
    
    // Ocultar todos los loading
    var loadingElements = document.querySelectorAll('.loading-overlay, .btn-loading, .select-loading');
    loadingElements.forEach(function(el) {
      if (el.classList.contains('loading-overlay')) {
        el.remove();
      } else {
        el.classList.remove('btn-loading', 'select-loading');
      }
    });
    
    // Reinicializar
    mostrarInfo('Reiniciando aplicaci√≥n...', 'Recuperaci√≥n');
    setTimeout(function() {
      inicializarSeccionPlanificacion();
    }, 1000);
    
  }, 'recuperarAplicacion');
}

// Funci√≥n para reportar problema al usuario
function reportarProblema() {
  var timestamp = new Date().toISOString();
  var info = {
    timestamp: timestamp,
    url: window.location.href,
    userAgent: navigator.userAgent,
    oposicionActiva: oposicionActiva ? oposicionActiva.id : 'ninguna'
  };
  
  mostrarInfo(
    'ID del reporte: ' + timestamp + '\n\nIncluye este ID si contactas con soporte.',
    'Informaci√≥n para soporte'
  );
  
  // Enviar reporte autom√°tico
  enviarLogError({
    contexto: 'reporteUsuario',
    mensaje: 'Usuario report√≥ problema',
    timestamp: timestamp,
    datos: info
  });
}

console.log('‚úÖ Funciones con manejo de errores robusto cargadas');

// ====================================
// MEJORAS RESPONSIVE ESPEC√çFICAS PARA PLANIFICACI√ìN
// A√±adir al final de scriptsPlanificacion.html
// ====================================

/*
// Funci√≥n mejorada para abrir modal de planificaci√≥n
function nuevaPlanificacionResponsive() {
  if (!diaSeleccionado) {
    mostrarAdvertencia('Primero selecciona un d√≠a del calendario', 'D√≠a no seleccionado');
    return;
  }
  
  if (!oposicionActiva) {
    mostrarError('Debes tener una oposici√≥n activa', 'Configuraci√≥n incompleta');
    return;
  }
  
  // Validar que no es d√≠a pasado
  var fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado);
  var hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada < hoy) {
    mostrarAdvertencia('No puedes crear planificaciones para d√≠as pasados', 'Fecha no v√°lida');
    return;
  }
  
  // Resetear estado
  resetearEstadoPlanificacion();
  
  // Establecer fecha
  var fechaStr = fechaSeleccionada.getFullYear() + '-' + 
    String(fechaSeleccionada.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fechaSeleccionada.getDate()).padStart(2, '0');
  window.fechaPlanificacion = fechaStr;
  
  // Mostrar modal
  var modal = document.getElementById('modalNuevaPlanificacion');
  if (modal) {
    modal.style.display = 'flex';
    
    // Optimizar para m√≥vil si es necesario
    if (typeof optimizarModalMovil === 'function') {
      optimizarModalMovil(modal);
    }
    
    // Configurar responsive espec√≠fico
    configurarModalPlanificacionResponsive(modal);
  }
  
  mostrarPaso(1);
}
*/


// Configurar modal espec√≠ficamente para planificaci√≥n responsive
function configurarModalPlanificacionResponsive(modal) {
  if (!modal) return;
  
  // Si es m√≥vil, ajustar el modal
  if (typeof esMobile === 'function' && esMobile()) {
    // Ajustar altura seg√∫n contenido
    ajustarAlturaModalMovil(modal);
    
    // Mejorar navegaci√≥n entre pasos
    mejorarNavegacionPasosMovil();
    
    // Optimizar √°rbol de temas para t√°ctil
    setTimeout(function() {
      optimizarArbolTemasMovil();
    }, 500);
  }
  
  // Configurar cierre responsivo
  configurarCierreModalResponsive(modal);
}

// Ajustar altura del modal en m√≥vil seg√∫n el paso
function ajustarAlturaModalMovil(modal) {
  if (!modal) return;
  
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
        var pasoVisible = modal.querySelector('.paso-modal[style*="block"]');
        if (pasoVisible) {
          ajustarAlturaSegunPaso(modal, pasoVisible);
        }
      }
    });
  });
  
  // Observar cambios en los pasos
  var pasos = modal.querySelectorAll('.paso-modal');
  pasos.forEach(function(paso) {
    observer.observe(paso, { attributes: true, attributeFilter: ['style'] });
  });
}

// Ajustar altura seg√∫n el paso actual
function ajustarAlturaSegunPaso(modal, pasoVisible) {
  if (!pasoVisible || !typeof esMobile === 'function' || !esMobile()) return;
  
  var alturaContenido = pasoVisible.scrollHeight;
  var alturaModal = modal.scrollHeight;
  var alturaVentana = window.innerHeight;
  
  // Si el contenido es muy alto, permitir scroll interno
  if (alturaContenido > alturaVentana * 0.7) {
    modal.style.height = '85vh';
    pasoVisible.style.maxHeight = '60vh';
    pasoVisible.style.overflowY = 'auto';
  } else {
    modal.style.height = 'auto';
    modal.style.maxHeight = '90vh';
    pasoVisible.style.maxHeight = 'none';
    pasoVisible.style.overflowY = 'visible';
  }
}

// Mejorar navegaci√≥n entre pasos en m√≥vil
function mejorarNavegacionPasosMovil() {
  if (!typeof esMobile === 'function' || !esMobile()) return;
  
  var indicadores = document.querySelectorAll('.indicadores-pasos [id^="indicadorPaso"]');
  indicadores.forEach(function(indicador, index) {
    // Hacer indicadores m√°s t√°ctiles
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(indicador);
    }
    
    // A√±adir navegaci√≥n t√°ctil
    indicador.style.cursor = 'pointer';
    indicador.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.95)';
    });
    
    indicador.addEventListener('touchend', function() {
      this.style.transform = '';
    });
  });
}

// Optimizar √°rbol de temas para dispositivos t√°ctiles
function optimizarArbolTemasMovil() {
  if (!typeof esMobile === 'function' || !esMobile()) return;
  
  var arbolTemas = document.getElementById('arbolTemas');
  if (!arbolTemas) return;
  
  // Mejorar checkboxes para t√°ctil
  var checkboxes = arbolTemas.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(function(checkbox) {
    // √Årea de toque m√°s grande
    var label = checkbox.closest('div');
    if (label) {
      label.style.minHeight = '44px';
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.padding = '8px';
      label.style.margin = '2px 0';
      label.style.borderRadius = '5px';
      label.style.transition = 'background-color 0.2s';
      
      // Feedback visual
      label.addEventListener('touchstart', function() {
        this.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
      });
      
      label.addEventListener('touchend', function() {
        var self = this;
        setTimeout(function() {
          self.style.backgroundColor = '';
        }, 150);
      });
    }
    
    // Hacer checkbox m√°s grande
    checkbox.style.transform = 'scale(1.3)';
    checkbox.style.marginRight = '12px';
  });
  
  // Mejorar expansi√≥n/colapso de secciones
  var bloqueHeaders = arbolTemas.querySelectorAll('.bloque-header, .tema-padre');
  bloqueHeaders.forEach(function(header) {
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(header);
    }
  });
}

// Configurar cierre responsive del modal
function configurarCierreModalResponsive(modal) {
  // Cerrar con swipe hacia abajo en m√≥vil
  if (typeof esMobile === 'function' && esMobile()) {
    var startY = 0;
    var currentY = 0;
    var modalContent = modal.querySelector('.confirmacion-modal') || modal.firstElementChild;
    
    if (modalContent) {
      modalContent.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
      });
      
      modalContent.addEventListener('touchmove', function(e) {
        currentY = e.touches[0].clientY;
        var diffY = currentY - startY;
        
        // Solo permitir swipe hacia abajo desde la parte superior
        if (diffY > 0 && startY < 100) {
          modalContent.style.transform = 'translateY(' + Math.min(diffY, 100) + 'px)';
          modalContent.style.opacity = Math.max(0.5, 1 - (diffY / 200));
        }
      });
      
      modalContent.addEventListener('touchend', function() {
        var diffY = currentY - startY;
        
        if (diffY > 80) {
          // Cerrar modal
          cerrarModal();
        } else {
          // Volver a posici√≥n original
          modalContent.style.transform = '';
          modalContent.style.opacity = '';
        }
      });
    }
  }
}
/*
// Funci√≥n mejorada para mostrar paso con optimizaciones responsive
function mostrarPasoResponsive(numeroPaso) {
  pasoActual = numeroPaso;
  
  // Ocultar todos los pasos
  document.getElementById('paso1').style.display = 'none';
  document.getElementById('paso2').style.display = 'none';
  document.getElementById('paso3').style.display = 'none';
  
  // Mostrar paso actual
  var pasoActual = document.getElementById('paso' + numeroPaso);
  pasoActual.style.display = 'block';
  
  // Actualizar indicadores
  if (typeof actualizarIndicadoresPasos === 'function') {
    actualizarIndicadoresPasos();
  }
  
  // Actualizar botones
  var btnAnterior = document.getElementById('btnAnterior');
  var btnSiguiente = document.getElementById('btnSiguiente');
  
  if (btnAnterior) {
    btnAnterior.style.display = numeroPaso > 1 ? 'inline-block' : 'none';
  }
  
  if (btnSiguiente) {
    btnSiguiente.textContent = numeroPaso === 3 ? 'Crear Planificaci√≥n' : 'Siguiente ‚ñ∂';
  }
  
  // Optimizaciones espec√≠ficas por paso
  setTimeout(function() {
    if (numeroPaso === 1) {
      optimizarPaso1Responsive();
    } else if (numeroPaso === 2) {
      optimizarPaso2Responsive();
    } else if (numeroPaso === 3) {
      optimizarPaso3Responsive();
      optimizarArbolTemasMovil();
    }
    
    // Ajustar altura del modal
    var modal = document.getElementById('modalNuevaPlanificacion');
    if (modal) {
      ajustarAlturaSegunPaso(modal, pasoActual);
    }
  }, 100);
}
*/


// Optimizaciones espec√≠ficas para cada paso
function optimizarPaso1Responsive() {
  var inputs = document.querySelectorAll('#paso1 input, #paso1 select');
  inputs.forEach(function(input) {
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(input);
    }
  });
}

function optimizarPaso2Responsive() {
  var inputs = document.querySelectorAll('#paso2 input, #paso2 select');
  inputs.forEach(function(input) {
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(input);
    }
  });
  
  // Mejorar controles de tiempo en m√≥vil
  var horasInput = document.getElementById('horasEstudio');
  if (horasInput && typeof esMobile === 'function' && esMobile()) {
    horasInput.setAttribute('inputmode', 'decimal');
    horasInput.style.fontSize = '18px';
  }
}

function optimizarPaso3Responsive() {
  var resumenTiempo = document.querySelector('.resumen-tiempo');
  if (resumenTiempo && typeof esMobile === 'function' && esMobile()) {
    // Hacer m√°s t√°ctil el resumen
    resumenTiempo.style.fontSize = '16px';
    resumenTiempo.style.padding = '15px';
  }
}

/*
// Funci√≥n para optimizar renderizado del calendario en m√≥vil
function renderizarCalendarioResponsive() {
  // Llamar a la funci√≥n original
  if (typeof renderizarCalendario === 'function') {
    renderizarCalendario();
  }
  
  // Aplicar optimizaciones m√≥viles
  setTimeout(function() {
    if (typeof optimizarCalendarioMovil === 'function') {
      optimizarCalendarioMovil();
    }
  }, 100);
}

// Sobrescribir funciones originales si existen
if (typeof nuevaPlanificacion === 'function') {
  var nuevaPlanificacionOriginal = nuevaPlanificacion;
  nuevaPlanificacion = nuevaPlanificacionResponsive;
}

if (typeof mostrarPaso === 'function') {
  var mostrarPasoOriginal = mostrarPaso;
  mostrarPaso = mostrarPasoResponsive;
}

if (typeof renderizarCalendario === 'function') {
  var renderizarCalendarioOriginal = renderizarCalendario;
  //renderizarCalendario = renderizarCalendarioResponsive;
}
*/
console.log('‚úÖ Mejoras responsive para planificaci√≥n cargadas');

// ====================================
// CALENDARIO B√ÅSICO QUE FUNCIONA
// A√±adir al final de scriptsPlanificacion.html
// ====================================

// Funci√≥n configurarCalendario() b√°sica
function configurarCalendario() {
  console.log('Configurando calendario b√°sico...');
  renderizarCalendarioBasico();
  cargarPlanificacionesDelMes();
}

// Funci√≥n renderizarCalendario() b√°sica (sin bucles)
function renderizarCalendarioBasico() {
  var calendarioDiv = document.getElementById('calendario');
  if (!calendarioDiv) {
    console.warn('Elemento calendario no encontrado');
    return;
  }
  
  var a√±o = mesActual.getFullYear();
  var mes = mesActual.getMonth();
  
  // Actualizar t√≠tulo
  var tituloMes = document.getElementById('tituloMes');
  if (tituloMes) {
    var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    tituloMes.textContent = meses[mes] + ' ' + a√±o;
  }
  
  // Generar calendario
  var primerDia = new Date(a√±o, mes, 1).getDay();
  primerDia = primerDia === 0 ? 6 : primerDia - 1;
  
  var diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
  var hoy = new Date();
  
  var html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
  
  // Encabezados de d√≠as
  var diasSemana = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
  diasSemana.forEach(function(dia) {
    html += '<div style="text-align: center; font-weight: bold; padding: 8px; color: #666; font-size: 12px;">' + dia + '</div>';
  });
  
  // D√≠as vac√≠os al inicio
  for (var i = 0; i < primerDia; i++) {
    html += '<div></div>';
  }
  
  // D√≠as del mes
  for (var dia = 1; dia <= diasEnMes; dia++) {
    var fecha = new Date(a√±o, mes, dia);
    var esHoy = fecha.toDateString() === hoy.toDateString();
    var esSeleccionado = diaSeleccionado === dia;
    
    var estilos = 'min-height: 80px; border: 1px solid #ddd; border-radius: 5px; padding: 5px; cursor: pointer; ';
    estilos += 'display: flex; flex-direction: column; justify-content: space-between; ';
    
    if (esHoy) {
      estilos += 'border: 2px solid #2196f3; background: #e3f2fd; ';
    } else if (esSeleccionado) {
      estilos += 'background: #f0f0f0; ';
    } else {
      estilos += 'background: white; ';
    }
    
      html += '<div onclick="seleccionarDia(' + dia + ')" style="' + estilos + '">';
      html += '<div style="font-weight: bold; color: ' + (esHoy ? '#2196f3' : '#333') + ';">' + dia + '</div>';
      html += '<div id="contenido-' + a√±o + '-' + mes + '-' + dia + '" style="font-size: 10px; flex: 1;"></div>';
      html += '</div>';
  }
  
  html += '</div>';
  calendarioDiv.innerHTML = html;
  
  console.log('Calendario renderizado correctamente');
}

// Reemplazar renderizarCalendario con la versi√≥n b√°sica
if (typeof renderizarCalendario !== 'undefined') {
  // No sobrescribir, usar alias
  renderizarCalendario = renderizarCalendarioBasico;
} else {
  // Crear nueva
  function renderizarCalendario() {
    renderizarCalendarioBasico();
  }
}

function irAHoy() {
  const hoy = new Date();
  const diaHoy = hoy.getDate();
  const mesHoy = hoy.getMonth();
  const a√±oHoy = hoy.getFullYear();
  
  const yaEnMesActual = (mesActual.getFullYear() === a√±oHoy && mesActual.getMonth() === mesHoy);
  const yaEnDiaHoy = (estadoDetalle.diaActual === diaHoy && 
                      estadoDetalle.mesActual === mesHoy && 
                      estadoDetalle.a√±oActual === a√±oHoy);
  
  // ‚úÖ VERIFICACIONES INTELIGENTES
  if (yaEnMesActual && yaEnDiaHoy) {
    console.log('üìç Ya est√°s en el d√≠a de hoy');
    alert('üìÖ Ya est√°s visualizando el d√≠a de hoy');
    return; // ‚úÖ NO HACER NADA
  }
  
  if (yaEnMesActual && !yaEnDiaHoy) {
    console.log('üìç Ya en mes actual, solo cambiar d√≠a');
    // Solo cambiar d√≠a, sin recargar calendario
    seleccionarDia(diaHoy);
    return;
  }
  
  // ‚úÖ CAMBIO DE MES NECESARIO
  console.log('üìÖ Cambiando a mes actual y d√≠a hoy');
  mesActual = new Date(a√±oHoy, mesHoy, 1); // Primer d√≠a del mes actual
  
  // Mostrar loading
  mostrarLoadingEnCalendario();
  renderizarCalendario();
  cargarTodoElMes();
  
  // Seleccionar hoy despu√©s de cargar
  setTimeout(function() {
    seleccionarDia(diaHoy);
  }, 500);
}

function limpiarDetalleDia() {
  var detalle = document.getElementById('contenidoDetalleDia');
  if (detalle) {
    detalle.innerHTML = 
      '<p style="text-align: center; color: #666; padding: 40px 0;">' +
      '<i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br>' +
      'Selecciona un d√≠a del calendario</p>';
  }
  
  var titulo = document.getElementById('tituloDetalleDia');
  if (titulo) {
    titulo.textContent = 'Selecciona un d√≠a';
  }
}

console.log('‚úÖ Calendario b√°sico funcional cargado');

function testRepasosDesdeWeb() {
  console.log('üß™ Testeando repasos desde web...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('‚úÖ RESULTADO TEST REPASOS:', resultado);
      alert('TEST REPASOS:\n' + JSON.stringify(resultado, null, 2));
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå ERROR TEST REPASOS:', error);
      alert('ERROR: ' + error.message);
    })
    .testRepasosDelDia();
}

</script>
