
<script>
// scriptsPlanificacion.html - VERSI√ìN LIMPIA
// Variables globales
var mesActual = new Date();
var diaSeleccionado = null;
// Variables del modal
var pasoActual = 1;
var temasSeleccionados = [];
var tiempoTotalDisponible = 240; // minutos
var tiempoUsado = 0;
var bloquesActivos = [];
var configuracionActual = null;
var oposicionActiva = null;

// 1. Inicializar secci√≥n de planificaci√≥n
function inicializarSeccionPlanificacion() {
  console.log('Inicializando secci√≥n Planificaci√≥n...');
  cargarOposicionActiva();
}

// 2. Cargar oposici√≥n activa
function cargarOposicionActiva() {
  var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  if (contenedor) {
    contenedor.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner loading-spinner-large"></div><p>Cargando oposici√≥n activa...</p></div>';
  }
  
  google.script.run
    .withSuccessHandler(function(oposicion) {
      oposicionActiva = oposicion;
      console.log('Oposici√≥n activa cargada:', oposicion);
      
      // Mostrar interfaz b√°sica
      if (contenedor) {
        if (oposicion) {
          contenedor.innerHTML = 
            '<div style="background: #d4edda; padding: 20px; border-radius: 8px; text-align: center;">' +
            '<h3 style="margin: 0; color: #155724;">üìö ' + oposicion.nombre + '</h3>' +
            '<p style="margin: 10px 0 0 0; color: #155724;">Oposici√≥n activa cargada correctamente</p>' +
            '</div>';
          
          // Inicializar calendario b√°sico
          setTimeout(function() {
            if (typeof renderizarCalendario === 'function') {
              renderizarCalendario();
            }
            cargarPlanificacionesDelMes();
          }, 500);
          
        } else {
          contenedor.innerHTML = 
            '<div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">' +
            '<h3 style="margin: 0; color: #856404;">‚ö†Ô∏è Sin oposici√≥n activa</h3>' +
            '<p style="margin: 10px 0; color: #856404;">No hay ninguna oposici√≥n configurada como activa</p>' +
            '<button onclick="mostrarSelectorOposicion()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px;">Configurar Oposici√≥n</button>' +
            '</div>';
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposici√≥n activa:', error);
      
      if (contenedor) {
        contenedor.innerHTML = 
          '<div style="background: #f8d7da; padding: 20px; border-radius: 8px; text-align: center;">' +
          '<h3 style="margin: 0; color: #721c24;">‚ùå Error de conexi√≥n</h3>' +
          '<p style="margin: 10px 0; color: #721c24;">No se pudo cargar la oposici√≥n activa</p>' +
          '<button onclick="cargarOposicionActiva()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px;">Reintentar</button>' +
          '</div>';
      }
      
      mostrarError('No se pudo cargar la oposici√≥n activa');
    })
    .getOposicionActiva();
}

function mostrarSelectorOposicion() {
  var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  if (!contenedor) return;
  
  var html = '<div style="text-align: center; padding: 40px;">';
  html += '<h3>Selecciona una oposici√≥n para planificar</h3>';
  html += '<p style="color: #666; margin-bottom: 30px;">Solo puedes tener una oposici√≥n activa a la vez</p>';
  
  html += '<div style="max-width: 400px; margin: 0 auto;">';
  html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Oposici√≥n:</label>';
  html += '<select id="selectorOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
  html += '<option value="">-- Cargando oposiciones --</option>';
  html += '</select>';
  
  html += '<button onclick="establecerOposicionActiva()" ';
  html += 'style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">';
  html += 'Establecer como activa</button>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  cargarOposicionesDisponibles();
}

// 3. Mostrar p√°gina principal (VERSI√ìN CON COMPARACI√ìN)
function mostrarPaginaPrincipal() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  if (!oposicionActiva) {
    // No hay oposici√≥n activa - mostrar selector
    let html = '<div style="text-align: center; padding: 40px;">';
    html += '<h3>Selecciona una oposici√≥n para planificar</h3>';
    html += '<p style="color: #666; margin-bottom: 30px;">Solo puedes tener una oposici√≥n activa a la vez</p>';
    
    html += '<div style="max-width: 400px; margin: 0 auto;">';
    html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Oposici√≥n:</label>';
    html += '<select id="selectorOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
    html += '<option value="">-- Selecciona una oposici√≥n --</option>';
    html += '</select>';
    
    html += '<button onclick="establecerOposicionActiva()" ';
    html += 'style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">';
    html += 'Establecer como activa</button>';
    html += '</div>';
    html += '</div>';
    
    contenedor.innerHTML = html;
    cargarOposicionesDisponibles();
    
  } else {
    // Ya hay oposici√≥n activa
    let html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
    html += '<div>';
    html += '<h3 style="margin: 0; color: #007bff;">üìö ' + oposicionActiva.nombre + '</h3>';
    html += '<p style="margin: 5px 0 0 0; color: #666;">Oposici√≥n activa</p>';
    html += '</div>';
    html += '<div>';
    html += '<button onclick="cambiarOposicion()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 3px; margin-right: 10px;">Cambiar</button>';
    html += '<button id="btnCompararOposiciones" onclick="mostrarComparadorOposiciones()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 3px; margin-right: 10px;" disabled>';
    html += 'üîç Comparar</button>';
    html += '</div>';
    html += '</div>';
    
    contenedor.innerHTML = html;
    
    // Verificar si hay m√°s de una oposici√≥n para habilitar comparaci√≥n
    verificarOposicionesDisponibles();
  }
}

// 4. Cargar oposiciones disponibles
function cargarOposicionesDisponibles() {
  var select = document.getElementById('selectorOposicion');
  if (!select) return;
  
  select.innerHTML = '<option value="">-- Cargando oposiciones --</option>';
  select.disabled = true;
  
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      select.disabled = false;
      select.innerHTML = '<option value="">-- Selecciona una oposici√≥n --</option>';
      
      oposiciones.forEach(function(op) {
        var option = document.createElement('option');
        option.value = op.id;
        option.textContent = op.nombre;
        select.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      select.disabled = false;
      select.innerHTML = '<option value="">Error al cargar</option>';
      mostrarError('Error al cargar oposiciones');
    })
    .getOposicionesParaPlanificacion();
}

// 5. Establecer oposici√≥n activa
function establecerOposicionActiva() {
  var idOposicion = document.getElementById('selectorOposicion').value;
  
  if (!idOposicion) {
    mostrarAdvertencia('Selecciona una oposici√≥n antes de continuar');
    return;
  }
  
  var btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Configurando...';
  
  google.script.run
    .withSuccessHandler(function() {
      btn.disabled = false;
      btn.textContent = 'Establecer como activa';
      mostrarExito('Oposici√≥n establecida correctamente');
      
      // Recargar la secci√≥n
      setTimeout(function() {
        cargarOposicionActiva();
      }, 1000);
    })
    .withFailureHandler(function(error) {
      console.error('Error al establecer oposici√≥n activa:', error);
      btn.disabled = false;
      btn.textContent = 'Establecer como activa';
      mostrarError('No se pudo establecer la oposici√≥n activa');
    })
    .setOposicionActiva(idOposicion);
}

// 6. Cambiar oposici√≥n activa (VERSI√ìN CON CANCELAR)
function cambiarOposicion() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  let html = '<div style="text-align: center; padding: 40px;">';
  html += '<h3>Cambiar oposici√≥n activa</h3>';
  html += '<p style="color: #666; margin-bottom: 30px;">Actualmente: <strong>' + oposicionActiva.nombre + '</strong></p>';
  
  html += '<div style="max-width: 400px; margin: 0 auto;">';
  html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Nueva oposici√≥n:</label>';
  html += '<select id="selectorNuevaOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
  html += '<option value="">-- Selecciona una oposici√≥n --</option>';
  html += '</select>';
  
  html += '<div style="display: flex; gap: 10px; justify-content: center;">';
  html += '<button onclick="cancelarCambioOposicion()" ';
  html += 'style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Cancelar</button>';
  
  html += '<button onclick="confirmarCambioOposicion()" ';
  html += 'style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Cambiar</button>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  
  // Cargar oposiciones (excluyendo la actual)
  cargarOposicionesParaCambio();
}

// 7. Verificar si hay m√°s oposiciones para habilitar comparaci√≥n
function verificarOposicionesDisponibles() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const btnComparar = document.getElementById('btnCompararOposiciones');
      if (btnComparar && oposiciones.length > 1) {
        btnComparar.disabled = false;
        btnComparar.title = 'Comparar con otras oposiciones';
      }
    })
    .getOposicionesOrdenadas();
}

// 8. Mostrar comparador de oposiciones
function mostrarComparadorOposiciones() {
  mostrarAdvertencia('Pr√≥ximo paso: Implementar modal de comparaci√≥n');
}

// 9. Cargar oposiciones para cambio (excluyendo la actual)
function cargarOposicionesParaCambio() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const select = document.getElementById('selectorNuevaOposicion');
      
      oposiciones.forEach(function(op) {
        // Excluir la oposici√≥n actualmente activa
        if (op.id != oposicionActiva.id) {
          const option = document.createElement('option');
          option.value = op.id;
          option.textContent = op.nombre;
          select.appendChild(option);
        }
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      alert('Error al cargar oposiciones');
    })
    .getOposicionesOrdenadas();
}

// 10. Cancelar cambio de oposici√≥n
function cancelarCambioOposicion() {
  // Volver a mostrar la p√°gina principal con la oposici√≥n actual
  mostrarPaginaPrincipal();
}

// 11. Confirmar cambio de oposici√≥n
function confirmarCambioOposicion() {
  const idNuevaOposicion = document.getElementById('selectorNuevaOposicion').value;
  
  if (!idNuevaOposicion) {
    mostrarAdvertencia('Selecciona una nueva oposici√≥n');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function() {
      mostrarExito('Oposici√≥n cambiada correctamente', 'üîÑ Actualizado');
      cargarOposicionActiva();
    })
    .withFailureHandler(function(error) {
      console.error('Error al cambiar oposici√≥n:', error);
      mostrarError('Error al cambiar oposici√≥n', 'Error de conexi√≥n');
    })
    .setOposicionActiva(idNuevaOposicion);
}

// Renderizar calendario
if (typeof renderizarCalendario === 'undefined') {
  function renderizarCalendario() {
    var calendarioDiv = document.getElementById('calendario');
    if (!calendarioDiv) {
      console.warn('Elemento calendario no encontrado');
      return;
    }
    
    var a√±o = mesActual.getFullYear();
    var mes = mesActual.getMonth();
    
    // Actualizar t√≠tulo si existe
    var tituloMes = document.getElementById('tituloMes');
    if (tituloMes) {
      var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      tituloMes.textContent = meses[mes] + ' ' + a√±o;
    }
    
    // Calendario b√°sico (simplificado)
    var primerDia = new Date(a√±o, mes, 1).getDay();
    primerDia = primerDia === 0 ? 6 : primerDia - 1;
    
    var diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
    var hoy = new Date();
    
    var html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 12px;">';
    
    // Encabezados
    var diasSemana = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
    diasSemana.forEach(function(dia) {
      html += '<div style="text-align: center; font-weight: bold; padding: 8px; color: #666;">' + dia + '</div>';
    });
    
    // D√≠as vac√≠os
    for (var i = 0; i < primerDia; i++) {
      html += '<div></div>';
    }
    
    // D√≠as del mes
    for (var dia = 1; dia <= diasEnMes; dia++) {
      var fecha = new Date(a√±o, mes, dia);
      var esHoy = fecha.toDateString() === hoy.toDateString();
      var esSeleccionado = diaSeleccionado === dia;
      
      var estilos = 'min-height: 50px; border: 1px solid #ddd; border-radius: 3px; padding: 5px; cursor: pointer; ';
      estilos += 'display: flex; flex-direction: column; justify-content: space-between; ';
      
      if (esHoy) {
        estilos += 'border: 2px solid #007bff; background: #e3f2fd; ';
      } else if (esSeleccionado) {
        estilos += 'background: #f0f0f0; ';
      } else {
        estilos += 'background: white; ';
      }
      
      html += '<div onclick="seleccionarDia(' + dia + ')" style="' + estilos + '">';
      html += '<div style="font-weight: bold; color: ' + (esHoy ? '#007bff' : '#333') + ';">' + dia + '</div>';
      html += '<div id="contenido-' + a√±o + '-' + mes + '-' + dia + '" style="font-size: 8px; flex: 1;"></div>';
      html += '</div>';
    }
    
    html += '</div>';
    calendarioDiv.innerHTML = html;
  }
}


// Cambiar mes
function cambiarMes(direccion) {
  mesActual.setMonth(mesActual.getMonth() + direccion);
  diaSeleccionado = null; // Reset selecci√≥n
  renderizarCalendario();
  limpiarDetalleDia();
}

// Ir a hoy
function irAHoy() {
  mesActual = new Date();
  renderizarCalendario();
  seleccionarDia(new Date().getDate());
}

// Seleccionar d√≠a
function seleccionarDia(dia) {
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  const esDiaPasado = fechaSeleccionada < hoy;
  
  diaSeleccionado = dia;
  renderizarCalendario(); // Re-renderizar para mostrar selecci√≥n
  
  // Actualizar detalle del d√≠a
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const tituloFecha = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
  
  if (esDiaPasado) {
    document.getElementById('tituloDetalleDia').textContent = tituloFecha + ' (Solo lectura)';
    document.getElementById('contenidoDetalleDia').innerHTML = 
      '<div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">' +
      '<strong>‚ÑπÔ∏è D√≠a pasado:</strong> Solo puedes consultar la informaci√≥n, no modificar.' +
      '</div>' +
      '<p style="color: #999;">Detalle del d√≠a en desarrollo...</p>';
  } else {
    document.getElementById('tituloDetalleDia').textContent = tituloFecha;
    document.getElementById('contenidoDetalleDia').innerHTML = 
      '<p style="color: #999;">D√≠a seleccionado: ' + dia + '. Detalle en desarrollo...</p>';
  }
}

// Limpiar detalle del d√≠a
function limpiarDetalleDia() {
  document.getElementById('tituloDetalleDia').textContent = 'Selecciona un d√≠a';
  document.getElementById('contenidoDetalleDia').innerHTML = '<p style="text-align: center; color: #666; padding: 40px 0;"><i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br>Selecciona un d√≠a del calendario</p>';
}

// Abrir modal de nueva planificaci√≥n
function nuevaPlanificacion() {
  if (!diaSeleccionado) {
    mostrarAdvertencia('Primero selecciona un d√≠a del calendario', 'D√≠a no seleccionado');
    return;
  }
  
  if (!oposicionActiva) {
    mostrarError('Debes tener una oposici√≥n activa', 'Configuraci√≥n incompleta');
    return;
  }
  
  // Validar que no es d√≠a pasado
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada < hoy) {
    mostrarAdvertencia('No puedes crear planificaciones para d√≠as pasados', 'Fecha no v√°lida');
    return;
  }
  
  // Resetear estado usando TUS variables
  resetearEstadoPlanificacion();
  
  // Establecer fecha autom√°ticamente usando TUS variables  
  const fechaStr = fechaSeleccionada.getFullYear() + '-' + 
    String(fechaSeleccionada.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fechaSeleccionada.getDate()).padStart(2, '0');

    // Cargar oposiciones
  cargarOposiciones();
  
  // Guardar fecha en variable global (crear si no existe)
  window.fechaPlanificacion = fechaStr;
  
  document.getElementById('modalNuevaPlanificacion').style.display = 'flex';
  mostrarPaso(1);

    // Verificar repasos del d√≠a seleccionado
  verificarRepasosDelDia();
}
  

async function validarPaso2() {
  const horasInput = document.getElementById('horasEstudio');
  const horas = parseFloat(horasInput.value);
  
  if (!horas || horas < 0.5) {
    mostrarAdvertencia('Introduce un tiempo de estudio v√°lido (m√≠nimo 0.5 horas)', 'Tiempo inv√°lido');
    horasInput.focus();
    return false;
  }
  
  if (horas > 12) {
    const confirmar = await mostrarConfirmacion({
      titulo: 'Tiempo de estudio muy alto',
      mensaje: `Has introducido ${horas} horas de estudio. ¬øEst√°s seguro de que es correcto?`,
      icono: '‚ö†Ô∏è',
      textoConfirmar: 'S√≠, continuar',
      textoCancelar: 'Corregir',
      tipo: 'normal'
    });
    
    if (!confirmar) {
      horasInput.focus();
      return false;
    }
  }
  
  // Guardar tiempos usando TUS variables
  tiempoTotalDisponible = horas * 60;
  
  // Crear variables para repasos si no existen
  if (typeof repasosDelDia === 'undefined') {
    window.repasosDelDia = [];
  }
  
  const tiempoRepasos = repasosDelDia.length * 30;
  const tiempoEstudioReal = Math.max(0, tiempoTotalDisponible - tiempoRepasos);
  
  // Actualizar variable global
  tiempoTotalDisponible = tiempoEstudioReal;
  
  return true;
}  

  
function resetearEstadoPlanificacion() {
  // Resetear todas las variables del modal
  pasoActual = 1;
  temasSeleccionados = [];
  tiempoTotalDisponible = 240; // 4 horas por defecto
  tiempoUsado = 0;
  bloquesActivos = [];
  
  // Variables que pueden no existir a√∫n (cr√©alas si las necesitas)
  if (typeof repasosDelDia === 'undefined') {
    window.repasosDelDia = [];
  } else {
    repasosDelDia = [];
  }
  
  if (typeof contadorAdvertencias === 'undefined') {
    window.contadorAdvertencias = {
      orden: {},
      bloques: {}
    };
  } else {
    contadorAdvertencias = {
      orden: {},
      bloques: {}
    };
  }
  
  console.log('Estado de planificaci√≥n reseteado');
}


// Cerrar modal
function cerrarModal() {
  document.getElementById('modalNuevaPlanificacion').style.display = 'none';
}

// Mostrar paso espec√≠fico
function mostrarPaso(numeroPaso) {
  pasoActual = numeroPaso; // Usar TU variable
  
  // Ocultar todos los pasos
  document.getElementById('paso1').style.display = 'none';
  document.getElementById('paso2').style.display = 'none';
  document.getElementById('paso3').style.display = 'none';
  
  // Mostrar paso actual
  document.getElementById('paso' + numeroPaso).style.display = 'block';
  
  // Actualizar indicadores (si los tienes)
  actualizarIndicadoresPasos();
  
  // Actualizar botones
  document.getElementById('btnAnterior').style.display = numeroPaso > 1 ? 'inline-block' : 'none';
  document.getElementById('btnSiguiente').textContent = numeroPaso === 3 ? 'Crear Planificaci√≥n' : 'Siguiente ‚ñ∂';
  
  // Acciones espec√≠ficas por paso
  if (numeroPaso === 1) {
    mostrarPaso1();
  } else if (numeroPaso === 2) {
    mostrarPaso2();
  } else if (numeroPaso === 3) {
    mostrarPaso3();
  }
}

function mostrarPaso1() {
  // Por ahora vac√≠a, ya funciona lo b√°sico
  console.log('Paso 1 cargado');
}

function mostrarPaso2() {
  console.log('Paso 2 cargado');
}

function mostrarPaso3() {
  console.log('Paso 3 cargado');
}

function validarPaso1() {
  const fecha = document.getElementById('fechaPlanificacion')?.value;
  if (!fecha) {
    mostrarAdvertencia('Selecciona una fecha para continuar');
    return false;
  }
  window.fechaPlanificacion = fecha;
  return true;
}


// Actualizar indicadores de pasos
function actualizarIndicadoresPasos() {
  for (let i = 1; i <= 3; i++) {
    const indicador = document.getElementById('indicadorPaso' + i);
    const circulo = indicador.querySelector('div');
    const texto = indicador.querySelector('span');
    
    if (i < pasoActual) {
      // Paso completado
      circulo.style.background = '#28a745';
      circulo.style.color = 'white';
      texto.style.color = '#28a745';
    } else if (i === pasoActual) {
      // Paso actual
      circulo.style.background = '#007bff';
      circulo.style.color = 'white';
      texto.style.color = '#007bff';
    } else {
      // Paso pendiente
      circulo.style.background = '#ddd';
      circulo.style.color = '#999';
      texto.style.color = '#999';
    }
  }
}

// Paso siguiente
async function pasoSiguiente() {
  if (pasoActual === 1) {
    if (validarPaso1()) {
      mostrarPaso(2);
    }
  } else if (pasoActual === 2) {
    const valido = await validarPaso2();
    if (valido) {
      mostrarPaso(3);
    }
  } else if (pasoActual === 3) {
    await crearPlanificacion();
  }
}

// Paso anterior
function pasoAnterior() {
  if (pasoActual > 1) {
    mostrarPaso(pasoActual - 1);
  }
}

// Cargar oposiciones (conectado al backend)
function cargarOposiciones() {
  const select = document.getElementById('oposicionPlanificacion');
  select.innerHTML = '<option value="">-- Cargando oposiciones... --</option>';
  
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      select.innerHTML = '<option value="">-- Selecciona una oposici√≥n --</option>';
      
      oposiciones.forEach(function(oposicion) {
        const option = document.createElement('option');
        option.value = oposicion.id;
        option.textContent = oposicion.nombre;
        select.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      select.innerHTML = '<option value="">-- Error al cargar --</option>';
    })
    .getOposicionesParaPlanificacion();
}

// 8. FUNCI√ìN verificarRepasosDelDia() con loading
function verificarRepasosDelDia() {
  var fechaInput = document.getElementById('fechaPlanificacion');
  if (!fechaInput.value) return;
  
  // Loading inline en la secci√≥n de repasos
  var alertaDiv = document.getElementById('alertaRepasos');
  if (alertaDiv) {
    mostrarLoading(alertaDiv, {
      mensaje: 'Verificando repasos...',
      tipo: 'inline'
    });
  }
  
  var fechaMs = new Date(fechaInput.value + 'T00:00:00').getTime();
  
  google.script.run
    .withSuccessHandler(function(repasos) {
      if (typeof repasosDelDia === 'undefined') {
        window.repasosDelDia = [];
      }
      repasosDelDia = repasos || [];
      
      if (alertaDiv) {
        ocultarLoading(alertaDiv);
      }
      mostrarRepasosEnPaso1(repasos);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar repasos:', error);
      if (typeof repasosDelDia === 'undefined') {
        window.repasosDelDia = [];
      }
      repasosDelDia = [];
      
      if (alertaDiv) {
        ocultarLoading(alertaDiv);
      }
    })
    .getRepasosDelDia(fechaMs);
}

// Cargar configuraci√≥n actual (conectado al backend)
function cargarConfiguracionActual() {
  const idOposicion = document.getElementById('oposicionPlanificacion').value;
  if (!idOposicion) return;
  
  google.script.run
    .withSuccessHandler(function(config) {
      configuracionActual = config;
      
      document.getElementById('vueltaActual').textContent = config.vueltaActual;
      
      const minutosPorPagina = getMinutosPorPaginaLocal(config);
      document.getElementById('minutosPorPagina').textContent = minutosPorPagina;
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar configuraci√≥n:', error);
      // Valores por defecto
      document.getElementById('vueltaActual').textContent = '1';
      document.getElementById('minutosPorPagina').textContent = '30';
    })
    .getConfiguracionOposicion(idOposicion);
}

// Funci√≥n auxiliar para calcular minutos por p√°gina localmente
function getMinutosPorPaginaLocal(config) {
  switch (config.vueltaActual) {
    case 1: return config.minPorPagV1;
    case 2: return config.minPorPagV2;
    case 3: return config.minPorPagV3;
    default: return config.minPorPagV4;
  }
}

// Modificar actualizarTiempoDisponible para incluir repasos
function actualizarTiempoDisponible() {
  const horas = parseFloat(document.getElementById('horasEstudio').value) || 0;
  const tiempoEstudio = horas * 60;
  const tiempoRepasos = window.repasosDelDia ? window.repasosDelDia.length * 30 : 0;
  const tiempoTotal = tiempoEstudio + tiempoRepasos;
  
  tiempoTotalDisponible = tiempoEstudio; // Solo el tiempo de estudio para la planificaci√≥n
  
  document.getElementById('tiempoEstudio').textContent = tiempoEstudio + ' min';
  document.getElementById('tiempoTotalConRepasos').textContent = tiempoTotal + ' min';
  
  if (pasoActual === 3) {
    actualizarResumenTiempo();
  }
}

// Mostrar repasos en el paso 2
function mostrarRepasosEnPasoDos() {
  const infoDiv = document.getElementById('infoRepasosStepDos');
  const detalleDiv = document.getElementById('detalleRepasosStepDos');
  
  if (window.repasosDelDia && window.repasosDelDia.length > 0) {
    const tiempoRepasos = window.repasosDelDia.length * 30;
    
    let html = '<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">';
    html += '<div>';
    html += '<ul style="margin: 0; padding-left: 20px;">';
    window.repasosDelDia.forEach(function(repaso) {
      html += '<li>' + repaso.nombreTema + ' <span style="color: #856404;">(30 min)</span></li>';
    });
    html += '</ul>';
    html += '</div>';
    html += '<div style="text-align: center; background: #ffc107; color: white; padding: 10px; border-radius: 5px; min-width: 80px;">';
    html += '<div style="font-size: 20px; font-weight: bold;">' + tiempoRepasos + ' min</div>';
    html += '<div style="font-size: 12px;">Total</div>';
    html += '</div>';
    html += '</div>';
    
    detalleDiv.innerHTML = html;
    infoDiv.style.display = 'block';
    
    // Actualizar el c√°lculo de tiempo
    document.getElementById('tiempoRepasos').textContent = tiempoRepasos + ' min';
    actualizarTiempoDisponible();
  } else {
    infoDiv.style.display = 'none';
    document.getElementById('tiempoRepasos').textContent = '0 min';
    actualizarTiempoDisponible();
  }
}

// 5. FUNCI√ìN cargarArbolTemas() con loading espec√≠fico
function cargarArbolTemas() {
  var contenedor = document.getElementById('arbolTemas');
  
  if (!oposicionActiva) {
    contenedor.innerHTML = '<p style="color: red; text-align: center;">Error: No hay oposici√≥n activa</p>';
    return;
  }
  
  var tiempoDisponible = tiempoTotalDisponible;
  
  // Mostrar loading espec√≠fico para el √°rbol
  mostrarLoadingArbol();
  
  google.script.run
    .withSuccessHandler(function(data) {
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay temas vinculados a esta oposici√≥n</p>';
        return;
      }
      
      renderizarArbolTemas(data.arbol, data.bloques);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar √°rbol:', error);
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas: ' + error.message + '</p>';
    })
    .getArbolTemasConEstados(oposicionActiva.id, tiempoDisponible);
}

// Renderizar √°rbol agrupado por bloques (CORREGIDO)
function renderizarArbolPorBloques(arbolTemas, minutosPorPagina, bloquesInfo) {
  const contenedor = document.getElementById('arbolTemas');
  
  if (!arbolTemas || arbolTemas.length === 0) {
    contenedor.innerHTML = '<p style="text-align: center; color: #666;">No hay temas vinculados a esta oposici√≥n</p>';
    return;
  }
  
  // Agrupar temas por bloque (USANDO DATOS REALES)
  const temasPorBloque = agruparTemasPorBloque(arbolTemas, bloquesInfo);
  
  let html = '';
  
  // Renderizar cada bloque
  Object.keys(temasPorBloque).forEach(nombreBloque => {
    const temasDelBloque = temasPorBloque[nombreBloque];
    const esEspecial = esBloqueBloqueEspecial(nombreBloque);
    
    html += '<div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">';
    
    // Header del bloque (colapsable)
    html += '<div onclick="toggleBloque(\'' + nombreBloque + '\')" style="padding: 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">';
    html += '<div>';
    html += '<h6 style="margin: 0; font-weight: bold;">' + nombreBloque;
    if (esEspecial) {
      html += ' <span style="background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px;">ESPECIAL</span>';
    }
    html += '</h6>';
    html += '<small style="color: #666;">' + temasDelBloque.length + ' temas principales</small>';
    html += '</div>';
    html += '<i id="icono-' + nombreBloque + '" style="transition: transform 0.3s;">‚ñº</i>';
    html += '</div>';
    
    // Contenido del bloque (inicialmente visible)
    html += '<div id="bloque-' + nombreBloque + '" style="padding: 15px;">';
    
    // Renderizar cada tema del bloque
    temasDelBloque.forEach(tema => {
      html += renderizarNodoTema(tema, 0, nombreBloque);
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  contenedor.innerHTML = html;
}

// Agrupar temas por bloque (USANDO DATOS REALES)
function agruparTemasPorBloque(arbolTemas, bloquesInfo) {
  const temasPorBloque = {};
  
  arbolTemas.forEach(tema => {
    const idBloque = tema.idBloque;
    const nombreBloque = bloquesInfo[idBloque] || 'Sin Bloque';
    
    if (!temasPorBloque[nombreBloque]) {
      temasPorBloque[nombreBloque] = [];
    }
    
    temasPorBloque[nombreBloque].push(tema);
  });
  
  console.log('üìä Temas agrupados por bloque:', temasPorBloque);
  return temasPorBloque;
}

// Renderizar nodo de tema con checkbox padre/hijo
function renderizarNodoTema(nodo, nivel, nombreBloque) {
  const margenIzquierdo = nivel * 20;
  const iconoEstado = getIconoEstado(nodo.estado);
  const colorFondo = getColorFondo(nodo.estado);
  
  let html = '';
  
  // Contenedor del nodo
  html += '<div style="margin-left: ' + margenIzquierdo + 'px; margin-bottom: 8px;">';
  
  // Fila del tema
  html += '<div style="display: flex; align-items: center; padding: 10px; background: ' + colorFondo + '; border: 1px solid #e0e0e0; border-radius: 6px;">';
  
  // Checkbox (para hojas seleccionables O padres seleccionables)
  if (nodo.seleccionable || nodo.seleccionablePadre) {
    const yaSeleccionado = temasSeleccionados.some(t => t.id === nodo.id);
    const tipoSeleccion = nodo.seleccionablePadre ? 'padre' : 'hijo';
    
    html += '<input type="checkbox" ';
    html += 'onchange="toggleSeleccionTemaConValidacion(this, ' + nodo.id + ', ' + nodo.tiempoMinutos + ', \'' + nombreBloque + '\', \'' + tipoSeleccion + '\')" ';
    html += (yaSeleccionado ? 'checked ' : '');
    html += 'style="margin-right: 10px; transform: scale(1.2);" ';
    html += 'title="' + (nodo.seleccionablePadre ? 'Seleccionar tema completo (' + nodo.tiempoTexto + ')' : 'Seleccionar subtema') + '">';
  } else {
    html += '<span style="width: 24px; margin-right: 10px; text-align: center; font-size: 16px;">' + iconoEstado + '</span>';
  }
  
  // Contenido del tema
  html += '<div style="flex: 1;">';
  html += '<div style="font-weight: ' + (nivel === 0 ? 'bold' : 'normal') + '; color: ' + getColorTexto(nodo.estado) + ';">';
  html += nodo.nombreCompleto;
  html += '</div>';
  
  if (nodo.paginas > 0) {
    html += '<small style="color: #666; font-size: 11px;">';
    html += nodo.paginas + ' p√°gs ‚Ä¢ ' + nodo.tiempoTexto;
    html += '</small>';
  }
  html += '</div>';
  
  // Badge de estado
  html += '<div style="margin-left: 10px;">';
  html += '<span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ' + getColorBadge(nodo.estado) + '; color: white; font-weight: bold;">';
  html += getTextoEstado(nodo.estado);
  html += '</span>';
  html += '</div>';
  
  html += '</div>';
  
  // Renderizar hijos si existen
  if (nodo.hijos && nodo.hijos.length > 0) {
    nodo.hijos.forEach(hijo => {
      html += renderizarNodoTema(hijo, nivel + 1, nombreBloque);
    });
  }
  
  html += '</div>';
  
  return html;
}

// Toggle selecci√≥n con validaci√≥n de orden (FUNCI√ìN COMPLETA)
function toggleSeleccionTemaConValidacion(checkbox, idTema, tiempoMinutos, nombreBloque, tipoSeleccion) {
  if (checkbox.checked) {
    // Validar orden consecutivo
    const nodoSeleccionado = { id: idTema };
    const validacionOrden = validarOrdenConsecutivo(nodoSeleccionado, window.arbolCompletoGlobal);
    
    if (!validacionOrden.esConsecutivo) {
      const confirmar = confirm('‚ö†Ô∏è ' + validacionOrden.mensaje + '\n\n¬øQuieres continuar seleccionando este tema?');
      if (!confirmar) {
        checkbox.checked = false;
        return;
      }
    }
    
    // Validar l√≠mites normales
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque,
      tipo: tipoSeleccion
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
    // Mostrar mensaje informativo para temas padre
    if (tipoSeleccion === 'padre') {
      setTimeout(() => {
        alert('‚úÖ Tema padre seleccionado completo.\nSe estudiar√° todo el tema en ' + formatearTiempo(tiempoMinutos) + '.');
      }, 100);
    }
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Formatear tiempo localmente
function formatearTiempo(minutos) {
  if (!minutos || minutos <= 0) return '0m';
  
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;
  
  if (horas > 0) {
    return horas + 'h ' + mins + 'm';
  } else {
    return mins + 'm';
  }
}

// Funciones auxiliares para estilos
function getIconoEstado(estado) {
  switch (estado) {
    case 'completado': return '‚úÖ';
    case 'en_progreso': return 'üîÑ';
    default: return '‚≠ï';
  }
}

function getColorFondo(estado) {
  switch (estado) {
    case 'completado': return '#e8f5e9';
    case 'en_progreso': return '#fff3e0';
    default: return '#ffffff';
  }
}

function getColorTexto(estado) {
  switch (estado) {
    case 'completado': return '#2e7d32';
    case 'en_progreso': return '#ef6c00';
    default: return '#333333';
  }
}

function getColorBadge(estado) {
  switch (estado) {
    case 'completado': return '#4caf50';
    case 'en_progreso': return '#ff9800';
    default: return '#9e9e9e';
  }
}

function getTextoEstado(estado) {
  switch (estado) {
    case 'completado': return 'OK';
    case 'en_progreso': return 'PROG';
    default: return 'PEND';
  }
}

// Verificar si es bloque especial
function esBloqueBloqueEspecial(nombreBloque) {
  const nombre = nombreBloque.toLowerCase();
  return nombre.includes('geograf√≠a') || nombre.includes('geografia') || nombre.includes('callejero');
}

// Toggle colapsar bloque
function toggleBloque(nombreBloque) {
  const contenido = document.getElementById('bloque-' + nombreBloque);
  const icono = document.getElementById('icono-' + nombreBloque);
  
  if (contenido.style.display === 'none') {
    contenido.style.display = 'block';
    icono.textContent = '‚ñº';
  } else {
    contenido.style.display = 'none';
    icono.textContent = '‚ñ∂';
  }
}

// Toggle selecci√≥n de tema
function toggleSeleccionTema(checkbox, idTema, tiempoMinutos, nombreBloque) {
  if (checkbox.checked) {
    // Validar selecci√≥n
    const validacion = validarSeleccionTema(tiempoMinutos, nombreBloque);
    if (!validacion.valido) {
      checkbox.checked = false;
      alert('‚ö†Ô∏è ' + validacion.mensaje);
      return;
    }
    
    // Agregar tema
    temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque
    });
    
    if (!bloquesActivos.includes(nombreBloque)) {
      bloquesActivos.push(nombreBloque);
    }
    
    tiempoUsado += tiempoMinutos;
    
  } else {
    // Quitar tema
    const index = temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      const tema = temasSeleccionados[index];
      temasSeleccionados.splice(index, 1);
      tiempoUsado -= tema.tiempo;
      
      // Verificar si quitar bloque
      const masDelMismoBloque = temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

// Validar selecci√≥n de tema
function validarSeleccionTema(tiempoMinutos, nombreBloque) {
  // Calcular tiempo usando TUS variables
  const tiempoUsadoActual = temasSeleccionados.reduce((total, tema) => total + tema.tiempo, 0);
  
  // Validar tiempo
  if (tiempoUsadoActual + tiempoMinutos > tiempoTotalDisponible) {
    const exceso = tiempoUsadoActual + tiempoMinutos - tiempoTotalDisponible;
    mostrarAdvertencia(
      `Este tema excede el tiempo disponible por ${Math.round(exceso)} minutos`, 
      'Tiempo insuficiente'
    );
    return false;
  }
  
  // Validar l√≠mite de bloques usando TUS variables
  if (!bloquesActivos.includes(nombreBloque)) {
    if (bloquesActivos.length >= 3) {
      // Crear contador si no existe
      if (typeof contadorAdvertencias === 'undefined') {
        window.contadorAdvertencias = { orden: {}, bloques: {} };
      }
      
      const clave = 'limite_bloques_' + bloquesActivos.length;
      
      if (!contadorAdvertencias.bloques[clave]) {
        contadorAdvertencias.bloques[clave] = 0;
      }
      
      contadorAdvertencias.bloques[clave]++;
      
      if (contadorAdvertencias.bloques[clave] === 1) {
        mostrarAdvertencia(
          `Has alcanzado el l√≠mite recomendado de ${bloquesActivos.length} bloques activos. Se recomienda no mezclar m√°s bloques en una sesi√≥n.`,
          'L√≠mite de bloques'
        );
        return false;
      } else {
        mostrarAdvertencia(
          `Tienes ${bloquesActivos.length} bloques activos. Aunque no es recomendado, se permite continuar.`,
          'Advertencia de bloques'
        );
        return true;
      }
    }
  }
  
  return true;
}



// Actualizar resumen de tiempo
function actualizarResumenTiempo() {
  const tiempoRestante = tiempoTotalDisponible - tiempoUsado;
  
  document.getElementById('tiempoTotal').textContent = tiempoTotalDisponible;
  document.getElementById('tiempoSeleccionado').textContent = tiempoUsado;
  document.getElementById('tiempoRestante').textContent = tiempoRestante;
  document.getElementById('bloquesUsados').textContent = bloquesActivos.length + '/3';
  
  // Cambiar colores seg√∫n estado
  const elementoRestante = document.getElementById('tiempoRestante');
  if (tiempoRestante < 0) {
    elementoRestante.style.color = '#dc3545';
  } else if (tiempoRestante < 30) {
    elementoRestante.style.color = '#ffc107';
  } else {
    elementoRestante.style.color = '#28a745';
  }
}

// 6. FUNCI√ìN crearPlanificacion() con loading en modal
async function crearPlanificacion() {
  // Validaciones finales
  if (temasSeleccionados.length === 0) {
    mostrarAdvertencia('Debes seleccionar al menos un tema', 'Sin temas seleccionados');
    return;
  }
  
  // Recopilar datos
  var datos = {
    fecha: window.fechaPlanificacion || '',
    idOposicion: oposicionActiva.id,
    tiempoPrevisto: tiempoTotalDisponible + (repasosDelDia?.length * 30 || 0),
    tiempoRepasos: repasosDelDia?.length * 30 || 0,
    tiempoEstudio: tiempoTotalDisponible,
    temasSeleccionados: temasSeleccionados,
    numeroBloques: bloquesActivos.length
  };
  
  // Confirmar creaci√≥n
  var confirmar = await mostrarConfirmacion({
    titulo: 'Crear planificaci√≥n',
    mensaje: '¬øCrear planificaci√≥n para ' + datos.fecha + '?\n\n‚Ä¢ ' + datos.temasSeleccionados.length + ' temas\n‚Ä¢ ' + Math.round(datos.tiempoEstudio / 60 * 10) / 10 + 'h de estudio\n‚Ä¢ ' + datos.numeroBloques + ' bloques',
    icono: 'üìù',
    textoConfirmar: 'Crear Planificaci√≥n',
    textoCancelar: 'Revisar',
    tipo: 'normal'
  });
  
  if (!confirmar) return;
  
  // Loading en todo el modal
  var modal = document.querySelector('.contenedor-administracion-modal');
  if (!modal) {
    modal = document.getElementById('modalNuevaPlanificacion');
  }
  
  mostrarLoading(modal, {
    mensaje: 'Creando planificaci√≥n...',
    tipo: 'overlay'
  });
  
  // Llamar al backend
  google.script.run
    .withSuccessHandler(function(resultado) {
      ocultarLoading(modal);
      mostrarExito(
        'Planificaci√≥n creada con ' + resultado.temasCreados + ' temas',
        'üéâ ¬°Planificaci√≥n lista!'
      );
      cerrarModal();
      cargarPlanificacionesDelMes();
      seleccionarDia(diaSeleccionado);
    })
    .withFailureHandler(function(error) {
      console.error('Error al crear planificaci√≥n:', error);
      ocultarLoading(modal);
      mostrarError('No se pudo crear la planificaci√≥n: ' + error.message, 'Error de creaci√≥n');
    })
    .addPlanificacion(datos);
}

// 7. FUNCI√ìN cargarDetalleDia() con loading
function cargarDetalleDia(fecha, esDiaPasado) {
  var contenedor = document.getElementById('contenidoDetalleDia');
  
  // Mostrar loading espec√≠fico para el detalle
  mostrarLoading(contenedor, {
    mensaje: 'Cargando informaci√≥n del d√≠a...',
    tipo: 'overlay'
  });
  
  // Buscar planificaci√≥n para esta fecha
  var fechaStr = fecha.getFullYear() + '-' + 
    String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fecha.getDate()).padStart(2, '0');
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      ocultarLoading(contenedor);
      
      // Buscar planificaci√≥n para esta fecha espec√≠fica
      var planDelDia = planificaciones.find(function(p) {
        var fechaPlan = new Date(p.fecha);
        var fechaBuscar = new Date(fecha);
        fechaPlan.setHours(0, 0, 0, 0);
        fechaBuscar.setHours(0, 0, 0, 0);
        return fechaPlan.getTime() === fechaBuscar.getTime();
      });
      
      if (planDelDia) {
        cargarDetallePlanificacionCompleta(planDelDia.id, esDiaPasado);
      } else {
        mostrarInterfazSinPlanificacion(esDiaPasado);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al buscar planificaci√≥n:', error);
      ocultarLoading(contenedor);
      mostrarInterfazSinPlanificacion(esDiaPasado);
    })
    .getPlanificacionesDelMes(fecha.getFullYear(), fecha.getMonth());
}

// 4. FUNCI√ìN cargarPlanificacionesDelMes() con loading en calendario
function cargarPlanificacionesDelMes() {
  var a√±o = mesActual.getFullYear();
  var mes = mesActual.getMonth();
  
  console.log('Cargando planificaciones para:', a√±o, mes);
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      console.log('Planificaciones cargadas:', planificaciones);
      
      if (planificaciones && planificaciones.length > 0 && typeof mostrarPlanificacionesEnCalendario === 'function') {
        mostrarPlanificacionesEnCalendario(planificaciones);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar planificaciones del mes:', error);
    })
    .getPlanificacionesDelMes(a√±o, mes);
}

function marcarTemaCompleto(idProgreso, nombreTema) {
  const tiempoReal = prompt('‚è±Ô∏è ¬øCu√°ntos minutos dedicaste al tema "' + nombreTema + '"?', '30');
  
  if (!tiempoReal || isNaN(tiempoReal) || tiempoReal < 1) {
    mostrarAdvertencia('Introduce un tiempo v√°lido en minutos', 'Tiempo no v√°lido');
    return;
  }
  
  const nota = prompt('üí≠ Nota personal (opcional):', '');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      if (resultado.success) {
        mostrarExito(
          `Se han programado ${resultado.repasosCreados} repasos autom√°ticamente`,
          '‚úÖ Tema completado'
        );
        setTimeout(() => {
          seleccionarDia(diaSeleccionado);
        }, 500);
      } else {
        mostrarError(`Error: ${resultado.error}`, 'No se pudo completar');
      }
    })
    .withFailureHandler(function(error) {
      mostrarError(`Error de conexi√≥n: ${error.message}`, 'Error de red');
    })
    .marcarTemaComoCompletado(idProgreso, parseInt(tiempoReal), nota || null);
}


// Validar orden consecutivo de temas
function validarOrdenConsecutivo(nodoSeleccionado, arbolCompleto) {
  // Buscar el nodo en el √°rbol completo para obtener contexto
  function encontrarNodoEnArbol(arbol, idBuscado) {
    for (let tema of arbol) {
      if (tema.id === idBuscado) return { nodo: tema, padre: null };
      
      if (tema.hijos && tema.hijos.length > 0) {
        const resultado = encontrarNodoEnArbol(tema.hijos, idBuscado);
        if (resultado.nodo) return { nodo: resultado.nodo, padre: tema };
      }
    }
    return { nodo: null, padre: null };
  }
  
  const { nodo, padre } = encontrarNodoEnArbol(arbolCompleto, nodoSeleccionado.id);
  
  if (!padre) return { esConsecutivo: true }; // Tema padre, no hay orden que validar
  
  // Obtener hermanos del mismo padre
  const hermanos = padre.hijos.sort((a, b) => {
    const numA = parseFloat((a.prenombre || '0').replace(/[^\d.]/g, ''));
    const numB = parseFloat((b.prenombre || '0').replace(/[^\d.]/g, ''));
    return numA - numB;
  });
  
  // Encontrar posici√≥n del nodo actual
  const posicionActual = hermanos.findIndex(h => h.id === nodoSeleccionado.id);
  
  // Verificar si hay hermanos anteriores sin completar/seleccionar
  const hermanosPreviosSinCompletar = [];
  for (let i = 0; i < posicionActual; i++) {
    const hermano = hermanos[i];
    const yaSeleccionado = temasSeleccionados.some(t => t.id === hermano.id);
    const completado = hermano.estado === 'completado';
    
    if (!yaSeleccionado && !completado) {
      hermanosPreviosSinCompletar.push(hermano);
    }
  }
  
  if (hermanosPreviosSinCompletar.length > 0) {
    return {
      esConsecutivo: false,
      mensaje: 'Te est√°s saltando el orden. Temas anteriores pendientes: ' + 
               hermanosPreviosSinCompletar.map(h => h.prenombre || h.nombre).join(', '),
      temasSaltados: hermanosPreviosSinCompletar
    };
  }
  
  return { esConsecutivo: true };
}

// ====================================
// FUNCIONES CON MANEJO DE ERRORES ROBUSTO
// A√±adir al final de scriptsPlanificacion.html
// ====================================

// Funci√≥n mejorada para cargar oposici√≥n activa
function cargarOposicionActivaSegura() {
  var contexto = 'cargarOposicionActiva';
  
  ejecutarSeguro(function() {
    var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
    if (contenedor) {
      mostrarLoading(contenedor, {
        mensaje: 'Cargando oposici√≥n activa...',
        tipo: 'overlay'
      });
    }
  }, 'mostrarLoadingOposicion');
  
  ejecutarConManejadorErrores(
    google.script.run.getOposicionActivaSegura,
    contexto,
    {
      successHandler: true,
      mensajeError: 'No se pudo cargar la oposici√≥n activa',
      reintentos: 2
    }
  ).then(function(oposicion) {
    ejecutarSeguro(function() {
      oposicionActiva = oposicion;
      
      var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
      if (contenedor) {
        ocultarLoading(contenedor);
      }
      
      console.log('Oposici√≥n activa cargada:', oposicion);
      
      if (oposicion) {
        mostrarExito('Oposici√≥n cargada: ' + oposicion.nombre, 'Configuraci√≥n lista');
        
        // Continuar con inicializaci√≥n
        inicializarCalendarioSeguro();
      } else {
        mostrarInfo('No hay oposici√≥n activa configurada');
        mostrarSelectorOposicion();
      }
    }, 'procesarResultadoOposicion');
    
  }).catch(function(errorInfo) {
    ejecutarSeguro(function() {
      var contenedor = document.getElementById('contenidoPrincipalPlanificacion');
      if (contenedor) {
        ocultarLoading(contenedor);
      }
      
      // Mostrar interfaz de fallback
      mostrarSelectorOposicion();
    }, 'manejarErrorOposicion');
  });
}

// Funci√≥n mejorada para crear planificaci√≥n
function crearPlanificacionSegura() {
  var contexto = 'crearPlanificacion';
  
  return ejecutarSeguro(function() {
    // Validaciones del frontend
    var erroresValidacion = [];
    
    if (temasSeleccionados.length === 0) {
      erroresValidacion.push('Debes seleccionar al menos un tema');
    }
    
    if (!oposicionActiva || !oposicionActiva.id) {
      erroresValidacion.push('No hay oposici√≥n activa seleccionada');
    }
    
    if (!window.fechaPlanificacion) {
      erroresValidacion.push('Fecha de planificaci√≥n no v√°lida');
    }
    
    if (erroresValidacion.length > 0) {
      mostrarAdvertencia(erroresValidacion.join('\n'), 'Datos incompletos');
      return Promise.reject(new Error('Validaci√≥n fallida: ' + erroresValidacion.join(', ')));
    }
    
    // Preparar datos
    var datos = {
      fecha: window.fechaPlanificacion,
      idOposicion: oposicionActiva.id,
      tiempoPrevisto: tiempoTotalDisponible + (repasosDelDia?.length * 30 || 0),
      tiempoRepasos: repasosDelDia?.length * 30 || 0,
      tiempoEstudio: tiempoTotalDisponible,
      temasSeleccionados: temasSeleccionados,
      numeroBloques: bloquesActivos.length
    };
    
    // Validar datos en el frontend
    validarDatos(datos, {
      fecha: { requerido: true, tipo: 'string' },
      idOposicion: { requerido: true },
      temasSeleccionados: { requerido: true }
    }, 'planificaci√≥n');
    
    return mostrarConfirmacion({
      titulo: 'Crear planificaci√≥n',
      mensaje: '¬øCrear planificaci√≥n para ' + datos.fecha + '?\n\n‚Ä¢ ' + datos.temasSeleccionados.length + ' temas\n‚Ä¢ ' + Math.round(datos.tiempoEstudio / 60 * 10) / 10 + 'h de estudio\n‚Ä¢ ' + datos.numeroBloques + ' bloques',
      icono: 'üìù',
      textoConfirmar: 'Crear Planificaci√≥n',
      textoCancelar: 'Revisar',
      tipo: 'normal'
    }).then(function(confirmar) {
      if (!confirmar) {
        return Promise.reject(new Error('Cancelado por el usuario'));
      }
      
      // Mostrar loading en modal
      var modal = document.querySelector('.contenedor-administracion-modal') || 
                 document.getElementById('modalNuevaPlanificacion');
      
      if (modal) {
        mostrarLoading(modal, {
          mensaje: 'Creando planificaci√≥n...',
          tipo: 'overlay'
        });
      }
      
      // Ejecutar con manejo de errores robusto
      return ejecutarConManejadorErrores(
        google.script.run.addPlanificacionSegura,
        contexto,
        {
          parametros: [datos],
          successHandler: true,
          mensajeError: 'No se pudo crear la planificaci√≥n',
          reintentos: 1 // Solo 1 reintento para operaciones de escritura
        }
      ).then(function(resultado) {
        if (modal) {
          ocultarLoading(modal);
        }
        
        mostrarExito(
          'Planificaci√≥n creada con ' + resultado.temasCreados + ' temas',
          'üéâ ¬°Planificaci√≥n lista!'
        );
        
        // Limpiar y cerrar
        cerrarModal();
        cargarPlanificacionesDelMesSegura();
        seleccionarDia(diaSeleccionado);
        
        return resultado;
        
      }).catch(function(errorInfo) {
        if (modal) {
          ocultarLoading(modal);
        }
        throw errorInfo;
      });
    });
    
  }, contexto, Promise.reject(new Error('Error en validaci√≥n inicial')));
}

// Funci√≥n mejorada para cargar √°rbol de temas
function cargarArbolTemasSeguro() {
  var contexto = 'cargarArbolTemas';
  
  return ejecutarSeguro(function() {
    var contenedor = document.getElementById('arbolTemas');
    
    if (!contenedor) {
      throw new Error('Contenedor del √°rbol de temas no encontrado');
    }
    
    if (!oposicionActiva) {
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error: No hay oposici√≥n activa</p>';
      return Promise.reject(new Error('No hay oposici√≥n activa'));
    }
    
    var tiempoDisponible = tiempoTotalDisponible;
    
    // Mostrar loading
    mostrarLoadingArbol();
    
    return ejecutarConManejadorErrores(
      google.script.run.getArbolTemasConEstadosSeguro,
      contexto,
      {
        parametros: [oposicionActiva.id, tiempoDisponible],
        successHandler: true,
        mensajeError: 'No se pudieron cargar los temas',
        reintentos: 2
      }
    ).then(function(data) {
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay temas vinculados a esta oposici√≥n</p>';
        return;
      }
      
      renderizarArbolTemas(data.arbol, data.bloques);
      
    }).catch(function(errorInfo) {
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas. <button onclick="cargarArbolTemasSeguro()">Reintentar</button></p>';
    });
    
  }, contexto, Promise.reject(new Error('Error al inicializar carga de √°rbol')));
}

// Funci√≥n mejorada para cargar planificaciones del mes
function cargarPlanificacionesDelMesSegura() {
  var contexto = 'cargarPlanificacionesDelMes';
  
  return ejecutarSeguro(function() {
    var a√±o = mesActual.getFullYear();
    var mes = mesActual.getMonth();
    
    // Mostrar loading en calendario
    mostrarLoadingCalendario();
    
    return ejecutarConManejadorErrores(
      google.script.run.getPlanificacionesDelMes,
      contexto,
      {
        parametros: [a√±o, mes],
        successHandler: true,
        mensajeError: 'No se pudieron cargar las planificaciones del mes',
        reintentos: 2
      }
    ).then(function(planificaciones) {
      // Restaurar calendario y mostrar planificaciones
      renderizarCalendario();
      
      if (planificaciones && planificaciones.length > 0) {
        mostrarPlanificacionesEnCalendario(planificaciones);
      }
      
    }).catch(function(errorInfo) {
      // Restaurar calendario aunque haya error
      renderizarCalendario();
      
      // Mostrar mensaje de error discreto en el calendario
      var calendario = document.getElementById('calendario');
      if (calendario) {
        var errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'text-align: center; color: #dc3545; font-size: 12px; margin-top: 10px;';
        errorDiv.innerHTML = 'Error al cargar planificaciones. <a href="#" onclick="cargarPlanificacionesDelMesSegura(); this.parentElement.remove();">Reintentar</a>';
        calendario.appendChild(errorDiv);
      }
    });
    
  }, contexto, Promise.reject(new Error('Error al inicializar carga de planificaciones')));
}

// Funci√≥n mejorada para inicializar calendario
function inicializarCalendarioSeguro() {
  return ejecutarSeguro(function() {
    renderizarCalendario();
    return cargarPlanificacionesDelMesSegura();
  }, 'inicializarCalendario');
}

// Funci√≥n wrapper para operaciones de UI cr√≠ticas
function ejecutarOperacionUI(operacion, contexto, valorPorDefecto) {
  return ejecutarSeguro(function() {
    return operacion();
  }, 'UI-' + contexto, valorPorDefecto);
}

// Funci√≥n de recuperaci√≥n para errores cr√≠ticos
function recuperarAplicacion() {
  ejecutarSeguro(function() {
    console.log('üîÑ Iniciando recuperaci√≥n de aplicaci√≥n...');
    
    // Limpiar estados
    oposicionActiva = null;
    temasSeleccionados = [];
    bloquesActivos = [];
    tiempoUsado = 0;
    
    // Ocultar todos los loading
    var loadingElements = document.querySelectorAll('.loading-overlay, .btn-loading, .select-loading');
    loadingElements.forEach(function(el) {
      if (el.classList.contains('loading-overlay')) {
        el.remove();
      } else {
        el.classList.remove('btn-loading', 'select-loading');
      }
    });
    
    // Reinicializar
    mostrarInfo('Reiniciando aplicaci√≥n...', 'Recuperaci√≥n');
    setTimeout(function() {
      inicializarSeccionPlanificacion();
    }, 1000);
    
  }, 'recuperarAplicacion');
}

// Funci√≥n para reportar problema al usuario
function reportarProblema() {
  var timestamp = new Date().toISOString();
  var info = {
    timestamp: timestamp,
    url: window.location.href,
    userAgent: navigator.userAgent,
    oposicionActiva: oposicionActiva ? oposicionActiva.id : 'ninguna'
  };
  
  mostrarInfo(
    'ID del reporte: ' + timestamp + '\n\nIncluye este ID si contactas con soporte.',
    'Informaci√≥n para soporte'
  );
  
  // Enviar reporte autom√°tico
  enviarLogError({
    contexto: 'reporteUsuario',
    mensaje: 'Usuario report√≥ problema',
    timestamp: timestamp,
    datos: info
  });
}

console.log('‚úÖ Funciones con manejo de errores robusto cargadas');

// ====================================
// MEJORAS RESPONSIVE ESPEC√çFICAS PARA PLANIFICACI√ìN
// A√±adir al final de scriptsPlanificacion.html
// ====================================

/*
// Funci√≥n mejorada para abrir modal de planificaci√≥n
function nuevaPlanificacionResponsive() {
  if (!diaSeleccionado) {
    mostrarAdvertencia('Primero selecciona un d√≠a del calendario', 'D√≠a no seleccionado');
    return;
  }
  
  if (!oposicionActiva) {
    mostrarError('Debes tener una oposici√≥n activa', 'Configuraci√≥n incompleta');
    return;
  }
  
  // Validar que no es d√≠a pasado
  var fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado);
  var hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada < hoy) {
    mostrarAdvertencia('No puedes crear planificaciones para d√≠as pasados', 'Fecha no v√°lida');
    return;
  }
  
  // Resetear estado
  resetearEstadoPlanificacion();
  
  // Establecer fecha
  var fechaStr = fechaSeleccionada.getFullYear() + '-' + 
    String(fechaSeleccionada.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fechaSeleccionada.getDate()).padStart(2, '0');
  window.fechaPlanificacion = fechaStr;
  
  // Mostrar modal
  var modal = document.getElementById('modalNuevaPlanificacion');
  if (modal) {
    modal.style.display = 'flex';
    
    // Optimizar para m√≥vil si es necesario
    if (typeof optimizarModalMovil === 'function') {
      optimizarModalMovil(modal);
    }
    
    // Configurar responsive espec√≠fico
    configurarModalPlanificacionResponsive(modal);
  }
  
  mostrarPaso(1);
}
*/


// Configurar modal espec√≠ficamente para planificaci√≥n responsive
function configurarModalPlanificacionResponsive(modal) {
  if (!modal) return;
  
  // Si es m√≥vil, ajustar el modal
  if (typeof esMobile === 'function' && esMobile()) {
    // Ajustar altura seg√∫n contenido
    ajustarAlturaModalMovil(modal);
    
    // Mejorar navegaci√≥n entre pasos
    mejorarNavegacionPasosMovil();
    
    // Optimizar √°rbol de temas para t√°ctil
    setTimeout(function() {
      optimizarArbolTemasMovil();
    }, 500);
  }
  
  // Configurar cierre responsivo
  configurarCierreModalResponsive(modal);
}

// Ajustar altura del modal en m√≥vil seg√∫n el paso
function ajustarAlturaModalMovil(modal) {
  if (!modal) return;
  
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
        var pasoVisible = modal.querySelector('.paso-modal[style*="block"]');
        if (pasoVisible) {
          ajustarAlturaSegunPaso(modal, pasoVisible);
        }
      }
    });
  });
  
  // Observar cambios en los pasos
  var pasos = modal.querySelectorAll('.paso-modal');
  pasos.forEach(function(paso) {
    observer.observe(paso, { attributes: true, attributeFilter: ['style'] });
  });
}

// Ajustar altura seg√∫n el paso actual
function ajustarAlturaSegunPaso(modal, pasoVisible) {
  if (!pasoVisible || !typeof esMobile === 'function' || !esMobile()) return;
  
  var alturaContenido = pasoVisible.scrollHeight;
  var alturaModal = modal.scrollHeight;
  var alturaVentana = window.innerHeight;
  
  // Si el contenido es muy alto, permitir scroll interno
  if (alturaContenido > alturaVentana * 0.7) {
    modal.style.height = '85vh';
    pasoVisible.style.maxHeight = '60vh';
    pasoVisible.style.overflowY = 'auto';
  } else {
    modal.style.height = 'auto';
    modal.style.maxHeight = '90vh';
    pasoVisible.style.maxHeight = 'none';
    pasoVisible.style.overflowY = 'visible';
  }
}

// Mejorar navegaci√≥n entre pasos en m√≥vil
function mejorarNavegacionPasosMovil() {
  if (!typeof esMobile === 'function' || !esMobile()) return;
  
  var indicadores = document.querySelectorAll('.indicadores-pasos [id^="indicadorPaso"]');
  indicadores.forEach(function(indicador, index) {
    // Hacer indicadores m√°s t√°ctiles
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(indicador);
    }
    
    // A√±adir navegaci√≥n t√°ctil
    indicador.style.cursor = 'pointer';
    indicador.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.95)';
    });
    
    indicador.addEventListener('touchend', function() {
      this.style.transform = '';
    });
  });
}

// Optimizar √°rbol de temas para dispositivos t√°ctiles
function optimizarArbolTemasMovil() {
  if (!typeof esMobile === 'function' || !esMobile()) return;
  
  var arbolTemas = document.getElementById('arbolTemas');
  if (!arbolTemas) return;
  
  // Mejorar checkboxes para t√°ctil
  var checkboxes = arbolTemas.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(function(checkbox) {
    // √Årea de toque m√°s grande
    var label = checkbox.closest('div');
    if (label) {
      label.style.minHeight = '44px';
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.padding = '8px';
      label.style.margin = '2px 0';
      label.style.borderRadius = '5px';
      label.style.transition = 'background-color 0.2s';
      
      // Feedback visual
      label.addEventListener('touchstart', function() {
        this.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
      });
      
      label.addEventListener('touchend', function() {
        var self = this;
        setTimeout(function() {
          self.style.backgroundColor = '';
        }, 150);
      });
    }
    
    // Hacer checkbox m√°s grande
    checkbox.style.transform = 'scale(1.3)';
    checkbox.style.marginRight = '12px';
  });
  
  // Mejorar expansi√≥n/colapso de secciones
  var bloqueHeaders = arbolTemas.querySelectorAll('.bloque-header, .tema-padre');
  bloqueHeaders.forEach(function(header) {
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(header);
    }
  });
}

// Configurar cierre responsive del modal
function configurarCierreModalResponsive(modal) {
  // Cerrar con swipe hacia abajo en m√≥vil
  if (typeof esMobile === 'function' && esMobile()) {
    var startY = 0;
    var currentY = 0;
    var modalContent = modal.querySelector('.confirmacion-modal') || modal.firstElementChild;
    
    if (modalContent) {
      modalContent.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
      });
      
      modalContent.addEventListener('touchmove', function(e) {
        currentY = e.touches[0].clientY;
        var diffY = currentY - startY;
        
        // Solo permitir swipe hacia abajo desde la parte superior
        if (diffY > 0 && startY < 100) {
          modalContent.style.transform = 'translateY(' + Math.min(diffY, 100) + 'px)';
          modalContent.style.opacity = Math.max(0.5, 1 - (diffY / 200));
        }
      });
      
      modalContent.addEventListener('touchend', function() {
        var diffY = currentY - startY;
        
        if (diffY > 80) {
          // Cerrar modal
          cerrarModal();
        } else {
          // Volver a posici√≥n original
          modalContent.style.transform = '';
          modalContent.style.opacity = '';
        }
      });
    }
  }
}
/*
// Funci√≥n mejorada para mostrar paso con optimizaciones responsive
function mostrarPasoResponsive(numeroPaso) {
  pasoActual = numeroPaso;
  
  // Ocultar todos los pasos
  document.getElementById('paso1').style.display = 'none';
  document.getElementById('paso2').style.display = 'none';
  document.getElementById('paso3').style.display = 'none';
  
  // Mostrar paso actual
  var pasoActual = document.getElementById('paso' + numeroPaso);
  pasoActual.style.display = 'block';
  
  // Actualizar indicadores
  if (typeof actualizarIndicadoresPasos === 'function') {
    actualizarIndicadoresPasos();
  }
  
  // Actualizar botones
  var btnAnterior = document.getElementById('btnAnterior');
  var btnSiguiente = document.getElementById('btnSiguiente');
  
  if (btnAnterior) {
    btnAnterior.style.display = numeroPaso > 1 ? 'inline-block' : 'none';
  }
  
  if (btnSiguiente) {
    btnSiguiente.textContent = numeroPaso === 3 ? 'Crear Planificaci√≥n' : 'Siguiente ‚ñ∂';
  }
  
  // Optimizaciones espec√≠ficas por paso
  setTimeout(function() {
    if (numeroPaso === 1) {
      optimizarPaso1Responsive();
    } else if (numeroPaso === 2) {
      optimizarPaso2Responsive();
    } else if (numeroPaso === 3) {
      optimizarPaso3Responsive();
      optimizarArbolTemasMovil();
    }
    
    // Ajustar altura del modal
    var modal = document.getElementById('modalNuevaPlanificacion');
    if (modal) {
      ajustarAlturaSegunPaso(modal, pasoActual);
    }
  }, 100);
}
*/


// Optimizaciones espec√≠ficas para cada paso
function optimizarPaso1Responsive() {
  var inputs = document.querySelectorAll('#paso1 input, #paso1 select');
  inputs.forEach(function(input) {
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(input);
    }
  });
}

function optimizarPaso2Responsive() {
  var inputs = document.querySelectorAll('#paso2 input, #paso2 select');
  inputs.forEach(function(input) {
    if (typeof mejorarAccesibilidadMovil === 'function') {
      mejorarAccesibilidadMovil(input);
    }
  });
  
  // Mejorar controles de tiempo en m√≥vil
  var horasInput = document.getElementById('horasEstudio');
  if (horasInput && typeof esMobile === 'function' && esMobile()) {
    horasInput.setAttribute('inputmode', 'decimal');
    horasInput.style.fontSize = '18px';
  }
}

function optimizarPaso3Responsive() {
  var resumenTiempo = document.querySelector('.resumen-tiempo');
  if (resumenTiempo && typeof esMobile === 'function' && esMobile()) {
    // Hacer m√°s t√°ctil el resumen
    resumenTiempo.style.fontSize = '16px';
    resumenTiempo.style.padding = '15px';
  }
}

/*
// Funci√≥n para optimizar renderizado del calendario en m√≥vil
function renderizarCalendarioResponsive() {
  // Llamar a la funci√≥n original
  if (typeof renderizarCalendario === 'function') {
    renderizarCalendario();
  }
  
  // Aplicar optimizaciones m√≥viles
  setTimeout(function() {
    if (typeof optimizarCalendarioMovil === 'function') {
      optimizarCalendarioMovil();
    }
  }, 100);
}

// Sobrescribir funciones originales si existen
if (typeof nuevaPlanificacion === 'function') {
  var nuevaPlanificacionOriginal = nuevaPlanificacion;
  nuevaPlanificacion = nuevaPlanificacionResponsive;
}

if (typeof mostrarPaso === 'function') {
  var mostrarPasoOriginal = mostrarPaso;
  mostrarPaso = mostrarPasoResponsive;
}

if (typeof renderizarCalendario === 'function') {
  var renderizarCalendarioOriginal = renderizarCalendario;
  //renderizarCalendario = renderizarCalendarioResponsive;
}
*/
console.log('‚úÖ Mejoras responsive para planificaci√≥n cargadas');

// ====================================
// CALENDARIO B√ÅSICO QUE FUNCIONA
// A√±adir al final de scriptsPlanificacion.html
// ====================================

// Funci√≥n configurarCalendario() b√°sica
function configurarCalendario() {
  console.log('Configurando calendario b√°sico...');
  renderizarCalendarioBasico();
  cargarPlanificacionesDelMes();
}

// Funci√≥n renderizarCalendario() b√°sica (sin bucles)
function renderizarCalendarioBasico() {
  var calendarioDiv = document.getElementById('calendario');
  if (!calendarioDiv) {
    console.warn('Elemento calendario no encontrado');
    return;
  }
  
  var a√±o = mesActual.getFullYear();
  var mes = mesActual.getMonth();
  
  // Actualizar t√≠tulo
  var tituloMes = document.getElementById('tituloMes');
  if (tituloMes) {
    var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    tituloMes.textContent = meses[mes] + ' ' + a√±o;
  }
  
  // Generar calendario
  var primerDia = new Date(a√±o, mes, 1).getDay();
  primerDia = primerDia === 0 ? 6 : primerDia - 1;
  
  var diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
  var hoy = new Date();
  
  var html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
  
  // Encabezados de d√≠as
  var diasSemana = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
  diasSemana.forEach(function(dia) {
    html += '<div style="text-align: center; font-weight: bold; padding: 8px; color: #666; font-size: 12px;">' + dia + '</div>';
  });
  
  // D√≠as vac√≠os al inicio
  for (var i = 0; i < primerDia; i++) {
    html += '<div></div>';
  }
  
  // D√≠as del mes
  for (var dia = 1; dia <= diasEnMes; dia++) {
    var fecha = new Date(a√±o, mes, dia);
    var esHoy = fecha.toDateString() === hoy.toDateString();
    var esSeleccionado = diaSeleccionado === dia;
    
    var estilos = 'min-height: 80px; border: 1px solid #ddd; border-radius: 5px; padding: 5px; cursor: pointer; ';
    estilos += 'display: flex; flex-direction: column; justify-content: space-between; ';
    
    if (esHoy) {
      estilos += 'border: 2px solid #2196f3; background: #e3f2fd; ';
    } else if (esSeleccionado) {
      estilos += 'background: #f0f0f0; ';
    } else {
      estilos += 'background: white; ';
    }
    
    html += '<div onclick="seleccionarDia(' + dia + ')" style="' + estilos + '">';
    html += '<div style="font-weight: bold; color: ' + (esHoy ? '#2196f3' : '#333') + ';">' + dia + '</div>';
    html += '<div id="contenido-' + a√±o + '-' + mes + '-' + dia + '" style="font-size: 10px; flex: 1;"></div>';
    html += '</div>';
  }
  
  html += '</div>';
  calendarioDiv.innerHTML = html;
  
  console.log('Calendario renderizado correctamente');
}

// Reemplazar renderizarCalendario con la versi√≥n b√°sica
if (typeof renderizarCalendario !== 'undefined') {
  // No sobrescribir, usar alias
  renderizarCalendario = renderizarCalendarioBasico;
} else {
  // Crear nueva
  function renderizarCalendario() {
    renderizarCalendarioBasico();
  }
}

// Funci√≥n para navegaci√≥n del calendario
function cambiarMes(direccion) {
  mesActual.setMonth(mesActual.getMonth() + direccion);
  diaSeleccionado = null;
  renderizarCalendarioBasico();
  cargarPlanificacionesDelMes();
  limpiarDetalleDia();
}

function irAHoy() {
  mesActual = new Date();
  renderizarCalendarioBasico();
  cargarPlanificacionesDelMes();
  var hoy = new Date();
  seleccionarDia(hoy.getDate());
}

function limpiarDetalleDia() {
  var detalle = document.getElementById('contenidoDetalleDia');
  if (detalle) {
    detalle.innerHTML = 
      '<p style="text-align: center; color: #666; padding: 40px 0;">' +
      '<i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br>' +
      'Selecciona un d√≠a del calendario</p>';
  }
  
  var titulo = document.getElementById('tituloDetalleDia');
  if (titulo) {
    titulo.textContent = 'Selecciona un d√≠a';
  }
}

console.log('‚úÖ Calendario b√°sico funcional cargado');

</script>
