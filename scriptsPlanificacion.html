<script>
// scriptsPlanificacion.html - REESCRITURA LIMPIA
// Siguiendo la estructura de scriptsBloques.html y scriptsConceptos.html

// ====================================
// VARIABLES GLOBALES
// ====================================

let oposicionActiva = null;
let configuracionActual = null;
let mesActual = new Date();
let diaSeleccionado = null;

// Estado del modal de planificaci√≥n
let estadoPlanificacion = {
  paso: 1,
  fecha: null,
  tiempoPrevisto: 240,
  tiempoRepasos: 0,
  tiempoEstudio: 240,
  temasSeleccionados: [],
  bloquesActivos: [],
  repasosDelDia: []
};

// Sistema de advertencias
let contadorAdvertencias = {
  orden: {},
  bloques: {}
};

// ====================================
// FUNCIONES DE INICIALIZACI√ìN
// ====================================

function inicializarSeccionPlanificacion() {
  console.log('Inicializando secci√≥n Planificaci√≥n...');
  cargarOposicionActiva();
}

function cargarOposicionActiva() {
  google.script.run
    .withSuccessHandler(function(oposicion) {
      oposicionActiva = oposicion;
      mostrarContenidoPrincipal();
      configurarCalendario();
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposici√≥n activa:', error);
      mostrarContenidoPrincipal();
    })
    .getOposicionActiva();
}

function mostrarContenidoPrincipal() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  if (!oposicionActiva) {
    mostrarSelectorOposicion(contenedor);
  } else {
    mostrarInterfazPrincipal(contenedor);
  }
}

function mostrarSelectorOposicion(contenedor) {
  let html = '<div style="text-align: center; padding: 40px;">';
  html += '<h3>Selecciona una oposici√≥n para planificar</h3>';
  html += '<p style="color: #666; margin-bottom: 30px;">Solo puedes tener una oposici√≥n activa a la vez</p>';
  
  html += '<div style="max-width: 400px; margin: 0 auto;">';
  html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Oposici√≥n:</label>';
  html += '<select id="selectorOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
  html += '<option value="">-- Selecciona una oposici√≥n --</option>';
  html += '</select>';
  
  html += '<button onclick="establecerOposicionActiva()" ';
  html += 'style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">';
  html += 'Establecer como activa</button>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  cargarOposicionesDisponibles();
}

function mostrarInterfazPrincipal(contenedor) {
  let html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
  html += '<div>';
  html += '<h3 style="margin: 0; color: #007bff;">üìö ' + oposicionActiva.nombre + '</h3>';
  html += '<p style="margin: 5px 0 0 0; color: #666;">Oposici√≥n activa</p>';
  html += '</div>';
  html += '<div>';
  html += '<button onclick="cambiarOposicion()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 3px;">Cambiar</button>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
}

// ====================================
// FUNCIONES DE OPOSICIONES
// ====================================

function cargarOposicionesDisponibles() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const select = document.getElementById('selectorOposicion');
      
      oposiciones.forEach(function(op) {
        const option = document.createElement('option');
        option.value = op.id;
        option.textContent = op.nombre;
        select.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      alert('Error al cargar oposiciones');
    })
    .getOposicionesParaPlanificacion();
}

function establecerOposicionActiva() {
  const idOposicion = document.getElementById('selectorOposicion').value;
  
  if (!idOposicion) {
    alert('Selecciona una oposici√≥n');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function() {
      alert('Oposici√≥n establecida correctamente');
      cargarOposicionActiva();
    })
    .withFailureHandler(function(error) {
      console.error('Error al establecer oposici√≥n activa:', error);
      alert('Error al establecer oposici√≥n activa');
    })
    .setOposicionActiva(idOposicion);
}

function cambiarOposicion() {
  const contenedor = document.getElementById('contenidoPrincipalPlanificacion');
  
  let html = '<div style="text-align: center; padding: 40px;">';
  html += '<h3>Cambiar oposici√≥n activa</h3>';
  html += '<p style="color: #666; margin-bottom: 30px;">Actual: <strong>' + oposicionActiva.nombre + '</strong></p>';
  
  html += '<div style="max-width: 400px; margin: 0 auto;">';
  html += '<label style="display: block; margin-bottom: 10px; text-align: left;">Nueva oposici√≥n:</label>';
  html += '<select id="selectorNuevaOposicion" style="width: 100%; padding: 10px; margin-bottom: 20px;">';
  html += '<option value="">-- Selecciona una oposici√≥n --</option>';
  html += '</select>';
  
  html += '<div style="display: flex; gap: 10px; justify-content: center;">';
  html += '<button onclick="cancelarCambioOposicion()" ';
  html += 'style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Cancelar</button>';
  
  html += '<button onclick="confirmarCambioOposicion()" ';
  html += 'style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer;">';
  html += 'Cambiar</button>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  
  contenedor.innerHTML = html;
  cargarOposicionesParaCambio();
}

function cargarOposicionesParaCambio() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const select = document.getElementById('selectorNuevaOposicion');
      
      oposiciones.forEach(function(op) {
        if (op.id != oposicionActiva.id) {
          const option = document.createElement('option');
          option.value = op.id;
          option.textContent = op.nombre;
          select.appendChild(option);
        }
      });
    })
    .getOposicionesParaPlanificacion();
}

function cancelarCambioOposicion() {
  mostrarContenidoPrincipal();
}

function confirmarCambioOposicion() {
  const idNuevaOposicion = document.getElementById('selectorNuevaOposicion').value;
  
  if (!idNuevaOposicion) {
    alert('Selecciona una oposici√≥n');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function() {
      alert('Oposici√≥n cambiada correctamente');
      cargarOposicionActiva();
    })
    .withFailureHandler(function(error) {
      console.error('Error al cambiar oposici√≥n:', error);
      alert('Error al cambiar oposici√≥n');
    })
    .setOposicionActiva(idNuevaOposicion);
}

// ====================================
// FUNCIONES DEL CALENDARIO
// ====================================

function configurarCalendario() {
  renderizarCalendario();
  cargarPlanificacionesDelMes();
  
  // Auto-seleccionar d√≠a actual si estamos en el mes actual
  const hoy = new Date();
  if (mesActual.getMonth() === hoy.getMonth() && mesActual.getFullYear() === hoy.getFullYear()) {
    setTimeout(() => {
      seleccionarDia(hoy.getDate());
    }, 100);
  }
}

function renderizarCalendario() {
  const a√±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();
  
  // Actualizar t√≠tulo
  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  document.getElementById('tituloMes').textContent = meses[mes] + ' ' + a√±o;
  
  // Calcular primer d√≠a (lunes = 0)
  let primerDia = new Date(a√±o, mes, 1).getDay();
  primerDia = primerDia === 0 ? 6 : primerDia - 1;
  
  const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
  const hoy = new Date();
  
  // Generar HTML del calendario
  let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">';
  
  // Encabezados de d√≠as
  const diasSemana = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
  diasSemana.forEach(dia => {
    html += '<div style="text-align: center; font-weight: bold; padding: 8px; color: #666; font-size: 12px;">' + dia + '</div>';
  });
  
  // D√≠as vac√≠os al inicio
  for (let i = 0; i < primerDia; i++) {
    html += '<div></div>';
  }
  
  // D√≠as del mes
  for (let dia = 1; dia <= diasEnMes; dia++) {
    const fecha = new Date(a√±o, mes, dia);
    const esHoy = fecha.toDateString() === hoy.toDateString();
    const esSeleccionado = diaSeleccionado === dia;
    
    // Estilos del d√≠a
    let estilos = 'min-height: 80px; border: 1px solid #ddd; border-radius: 5px; padding: 5px; cursor: pointer; ';
    estilos += 'display: flex; flex-direction: column; justify-content: space-between; ';
    
    if (esHoy) {
      estilos += 'border: 2px solid #2196f3; background: #e3f2fd; ';
    } else if (esSeleccionado) {
      estilos += 'background: #f0f0f0; ';
    } else {
      estilos += 'background: white; ';
    }
    
    html += '<div onclick="seleccionarDia(' + dia + ')" style="' + estilos + '">';
    
    // N√∫mero del d√≠a
    html += '<div style="font-weight: bold; color: ' + (esHoy ? '#2196f3' : '#333') + ';">' + dia + '</div>';
    
    // Contenido del d√≠a (se llenar√° con planificaciones)
    html += '<div id="contenido-' + a√±o + '-' + mes + '-' + dia + '" style="font-size: 10px; flex: 1;"></div>';
    
    html += '</div>';
  }
  
  html += '</div>';
  document.getElementById('calendario').innerHTML = html;
}

function cambiarMes(direccion) {
  mesActual.setMonth(mesActual.getMonth() + direccion);
  diaSeleccionado = null;
  renderizarCalendario();
  cargarPlanificacionesDelMes();
  limpiarDetalleDia();
}

function irAHoy() {
  mesActual = new Date();
  renderizarCalendario();
  cargarPlanificacionesDelMes();
  seleccionarDia(new Date().getDate());
}

function seleccionarDia(dia) {
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  const esDiaPasado = fechaSeleccionada < hoy;
  
  diaSeleccionado = dia;
  renderizarCalendario();
  
  // Actualizar detalle del d√≠a
  const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const tituloFecha = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
  
  document.getElementById('tituloDetalleDia').textContent = tituloFecha + (esDiaPasado ? ' (Solo lectura)' : '');
  
  cargarDetalleDia(fechaSeleccionada, esDiaPasado);
}

function limpiarDetalleDia() {
  document.getElementById('tituloDetalleDia').textContent = 'Selecciona un d√≠a';
  document.getElementById('contenidoDetalleDia').innerHTML = 
    '<p style="text-align: center; color: #666; padding: 40px 0;">' +
    '<i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br>' +
    'Selecciona un d√≠a del calendario</p>';
}

function cargarPlanificacionesDelMes() {
  const a√±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      mostrarPlanificacionesEnCalendario(planificaciones);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar planificaciones:', error);
    })
    .getPlanificacionesDelMes(a√±o, mes);
}

function mostrarPlanificacionesEnCalendario(planificaciones) {
  planificaciones.forEach(plan => {
    const fecha = new Date(plan.fecha);
    const dia = fecha.getDate();
    const contenedorDia = document.getElementById(`contenido-${fecha.getFullYear()}-${fecha.getMonth()}-${dia}`);
    
    if (contenedorDia) {
      let html = '';
      let colorFondo = '#e3f2fd';
      let icono = 'üìö';
      
      if (plan.estado === 'completado') {
        colorFondo = '#e8f5e9';
        icono = '‚úÖ';
      } else if (plan.estado === 'en_progreso') {
        colorFondo = '#fff3e0';
        icono = 'üîÑ';
      }
      
      html += `<div style="background: ${colorFondo}; padding: 3px; border-radius: 3px; margin: 1px 0; font-size: 10px; cursor: pointer;" `;
      html += `onclick="mostrarDetallePlanificacion('${plan.id}')" title="Ver detalle de planificaci√≥n">`;
      html += `${icono} ${plan.numeroTemas} temas`;
      html += `<br><small style="font-size: 8px;">${Math.round(plan.tiempoEstudio / 60)}h</small>`;
      html += '</div>';
      
      contenedorDia.innerHTML = html;
    }
  });
}

function cargarDetalleDia(fecha, esDiaPasado) {
  const contenedor = document.getElementById('contenidoDetalleDia');
  
  // Mostrar loading inicial
  contenedor.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';
  
  // Buscar planificaci√≥n para esta fecha
  const fechaStr = fecha.getFullYear() + '-' + 
    String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fecha.getDate()).padStart(2, '0');
  
  google.script.run
    .withSuccessHandler(function(planificaciones) {
      // Buscar planificaci√≥n para esta fecha espec√≠fica
      const planDelDia = planificaciones.find(p => {
        const fechaPlan = new Date(p.fecha);
        const fechaBuscar = new Date(fecha);
        fechaPlan.setHours(0, 0, 0, 0);
        fechaBuscar.setHours(0, 0, 0, 0);
        return fechaPlan.getTime() === fechaBuscar.getTime();
      });
      
      if (planDelDia) {
        // Existe planificaci√≥n - cargar detalle completo
        cargarDetallePlanificacionCompleta(planDelDia.id, esDiaPasado);
      } else {
        // No existe planificaci√≥n - mostrar interfaz para crear
        mostrarInterfazSinPlanificacion(esDiaPasado);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al buscar planificaci√≥n:', error);
      mostrarInterfazSinPlanificacion(esDiaPasado);
    })
    .getPlanificacionesDelMes(fecha.getFullYear(), fecha.getMonth());
}

function cargarDetallePlanificacionCompleta(idPlanificacion, esDiaPasado) {
  const contenedor = document.getElementById('contenidoDetalleDia');
  
  google.script.run
    .withSuccessHandler(function(detalle) {
      if (detalle) {
        renderizarDetallePlanificacion(detalle, esDiaPasado);
      } else {
        mostrarInterfazSinPlanificacion(esDiaPasado);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar detalle:', error);
      contenedor.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">‚ùå Error: ' + error.message + '</div>';
    })
    .getDetallePlanificacion(idPlanificacion);
}

function mostrarInterfazSinPlanificacion(esDiaPasado) {
  const contenedor = document.getElementById('contenidoDetalleDia');
  
  if (esDiaPasado) {
    contenedor.innerHTML = 
      '<div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">' +
      '<strong>‚ÑπÔ∏è D√≠a pasado:</strong> Solo puedes consultar la informaci√≥n, no modificar.' +
      '</div>' +
      '<div style="text-align: center; padding: 40px; color: #666;">' +
      '<i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3;"></i><br><br>' +
      'Sin planificaci√≥n registrada' +
      '</div>';
  } else {
    contenedor.innerHTML = 
      '<div style="text-align: center; padding: 40px;">' +
      '<div style="color: #666; margin-bottom: 20px;">' +
      '<i class="fas fa-calendar-plus" style="font-size: 48px; opacity: 0.3;"></i>' +
      '</div>' +
      '<h4 style="color: #666;">Sin planificaci√≥n</h4>' +
      '<p style="color: #999; margin-bottom: 20px;">Este d√≠a no tiene planificaci√≥n de estudio.</p>' +
      '<button onclick="nuevaPlanificacion()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px;">' +
      '‚ûï Crear Planificaci√≥n' +
      '</button>' +
      '</div>';
  }
}

// ====================================
// FUNCIONES DEL MODAL DE PLANIFICACI√ìN
// ====================================

function nuevaPlanificacion() {
  if (!diaSeleccionado) {
    alert('‚ö†Ô∏è Primero selecciona un d√≠a del calendario');
    return;
  }
  
  if (!oposicionActiva) {
    alert('‚ö†Ô∏è Debes tener una oposici√≥n activa');
    return;
  }
  
  // Validar que no es d√≠a pasado
  const fechaSeleccionada = new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fechaSeleccionada.setHours(0, 0, 0, 0);
  
  if (fechaSeleccionada < hoy) {
    alert('‚ö†Ô∏è No puedes crear planificaciones para d√≠as pasados');
    return;
  }
  
  // Resetear estado
  resetearEstadoPlanificacion();
  
  // Establecer fecha autom√°ticamente
  const fechaStr = fechaSeleccionada.getFullYear() + '-' + 
    String(fechaSeleccionada.getMonth() + 1).padStart(2, '0') + '-' + 
    String(fechaSeleccionada.getDate()).padStart(2, '0');
  estadoPlanificacion.fecha = fechaStr;
  
  // Mostrar modal
  document.getElementById('modalNuevaPlanificacion').style.display = 'flex';
  mostrarPaso(1);
}

function resetearEstadoPlanificacion() {
  estadoPlanificacion = {
    paso: 1,
    fecha: null,
    tiempoPrevisto: 240,
    tiempoRepasos: 0,
    tiempoEstudio: 240,
    temasSeleccionados: [],
    bloquesActivos: [],
    repasosDelDia: []
  };
  
  contadorAdvertencias = {
    orden: {},
    bloques: {}
  };
}

function cerrarModal() {
  document.getElementById('modalNuevaPlanificacion').style.display = 'none';
}

function mostrarPaso(numeroPaso) {
  estadoPlanificacion.paso = numeroPaso;
  
  // Ocultar todos los pasos
  document.getElementById('paso1').style.display = 'none';
  document.getElementById('paso2').style.display = 'none';
  document.getElementById('paso3').style.display = 'none';
  
  // Mostrar paso actual
  document.getElementById('paso' + numeroPaso).style.display = 'block';
  
  // Actualizar indicadores
  actualizarIndicadoresPasos();
  
  // Actualizar botones
  document.getElementById('btnAnterior').style.display = numeroPaso > 1 ? 'inline-block' : 'none';
  document.getElementById('btnSiguiente').textContent = numeroPaso === 3 ? 'Crear Planificaci√≥n' : 'Siguiente ‚ñ∂';
  
  // Acciones espec√≠ficas por paso
  if (numeroPaso === 1) {
    mostrarPaso1();
  } else if (numeroPaso === 2) {
    mostrarPaso2();
  } else if (numeroPaso === 3) {
    mostrarPaso3();
  }
}

function actualizarIndicadoresPasos() {
  for (let i = 1; i <= 3; i++) {
    const indicador = document.getElementById('indicadorPaso' + i);
    const circulo = indicador.querySelector('div');
    const texto = indicador.querySelector('span');
    
    if (i < estadoPlanificacion.paso) {
      circulo.style.background = '#28a745';
      circulo.style.color = 'white';
      texto.style.color = '#28a745';
    } else if (i === estadoPlanificacion.paso) {
      circulo.style.background = '#007bff';
      circulo.style.color = 'white';
      texto.style.color = '#007bff';
    } else {
      circulo.style.background = '#ddd';
      circulo.style.color = '#999';
      texto.style.color = '#999';
    }
  }
}

function pasoSiguiente() {
  if (estadoPlanificacion.paso === 1) {
    if (validarPaso1()) {
      mostrarPaso(2);
    }
  } else if (estadoPlanificacion.paso === 2) {
    if (validarPaso2()) {
      mostrarPaso(3);
    }
  } else if (estadoPlanificacion.paso === 3) {
    crearPlanificacion();
  }
}

function pasoAnterior() {
  if (estadoPlanificacion.paso > 1) {
    mostrarPaso(estadoPlanificacion.paso - 1);
  }
}

// ====================================
// PASOS DEL MODAL
// ====================================

function mostrarPaso1() {
  // Establecer fecha autom√°ticamente
  if (estadoPlanificacion.fecha) {
    document.getElementById('fechaPlanificacion').value = estadoPlanificacion.fecha;
    verificarRepasosDelDia();
  }
  
  // Llenar select de oposici√≥n (aunque se usa la activa)
  const select = document.getElementById('oposicionPlanificacion');
  select.innerHTML = '<option value="' + oposicionActiva.id + '">' + oposicionActiva.nombre + '</option>';
  select.value = oposicionActiva.id;
  select.disabled = true; // Solo informativo
}

function mostrarPaso2() {
  // Mostrar repasos del d√≠a
  mostrarRepasosEnPaso2();
  
  // Cargar configuraci√≥n actual
  cargarConfiguracionActual();
  
  // Calcular tiempo inicial
  actualizarCalculoTiempo();
  
  // Configurar event listener
  const horasInput = document.getElementById('horasEstudio');
  horasInput.addEventListener('input', actualizarCalculoTiempo);
}

function mostrarPaso3() {
  // Actualizar tiempo disponible
  actualizarTiempoDisponible();
  
  // Cargar √°rbol de temas
  cargarArbolTemas();
}

// ====================================
// VALIDACIONES DE PASOS
// ====================================

function validarPaso1() {
  const fecha = document.getElementById('fechaPlanificacion').value;
  
  if (!fecha) {
    alert('‚ö†Ô∏è Selecciona una fecha');
    return false;
  }
  
  estadoPlanificacion.fecha = fecha;
  return true;
}

function validarPaso2() {
  const horasInput = document.getElementById('horasEstudio');
  const horas = parseFloat(horasInput.value);
  
  if (!horas || horas < 0.5) {
    alert('‚ö†Ô∏è Introduce un tiempo de estudio v√°lido (m√≠nimo 0.5 horas)');
    horasInput.focus();
    return false;
  }
  
  if (horas > 12) {
    if (!confirm('‚ö†Ô∏è Has introducido ' + horas + ' horas de estudio. ¬øEst√°s seguro?')) {
      horasInput.focus();
      return false;
    }
  }
  
  // Guardar tiempos en estado
  estadoPlanificacion.tiempoPrevisto = horas * 60;
  estadoPlanificacion.tiempoRepasos = estadoPlanificacion.repasosDelDia.length * 30;
  estadoPlanificacion.tiempoEstudio = Math.max(0, estadoPlanificacion.tiempoPrevisto - estadoPlanificacion.tiempoRepasos);
  
  return true;
}

// ====================================
// FUNCIONES DE REPASOS
// ====================================

function verificarRepasosDelDia() {
  const fechaInput = document.getElementById('fechaPlanificacion');
  if (!fechaInput.value) return;
  
  const fechaMs = new Date(fechaInput.value + 'T00:00:00').getTime();
  
  google.script.run
    .withSuccessHandler(function(repasos) {
      estadoPlanificacion.repasosDelDia = repasos || [];
      mostrarRepasosEnPaso1(repasos);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar repasos:', error);
      estadoPlanificacion.repasosDelDia = [];
    })
    .getRepasosDelDia(fechaMs);
}

function mostrarRepasosEnPaso1(repasos) {
  const alertaDiv = document.getElementById('alertaRepasos');
  const listaDiv = document.getElementById('listaRepasos');
  
  if (!repasos || repasos.length === 0) {
    alertaDiv.style.display = 'none';
    return;
  }
  
  let html = '';
  let tiempoTotal = 0;
  
  repasos.forEach(function(repaso) {
    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #ffeaa7;">';
    html += '<div><strong>R' + repaso.numeroRepaso + ':</strong> ' + repaso.nombreTema + '</div>';
    html += '<div style="color: #856404; font-size: 12px;">' + repaso.tiempoEstimado + ' min</div>';
    html += '</div>';
    tiempoTotal += repaso.tiempoEstimado;
  });
  
  html += '<div style="text-align: right; margin-top: 10px; font-weight: bold; color: #856404;">';
  html += 'Total repasos: ' + tiempoTotal + ' minutos (' + Math.round(tiempoTotal / 60 * 10) / 10 + ' horas)';
  html += '</div>';
  
  listaDiv.innerHTML = html;
  alertaDiv.style.display = 'block';
}

function mostrarRepasosEnPaso2() {
  const infoDiv = document.getElementById('infoRepasosStepDos');
  const detalleDiv = document.getElementById('detalleRepasosStepDos');
  
  const repasos = estadoPlanificacion.repasosDelDia;
  
  if (repasos.length === 0) {
    infoDiv.style.display = 'none';
    return;
  }
  
  const tiempoRepasos = repasos.length * 30;
  
  let html = '<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">';
  html += '<div>';
  html += '<ul style="margin: 0; padding-left: 20px;">';
  
  repasos.forEach(function(repaso) {
    html += '<li><strong>R' + repaso.numeroRepaso + ':</strong> ' + repaso.nombreTema + ' <span style="color: #856404;">(30 min)</span></li>';
  });
  
  html += '</ul>';
  html += '</div>';
  html += '<div style="text-align: center; background: #ffc107; color: white; padding: 10px; border-radius: 5px; min-width: 80px;">';
  html += '<div style="font-size: 20px; font-weight: bold;">' + tiempoRepasos + ' min</div>';
  html += '<div style="font-size: 12px;">Total repasos</div>';
  html += '</div>';
  html += '</div>';
  
  detalleDiv.innerHTML = html;
  infoDiv.style.display = 'block';
}

// ====================================
// FUNCIONES DE CONFIGURACI√ìN Y TIEMPO
// ====================================

function cargarConfiguracionActual() {
  if (!oposicionActiva) return;
  
  google.script.run
    .withSuccessHandler(function(config) {
      configuracionActual = config;
      
      document.getElementById('vueltaActual').textContent = config.vueltaActual || '1';
      document.getElementById('minutosPorPagina').textContent = calcularMinutosPorPagina(config);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar configuraci√≥n:', error);
      document.getElementById('vueltaActual').textContent = '1';
      document.getElementById('minutosPorPagina').textContent = '30';
    })
    .getConfiguracionOposicion(oposicionActiva.id);
}

function calcularMinutosPorPagina(config) {
  switch (config.vueltaActual) {
    case 1: return config.minPorPagV1;
    case 2: return config.minPorPagV2;
    case 3: return config.minPorPagV3;
    default: return config.minPorPagV4;
  }
}

function actualizarCalculoTiempo() {
  const horasInput = document.getElementById('horasEstudio');
  const horas = parseFloat(horasInput.value) || 4;
  const minutosPrevistas = horas * 60;
  
  const tiempoRepasos = estadoPlanificacion.repasosDelDia.length * 30;
  const tiempoRealEstudio = Math.max(0, minutosPrevistas - tiempoRepasos);
  
  // Actualizar interfaz
  document.getElementById('tiempoEstudio').textContent = tiempoRealEstudio + ' min';
  document.getElementById('tiempoRepasos').textContent = tiempoRepasos + ' min';
  document.getElementById('tiempoTotalConRepasos').textContent = minutosPrevistas + ' min';
  
  // Mostrar advertencia si tiempo es muy bajo
  mostrarAdvertenciaTiempo(tiempoRealEstudio, tiempoRepasos);
}

function mostrarAdvertenciaTiempo(tiempoReal, tiempoRepasos) {
  let advertenciaDiv = document.getElementById('advertenciaTiempo');
  
  if (!advertenciaDiv) {
    advertenciaDiv = document.createElement('div');
    advertenciaDiv.id = 'advertenciaTiempo';
    advertenciaDiv.style.marginTop = '15px';
    document.getElementById('infoConfiguracion').parentElement.appendChild(advertenciaDiv);
  }
  
  if (tiempoReal <= 30) {
    let html = '<div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px;">';
    html += '<h6 style="color: #721c24; margin: 0 0 10px 0;">‚ö†Ô∏è Advertencia de tiempo</h6>';
    
    if (tiempoReal <= 0) {
      html += '<p style="margin: 0; color: #721c24;">Los repasos ocupan todo el tiempo disponible. ';
      html += 'Considera aumentar las horas previstas.</p>';
    } else {
      html += '<p style="margin: 0; color: #721c24;">Solo quedan ' + tiempoReal + ' minutos para temas nuevos. ';
      html += 'Podr√°s seleccionar muy pocos temas.</p>';
    }
    html += '</div>';
    
    advertenciaDiv.innerHTML = html;
  } else {
    advertenciaDiv.innerHTML = '';
  }
}

function actualizarTiempoDisponible() {
  const tiempoDisponible = estadoPlanificacion.tiempoEstudio;
  
  document.getElementById('tiempoTotal').textContent = tiempoDisponible;
  document.getElementById('tiempoSeleccionado').textContent = '0';
  document.getElementById('tiempoRestante').textContent = tiempoDisponible;
  document.getElementById('bloquesUsados').textContent = '0/4';
}

// ====================================
// FUNCIONES DEL √ÅRBOL DE TEMAS
// ====================================

function cargarArbolTemas() {
  const contenedor = document.getElementById('arbolTemas');
  
  if (!oposicionActiva) {
    contenedor.innerHTML = '<p style="color: red; text-align: center;">Error: No hay oposici√≥n activa</p>';
    return;
  }
  
  const tiempoDisponible = estadoPlanificacion.tiempoEstudio;
  
  contenedor.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando temas...</p>';
  
  google.script.run
    .withSuccessHandler(function(data) {
      if (!data || !data.arbol || data.arbol.length === 0) {
        contenedor.innerHTML = '<p style="text-align: center; color: #999;">No hay temas vinculados a esta oposici√≥n</p>';
        return;
      }
      
      renderizarArbolTemas(data.arbol, data.bloques);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar √°rbol:', error);
      contenedor.innerHTML = '<p style="color: red; text-align: center;">Error al cargar temas: ' + error.message + '</p>';
    })
    .getArbolTemasConEstados(oposicionActiva.id, tiempoDisponible);
}

function renderizarArbolTemas(arbolTemas, bloquesInfo) {
  const contenedor = document.getElementById('arbolTemas');
  
  // Agrupar por bloques
  const temasPorBloque = agruparTemasPorBloque(arbolTemas, bloquesInfo);
  
  let html = '';
  
  Object.keys(temasPorBloque).forEach(nombreBloque => {
    const temasDelBloque = temasPorBloque[nombreBloque];
    
    html += '<div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">';
    
    // Header del bloque
    html += '<div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee;">';
    html += '<h6 style="margin: 0; font-weight: bold;">' + nombreBloque + '</h6>';
    html += '<small style="color: #666;">' + temasDelBloque.length + ' temas principales</small>';
    html += '</div>';
    
    // Contenido del bloque
    html += '<div style="padding: 15px;">';
    temasDelBloque.forEach(tema => {
      html += renderizarNodoTema(tema, 0, nombreBloque);
    });
    html += '</div>';
    
    html += '</div>';
  });
  
  contenedor.innerHTML = html;
}

function agruparTemasPorBloque(arbolTemas, bloquesInfo) {
  const temasPorBloque = {};
  
  arbolTemas.forEach(tema => {
    const nombreBloque = bloquesInfo[tema.idBloque] || 'Sin Bloque';
    
    if (!temasPorBloque[nombreBloque]) {
      temasPorBloque[nombreBloque] = [];
    }
    
    temasPorBloque[nombreBloque].push(tema);
  });
  
  return temasPorBloque;
}

function renderizarNodoTema(nodo, nivel, nombreBloque) {
  const margenIzquierdo = nivel * 20;
  const iconoEstado = getIconoEstado(nodo.estado);
  const colorFondo = getColorFondo(nodo.estado);
  
  let html = '';
  
  html += '<div style="margin-left: ' + margenIzquierdo + 'px; margin-bottom: 8px;">';
  html += '<div style="display: flex; align-items: center; padding: 10px; background: ' + colorFondo + '; border: 1px solid #e0e0e0; border-radius: 6px;">';
  
  // Checkbox solo para temas seleccionables
  if (nodo.seleccionable) {
    html += '<input type="checkbox" onchange="toggleSeleccionTema(this, ' + nodo.id + ', ' + nodo.tiempoMinutos + ', \'' + nombreBloque + '\')" ';
    html += 'style="margin-right: 10px; transform: scale(1.2);">';
  } else {
    html += '<span style="width: 24px; margin-right: 10px; text-align: center; font-size: 16px;">' + iconoEstado + '</span>';
  }
  
  // Contenido del tema
  html += '<div style="flex: 1;">';
  html += '<div style="font-weight: ' + (nivel === 0 ? 'bold' : 'normal') + ';">' + nodo.nombreCompleto + '</div>';
  if (nodo.paginas > 0) {
    html += '<small style="color: #666;">' + nodo.paginas + ' p√°gs ‚Ä¢ ' + nodo.tiempoTexto + '</small>';
  }
  html += '</div>';
  
  // Badge de estado
  html += '<span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ' + getColorBadge(nodo.estado) + '; color: white;">';
  html += getTextoEstado(nodo.estado);
  html += '</span>';
  
  html += '</div>';
  
  // Renderizar hijos recursivamente
  if (nodo.hijos && nodo.hijos.length > 0) {
    nodo.hijos.forEach(hijo => {
      html += renderizarNodoTema(hijo, nivel + 1, nombreBloque);
    });
  }
  
  html += '</div>';
  
  return html;
}

// ====================================
// FUNCIONES DE SELECCI√ìN DE TEMAS
// ====================================

function toggleSeleccionTema(checkbox, idTema, tiempoMinutos, nombreBloque) {
  if (checkbox.checked) {
    // Validar selecci√≥n
    if (!validarSeleccionTema(tiempoMinutos, nombreBloque)) {
      checkbox.checked = false;
      return;
    }
    
    // Agregar tema
    estadoPlanificacion.temasSeleccionados.push({
      id: idTema,
      tiempo: tiempoMinutos,
      bloque: nombreBloque,
      tipo: 'hijo'
    });
    
    // Agregar bloque si no est√°
    if (!estadoPlanificacion.bloquesActivos.includes(nombreBloque)) {
      estadoPlanificacion.bloquesActivos.push(nombreBloque);
    }
    
  } else {
    // Quitar tema
    const index = estadoPlanificacion.temasSeleccionados.findIndex(t => t.id === idTema);
    if (index > -1) {
      estadoPlanificacion.temasSeleccionados.splice(index, 1);
      
      // Verificar si quitar bloque
      const masDelMismoBloque = estadoPlanificacion.temasSeleccionados.some(t => t.bloque === nombreBloque);
      if (!masDelMismoBloque) {
        const indexBloque = estadoPlanificacion.bloquesActivos.indexOf(nombreBloque);
        if (indexBloque > -1) {
          estadoPlanificacion.bloquesActivos.splice(indexBloque, 1);
        }
      }
    }
  }
  
  actualizarResumenTiempo();
}

function validarSeleccionTema(tiempoMinutos, nombreBloque) {
  const tiempoUsado = estadoPlanificacion.temasSeleccionados.reduce((total, tema) => total + tema.tiempo, 0);
  const tiempoDisponible = estadoPlanificacion.tiempoEstudio;
  
  // Validar tiempo
  if (tiempoUsado + tiempoMinutos > tiempoDisponible) {
    const exceso = tiempoUsado + tiempoMinutos - tiempoDisponible;
    alert('‚ö†Ô∏è Excede el tiempo disponible por ' + Math.round(exceso) + ' minutos');
    return false;
  }
  
  // Validar l√≠mite de bloques (con advertencias)
  if (!estadoPlanificacion.bloquesActivos.includes(nombreBloque)) {
    if (estadoPlanificacion.bloquesActivos.length >= 3) {
      const clave = 'limite_bloques_' + estadoPlanificacion.bloquesActivos.length;
      
      if (!contadorAdvertencias.bloques[clave]) {
        contadorAdvertencias.bloques[clave] = 0;
      }
      
      contadorAdvertencias.bloques[clave]++;
      
      if (contadorAdvertencias.bloques[clave] === 1) {
        alert('‚ö†Ô∏è L√≠mite de bloques recomendado alcanzado.\nTienes ' + estadoPlanificacion.bloquesActivos.length + ' bloques activos.\n\nPrimera advertencia: No se permite esta vez.');
        return false;
      } else {
        const confirmar = confirm('‚ö†Ô∏è L√≠mite de bloques recomendado alcanzado.\nTienes ' + estadoPlanificacion.bloquesActivos.length + ' bloques activos.\n\n¬øQuieres continuar de todas formas?');
        return confirmar;
      }
    }
  }
  
  return true;
}

function actualizarResumenTiempo() {
  const tiempoUsado = estadoPlanificacion.temasSeleccionados.reduce((total, tema) => total + tema.tiempo, 0);
  const tiempoDisponible = estadoPlanificacion.tiempoEstudio;
  const tiempoRestante = tiempoDisponible - tiempoUsado;
  
  document.getElementById('tiempoSeleccionado').textContent = tiempoUsado;
  document.getElementById('tiempoRestante').textContent = tiempoRestante;
  document.getElementById('bloquesUsados').textContent = estadoPlanificacion.bloquesActivos.length + '/4';
  
  // Cambiar colores seg√∫n estado
  const elementoRestante = document.getElementById('tiempoRestante');
  if (tiempoRestante < 0) {
    elementoRestante.style.color = '#dc3545';
  } else if (tiempoRestante < 30) {
    elementoRestante.style.color = '#ffc107';
  } else {
    elementoRestante.style.color = '#28a745';
  }
}

// ====================================
// FUNCIONES DE CREACI√ìN DE PLANIFICACI√ìN
// ====================================

function crearPlanificacion() {
  // Validaciones finales
  if (estadoPlanificacion.temasSeleccionados.length === 0) {
    alert('‚ö†Ô∏è Debes seleccionar al menos un tema');
    return;
  }
  
  // Recopilar datos
  const datos = {
    fecha: estadoPlanificacion.fecha,
    idOposicion: oposicionActiva.id,
    tiempoPrevisto: estadoPlanificacion.tiempoPrevisto,
    tiempoRepasos: estadoPlanificacion.tiempoRepasos,
    tiempoEstudio: estadoPlanificacion.tiempoEstudio,
    temasSeleccionados: estadoPlanificacion.temasSeleccionados,
    numeroBloques: estadoPlanificacion.bloquesActivos.length
  };
  
  // Confirmar creaci√≥n
  const mensaje = `¬øCrear planificaci√≥n para ${estadoPlanificacion.fecha}?\n\n` +
                 `‚Ä¢ ${datos.temasSeleccionados.length} temas\n` +
                 `‚Ä¢ ${Math.round(datos.tiempoEstudio / 60 * 10) / 10}h de estudio\n` +
                 `‚Ä¢ ${datos.numeroBloques} bloques`;
  
  if (!confirm(mensaje)) return;
  
  // Deshabilitar bot√≥n
  const btnCrear = document.getElementById('btnSiguiente');
  btnCrear.disabled = true;
  btnCrear.textContent = '‚è≥ Creando...';
  
  // Llamar al backend
  google.script.run
    .withSuccessHandler(function(resultado) {
      alert('üéâ Planificaci√≥n creada correctamente!\n\n' + resultado.mensaje);
      cerrarModal();
      cargarPlanificacionesDelMes();
      seleccionarDia(diaSeleccionado); // Recargar detalle del d√≠a
    })
    .withFailureHandler(function(error) {
      console.error('Error al crear planificaci√≥n:', error);
      alert('‚ùå Error al crear planificaci√≥n: ' + error.message);
    })
    .addPlanificacion(datos)
    .finally(function() {
      btnCrear.disabled = false;
      btnCrear.textContent = 'Crear Planificaci√≥n';
    });
}

// ====================================
// FUNCIONES AUXILIARES
// ====================================

function getIconoEstado(estado) {
  switch (estado) {
    case 'completado': return '‚úÖ';
    case 'en_progreso': return 'üîÑ';
    default: return '‚≠ï';
  }
}

function getColorFondo(estado) {
  switch (estado) {
    case 'completado': return '#e8f5e9';
    case 'en_progreso': return '#fff3e0';
    default: return '#ffffff';
  }
}

function getColorBadge(estado) {
  switch (estado) {
    case 'completado': return '#4caf50';
    case 'en_progreso': return '#ff9800';
    default: return '#9e9e9e';
  }
}

function getTextoEstado(estado) {
  switch (estado) {
    case 'completado': return 'OK';
    case 'en_progreso': return 'PROG';
    default: return 'PEND';
  }
}

function mostrarDetallePlanificacion(idPlanificacion) {
  console.log('Mostrar detalle de planificaci√≥n:', idPlanificacion);
  
  document.getElementById('contenidoDetalleDia').innerHTML = 
    '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Cargando detalle...</div>';
  
  google.script.run
    .withSuccessHandler(function(detalle) {
      if (detalle) {
        renderizarDetallePlanificacion(detalle);
      } else {
        document.getElementById('contenidoDetalleDia').innerHTML = 
          '<div style="color: red; text-align: center; padding: 20px;">‚ùå Planificaci√≥n no encontrada</div>';
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar detalle:', error);
      document.getElementById('contenidoDetalleDia').innerHTML = 
        '<div style="color: red; text-align: center; padding: 20px;">‚ùå Error: ' + error.message + '</div>';
    })
    .getDetallePlanificacion(idPlanificacion);
}

function renderizarDetallePlanificacion(detalle) {
  const contenedor = document.getElementById('contenidoDetalleDia');
  
  // Calcular estad√≠sticas
  const temasCompletados = detalle.temas.filter(t => t.estado === 'completado').length;
  const temasPendientes = detalle.temas.filter(t => t.estado === 'planificado').length;
  
  let html = '';
  
  // Header con informaci√≥n general
  html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
  html += '<h4 style="margin: 0 0 10px 0; color: #007bff;">üìù Planificaci√≥n del d√≠a</h4>';
  
  html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-bottom: 15px;">';
  html += '<div style="background: white; padding: 10px; border-radius: 5px;">';
  html += '<div style="font-size: 20px; font-weight: bold; color: #007bff;">' + detalle.temas.length + '</div>';
  html += '<div style="font-size: 12px; color: #666;">Total</div>';
  html += '</div>';
  html += '<div style="background: white; padding: 10px; border-radius: 5px;">';
  html += '<div style="font-size: 20px; font-weight: bold; color: #28a745;">' + temasCompletados + '</div>';
  html += '<div style="font-size: 12px; color: #666;">Completados</div>';
  html += '</div>';
  html += '<div style="background: white; padding: 10px; border-radius: 5px;">';
  html += '<div style="font-size: 20px; font-weight: bold; color: #6c757d;">' + temasPendientes + '</div>';
  html += '<div style="font-size: 12px; color: #666;">Pendientes</div>';
  html += '</div>';
  html += '</div>';
  
  html += '<div style="text-align: center;">';
  html += '<strong>‚è±Ô∏è Tiempo:</strong> ' + Math.round(detalle.tiempoEstudio / 60 * 10) / 10 + 'h estudio';
  if (detalle.tiempoRepasos > 0) {
    html += ' + ' + Math.round(detalle.tiempoRepasos / 60 * 10) / 10 + 'h repasos';
  }
  html += '</div>';
  
  html += '</div>';
  
  // Lista de temas
  html += '<div style="background: white; border-radius: 8px; padding: 15px;">';
  html += '<h5 style="margin: 0 0 15px 0;">üìã Temas planificados</h5>';
  
  if (detalle.temas.length === 0) {
    html += '<p style="text-align: center; color: #666;">No hay temas en esta planificaci√≥n</p>';
  } else {
    detalle.temas.forEach(tema => {
      let colorBorde = '#6c757d';
      let colorFondo = '#f8f9fa';
      let icono = '‚≠ï';
      
      if (tema.estado === 'completado') {
        colorBorde = '#28a745';
        colorFondo = '#d4edda';
        icono = '‚úÖ';
      }
      
      html += '<div style="border-left: 4px solid ' + colorBorde + '; background: ' + colorFondo + '; padding: 12px; margin-bottom: 10px; border-radius: 5px;">';
      html += '<div style="font-weight: bold;">' + icono + ' ' + tema.nombreCompleto + '</div>';
      html += '<div style="font-size: 13px; color: #666; margin-top: 5px;">';
      html += '‚è±Ô∏è ' + tema.tiempoAsignado + ' min asignados';
      if (tema.tiempoDedicado > 0) {
        html += ' | ' + tema.tiempoDedicado + ' min dedicados';
      }
      html += '</div>';
      
      if (tema.estado === 'planificado') {
        html += '<button onclick="marcarTemaCompleto(' + tema.idProgreso + ', \'' + tema.nombreCompleto.replace(/'/g, "\\'") + '\')" ';
        html += 'style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 10px; cursor: pointer;">‚úÖ Completar</button>';
      }
      
      html += '</div>';
    });
  }
  
  html += '</div>';
  
  contenedor.innerHTML = html;
}

function marcarTemaCompleto(idProgreso, nombreTema) {
  const tiempoReal = prompt('‚è±Ô∏è ¬øCu√°ntos minutos dedicaste al tema "' + nombreTema + '"?', '30');
  
  if (!tiempoReal || isNaN(tiempoReal) || tiempoReal < 1) {
    alert('‚ö†Ô∏è Tiempo no v√°lido');
    return;
  }
  
  const nota = prompt('üí≠ Nota personal (opcional):', '');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      if (resultado.success) {
        alert('üéâ ¬°Tema completado!\n\nSe han programado ' + resultado.repasosCreados + ' repasos autom√°ticamente.');
        // Recargar el detalle
        setTimeout(() => {
          seleccionarDia(diaSeleccionado);
        }, 500);
      } else {
        alert('‚ùå Error: ' + resultado.error);
      }
    })
    .withFailureHandler(function(error) {
      alert('‚ùå Error de conexi√≥n: ' + error.message);
    })
    .marcarTemaComoCompletado(idProgreso, parseInt(tiempoReal), nota || null);
}
</script>
