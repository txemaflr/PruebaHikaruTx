<script>
// Funciones para la sección de Tests

// Cargar datos iniciales para tests
function cargarDatosTest() {
  console.log('Cargando datos para test...');
  cargarOposicionesParaTest();
}

// Cargar oposiciones en el select
function cargarOposicionesParaTest() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const combo = document.getElementById('selectOposicionTest');
      combo.innerHTML = '<option value="">-- Selecciona una oposición --</option>';
      
      oposiciones.forEach(function(op) {
        const option = document.createElement('option');
        option.value = op.id;
        option.text = op.nombre;
        combo.add(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      alert('Error al cargar oposiciones');
    })
    .getOposicionesOrdenadas();
}

// Cargar temas cuando se selecciona una oposición
function cargarTemasParaTest() {
  const idOposicion = document.getElementById('selectOposicionTest').value;
  const contenedor = document.getElementById('contenedorTemasTest');
  
  if (!idOposicion) {
    contenedor.innerHTML = '';
    contenedor.style.display = 'none';
    return;
  }
  
  contenedor.style.display = 'block';
  
  google.script.run
    .withSuccessHandler(function(temas) {
      mostrarArbolTemasTest(temas);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar temas:', error);
      contenedor.innerHTML = '<p style="color: red;">Error al cargar temas</p>';
    })
    .getTemasVinculadosEnArbolOrdenados(idOposicion);
}

// Mostrar árbol de temas con checkboxes
function mostrarArbolTemasTest(temas) {
  const contenedor = document.getElementById('contenedorTemasTest');
  contenedor.innerHTML = '<h4>Selecciona los temas:</h4>';
  
  const divTemas = document.createElement('div');
  divTemas.className = 'lista-temas-test';
  
  function crearNodoTema(tema, nivel = 0) {
    const div = document.createElement('div');
    div.className = 'tema-checkbox';
    div.style.marginLeft = (nivel * 20) + 'px';
    div.style.padding = '3px 0';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = tema.id;
    checkbox.id = 'tema_test_' + tema.id;
    checkbox.className = 'checkbox-tema';
    
    const label = document.createElement('label');
    label.htmlFor = 'tema_test_' + tema.id;
    label.style.marginLeft = '5px';
    label.style.fontWeight = 'normal';
    label.textContent = (tema.prenombre ? tema.prenombre + ' ' : '') + tema.nombre;
    
    div.appendChild(checkbox);
    div.appendChild(label);
    divTemas.appendChild(div);
    
    // Procesar hijos
    if (tema.hijos && tema.hijos.length > 0) {
      tema.hijos.forEach(hijo => crearNodoTema(hijo, nivel + 1));
    }
  }
  
  if (temas && temas.length > 0) {
    temas.forEach(tema => crearNodoTema(tema));
  } else {
    divTemas.innerHTML = '<p>No hay temas vinculados a esta oposición</p>';
  }
  
  contenedor.appendChild(divTemas);
  
  // Botón seleccionar todos
  const btnContainer = document.createElement('div');
  btnContainer.style.marginTop = '10px';
  
  const btnTodos = document.createElement('button');
  btnTodos.textContent = 'Seleccionar todos';
  btnTodos.type = 'button';
  btnTodos.onclick = function() {
    document.querySelectorAll('.checkbox-tema').forEach(cb => cb.checked = true);
  };
  
  btnContainer.appendChild(btnTodos);
  contenedor.appendChild(btnContainer);
}

// Variables globales para el test
let testActual = null;
let preguntaActual = 0;
let respuestasUsuario = [];
let tiempoInicio = null;
let timerInterval = null;

// Configurar y generar test
function configurarTest() {
  const idOposicion = document.getElementById('selectOposicionTest').value;
  const numPreguntas = parseInt(document.getElementById('numPreguntasTest').value);
  const modo = document.querySelector('input[name="modoTest"]:checked')?.value;
  
  // Obtener temas seleccionados
  const temasSeleccionados = [];
  document.querySelectorAll('.checkbox-tema:checked').forEach(cb => {
    temasSeleccionados.push(parseInt(cb.value));
  });
  
  // Validaciones
  if (!idOposicion) {
    alert('Selecciona una oposición');
    return;
  }
  
  if (temasSeleccionados.length === 0) {
    alert('Selecciona al menos un tema');
    return;
  }
  
  if (!numPreguntas || numPreguntas < 5 || numPreguntas > 125) {
    alert('El número de preguntas debe estar entre 5 y 125');
    return;
  }
  
  if (!modo) {
    alert('Selecciona un modo de test');
    return;
  }
  
  // Opciones adicionales
  const opciones = {
    soloFalladas: document.getElementById('checkSoloFalladas').checked,
    incluirDominadas: !document.getElementById('checkExcluirDominadas').checked,
    soloDominadas: document.getElementById('checkSoloDominadas').checked
  };
  
  console.log('Generando test con:', {
    idOposicion,
    temasSeleccionados,
    numPreguntas,
    modo,
    opciones
  });
  
  // Por ahora solo mostrar alerta
  alert('Función de test en desarrollo. Configuración recibida correctamente.');
}
</script>

<style>
/* Estilos para la sección de tests */
#contenedorTemasTest {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 15px;
  margin: 15px 0;
  display: none;
}

.lista-temas-test {
  max-height: 250px;
  overflow-y: auto;
  margin-bottom: 10px;
  padding: 10px;
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 4px;
}

.tema-checkbox {
  padding: 3px 0;
}

.tema-checkbox input[type="checkbox"] {
  margin-right: 5px;
}

.tema-checkbox label {
  cursor: pointer;
  user-select: none;
}

.tema-checkbox label:hover {
  color: #007bff;
}

/* Corregir alineación de radio buttons y checkboxes */
input[type="radio"],
input[type="checkbox"] {
  margin: 0 5px 0 0;
  vertical-align: middle;
}

input[type="radio"] + label,
input[type="checkbox"] + label {
  display: inline;
  margin: 0;
  vertical-align: middle;
  font-weight: normal;
}

.radio-option,
.checkbox-option {
  margin: 8px 0;
}
</style>
