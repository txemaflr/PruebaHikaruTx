<script>
// Variables globales para test
var temasDisponiblesTest = [];
// Variables para el test activo globales
var testActivo = null;
var preguntaActual = 0;
var respuestasTest = []; // Array de objetos {letra: 'A', corregida: false, esCorrecta: null}

// NUEVO: Variables para el temporizador
var tiempoInicio = null;
var intervalTemporizador = null;
var alertas5MinMostrada = false;
var alerta1MinMostrada = false;

// Cargar oposiciones cuando se entra a la sección Test
function inicializarSeccionTest() {
  console.log('Inicializando sección Test...');
  cargarOposicionesParaTest();
}

// Cargar combo de oposiciones
function cargarOposicionesParaTest() {
  google.script.run
    .withSuccessHandler(function(oposiciones) {
      const combo = document.getElementById('comboOposicionTest');
      combo.innerHTML = '<option value="">-- Selecciona una oposición --</option>';
      
      oposiciones.forEach(function(op) {
        const option = document.createElement('option');
        option.value = op.id;
        option.textContent = op.nombre;
        combo.appendChild(option);
      });
      
      console.log('Oposiciones cargadas:', oposiciones.length);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar oposiciones:', error);
      alert('Error al cargar oposiciones');
    })
    .getOposicionesOrdenadas();
}

// Cargar temas cuando se selecciona una oposición
function cargarTemasParaTestPorOposicion() {
  const idOposicion = document.getElementById('comboOposicionTest').value;
  const seccionTemas = document.getElementById('seccionTemasTest');
  const arbolTemas = document.getElementById('arbolTemasTest');
  
  if (!idOposicion) {
    seccionTemas.style.display = 'none';
    return;
  }
  
  seccionTemas.style.display = 'block';
  arbolTemas.innerHTML = '<p>Cargando temas...</p>';
  
  google.script.run
    .withSuccessHandler(function(temas) {
      temasDisponiblesTest = temas;
      mostrarArbolTemasParaTest(temas);
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar temas:', error);
      arbolTemas.innerHTML = '<p style="color: red;">Error al cargar temas</p>';
    })
    .getTemasVinculadosEnArbolOrdenados(idOposicion);
}

// Mostrar árbol de temas con checkboxes
function mostrarArbolTemasParaTest(temas) {
  const contenedor = document.getElementById('arbolTemasTest');
  let html = '';
  
  function renderTema(tema, nivel) {
    const margen = nivel * 20;
    const nombreCompleto = (tema.prenombre ? tema.prenombre + ' ' : '') + tema.nombre;
    
    html += '<div style="margin-left: ' + margen + 'px; padding: 3px 0;">';
    html += '<label style="cursor: pointer; display: block;">';
    html += '<input type="checkbox" class="checkTemaTest" value="' + tema.id + '" ';
    html += 'data-nivel="' + nivel + '" ';
    html += 'onchange="manejarSeleccionTema(this, ' + tema.id + ')" ';
    html += 'style="margin-right: 5px;">';
    html += nombreCompleto;
    html += '</label>';
    html += '</div>';
    
    if (tema.hijos && tema.hijos.length > 0) {
      tema.hijos.forEach(function(hijo) {
        renderTema(hijo, nivel + 1);
      });
    }
  }
  
  if (temas && temas.length > 0) {
    temas.forEach(function(tema) {
      renderTema(tema, 0);
    });
  } else {
    html = '<p>No hay temas vinculados a esta oposición</p>';
  }
  
  contenedor.innerHTML = html;
}

// Manejar selección de temas (seleccionar hijos automáticamente)
function manejarSeleccionTema(checkbox, idTema) {
  const seleccionado = checkbox.checked;
  
  // Buscar el tema en la estructura
  function buscarTema(temas, id) {
    for (let tema of temas) {
      if (tema.id === id) return tema;
      if (tema.hijos) {
        const encontrado = buscarTema(tema.hijos, id);
        if (encontrado) return encontrado;
      }
    }
    return null;
  }
  
  const tema = buscarTema(temasDisponiblesTest, idTema);
  
  // Seleccionar/deseleccionar todos los hijos
  if (tema && tema.hijos) {
    function toggleHijos(hijos) {
      hijos.forEach(function(hijo) {
        const checkHijo = document.querySelector('input[value="' + hijo.id + '"]');
        if (checkHijo) {
          checkHijo.checked = seleccionado;
        }
        if (hijo.hijos) toggleHijos(hijo.hijos);
      });
    }
    toggleHijos(tema.hijos);
  }
}

// Seleccionar todos los temas
function seleccionarTodosLosTemas() {
  document.querySelectorAll('.checkTemaTest').forEach(function(check) {
    check.checked = true;
  });
}

// Deseleccionar todos los temas
function deseleccionarTodosLosTemas() {
  document.querySelectorAll('.checkTemaTest').forEach(function(check) {
    check.checked = false;
  });
}

// Preparar el test
function prepararTest() {
  // Obtener valores ANTES de usarlos
  const idOposicion = document.getElementById('comboOposicionTest').value;
  const numPreguntas = parseInt(document.getElementById('numeroPreguntasTest').value);
  const modoRadio = document.querySelector('input[name="modoTest"]:checked');
  const modo = modoRadio ? modoRadio.value : 'practica';
  
  // Validaciones
  if (!idOposicion) {
    alert('Selecciona una oposición');
    return;
  }
  
  const temasSeleccionados = [];
  document.querySelectorAll('.checkTemaTest:checked').forEach(function(check) {
    temasSeleccionados.push(parseInt(check.value));
  });
  
  if (temasSeleccionados.length === 0) {
    alert('Selecciona al menos un tema');
    return;
  }
  
  if (isNaN(numPreguntas) || numPreguntas < 5 || numPreguntas > 125) {
    alert('El número de preguntas debe estar entre 5 y 125');
    return;
  }
  
  const opciones = {
    soloFalladas: document.getElementById('checkSoloFalladas').checked,
    excluirDominadas: document.getElementById('checkExcluirDominadas').checked,
    soloDominadas: document.getElementById('checkMostrarDominadas').checked
  };
  
  console.log('Configuración del test:', {
    oposicion: idOposicion,
    temas: temasSeleccionados,
    preguntas: numPreguntas,
    modo: modo,
    opciones: opciones
  });
  
  // Ocultar panel de configuración
  document.getElementById('panelConfiguracionTest').style.display = 'none';
  const panelAdmin = document.querySelector('div[style*="width: 350px"]');
  if (panelAdmin) panelAdmin.style.display = 'none';
  
  // Mostrar loading
  document.getElementById('panelEjecucionTest').innerHTML = '<p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Generando test...</p>';
  document.getElementById('panelEjecucionTest').style.display = 'block';
  
  // Llamar al backend para generar el test
  google.script.run
    .withSuccessHandler(function(test) {
      console.log('Test generado:', test);
      testActivo = test;
      preguntaActual = 0;
      respuestasTest = new Array(test.preguntas.length).fill(null);
      
      // Iniciar temporizador si es modo examen
      if (modo === 'examen') {
        tiempoInicio = new Date();
        alertas5MinMostrada = false;
        alerta1MinMostrada = false;
        iniciarTemporizador();
      }
      
      mostrarPregunta();
    })
    .withFailureHandler(function(error) {
      console.error('Error al generar test:', error);
      alert('Error al generar test: ' + error.message);
      volverAConfiguracion();
    })
    .generarTest(idOposicion, temasSeleccionados, numPreguntas, modo, opciones);
}

// NUEVO: Iniciar temporizador para modo examen
function iniciarTemporizador() {
  if (intervalTemporizador) clearInterval(intervalTemporizador);
  
  intervalTemporizador = setInterval(function() {
    actualizarTemporizador();
  }, 1000);
}

// NUEVO: Actualizar temporizador
function actualizarTemporizador() {
  if (!tiempoInicio) return;
  
  const ahora = new Date();
  const tiempoTranscurrido = Math.floor((ahora - tiempoInicio) / 1000);
  const minutos = Math.floor(tiempoTranscurrido / 60);
  const segundos = tiempoTranscurrido % 60;
  
  // Calcular tiempo total y restante
  const tiempoTotal = testActivo.preguntas.length * 60; // 1 minuto por pregunta
  const tiempoRestante = tiempoTotal - tiempoTranscurrido;
  const minutosRestantes = Math.floor(tiempoRestante / 60);
  const segundosRestantes = tiempoRestante % 60;
  
  const elementoTiempo = document.getElementById('tiempoTranscurrido');
  if (elementoTiempo) {
    // Mostrar tiempo transcurrido y restante
    let textoTiempo = minutos + ':' + (segundos < 10 ? '0' : '') + segundos;
    
    // Si quedan menos de 5 minutos, mostrar en rojo
    if (tiempoRestante <= 300) {
      textoTiempo += ' <span style="color: #dc3545; font-weight: bold;">(' + 
                     minutosRestantes + ':' + (segundosRestantes < 10 ? '0' : '') + 
                     segundosRestantes + ' restantes)</span>';
    } else {
      textoTiempo += ' <span style="color: #6c757d; font-size: 14px;">(' + 
                     minutosRestantes + ':' + (segundosRestantes < 10 ? '0' : '') + 
                     segundosRestantes + ' restantes)</span>';
    }
    
    elementoTiempo.innerHTML = textoTiempo;
    
    // Avisos de tiempo
    if (tiempoRestante === 300 && testActivo.preguntas.length > 20 && !alertas5MinMostrada) {
      alertas5MinMostrada = true;
      mostrarAvisoTiempo('¡Atención! Quedan 5 minutos para finalizar el test', 'warning');
    } else if (tiempoRestante === 60 && !alerta1MinMostrada) {
      alerta1MinMostrada = true;
      mostrarAvisoTiempo('¡ÚLTIMO MINUTO! El test finalizará pronto', 'danger');
    } else if (tiempoRestante <= 0) {
      // Tiempo agotado - finalizar automáticamente
      clearInterval(intervalTemporizador);
      alert('¡Tiempo agotado! El test se finalizará automáticamente.');
      finalizarTest();
    }
  }
}

// NUEVO: Mostrar aviso de tiempo con estilo
function mostrarAvisoTiempo(mensaje, tipo) {
  // Crear elemento de aviso
  const aviso = document.createElement('div');
  aviso.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: ${tipo === 'danger' ? '#dc3545' : '#ffc107'};
    color: ${tipo === 'danger' ? 'white' : '#212529'};
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    font-weight: bold;
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
  `;
  aviso.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + mensaje;
  
  // Añadir animación CSS
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(aviso);
  
  // Quitar aviso después de 5 segundos
  setTimeout(function() {
    aviso.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(function() {
      aviso.remove();
    }, 300);
  }, 5000);
  
  // También mostrar en alert para asegurar que el usuario lo vea
  alert(mensaje);
}

// Mostrar una pregunta (CORREGIDA)
function mostrarPregunta() {
  if (!testActivo || preguntaActual >= testActivo.preguntas.length) {
    finalizarTest();
    return;
  }
  
  const pregunta = testActivo.preguntas[preguntaActual];
  const totalPreguntas = testActivo.preguntas.length;
  const respuestaGuardada = respuestasTest[preguntaActual];
  
  let html = '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
  
  // Temporizador para modo examen
  if (testActivo.modo === 'examen') {
    html += '<div style="text-align: right; margin-bottom: 10px; font-size: 18px; font-weight: bold;">';
    html += '<i class="fas fa-clock"></i> <span id="tiempoTranscurrido">0:00</span>';
    html += '</div>';
  }
  
  // Progreso
  html += '<div style="margin-bottom: 20px;">';
  html += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
  html += '<span>Pregunta ' + (preguntaActual + 1) + ' de ' + totalPreguntas + '</span>';
  html += '<span>Modo: ' + testActivo.modo + '</span>';
  html += '</div>';
  html += '<div style="background: #e0e0e0; height: 10px; border-radius: 5px;">';
  html += '<div style="background: #007bff; height: 100%; width: ' + ((preguntaActual + 1) / totalPreguntas * 100) + '%; border-radius: 5px;"></div>';
  html += '</div>';
  html += '</div>';
  
  // Pregunta
  html += '<h3>' + pregunta.titulo + '</h3>';
  if (pregunta.descripcion) {
    html += '<p>' + pregunta.descripcion + '</p>';
  }
  
  // Opciones
  html += '<div style="margin: 20px 0;" id="contenedorOpciones">';
  ['A', 'B', 'C', 'D'].forEach(function(letra, index) {
    const opcion = pregunta['opcion_' + letra.toLowerCase()];
    html += '<div style="margin: 10px 0; padding: 15px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer;" ';
    html += 'id="opcion' + letra + '" ';
    html += 'onclick="seleccionarRespuesta(\'' + letra + '\')" ';
    html += 'ondblclick="deseleccionarRespuesta()">';
    html += '<strong>' + letra + '.</strong> ' + opcion;
    html += '</div>';
  });
  html += '</div>';
  
  // Área de retroalimentación (oculta inicialmente)
  html += '<div id="areaRetroalimentacion" style="display: none;"></div>';
  
  // Botones navegación
  html += '<div style="display: flex; justify-content: space-between; margin-top: 20px;">';
  html += '<button onclick="preguntaAnterior()" ' + (preguntaActual === 0 ? 'disabled' : '') + '>Anterior</button>';
  
  if (testActivo.modo === 'practica') {
    html += '<button id="btnCorregir" onclick="corregirPregunta()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 5px;">Corregir</button>';
  }
  
  html += '<button id="btnSiguiente" onclick="siguientePregunta()">';
  html += (preguntaActual === totalPreguntas - 1) ? 'Finalizar' : 'Siguiente';
  html += '</button>';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('panelEjecucionTest').innerHTML = html;
  
  // Restaurar estado si había respuesta guardada
  if (respuestaGuardada) {
    marcarOpcion(respuestaGuardada.letra);
    
    // Si está corregida en modo práctica, mostrar corrección
    if (testActivo.modo === 'practica' && respuestaGuardada.corregida) {
      mostrarCorreccion();
    }
  }
}

// Seleccionar respuesta (UNIFICADA Y CORREGIDA)
function seleccionarRespuesta(letra) {
  // Si ya está corregida en modo práctica, no permitir cambios
  if (testActivo.modo === 'practica' && respuestasTest[preguntaActual] && 
      respuestasTest[preguntaActual].corregida) {
    return;
  }
  
  // Guardar respuesta en la estructura local
  respuestasTest[preguntaActual] = {
    letra: letra,
    corregida: false,
    esCorrecta: null
  };
  
  // Marcar visualmente
  marcarOpcion(letra);
}

// NUEVA: Función auxiliar para marcar visualmente una opción
function marcarOpcion(letra) {
  ['A', 'B', 'C', 'D'].forEach(function(l) {
    const elem = document.getElementById('opcion' + l);
    if (l === letra) {
      elem.style.background = '#e3f2fd';
      elem.style.borderColor = '#2196f3';
    } else {
      elem.style.background = 'white';
      elem.style.borderColor = '#ddd';
    }
  });
}

// Deseleccionar respuesta (doble click)
function deseleccionarRespuesta() {
  // No permitir deseleccionar si ya está corregida
  if (testActivo.modo === 'practica' && respuestasTest[preguntaActual] && 
      respuestasTest[preguntaActual].corregida) {
    return;
  }
  
  respuestasTest[preguntaActual] = null;
  
  ['A', 'B', 'C', 'D'].forEach(function(letra) {
    const elem = document.getElementById('opcion' + letra);
    elem.style.background = 'white';
    elem.style.borderColor = '#ddd';
  });
}

// Función para corregir en modo práctica (CORREGIDA)
function corregirPregunta() {
  if (!respuestasTest[preguntaActual] || !respuestasTest[preguntaActual].letra) {
    alert('Selecciona una respuesta primero');
    return;
  }
  
  // Si ya está corregida, no hacer nada
  if (respuestasTest[preguntaActual].corregida) {
    return;
  }
  
  const pregunta = testActivo.preguntas[preguntaActual];
  const respuestaUsuario = respuestasTest[preguntaActual].letra;
  
  // Deshabilitar botón mientras se procesa
  const btnCorregir = document.getElementById('btnCorregir');
  if (btnCorregir) {
    btnCorregir.disabled = true;
    btnCorregir.textContent = 'Corrigiendo...';
  }
  
  // Guardar respuesta en el servidor
  google.script.run
    .withSuccessHandler(function(resultado) {
      respuestasTest[preguntaActual].esCorrecta = resultado.esCorrecta;
      respuestasTest[preguntaActual].corregida = true;
      mostrarCorreccion();
    })
    .withFailureHandler(function(error) {
      console.error('Error al guardar respuesta:', error);
      if (btnCorregir) {
        btnCorregir.disabled = false;
        btnCorregir.textContent = 'Corregir';
      }
    })
    .guardarRespuestaTest(
      testActivo.idHistorial, 
      pregunta.id, 
      respuestaUsuario, 
      pregunta.index
    );
}

// Mostrar corrección (MEJORADA)
function mostrarCorreccion() {
  const pregunta = testActivo.preguntas[preguntaActual];
  const respuestaUsuario = respuestasTest[preguntaActual].letra;
  const esCorrecta = respuestasTest[preguntaActual].esCorrecta;
  
  // Deshabilitar clicks en opciones
  document.getElementById('contenedorOpciones').style.pointerEvents = 'none';
  
  // Marcar respuestas
  ['A', 'B', 'C', 'D'].forEach(function(letra) {
    const elem = document.getElementById('opcion' + letra);
    // Limpiar cualquier marca anterior
    const textoOriginal = elem.innerHTML.split('<span')[0];
    elem.innerHTML = textoOriginal;
    
    if (letra === pregunta.respuesta_correcta) {
      elem.style.background = '#e8f5e9';
      elem.style.borderColor = '#4caf50';
      elem.innerHTML += ' <span style="color: #4caf50; float: right;">✓ Correcta</span>';
    } else if (letra === respuestaUsuario && !esCorrecta) {
      elem.style.background = '#ffebee';
      elem.style.borderColor = '#f44336';
      elem.innerHTML += ' <span style="color: #f44336; float: right;">✗ Incorrecta</span>';
    }
  });
  
  // Mostrar retroalimentación
  const areaRetro = document.getElementById('areaRetroalimentacion');
  if (pregunta.retroalimentacion) {
    areaRetro.style.display = 'block';
    areaRetro.innerHTML = '<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">' +
                         '<strong>Explicación:</strong> ' + pregunta.retroalimentacion +
                         '</div>';
  }
  
  // Ocultar botón corregir
  const btnCorregir = document.getElementById('btnCorregir');
  if (btnCorregir) btnCorregir.style.display = 'none';
}

// Navegación - Pregunta anterior
function preguntaAnterior() {
  if (preguntaActual > 0) {
    preguntaActual--;
    mostrarPregunta();
  }
}

// Siguiente pregunta
function siguientePregunta() {
  // En modo práctica, verificar si se ha corregido antes de avanzar
  if (testActivo.modo === 'practica' && respuestasTest[preguntaActual] && 
      respuestasTest[preguntaActual].letra && !respuestasTest[preguntaActual].corregida) {
    if (confirm('No has corregido esta pregunta. ¿Deseas continuar sin corregir?')) {
      avanzarPregunta();
    }
  } else {
    avanzarPregunta();
  }
}

// NUEVA: Función auxiliar para avanzar pregunta
function avanzarPregunta() {
  if (preguntaActual < testActivo.preguntas.length - 1) {
    preguntaActual++;
    mostrarPregunta();
  } else {
    finalizarTest();
  }
}

// Finalizar test (ACTUALIZADA)
function finalizarTest() {
  // Detener temporizador si existe
  if (intervalTemporizador) {
    clearInterval(intervalTemporizador);
    intervalTemporizador = null;
  }
  
  const sinResponder = respuestasTest.filter(r => !r || !r.letra).length;
  
  if (sinResponder > 0) {
    if (!confirm('Hay ' + sinResponder + ' preguntas sin responder. ¿Deseas finalizar de todos modos?')) {
      return;
    }
  }
  
  document.getElementById('panelEjecucionTest').innerHTML = '<p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Procesando resultados...</p>';
  
  // Si es modo examen, guardar todas las respuestas primero
  if (testActivo.modo === 'examen') {
    guardarRespuestasExamen();
  } else {
    // Modo práctica - finalizar directamente
    finalizarTestReal();
  }
}

// NUEVA: Guardar respuestas del examen
function guardarRespuestasExamen() {
  let respuestasPendientes = 0;
  let respuestasGuardadas = 0;
  
  testActivo.preguntas.forEach(function(pregunta, index) {
    if (respuestasTest[index] && respuestasTest[index].letra) {
      respuestasPendientes++;
      
      google.script.run
        .withSuccessHandler(function(resultado) {
          respuestasTest[index].esCorrecta = resultado.esCorrecta;
          respuestasGuardadas++;
          
          // Cuando se procesen todas, finalizar
          if (respuestasGuardadas === respuestasPendientes) {
            finalizarTestReal();
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error al guardar respuesta:', error);
          respuestasGuardadas++;
          if (respuestasGuardadas === respuestasPendientes) {
            finalizarTestReal();
          }
        })
        .guardarRespuestaTest(
          testActivo.idHistorial,
          pregunta.id,
          respuestasTest[index].letra,
          pregunta.index
        );
    }
  });
  
  // Si no hay respuestas, finalizar directamente
  if (respuestasPendientes === 0) {
    finalizarTestReal();
  }
}

// Finalizar test (llamada al servidor)
function finalizarTestReal() {
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarResultadosTest(resultado);
    })
    .withFailureHandler(function(error) {
      console.error('Error al finalizar test:', error);
      alert('Error al finalizar test');
    })
    .finalizarTest(testActivo.idHistorial, testActivo.tiempoInicio);
}

// Mostrar resultados
function mostrarResultadosTest(resultado) {
  let html = '<div style="background: white; padding: 20px; border-radius: 8px;">';
  
  // Resumen
  html += '<div style="text-align: center; margin-bottom: 30px;">';
  html += '<h2>Resultados del Test</h2>';
  html += '<div style="font-size: 48px; color: #007bff; margin: 20px 0;">' + resultado.porcentaje + '%</div>';
  html += '<p>Respuestas correctas: ' + resultado.correctas + ' de ' + resultado.total + '</p>';
  html += '<p>Tiempo: ' + resultado.tiempoFormateado + '</p>';
  html += '</div>';
  
  // Si es modo examen, mostrar todas las preguntas con respuestas
  if (testActivo.modo === 'examen') {
    html += '<hr style="margin: 30px 0;">';
    html += '<h3>Revisión de respuestas</h3>';
    html += '<div style="max-height: 60vh; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 5px;">';
    
    testActivo.preguntas.forEach(function(pregunta, index) {
      const respuesta = respuestasTest[index];
      const respuestaUsuario = respuesta ? respuesta.letra : null;
      const esCorrecta = respuestaUsuario === pregunta.respuesta_correcta;
      
      html += '<div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">';
      
      // Número y título
      html += '<h4 style="margin-bottom: 15px;">';
      html += '<span style="color: ' + (esCorrecta ? '#4caf50' : '#f44336') + ';">';
      html += (esCorrecta ? '✓' : '✗') + '</span> ';
      html += 'Pregunta ' + (index + 1) + ': ' + pregunta.titulo;
      html += '</h4>';
      
      // Opciones
      ['A', 'B', 'C', 'D'].forEach(function(letra) {
        const opcion = pregunta['opcion_' + letra.toLowerCase()];
        let estilo = 'margin: 5px 0; padding: 10px; border-radius: 5px;';
        
        if (letra === pregunta.respuesta_correcta) {
          estilo += ' background: #e8f5e9; border: 1px solid #4caf50;';
        } else if (letra === respuestaUsuario && !esCorrecta) {
          estilo += ' background: #ffebee; border: 1px solid #f44336;';
        } else {
          estilo += ' background: white; border: 1px solid #ddd;';
        }
        
        html += '<div style="' + estilo + '">';
        html += '<strong>' + letra + '.</strong> ' + opcion;
        
        if (letra === pregunta.respuesta_correcta) {
          html += ' <span style="color: #4caf50; float: right;">✓ Correcta</span>';
        } else if (letra === respuestaUsuario && !esCorrecta) {
          html += ' <span style="color: #f44336; float: right;">Tu respuesta</span>';
        }
        
        html += '</div>';
      });
      
      // Retroalimentación
      if (pregunta.retroalimentacion) {
        html += '<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">';
        html += '<strong>Explicación:</strong> ' + pregunta.retroalimentacion;
        html += '</div>';
      }
      
      html += '</div>';
    });
    
    html += '</div>';
  }
  
  html += '<div style="text-align: center; margin-top: 20px;">';
  html += '<button onclick="volverAConfiguracion()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">Nuevo Test</button>';
  html += '<button onclick="mostrarPreguntasMasFalladas()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">Ver Preguntas Más Falladas</button>';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('panelEjecucionTest').innerHTML = html;
}

// ===== NUEVA SECCIÓN: PREGUNTAS MÁS FALLADAS =====

var preguntasFalladasActuales = [];
var paginaFalladasActual = 0;
var totalPaginasFalladas = 0;

// Mostrar preguntas más falladas
function mostrarPreguntasMasFalladas() {
  document.getElementById('panelEjecucionTest').innerHTML = '<p style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Cargando preguntas más falladas...</p>';
  
  const idOposicion = document.getElementById('comboOposicionTest').value;
  
  google.script.run
    .withSuccessHandler(function(preguntas) {
      preguntasFalladasActuales = preguntas;
      paginaFalladasActual = 0;
      totalPaginasFalladas = Math.ceil(preguntas.length / 10);
      mostrarPaginaFalladas();
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar preguntas falladas:', error);
      alert('Error al cargar preguntas más falladas');
      volverAConfiguracion();
    })
    .getPreguntasMasFalladas(idOposicion);
}

// Mostrar página de preguntas falladas
function mostrarPaginaFalladas() {
  const inicio = paginaFalladasActual * 10;
  const fin = Math.min(inicio + 10, preguntasFalladasActuales.length);
  const preguntasPagina = preguntasFalladasActuales.slice(inicio, fin);
  
  let html = '<div style="background: white; padding: 20px; border-radius: 8px;">';
  
  // Título y navegación
  html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
  html += '<h2>Preguntas Más Falladas</h2>';
  html += '<button onclick="volverAConfiguracion()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 5px;">Volver</button>';
  html += '</div>';
  
  // Info de paginación
  html += '<p style="text-align: center; color: #666; margin-bottom: 20px;">Página ' + (paginaFalladasActual + 1) + ' de ' + totalPaginasFalladas + ' - Total: ' + preguntasFalladasActuales.length + ' preguntas</p>';
  
  // Preguntas
  html += '<div style="max-height: 70vh; overflow-y: auto;">';
  
  preguntasPagina.forEach(function(item, index) {
    const pregunta = item.pregunta;
    const estadisticas = item.estadisticas;
    const numeroGlobal = inicio + index + 1;
    
    html += '<div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 5px solid #dc3545;">';
    
    // Cabecera con estadísticas
    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 15px;">';
    html += '<h4 style="margin: 0;">Pregunta #' + numeroGlobal + '</h4>';
    html += '<div style="text-align: right; font-size: 14px;">';
    html += '<span style="color: #dc3545;"><i class="fas fa-times-circle"></i> Fallos: ' + estadisticas.fallos + '</span> | ';
    html += '<span style="color: #28a745;"><i class="fas fa-check-circle"></i> Aciertos: ' + estadisticas.aciertos + '</span> | ';
    html += '<span style="color: #6c757d;">Tasa error: ' + estadisticas.porcentajeFallo + '%</span>';
    html += '</div>';
    html += '</div>';
    
    // Título de la pregunta
    html += '<h5 style="margin-bottom: 15px;">' + pregunta.titulo + '</h5>';
    
    if (pregunta.descripcion) {
      html += '<p style="margin-bottom: 15px;">' + pregunta.descripcion + '</p>';
    }
    
    // Opciones
    ['A', 'B', 'C', 'D'].forEach(function(letra) {
      const opcion = pregunta['opcion_' + letra.toLowerCase()];
      let estilo = 'margin: 5px 0; padding: 10px; border-radius: 5px;';
      
      if (letra === pregunta.respuesta_correcta) {
        estilo += ' background: #e8f5e9; border: 1px solid #4caf50;';
      } else {
        estilo += ' background: white; border: 1px solid #ddd;';
      }
      
      html += '<div style="' + estilo + '">';
      html += '<strong>' + letra + '.</strong> ' + opcion;
      
      if (letra === pregunta.respuesta_correcta) {
        html += ' <span style="color: #4caf50; float: right;">✓ Correcta</span>';
      }
      
      html += '</div>';
    });
    
    // Retroalimentación
    if (pregunta.retroalimentacion) {
      html += '<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">';
      html += '<strong>Explicación:</strong> ' + pregunta.retroalimentacion;
      html += '</div>';
    }
    
    // Tema de la pregunta
    html += '<div style="margin-top: 10px; font-size: 12px; color: #666;">';
    html += '<i class="fas fa-folder"></i> Tema: ' + (pregunta.nombreTema || 'Sin tema asignado');
    html += '</div>';
    
    html += '</div>';
  });
  
  html += '</div>';
  
  // Botones de paginación
  html += '<div style="display: flex; justify-content: center; margin-top: 20px; gap: 10px;">';
  
  if (paginaFalladasActual > 0) {
    html += '<button onclick="paginaFalladasAnterior()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 5px;">';
    html += '<i class="fas fa-chevron-left"></i> Anterior';
    html += '</button>';
  }
  
  // Números de página
  for (let i = 0; i < totalPaginasFalladas; i++) {
    const esActual = i === paginaFalladasActual;
    html += '<button onclick="irAPaginaFalladas(' + i + ')" ';
    html += 'style="background: ' + (esActual ? '#007bff' : '#e9ecef') + '; ';
    html += 'color: ' + (esActual ? 'white' : '#495057') + '; ';
    html += 'padding: 8px 12px; border: none; border-radius: 5px; min-width: 40px;">';
    html += (i + 1);
    html += '</button>';
  }
  
  if (paginaFalladasActual < totalPaginasFalladas - 1) {
    html += '<button onclick="paginaFalladasSiguiente()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 5px;">';
    html += 'Siguiente <i class="fas fa-chevron-right"></i>';
    html += '</button>';
  }
  
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('panelEjecucionTest').innerHTML = html;
}

// Navegación de páginas falladas
function paginaFalladasAnterior() {
  if (paginaFalladasActual > 0) {
    paginaFalladasActual--;
    mostrarPaginaFalladas();
  }
}

function paginaFalladasSiguiente() {
  if (paginaFalladasActual < totalPaginasFalladas - 1) {
    paginaFalladasActual++;
    mostrarPaginaFalladas();
  }
}

function irAPaginaFalladas(pagina) {
  paginaFalladasActual = pagina;
  mostrarPaginaFalladas();
}

// Volver a configuración
function volverAConfiguracion() {
  document.getElementById('panelConfiguracionTest').style.display = 'block';
  const panelAdmin = document.querySelector('div[style*="width: 350px"]');
  if (panelAdmin) panelAdmin.style.display = 'block';
  document.getElementById('panelEjecucionTest').style.display = 'none';
  
  // Limpiar estado
  testActivo = null;
  preguntaActual = 0;
  respuestasTest = [];
  
  // Detener temporizador si existe
  if (intervalTemporizador) {
    clearInterval(intervalTemporizador);
    intervalTemporizador = null;
  }
  tiempoInicio = null;
}

// ===== SECCIÓN DE ADMINISTRACIÓN =====

// Panel de administración
function togglePanelAdmin() {
  const panel = document.getElementById('opcionesAdmin');
  const texto = document.getElementById('toggleAdminText');
  const icono = document.getElementById('toggleAdminIcon');
  
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    texto.textContent = 'Ocultar opciones';
    icono.className = 'fas fa-chevron-up';
    // Cargar estadísticas al abrir
    actualizarEstadisticasPreguntas();
  } else {
    panel.style.display = 'none';
    texto.textContent = 'Mostrar opciones';
    icono.className = 'fas fa-chevron-down';
  }
}

// Importar preguntas desde URL
function importarPreguntasDesdeURL() {
  const url = document.getElementById('urlSheetImportar').value.trim();
  
  if (!url) {
    alert('Por favor, introduce la URL del Google Sheet');
    return;
  }
  
  if (!url.includes('docs.google.com/spreadsheets')) {
    alert('La URL no parece ser de un Google Sheet válido');
    return;
  }
  
  // Preguntar qué hojas importar
  const importarTodas = confirm('¿Importar todas las hojas del documento?\n\nSí = Importar todas las hojas\nNo = Especificar nombres de hojas');
  
  let hojasAImportar = null;
  if (!importarTodas) {
    const nombresHojas = prompt('Introduce los nombres de las hojas a importar, separados por comas:\n\nEjemplo: Hoja1, Hoja2, Hoja3');
    if (!nombresHojas) return;
    hojasAImportar = nombresHojas.split(',').map(h => h.trim());
  }
  
  // Mostrar loading
  const boton = event.target || document.querySelector('button[onclick*="importarPreguntasDesdeURL"]');
  const textoOriginal = boton.innerHTML;
  boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
  boton.disabled = true;
  
  // Llamar a función mejorada
  google.script.run
    .withSuccessHandler(function(resultado) {
      alert(resultado);
      document.getElementById('urlSheetImportar').value = '';
      actualizarEstadisticasPreguntas();
      boton.innerHTML = textoOriginal;
      boton.disabled = false;
    })
    .withFailureHandler(function(error) {
      alert('Error al importar: ' + error.message);
      boton.innerHTML = textoOriginal;
      boton.disabled = false;
    })
    .importarPreguntasDesdeSheetMejorado(url, hojasAImportar);
}

// Buscar archivos en carpeta
function buscarArchivosEnCarpeta() {
  const nombreCarpeta = document.getElementById('nombreCarpetaDrive').value.trim();
  
  if (!nombreCarpeta) {
    alert('Por favor, introduce el nombre de la carpeta');
    return;
  }
  
  const contenedor = document.getElementById('listaArchivosEncontrados');
  contenedor.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Buscando...</p>';
  
  google.script.run
    .withSuccessHandler(function(archivos) {
      if (archivos.length === 0) {
        contenedor.innerHTML = '<p style="color: #666; font-size: 14px;">No se encontraron archivos en la carpeta</p>';
        return;
      }
      
      let html = '<p style="font-size: 14px; margin-bottom: 10px;">Se encontraron ' + archivos.length + ' archivos:</p>';
      html += '<div style="border: 1px solid #ddd; border-radius: 5px; padding: 5px;">';
      
      archivos.forEach(function(archivo) {
        html += '<div style="padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">';
        html += '<span style="font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">';
        html += '<i class="fas fa-file-alt" style="color: #28a745; margin-right: 5px;"></i>';
        html += archivo.nombre;
        html += '</span>';
        html += '<button onclick="importarArchivoSeleccionado(\'' + archivo.url + '\', \'' + archivo.nombre.replace(/'/g, "\\'") + '\')" ';
        html += 'style="padding: 3px 8px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">';
        html += '<i class="fas fa-download"></i>';
        html += '</button>';
        html += '</div>';
      });
      
      html += '</div>';
      contenedor.innerHTML = html;
    })
    .withFailureHandler(function(error) {
      contenedor.innerHTML = '<p style="color: red; font-size: 14px;">Error: ' + error.message + '</p>';
    })
    .buscarArchivosTestEnCarpeta(nombreCarpeta);
}

// Importar archivo seleccionado
function importarArchivoSeleccionado(url, nombre) {
  if (confirm('¿Importar preguntas de "' + nombre + '"?')) {
    const boton = event.target;
    const textoOriginal = boton.innerHTML;
    boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    boton.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(resultado) {
        alert(resultado);
        actualizarEstadisticasPreguntas();
        boton.innerHTML = textoOriginal;
        boton.disabled = false;
      })
      .withFailureHandler(function(error) {
        alert('Error al importar: ' + error.message);
        boton.innerHTML = textoOriginal;
        boton.disabled = false;
      })
      .importarPreguntasDesdeSheet(url);
  }
}

// Actualizar estadísticas
function actualizarEstadisticasPreguntas() {
  google.script.run
    .withSuccessHandler(function(stats) {
      document.getElementById('totalPreguntas').textContent = stats.totalPreguntas;
      document.getElementById('temasConPreguntas').textContent = stats.temasConPreguntas;
      document.getElementById('ultimaImportacion').textContent = stats.ultimaImportacion || 'Nunca';
    })
    .withFailureHandler(function(error) {
      console.error('Error al obtener estadísticas:', error);
    })
    .obtenerEstadisticasPreguntas();
}
</script>
