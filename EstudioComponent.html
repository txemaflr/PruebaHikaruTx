<script type="text/x-template" id="estudio-template">
  <div class="space-y-6">
    <!-- Selector de Oposición y Configuración -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        <i class="fas fa-brain mr-2 text-purple-600"></i>
        Sistema de Estudio Inteligente
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Selecciona una oposición
          </label>
          <select v-model="oposicionSeleccionada" 
                  @change="cargarDatosOposicion"
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="">-- Selecciona --</option>
            <option v-for="op in oposiciones" :key="op.id" :value="op.id">
              {{ op.nombre }}
            </option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Modo de estudio
          </label>
          <select v-model="modoEstudio" 
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="inteligente">Inteligente (Recomendado)</option>
            <option value="secuencial">Secuencial</option>
            <option value="aleatorio">Aleatorio</option>
            <option value="repaso">Solo Repasos</option>
          </select>
        </div>
      </div>
      
      <!-- Estadísticas de Sesión -->
      <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-purple-50 p-3 rounded-lg text-center">
          <div class="text-xl font-bold text-purple-600">{{ sesion.conceptosEstudiados }}</div>
          <div class="text-xs text-gray-600">Conceptos Hoy</div>
        </div>
        <div class="bg-green-50 p-3 rounded-lg text-center">
          <div class="text-xl font-bold text-green-600">{{ sesion.racha }} 🔥</div>
          <div class="text-xs text-gray-600">Días de Racha</div>
        </div>
        <div class="bg-blue-50 p-3 rounded-lg text-center">
          <div class="text-xl font-bold text-blue-600">{{ sesion.tiempoEstudio }}</div>
          <div class="text-xs text-gray-600">Tiempo Total</div>
        </div>
        <div class="bg-yellow-50 p-3 rounded-lg text-center">
          <div class="text-xl font-bold text-yellow-600">{{ sesion.eficacia }}%</div>
          <div class="text-xs text-gray-600">Eficacia</div>
        </div>
      </div>
      
      <!-- Botón Iniciar Estudio -->
      <div class="mt-6 text-center">
        <button v-if="!estudiando && oposicionSeleccionada" 
                @click="iniciarEstudio"
                class="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 transition-colors text-lg font-semibold">
          <i class="fas fa-play mr-2"></i>
          Iniciar Sesión de Estudio
        </button>
      </div>
    </div>

    <!-- Panel de Estudio Activo -->
    <transition name="fade">
      <div v-if="estudiando && conceptoActual" class="bg-white rounded-lg shadow-md p-6">
        <!-- Progreso de la Sesión -->
        <div class="mb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Progreso de la sesión</span>
            <span class="text-sm font-semibold">{{ sesion.conceptosEstudiados }} / {{ sesion.objetivoDiario }}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" 
                 :style="{width: progresoPorcentaje + '%'}"></div>
          </div>
        </div>
        
        <!-- Información del Tema -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold text-gray-800">{{ conceptoActual.tema }}</h3>
              <p class="text-sm text-gray-600 mt-1">{{ conceptoActual.bloque }}</p>
            </div>
            <div class="text-right">
              <span class="text-xs text-gray-500">Importancia</span>
              <div class="flex mt-1">
                <i v-for="i in 5" :key="i" 
                   :class="['fas fa-star text-sm', i <= conceptoActual.importancia ? 'text-yellow-500' : 'text-gray-300']"></i>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Concepto Principal -->
        <div class="mb-6">
          <h4 class="text-2xl font-bold text-gray-800 mb-4">{{ conceptoActual.nombre }}</h4>
          
          <!-- Tipo de Concepto -->
          <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium mb-4"
               :class="tipoConceptoClase(conceptoActual.tipo)">
            <i :class="tipoConceptoIcono(conceptoActual.tipo) + ' mr-2'"></i>
            {{ conceptoActual.tipo }}
          </div>
          
          <!-- Descripción -->
          <div v-if="mostrarDescripcion" class="mb-6">
            <h5 class="font-semibold text-gray-700 mb-2">Descripción:</h5>
            <p class="text-gray-600 leading-relaxed">{{ conceptoActual.descripcion }}</p>
          </div>
          
          <!-- Pista (Opcional) -->
          <div v-if="mostrarPista && conceptoActual.pista" class="mb-6 bg-blue-50 border-l-4 border-blue-400 p-4">
            <h5 class="font-semibold text-blue-800 mb-1">
              <i class="fas fa-lightbulb mr-1"></i>
              Pista:
            </h5>
            <p class="text-blue-700">{{ conceptoActual.pista }}</p>
          </div>
          
          <!-- Técnica de Memorización -->
          <div v-if="mostrarTecnica && conceptoActual.tecnica" class="mb-6 bg-green-50 border-l-4 border-green-400 p-4">
            <h5 class="font-semibold text-green-800 mb-1">
              <i class="fas fa-brain mr-1"></i>
              Técnica de memorización:
            </h5>
            <p class="text-green-700">{{ conceptoActual.tecnica }}</p>
          </div>
        </div>
        
        <!-- Controles de Estudio -->
        <div class="space-y-4">
          <!-- Botones de Revelación Progresiva -->
          <div class="flex flex-wrap gap-2 justify-center">
            <button v-if="!mostrarDescripcion" 
                    @click="mostrarDescripcion = true"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
              <i class="fas fa-eye mr-2"></i>
              Ver Descripción
            </button>
            <button v-if="!mostrarPista && conceptoActual.pista" 
                    @click="mostrarPista = true"
                    class="px-4 py-2 bg-blue-200 text-blue-700 rounded-lg hover:bg-blue-300 transition-colors">
              <i class="fas fa-lightbulb mr-2"></i>
              Ver Pista
            </button>
            <button v-if="!mostrarTecnica && conceptoActual.tecnica" 
                    @click="mostrarTecnica = true"
                    class="px-4 py-2 bg-green-200 text-green-700 rounded-lg hover:bg-green-300 transition-colors">
              <i class="fas fa-brain mr-2"></i>
              Ver Técnica
            </button>
          </div>
          
          <!-- Evaluación de Comprensión -->
          <div class="bg-gray-50 rounded-lg p-4">
            <p class="text-center text-gray-700 mb-3">¿Cómo de bien conoces este concepto?</p>
            <div class="grid grid-cols-4 gap-2">
              <button v-for="nivel in nivelesComprension" 
                      :key="nivel.valor"
                      @click="evaluarComprension(nivel.valor)"
                      :class="[
                        'py-3 rounded-lg font-medium transition-all',
                        nivel.clase
                      ]">
                <i :class="nivel.icono + ' mr-1'"></i>
                {{ nivel.texto }}
              </button>
            </div>
          </div>
        </div>
        
        <!-- Timer y Controles de Sesión -->
        <div class="mt-6 flex justify-between items-center">
          <div class="text-sm text-gray-600">
            <i class="fas fa-clock mr-1"></i>
            Tiempo en concepto: {{ tiempoEnConcepto }}
          </div>
          <button @click="pausarEstudio" 
                  class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-pause mr-2"></i>
            Pausar Sesión
          </button>
        </div>
      </div>
    </transition>

    <!-- Resumen de Sesión -->
    <transition name="fade">
      <div v-if="mostrarResumen" class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
          <i class="fas fa-trophy mr-2 text-yellow-500"></i>
          ¡Sesión Completada!
        </h3>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-600">{{ resumen.conceptosEstudiados }}</div>
            <div class="text-sm text-gray-600">Conceptos Estudiados</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">{{ resumen.conceptosDominados }}</div>
            <div class="text-sm text-gray-600">Dominados</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">{{ resumen.tiempoTotal }}</div>
            <div class="text-sm text-gray-600">Tiempo Total</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-yellow-600">{{ resumen.puntos }}</div>
            <div class="text-sm text-gray-600">Puntos Ganados</div>
          </div>
        </div>
        
        <!-- Gráfico de Progreso -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <h4 class="font-semibold text-gray-700 mb-3">Distribución de Comprensión</h4>
          <div class="space-y-2">
            <div v-for="nivel in resumenNiveles" :key="nivel.nombre" class="flex items-center">
              <span class="w-24 text-sm text-gray-600">{{ nivel.nombre }}</span>
              <div class="flex-1 bg-gray-200 rounded-full h-6 ml-2">
                <div :class="nivel.clase + ' h-6 rounded-full flex items-center justify-center text-xs font-semibold text-white'"
                     :style="{width: nivel.porcentaje + '%'}">
                  {{ nivel.cantidad }}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Próximos Repasos -->
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
          <h4 class="font-semibold text-blue-800 mb-2">
            <i class="fas fa-calendar-alt mr-2"></i>
            Próximos Repasos Programados
          </h4>
          <div class="space-y-1">
            <div v-for="repaso in proximosRepasos" :key="repaso.id" class="text-sm text-blue-700">
              <span class="font-medium">{{ repaso.concepto }}</span> - {{ repaso.fecha }}
            </div>
          </div>
        </div>
        
        <div class="flex justify-center space-x-4">
          <button @click="mostrarResumen = false" 
                  class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
            Cerrar
          </button>
          <button @click="iniciarEstudio" 
                  class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            <i class="fas fa-redo mr-2"></i>
            Nueva Sesión
          </button>
        </div>
      </div>
    </transition>
  </div>
</script>

<script>
const EstudioComponent = {
  template: '#estudio-template',
  mixins: [GlobalMixin],
  data() {
    return {
      oposiciones: [],
      oposicionSeleccionada: '',
      modoEstudio: 'inteligente',
      estudiando: false,
      conceptoActual: null,
      mostrarDescripcion: false,
      mostrarPista: false,
      mostrarTecnica: false,
      tiempoInicio: null,
      tiempoConcepto: null,
      intervalTimer: null,
      tiempoEnConcepto: '00:00',
      sesion: {
        conceptosEstudiados: 0,
        racha: 0,
        tiempoEstudio: '00:00',
        eficacia: 85,
        objetivoDiario: 20
      },
      mostrarResumen: false,
      resumen: {},
      historialSesion: [],
      nivelesComprension: [
        { valor: 1, texto: 'No lo sé', icono: 'fas fa-times', clase: 'bg-red-500 text-white hover:bg-red-600' },
        { valor: 2, texto: 'Difícil', icono: 'fas fa-frown', clase: 'bg-orange-500 text-white hover:bg-orange-600' },
        { valor: 3, texto: 'Bien', icono: 'fas fa-check', clase: 'bg-blue-500 text-white hover:bg-blue-600' },
        { valor: 4, texto: 'Fácil', icono: 'fas fa-smile', clase: 'bg-green-500 text-white hover:bg-green-600' }
      ]
    }
  },
  
  computed: {
    progresoPorcentaje() {
      return Math.min(100, (this.sesion.conceptosEstudiados / this.sesion.objetivoDiario) * 100);
    },
    
    resumenNiveles() {
      const niveles = { 1: 0, 2: 0, 3: 0, 4: 0 };
      this.historialSesion.forEach(h => niveles[h.comprension]++);
      
      return [
        { nombre: 'No lo sé', cantidad: niveles[1], porcentaje: (niveles[1] / this.historialSesion.length) * 100, clase: 'bg-red-500' },
        { nombre: 'Difícil', cantidad: niveles[2], porcentaje: (niveles[2] / this.historialSesion.length) * 100, clase: 'bg-orange-500' },
        { nombre: 'Bien', cantidad: niveles[3], porcentaje: (niveles[3] / this.historialSesion.length) * 100, clase: 'bg-blue-500' },
        { nombre: 'Fácil', cantidad: niveles[4], porcentaje: (niveles[4] / this.historialSesion.length) * 100, clase: 'bg-green-500' }
      ];
    },
    
    proximosRepasos() {
      // Simular próximos repasos
      return [
        { id: 1, concepto: 'Derecho Administrativo - Principios', fecha: 'Mañana' },
        { id: 2, concepto: 'Constitución - Artículos 1-20', fecha: 'En 3 días' },
        { id: 3, concepto: 'Ley 39/2015 - Procedimiento', fecha: 'En 1 semana' }
      ];
    }
  },
  
  methods: {
    async cargarOposiciones() {
      try {
        this.oposiciones = await this.ejecutarGAS('getOposiciones');
      } catch (error) {
        console.error('Error al cargar oposiciones:', error);
      }
    },
    
    async cargarDatosOposicion() {
      if (!this.oposicionSeleccionada) return;
      
      // Cargar estadísticas de la oposición
      try {
        const stats = await this.ejecutarGAS('getEstadisticasEstudio', this.oposicionSeleccionada);
        this.sesion.racha = stats.racha || 0;
        this.sesion.conceptosEstudiados = stats.conceptosHoy || 0;
      } catch (error) {
        console.error('Error al cargar estadísticas:', error);
      }
    },
    
    async iniciarEstudio() {
      this.estudiando = true;
      this.mostrarResumen = false;
      this.historialSesion = [];
      this.tiempoInicio = new Date();
      
      // Iniciar timer
      this.intervalTimer = setInterval(() => {
        this.actualizarTiempos();
      }, 1000);
      
      await this.cargarSiguienteConcepto();
    },
    
    async cargarSiguienteConcepto() {
      try {
        // Resetear visualización
        this.mostrarDescripcion = false;
        this.mostrarPista = false;
        this.mostrarTecnica = false;
        this.tiempoConcepto = new Date();
        
        // Obtener siguiente concepto según el modo
        const concepto = await this.ejecutarGAS(
          'obtenerSiguienteConcepto', 
          this.oposicionSeleccionada, 
          this.modoEstudio
        );
        
        if (!concepto) {
          this.finalizarSesion();
          return;
        }
        
        this.conceptoActual = concepto;
      } catch (error) {
        console.error('Error al cargar concepto:', error);
        this.$emit('mostrar-alerta', 'error', 'Error al cargar el siguiente concepto');
      }
    },
    
    async evaluarComprension(nivel) {
      // Guardar en historial
      this.historialSesion.push({
        concepto: this.conceptoActual,
        comprension: nivel,
        tiempo: new Date() - this.tiempoConcepto
      });
      
      // Actualizar estadísticas
      this.sesion.conceptosEstudiados++;
      
      // Guardar progreso en el servidor
      try {
        await this.ejecutarGAS(
          'guardarProgresoConcepto',
          this.conceptoActual.id,
          nivel,
          new Date() - this.tiempoConcepto
        );
      } catch (error) {
        console.error('Error al guardar progreso:', error);
      }
      
      // Cargar siguiente concepto o finalizar
      if (this.sesion.conceptosEstudiados >= this.sesion.objetivoDiario) {
        this.finalizarSesion();
      } else {
        await this.cargarSiguienteConcepto();
      }
    },
    
    pausarEstudio() {
      this.estudiando = false;
      if (this.intervalTimer) {
        clearInterval(this.intervalTimer);
        this.intervalTimer = null;
      }
    },
    
    finalizarSesion() {
      this.pausarEstudio();
      
      // Calcular resumen
      const tiempoTotal = new Date() - this.tiempoInicio;
      const minutos = Math.floor(tiempoTotal / 60000);
      const segundos = Math.floor((tiempoTotal % 60000) / 1000);
      
      this.resumen = {
        conceptosEstudiados: this.historialSesion.length,
        conceptosDominados: this.historialSesion.filter(h => h.comprension >= 3).length,
        tiempoTotal: `${minutos}m ${segundos}s`,
        puntos: this.historialSesion.reduce((acc, h) => acc + h.comprension * 10, 0)
      };
      
      this.mostrarResumen = true;
      this.$emit('mostrar-alerta', 'success', '¡Sesión de estudio completada!');
    },
    
    actualizarTiempos() {
      // Actualizar tiempo total de sesión
      const tiempoTotal = new Date() - this.tiempoInicio;
      const minutos = Math.floor(tiempoTotal / 60000);
      const segundos = Math.floor((tiempoTotal % 60000) / 1000);
      this.sesion.tiempoEstudio = `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
      
      // Actualizar tiempo en concepto actual
      if (this.tiempoConcepto) {
        const tiempoConcepto = new Date() - this.tiempoConcepto;
        const minutosC = Math.floor(tiempoConcepto / 60000);
        const segundosC = Math.floor((tiempoConcepto % 60000) / 1000);
        this.tiempoEnConcepto = `${String(minutosC).padStart(2, '0')}:${String(segundosC).padStart(2, '0')}`;
      }
    },
    
    tipoConceptoClase(tipo) {
      const clases = {
        'Definición': 'bg-blue-100 text-blue-800',
        'Artículo': 'bg-purple-100 text-purple-800',
        'Procedimiento': 'bg-green-100 text-green-800',
        'Fecha': 'bg-yellow-100 text-yellow-800',
        'Concepto': 'bg-gray-100 text-gray-800'
      };
      return clases[tipo] || 'bg-gray-100 text-gray-800';
    },
    
    tipoConceptoIcono(tipo) {
      const iconos = {
        'Definición': 'fas fa-book',
        'Artículo': 'fas fa-gavel',
        'Procedimiento': 'fas fa-list-ol',
        'Fecha': 'fas fa-calendar',
        'Concepto': 'fas fa-lightbulb'
      };
      return iconos[tipo] || 'fas fa-circle';
    }
  },
  
  mounted() {
    this.cargarOposiciones();
    
    // Cargar racha y estadísticas del día
    this.cargarDatosOposicion();
  },
  
  beforeUnmount() {
    if (this.intervalTimer) {
      clearInterval(this.intervalTimer);
    }
  }
};
</script>
